<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tormenta RPG - Gerenciador de Fichas</title>
    <!-- Tailwind CSS CDN para um estilo moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter e cores temáticas */
        :root {
            --color-bg: #111827;
            --color-surface: #1f2937;
            --color-surface-alt: #374151;
            --color-border: #4b5563;
            --color-primary: #8b5cf6;
            --color-primary-hover: #7c3aed;
            --color-primary-light: #a78bfa;
            --color-secondary: #fcd34d;
            --color-text-base: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-button-bg: #4b5563;
            --color-button-bg-hover: #6b7280;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-base);
            transition: background-color 0.3s, color 0.3s;
        }
        /* Estilo para destacar campos importantes */
        .stat-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .themed-bg-surface { background-color: var(--color-surface); }
        .themed-bg-surface-alt { background-color: var(--color-surface-alt); }
        .themed-border { border-color: var(--color-border); }
        .themed-text-primary { color: var(--color-primary); }
        .themed-text-primary-light { color: var(--color-primary-light); }
        .themed-text-secondary { color: var(--color-secondary); }
        .themed-text-base { color: var(--color-text-base); }
        .themed-text-muted { color: var(--color-text-muted); }
        .themed-bg-primary { background-color: var(--color-primary); }
        .themed-bg-primary-hover:hover { background-color: var(--color-primary-hover); }
        .themed-bg-button { background-color: var(--color-button-bg); }
        .themed-bg-button-hover:hover { background-color: var(--color-button-bg-hover); }
        .themed-border-primary { border-color: var(--color-primary); }
        .themed-border-secondary { border-color: var(--color-secondary); }
        .themed-ring-focus:focus { ring-color: var(--color-primary); border-color: var(--color-primary); }


        /* Estilos de impressão */
        @media print {
            /* Oculta tudo que não é essencial para a ficha */
            .no-print, .header, .sidebar, #character-list-view, .tabs, .tab-content > div:not(.active-tab) {
                display: none !important;
            }
            /* Mostra apenas a ficha e remove o fundo escuro */
            #app-container {
                display: block;
                background-color: white !important;
                color: black !important;
            }
            #character-sheet-view {
                display: block !important;
                width: 100% !important;
                padding: 0 !important;
            }
            /* Garante que os containers da ficha apareçam */
            .char-details-container {
                display: block !important;
                color: black;
                border: 1px solid #ccc;
                margin-bottom: 1rem;
                padding: 1rem;
                page-break-inside: avoid;
            }
            /* Estilos específicos para as informações */
            .print-hidden-input {
                border: none !important;
                outline: none !important;
                background-color: transparent !important;
                color: black !important;
                pointer-events: none;
            }
        }

        /* === ESTILOS DE ACESSIBILIDADE === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus\\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: 0.5rem 1rem;
            margin: 0;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }

        /* === ESTILOS DE VALIDAÇÃO === */
        .field-error {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .border-red-500 {
            border-color: #ef4444 !important;
        }

        /* === MELHORIAS DE FOCO === */
        .focus\\:ring-2:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
        }

        .focus\\:ring-violet-500:focus {
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
        }

        .focus\\:ring-opacity-50:focus {
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
        }

        /* === ANIMAÇÕES MELHORADAS === */
        .transition-colors {
            transition-property: color, background-color, border-color;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* === ESTILOS PARA SKIP LINKS === */
        .skip-link {
            transform: translateY(-100%);
            transition: transform 0.3s;
        }

        .skip-link:focus {
            transform: translateY(0%);
        }

        /* === ESTILOS PARA MODAL DE AJUDA === */
        .help-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        kbd {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        /* Estilo para as abas de ajuda */
        .help-tab-active {
            background-color: #2563eb !important;
            color: white !important;
        }

        .help-tab-inactive {
            color: #9ca3af;
        }

        .help-tab-inactive:hover {
            color: white;
            background-color: #374151;
        }

        /* Scrollbar personalizada para o modal */
        .help-content::-webkit-scrollbar {
            width: 6px;
        }

        .help-content::-webkit-scrollbar-track {
            background: var(--color-surface-alt);
        }

        .help-content::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        .help-content::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }

        /* === ESTILOS PARA JANELAS ARRASTÁVEIS === */
        .draggable-modal {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
        }

        .draggable-modal.dragging {
            user-select: none;
            cursor: move;
        }

        .modal-header {
            cursor: move;
            user-select: none;
        }

        .modal-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        /* Estilos para as abas de auditoria */
        .audit-tab-content {
            display: block;
        }
        
        .audit-tab-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- ========== MODAIS ========== -->

    <!-- Modal de Criação de Personagem -->
    <div id="create-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-md border-t-4 themed-border-primary">
            <h3 class="text-2xl font-bold mb-4 themed-text-primary-light">Novo Personagem</h3>
            
            <div class="mb-4">
                <label for="char-name-input" class="block mb-2 text-sm font-medium themed-text-muted">Nome do Personagem *</label>
                <input type="text" 
                       id="char-name-input" 
                       placeholder="Aventureiro(a) Implacável" 
                       class="w-full p-3 rounded-lg themed-bg-surface-alt themed-border themed-text-base themed-ring-focus border"
                       maxlength="50"
                       required
                       aria-describedby="char-name-error">
                <div id="char-name-error" class="text-red-400 text-xs mt-1 hidden" role="alert"></div>
            </div>

            <div class="mb-6">
                <label for="player-name-input" class="block mb-2 text-sm font-medium themed-text-muted">Nome do Jogador</label>
                <input type="text" 
                       id="player-name-input" 
                       placeholder="Seu Nome" 
                       class="w-full p-3 rounded-lg themed-bg-surface-alt themed-border themed-text-base themed-ring-focus border"
                       maxlength="50"
                       aria-describedby="player-name-help">
                <div id="player-name-help" class="text-gray-500 text-xs mt-1">Opcional</div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('create-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg transition duration-150">Cancelar</button>
                <button id="create-character-btn" onclick="createNewCharacter()" class="px-4 py-2 themed-bg-primary themed-bg-primary-hover text-white font-semibold rounded-lg transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Criar Ficha</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação (para deletar) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-red-500">
            <h3 id="confirm-title" class="text-xl font-bold mb-4 text-red-400">Confirmar Ação</h3>
            <p id="confirm-message" class="mb-6 themed-text-muted">Tem certeza?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirm-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg transition duration-150">Cancelar</button>
                <button id="confirm-action-button" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Aprimoramento -->
    <div id="enhancement-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-yellow-500">
            <h3 class="text-2xl font-bold mb-4 text-yellow-300">Adicionar Aprimoramento</h3>
            <label for="enhancement-text" class="block mb-2 text-sm font-medium themed-text-muted">Descrição do Aprimoramento</label>
            <input type="text" id="enhancement-text" placeholder="Ex: Afiada (+2 no dano)" class="w-full p-3 mb-4 rounded-lg themed-bg-surface-alt themed-border themed-text-base border focus:ring-yellow-500 focus:border-yellow-500">
            <input type="hidden" id="enhancement-item-id">
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('enhancement-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg transition duration-150">Cancelar</button>
                <button onclick="addEnhancement()" class="px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Modal Conversor de Moeda -->
    <div id="currency-converter-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-2xl border-t-4 themed-border-secondary">
            <h3 class="text-2xl font-bold mb-4 themed-text-secondary">Calculadora de Câmbio</h3>
            <p class="text-sm themed-text-muted mb-6">Digite um valor em qualquer campo para converter para as outras moedas. (1 TL = 10 TO = 100 TP = 1000 T$)</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                    <label for="conv-tl" class="block text-sm font-semibold themed-text-muted">Platina (TL)</label>
                    <input type="number" id="conv-tl" oninput="convertCurrency('tl')" class="w-full themed-bg-surface-alt text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                </div>
                <div>
                    <label for="conv-to" class="block text-sm font-semibold themed-text-muted">Ouro (TO)</label>
                    <input type="number" id="conv-to" oninput="convertCurrency('to')" class="w-full themed-bg-surface-alt text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                </div>
                <div>
                    <label for="conv-tp" class="block text-sm font-semibold themed-text-muted">Prata (TP)</label>
                    <input type="number" id="conv-tp" oninput="convertCurrency('tp')" class="w-full themed-bg-surface-alt text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                </div>
                <div>
                    <label for="conv-ts" class="block text-sm font-semibold themed-text-muted">Tibar (T$)</label>
                    <input type="number" id="conv-ts" oninput="convertCurrency('ts')" class="w-full themed-bg-surface-alt text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal('currency-converter-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg transition duration-150">Fechar</button>
            </div>
        </div>
    </div>

    <!-- INÍCIO: MODAIS DE EDIÇÃO -->
    <div id="edit-spell-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 overflow-y-auto p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-lg border-t-4 border-sky-500">
            <h3 class="text-2xl font-bold mb-4 text-sky-300">Editar Magia</h3>
            <input type="hidden" id="edit-spell-id">
            <div class="space-y-2">
                <input type="text" id="edit-spell-name" placeholder="Nome da Magia" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <input type="text" id="edit-spell-level" placeholder="Nível" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <input type="text" id="edit-spell-school" placeholder="Escola/Descritor" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <input type="text" id="edit-spell-components" placeholder="Componentes" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <input type="text" id="edit-spell-time" placeholder="Tempo de Execução" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <input type="text" id="edit-spell-range" placeholder="Alcance" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <input type="text" id="edit-spell-target" placeholder="Alvo/Área" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <input type="text" id="edit-spell-duration" placeholder="Duração" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                </div>
                <input type="text" id="edit-spell-resistance" placeholder="Teste de Resistência" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <textarea id="edit-spell-description" placeholder="Descrição" rows="3" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeModal('edit-spell-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg">Cancelar</button>
                <button onclick="saveEditedSpell()" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-talent-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-lg border-t-4 border-sky-500">
            <h3 class="text-2xl font-bold mb-4 text-sky-300">Editar Talento</h3>
            <input type="hidden" id="edit-talent-id">
            <div class="space-y-2">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <input type="text" id="edit-talent-name" placeholder="Nome do Talento" class="sm:col-span-2 w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <select id="edit-talent-type" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                        <option value="Comprado">Comprado</option>
                        <option value="Classe">Classe</option>
                        <option value="Raça">Raça</option>
                        <option value="Desvantagem">Desvantagem</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <input type="text" id="edit-talent-prerequisite" placeholder="Pré-requisito" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <textarea id="edit-talent-benefit" placeholder="Benefício" rows="4" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeModal('edit-talent-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg">Cancelar</button>
                <button onclick="saveEditedTalent()" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-equipment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-lg border-t-4 border-sky-500">
            <h3 class="text-2xl font-bold mb-4 text-sky-300">Editar Equipamento</h3>
            <input type="hidden" id="edit-equipment-id">
            <div class="space-y-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" id="edit-item-name" placeholder="Nome do Item" class="md:col-span-2 w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                    <input type="number" id="edit-item-cost" placeholder="Custo (T$)" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                </div>
                <select id="edit-item-type" onchange="toggleEditWeaponFields()" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></select>
                <input type="number" id="edit-item-ca-bonus" placeholder="Bônus na CA" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <div id="edit-weapon-fields" class="hidden space-y-2 p-3 bg-black/20 rounded-lg">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="edit-weapon-bonus" placeholder="Bônus de Ataque" class="p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                        <input type="text" id="edit-weapon-damage" placeholder="Dano" class="p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                        <input type="text" id="edit-weapon-threat" placeholder="Ameaça" class="p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border col-span-2">
                    </div>
                    <textarea id="edit-weapon-special" placeholder="Característica Especial" rows="2" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
                </div>
                <textarea id="edit-item-description" placeholder="Descrição" rows="3" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeModal('edit-equipment-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg">Cancelar</button>
                <button onclick="saveEditedEquipment()" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-npc-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-lg border-t-4 border-sky-500">
            <h3 class="text-2xl font-bold mb-4 text-sky-300">Editar NPC</h3>
            <input type="hidden" id="edit-npc-id">
            <div class="space-y-2">
                <input type="text" id="edit-npc-name" placeholder="Nome do NPC" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <textarea id="edit-npc-note" placeholder="Nota sobre o NPC" rows="4" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeModal('edit-npc-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg">Cancelar</button>
                <button onclick="saveEditedNpc()" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-note-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-lg border-t-4 border-sky-500">
            <h3 class="text-2xl font-bold mb-4 text-sky-300">Editar Nota</h3>
            <input type="hidden" id="edit-note-id">
            <div class="space-y-2">
                <input type="text" id="edit-note-title" placeholder="Título da Nota" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <textarea id="edit-note-text" placeholder="Texto da Nota" rows="5" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeModal('edit-note-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg">Cancelar</button>
                <button onclick="saveEditedNote()" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-historyItem-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-lg border-t-4 border-sky-500">
            <h3 class="text-2xl font-bold mb-4 text-sky-300">Editar Característica</h3>
            <input type="hidden" id="edit-historyItem-id">
            <div class="space-y-2">
                <input type="text" id="edit-historyItem-description" placeholder="Descrição" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                <select id="edit-historyItem-type" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></select>
                <textarea id="edit-historyItem-details" placeholder="Detalhes" rows="3" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeModal('edit-historyItem-modal')" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white rounded-lg">Cancelar</button>
                <button onclick="saveEditedHistoryItem()" class="px-4 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700">Salvar</button>
            </div>
        </div>
    </div>
    <!-- FIM: MODAIS DE EDIÇÃO -->

    <!-- Modal de Ajuda -->
    <div id="help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 p-4">
        <div class="themed-bg-surface p-6 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto border-t-4 border-blue-500">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-blue-300 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.267l-1.162 1.162a3 3 0 00-.879 2.121V16M12 18h.01"></path>
                    </svg>
                    Central de Ajuda
                </h3>
                <button onclick="closeModal('help-modal')" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Tabs de Ajuda -->
            <div class="flex space-x-1 mb-6 bg-gray-800 p-1 rounded-lg">
                <button onclick="switchHelpTab('shortcuts')" id="help-tab-shortcuts" class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white">
                    Atalhos
                </button>
                <button onclick="switchHelpTab('features')" id="help-tab-features" class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors text-gray-400 hover:text-white">
                    Funcionalidades
                </button>
                <button onclick="switchHelpTab('tips')" id="help-tab-tips" class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors text-gray-400 hover:text-white">
                    Dicas
                </button>
                <button onclick="switchHelpTab('dev')" id="help-tab-dev" class="flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors text-gray-400 hover:text-white">
                    Dev
                </button>
            </div>

            <!-- Conteúdo dos Atalhos -->
            <div id="help-content-shortcuts" class="help-content">
                <h4 class="text-lg font-semibold text-blue-300 mb-4">⌨️ Atalhos de Teclado</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Salvar alterações</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Alt + S</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Novo personagem</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Alt + N</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Exportar personagem</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Alt + E</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Sistema de backup</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-orange-300 rounded text-sm font-mono">Alt + B</kbd>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Abrir ajuda</span>
                            <div class="flex space-x-1">
                                <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Alt + H</kbd>
                                <span class="themed-text-muted">ou</span>
                                <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">F1</kbd>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Fechar modal</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Esc</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Atalhos rápidos</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Alt + K</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Navegar entre abas</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Tab</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 themed-bg-surface-alt rounded-lg">
                            <span class="themed-text-base">Ativar elemento</span>
                            <kbd class="px-2 py-1 bg-gray-700 text-white rounded text-sm font-mono">Enter</kbd>
                        </div>
                    </div>
                </div>
                
                <!-- Nota sobre atalhos Alt -->
                <div class="mt-4 p-3 bg-amber-900/20 rounded-lg border border-amber-700/30">
                    <p class="text-sm text-amber-200">
                        <strong><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Por que Alt ao invés de Ctrl?</strong> Os atalhos usam <strong>Alt</strong> para evitar conflitos com atalhos do navegador. 
                        Por exemplo, Ctrl+N sempre abre uma nova aba, mas Alt+N funciona perfeitamente para criar novo personagem.
                    </p>
                </div>
                
                <!-- Seção específica para atalhos do resumo -->
                <div class="mt-6 p-4 themed-bg-surface rounded-lg border-l-4 border-violet-500">
                    <h5 class="text-lg font-semibold text-violet-300 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" clip-rule="evenodd"></path>
                        </svg>
                        Atalhos na Página de Resumo
                    </h5>
                    <p class="text-sm themed-text-muted mb-4">
                        Quando você gera o resumo de um personagem, uma nova janela é aberta com atalhos específicos para gerenciar PV e PM durante o jogo:
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex justify-between items-center p-3 bg-red-900/30 rounded-lg border border-red-700/50">
                            <span class="text-red-200">Diminuir PV</span>
                            <kbd class="px-2 py-1 bg-red-700 text-white rounded text-sm font-mono">Q</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-900/30 rounded-lg border border-green-700/50">
                            <span class="text-green-200">Aumentar PV</span>
                            <kbd class="px-2 py-1 bg-green-700 text-white rounded text-sm font-mono">W</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-900/30 rounded-lg border border-purple-700/50">
                            <span class="text-purple-200">Diminuir PM</span>
                            <kbd class="px-2 py-1 bg-purple-700 text-white rounded text-sm font-mono">A</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-900/30 rounded-lg border border-blue-700/50">
                            <span class="text-blue-200">Aumentar PM</span>
                            <kbd class="px-2 py-1 bg-blue-700 text-white rounded text-sm font-mono">S</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-emerald-900/30 rounded-lg border border-emerald-700/50">
                            <span class="text-emerald-200">Restaurar PV completo</span>
                            <kbd class="px-2 py-1 bg-emerald-700 text-white rounded text-sm font-mono">Ctrl + R</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-cyan-900/30 rounded-lg border border-cyan-700/50">
                            <span class="text-cyan-200">Restaurar PM completo</span>
                            <kbd class="px-2 py-1 bg-cyan-700 text-white rounded text-sm font-mono">Ctrl + M</kbd>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-amber-900/20 rounded-lg border border-amber-700/30">
                        <p class="text-sm text-amber-200">
                            <strong><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Dica:</strong> Os valores de PV/PM mudam de cor conforme a saúde do personagem:
                            <span class="text-green-400">Verde</span> (saudável) → 
                            <span class="text-yellow-400">Amarelo</span> (ferido) → 
                            <span class="text-red-400">Vermelho</span> (crítico) → 
                            <span class="text-gray-600">Preto</span> (inconsciente)
                        </p>
                    </div>
                </div>
                
                <!-- Seção específica para atalhos do modal de backup -->
                <div class="mt-6 p-4 themed-bg-surface rounded-lg border-l-4 border-orange-500">
                    <h5 class="text-lg font-semibold text-orange-300 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                        </svg>
                        💾 Atalhos do Modal de Backup
                    </h5>
                    <p class="text-sm themed-text-muted mb-4">
                        O modal de backup possui atalhos dedicados para agilizar as operações. Use <kbd class="px-1 py-0.5 bg-orange-700 text-white rounded text-xs">Alt+B</kbd> para abrir o modal.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex justify-between items-center p-3 bg-red-900/30 rounded-lg border border-red-700/50">
                            <span class="text-red-200">Fechar modal</span>
                            <kbd class="px-2 py-1 bg-red-700 text-white rounded text-sm font-mono">ESC</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-900/30 rounded-lg border border-green-700/50">
                            <span class="text-green-200">Criar backup manual</span>
                            <kbd class="px-2 py-1 bg-green-700 text-white rounded text-sm font-mono">Alt + B</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-900/30 rounded-lg border border-blue-700/50">
                            <span class="text-blue-200">Download backup</span>
                            <kbd class="px-2 py-1 bg-blue-700 text-white rounded text-sm font-mono">Alt + D</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-900/30 rounded-lg border border-purple-700/50">
                            <span class="text-purple-200">Listar backups</span>
                            <kbd class="px-2 py-1 bg-purple-700 text-white rounded text-sm font-mono">Alt + L</kbd>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-orange-900/20 rounded-lg border border-orange-700/30">
                        <p class="text-sm text-orange-200">
                            <strong>🔄 Fluxo Recomendado:</strong> 
                            <kbd class="px-1 py-0.5 bg-orange-700 text-white rounded text-xs">Alt+B</kbd> (abrir) → 
                            <kbd class="px-1 py-0.5 bg-green-700 text-white rounded text-xs">Alt+B</kbd> (backup) → 
                            <kbd class="px-1 py-0.5 bg-blue-700 text-white rounded text-xs">Alt+D</kbd> (download) → 
                            <kbd class="px-1 py-0.5 bg-red-700 text-white rounded text-xs">ESC</kbd> (fechar)
                        </p>
                    </div>
                </div>
                
                <div class="pb-6"></div> <!-- Padding inferior para garantir visibilidade completa -->
            </div>

            <!-- Conteúdo das Funcionalidades -->
            <div id="help-content-features" class="help-content hidden">
                <h4 class="text-lg font-semibold text-blue-300 mb-4">🚀 Funcionalidades do Sistema</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Gerenciamento de Personagens -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg">
                        <h5 class="font-semibold text-green-400 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                            </svg>
                            Fichas de Personagem
                        </h5>
                        <ul class="text-sm themed-text-muted space-y-1">
                            <li>• Criação e edição completa de fichas</li>
                            <li>• Cálculos automáticos de CA, ataques e resistências</li>
                            <li>• Import/Export de personagens (JSON)</li>
                            <li>• Geração de resumo para combate</li>
                            <li>• Auto-save inteligente e backup automático</li>
                        </ul>
                    </div>

                    <!-- Magias e Talentos -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg">
                        <h5 class="font-semibold text-purple-400 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"></path>
                            </svg>
                            Magias e Talentos
                        </h5>
                        <ul class="text-sm themed-text-muted space-y-1">
                            <li>• Biblioteca de magias com sistema CRUD</li>
                            <li>• Biblioteca de talentos com 12 tipos do Tormenta</li>
                            <li>• Biblioteca de raças com dados oficiais do Tormenta</li>
                            <li>• Sistema de origem para cálculo de pontos</li>
                            <li>• Busca por nome e filtros por categoria</li>
                            <li>• Ferramenta colaborativa externa para talentos</li>
                        </ul>
                    </div>

                    <!-- Sistema de Backup -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-2 border-orange-500/30">
                        <h5 class="font-semibold text-orange-400 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                            </svg>
                            Sistema de Backup
                        </h5>
                        <ul class="text-sm themed-text-muted space-y-1">
                            <li>• Modal dedicado com botão BKP no header</li>
                            <li>• Backup manual sob demanda</li>
                            <li>• Download direto para o computador</li>
                            <li>• Restauração a partir de backups locais ou arquivo</li>
                            <li>• Atalhos: Alt+B (abrir/criar), Alt+D (download)</li>
                        </ul>
                    </div>

                    <!-- Combate e Resumo -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg">
                        <h5 class="font-semibold text-red-400 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Ferramentas de Combate
                        </h5>
                        <ul class="text-sm themed-text-muted space-y-1">
                            <li>• Janela de resumo otimizada para combate</li>
                            <li>• Gerenciamento visual de PV/PM com cores</li>
                            <li>• Atalhos de teclado (Q/W para PV, A/S para PM)</li>
                            <li>• Sincronização automática entre resumo e ficha</li>
                            <li>• Restauração rápida com Ctrl+R/M</li>
                        </ul>
                    </div>

                    <!-- Interface e Usabilidade -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg">
                        <h5 class="font-semibold text-cyan-400 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"></path>
                            </svg>
                            Interface e Experiência
                        </h5>
                        <ul class="text-sm themed-text-muted space-y-1">
                            <li>• Design responsivo para dispositivos móveis</li>
                            <li>• 8 temas visuais baseados em psicologia das cores</li>
                            <li>• Central de ajuda interativa (F1) com atalhos</li>
                            <li>• Notificações visuais e feedback em tempo real</li>
                            <li>• Navegação por atalhos de teclado otimizada</li>
                        </ul>
                    </div>

                    <!-- Ferramentas Auxiliares -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg">
                        <h5 class="font-semibold text-yellow-400 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                            </svg>
                            Utilitários Extras
                        </h5>
                        <ul class="text-sm themed-text-muted space-y-1">
                            <li>• Calculadora de moedas automática</li>
                            <li>• Sistema de anotações e gestão de NPCs</li>
                            <li>• Histórico completo do personagem</li>
                            <li>• Sistema de logs para desenvolvimento</li>
                            <li>• Ferramentas de diagnóstico integradas</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Nota sobre funcionalidades -->
                <div class="mt-6 p-4 bg-blue-900/20 rounded-lg border border-blue-700/30">
                    <p class="text-sm text-blue-200">
                        <strong><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Funcionalidades em constante evolução:</strong> O sistema é atualizado regularmente com novas 
                        funcionalidades e melhorias. Confira o registro de mudanças na aba "Dev" para ver as últimas implementações.
                    </p>
                </div>
            </div>

            <!-- Conteúdo das Dicas -->
            <div id="help-content-tips" class="help-content hidden">
                <h4 class="text-lg font-semibold text-blue-300 mb-4"><span class="inline-flex items-center justify-center w-5 h-5 bg-blue-500 text-white rounded-full text-sm mr-2">ℹ</span>Dicas e Truques</h4>
                <div class="space-y-4">
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-green-500">
                        <h5 class="font-semibold text-green-400 mb-2">💾 Backup de Segurança</h5>
                        <p class="text-sm themed-text-muted">
                            <span id="help-backup-text">O sistema cria backups automáticos a cada X minutos.</span> Você pode exportar seus personagens 
                            regularmente para ter uma cópia de segurança local.
                        </p>
                    </div>

                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-blue-500">
                        <h5 class="font-semibold text-blue-400 mb-2">🔍 Busca por Nome</h5>
                        <p class="text-sm themed-text-muted">
                            Use a busca nas abas de Magias e Talentos para encontrar rapidamente itens por nome. 
                            A busca é simples e direta, ideal para localizar magias e talentos específicos.
                        </p>
                    </div>

                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-purple-500">
                        <h5 class="font-semibold text-purple-400 mb-2">🎨 Temas Disponíveis</h5>
                        <p class="text-sm themed-text-muted mb-3">
                            Experimente os diferentes temas clicando no botão de tema no topo da página. 
                            Cada tema foi criado com base na psicologia das cores para diferentes ambientes de jogo:
                        </p>
                        <ul class="text-xs themed-text-muted space-y-1 ml-4">
                            <li>• <span class="text-gray-400">Padrão</span> - Interface clássica e equilibrada</li>
                            <li>• <span class="text-gray-200">Claro</span> - Para ambientes bem iluminados</li>
                            <li>• <span class="text-green-400">Floresta</span> - Conectado com a natureza</li>
                            <li>• <span class="text-red-400">Dragão Vermelho</span> - Energia e paixão para combates épicos</li>
                            <li>• <span class="text-blue-400">Oceano Profundo</span> - Calma e mistério das águas</li>
                            <li>• <span class="text-pink-400">Aurora Élfica</span> - Elegância e magia arcana</li>
                            <li>• <span class="text-orange-400">Forja Anã</span> - Força e tradição das montanhas</li>
                            <li>• <span class="text-purple-400">Noite Sombria</span> - Foco e introspecção</li>
                        </ul>
                    </div>

                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-yellow-500">
                        <h5 class="font-semibold text-yellow-400 mb-2">📱 Responsividade</h5>
                        <p class="text-sm themed-text-muted">
                            O sistema funciona perfeitamente em tablets e celulares. Todas as funcionalidades 
                            estão disponíveis em qualquer dispositivo.
                        </p>
                    </div>

                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-cyan-500">
                        <h5 class="font-semibold text-cyan-400 mb-2">⚔️ Gerenciamento de Combate</h5>
                        <p class="text-sm themed-text-muted">
                            Use o resumo do personagem durante combates! Clique em "Gerar Resumo" para abrir uma janela 
                            com controles rápidos de PV/PM. Os atalhos Q/W/A/S permitem ajustar valores rapidamente, 
                            e as cores mudam automaticamente para indicar o estado do personagem.
                        </p>
                        <div class="mt-2 p-2 bg-gray-800 rounded border-l-2 border-purple-400">
                            <p class="text-xs text-purple-300 font-medium"><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Novo: Pressione <kbd class="px-1 py-0.5 bg-gray-700 text-purple-300 rounded text-xs">F1</kbd> na janela do resumo para ver os atalhos específicos!</p>
                        </div>
                    </div>

                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-red-500">
                        <h5 class="font-semibold text-red-400 mb-2">⚡ Performance</h5>
                        <p class="text-sm themed-text-muted">
                            Para melhor performance, evite ter muitas abas do navegador abertas simultaneamente 
                            e mantenha seu navegador atualizado.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Conteúdo do Desenvolvimento -->
            <div id="help-content-dev" class="help-content hidden">
                <h4 class="text-lg font-semibold text-blue-300 mb-4">🛠️ Ferramentas de Desenvolvimento</h4>
                
                <!-- Sistema de Versioning -->
                <div class="space-y-4">
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-green-500">
                        <h5 class="font-semibold text-green-400 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-1.757l4.9-4.9a2 2 0 000-2.828L13.485 5.1a2 2 0 00-2.828 0L10 5.757v8.486zM16 18H9.071l6-6H16a2 2 0 012 2v2a2 2 0 01-2 2z" clip-rule="evenodd"></path>
                            </svg>
                            🏷️ Sistema de Versioning Centralizado
                        </h5>
                        <div class="text-sm themed-text-muted space-y-3">
                            <p class="font-medium text-white">Versão Atual: <span id="help-current-version" class="text-green-400 font-mono">3.14.0.9</span></p>
                            
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-blue-400">
                                <p class="font-medium text-blue-300 mb-2">📝 Como Atualizar a Versão:</p>
                                <div class="space-y-2 text-xs">
                                    <div class="flex items-start space-x-2">
                                        <span class="text-yellow-400 font-bold">1.</span>
                                        <div>
                                            <span class="text-gray-300">Diretamente no CONFIG:</span>
                                            <code class="block mt-1 bg-gray-900 px-2 py-1 rounded text-green-400 font-mono">CONFIG.VERSION = "3.13.0.0"</code>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <span class="text-yellow-400 font-bold">2.</span>
                                        <div>
                                            <span class="text-gray-300">Via VersionManager:</span>
                                            <code class="block mt-1 bg-gray-900 px-2 py-1 rounded text-green-400 font-mono">VersionManager.setVersion("3.13.0.0")</code>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-2">
                                        <span class="text-yellow-400 font-bold">3.</span>
                                        <div>
                                            <span class="text-gray-300">Via Console (recomendado):</span>
                                            <code class="block mt-1 bg-gray-900 px-2 py-1 rounded text-green-400 font-mono">updateSystemVersion("3.13.0.0")</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-purple-400">
                                <p class="font-medium text-purple-300 mb-2">🔍 Comandos de Console Disponíveis:</p>
                                <div class="space-y-1 text-xs">
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-cyan-400 font-mono">getCurrentVersion()</code>
                                        <span class="text-gray-400 ml-2">- Mostra versão atual</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-cyan-400 font-mono">updateSystemVersion("x.y.z.w")</code>
                                        <span class="text-gray-400 ml-2">- Atualiza versão</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-amber-400">
                                <p class="font-medium text-amber-300 mb-2">⚙️ Atualização Automática:</p>
                                <ul class="text-xs space-y-1 text-gray-300">
                                    <li>• Header principal (elemento <code class="text-cyan-400">#header-version</code>)</li>
                                    <li>• Modal de ajuda (elemento <code class="text-cyan-400">#modal-version</code>)</li>
                                    <li>• Esta página de ajuda (elemento <code class="text-cyan-400">#help-current-version</code>)</li>
                                    <li>• Metadados de novos personagens (<code class="text-cyan-400">CharacterManager</code>)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sistema de Backup de Arquivos -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-orange-500">
                        <h5 class="font-semibold text-orange-400 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            💾 Sistema de Backup de Arquivos
                        </h5>
                        <div class="text-sm themed-text-muted space-y-3">
                            <p class="font-medium text-white">Mantém as 2 últimas versões do arquivo automaticamente</p>
                            
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-green-400">
                                <p class="font-medium text-green-300 mb-2">🛡️ Comandos de Backup:</p>
                                <div class="space-y-1 text-xs">
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-green-400 font-mono">FileBackupManager.createBackup("motivo")</code>
                                        <span class="text-gray-400 ml-2">- Criar backup manual</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-blue-400 font-mono">FileBackupManager.getBackupList()</code>
                                        <span class="text-gray-400 ml-2">- Listar backups</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-purple-400 font-mono">FileBackupManager.downloadBackup("timestamp")</code>
                                        <span class="text-gray-400 ml-2">- Baixar backup</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-cyan-400 font-mono">FileBackupManager.restoreBackup("timestamp")</code>
                                        <span class="text-gray-400 ml-2">- Restaurar backup</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-blue-400">
                                <p class="font-medium text-blue-300 mb-2">📊 Estatísticas:</p>
                                <div class="space-y-1 text-xs">
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-cyan-400 font-mono">FileBackupManager.getBackupStats()</code>
                                        <span class="text-gray-400 ml-2">- Ver estatísticas</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-red-400 font-mono">FileBackupManager.clearAllBackups()</code>
                                        <span class="text-gray-400 ml-2">- Limpar todos</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-yellow-400">
                                <p class="font-medium text-yellow-300 mb-2">🎯 Funcionalidades Principais:</p>
                                <ul class="text-xs space-y-1 text-gray-300">
                                    <li>• Backup automático antes de modificações importantes</li>
                                    <li>• Mantém apenas as 2 versões mais recentes</li>
                                    <li>• Download de backups em formato HTML</li>
                                    <li>• Restauração em nova janela para comparação</li>
                                    <li>• Limpeza automática de backups antigos</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sistema de Logs e Erros -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-red-500">
                        <h5 class="font-semibold text-red-400 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                🐛 Monitor de Logs e Erros
                            </div>
                            <button onclick="updateLogStats()" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs transition-colors">
                                🔄 Atualizar
                            </button>
                        </h5>
                        
                        <div class="text-sm themed-text-muted space-y-3">
                            <!-- Estatísticas dos Logs -->
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-cyan-400">
                                <p class="font-medium text-cyan-300 mb-2">📊 Estatísticas em Tempo Real:</p>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div>
                                        <span class="text-gray-300">Total de logs:</span>
                                        <span id="log-stats-total" class="text-white font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-red-300">Erros:</span>
                                        <span id="log-stats-errors" class="text-red-400 font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-yellow-300">Warnings:</span>
                                        <span id="log-stats-warnings" class="text-yellow-400 font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-blue-300">Performance:</span>
                                        <span id="log-stats-performance" class="text-blue-400 font-mono ml-1">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ações de Gerenciamento -->
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-green-400">
                                <p class="font-medium text-green-300 mb-2">🎮 Ações Disponíveis:</p>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="showSystemLogs()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-colors">
                                        📋 Ver Logs
                                    </button>
                                    <button onclick="exportSystemLogs()" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs transition-colors">
                                        💾 Exportar
                                    </button>
                                    <button onclick="clearSystemLogs()" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs transition-colors">
                                        🗑️ Limpar
                                    </button>
                                    <button onclick="testErrorLogging()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors">
                                        🧪 Teste
                                    </button>
                                    <button onclick="diagnoseBackupSystems()" class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-xs transition-colors">
                                        🔍 Diagnóstico Backup
                                    </button>
                                    <button onclick="openAuditModal()" class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-xs transition-colors" title="Sistema de Diagnóstico">
                                        🔍 Diagnóstico
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Comandos de Console -->
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-purple-400">
                                <p class="font-medium text-purple-300 mb-2">💻 Comandos de Console Melhorados:</p>
                                <div class="space-y-1 text-xs">
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-cyan-400 font-mono">Logger.getLogs()</code>
                                        <span class="text-gray-400 ml-2">- Obter todos os logs</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-green-400 font-mono">Logger.getLogStats()</code>
                                        <span class="text-gray-400 ml-2">- Ver estatísticas detalhadas ✨</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-purple-400 font-mono">Logger.character('info', 'mensagem')</code>
                                        <span class="text-gray-400 ml-2">- Log específico para personagem ✨</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-yellow-400 font-mono">Logger.warn('mensagem', dados, 'contexto')</code>
                                        <span class="text-gray-400 ml-2">- Novo método warn ✨</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-blue-400 font-mono">Logger.exportLogs()</code>
                                        <span class="text-gray-400 ml-2">- Exportar logs</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-red-400 font-mono">Logger.clearLogs()</code>
                                        <span class="text-gray-400 ml-2">- Limpar logs</span>
                                    </div>
                                    <div>
                                        <code class="bg-gray-900 px-2 py-1 rounded text-orange-400 font-mono">diagnoseBackupSystems()</code>
                                        <span class="text-gray-400 ml-2">- Diagnóstico de backup</span>
                                    </div>
                                </div>
                                <div class="mt-2 p-2 bg-green-900/30 rounded text-xs">
                                    <span class="text-green-300 font-semibold">✨ Novos métodos por categoria:</span><br>
                                    <code class="text-cyan-400">Logger.library()</code>, 
                                    <code class="text-cyan-400">Logger.storage()</code>, 
                                    <code class="text-cyan-400">Logger.ui()</code>, 
                                    <code class="text-cyan-400">Logger.pagination()</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monitor de Logs em Tempo Real -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-green-500">
                        <h5 class="font-semibold text-green-400 mb-3 flex items-center justify-between">
                            📊 Monitor de Logs em Tempo Real
                            <button onclick="Logger.updateLogStats()" class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs transition-colors">
                                🔄 Atualizar
                            </button>
                        </h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                            <div class="bg-gray-800 p-2 rounded border-l-2 border-blue-400">
                                <div class="text-blue-300 font-semibold">📋 Total</div>
                                <div id="log-stats-total" class="text-xl text-white font-mono">0</div>
                            </div>
                            <div class="bg-gray-800 p-2 rounded border-l-2 border-red-400">
                                <div class="text-red-300 font-semibold">🚨 Erros</div>
                                <div id="log-stats-errors" class="text-xl text-white font-mono">0</div>
                            </div>
                            <div class="bg-gray-800 p-2 rounded border-l-2 border-yellow-400">
                                <div class="text-yellow-300 font-semibold">⚠️ Avisos</div>
                                <div id="log-stats-warnings" class="text-xl text-white font-mono">0</div>
                            </div>
                            <div class="bg-gray-800 p-2 rounded border-l-2 border-purple-400">
                                <div class="text-purple-300 font-semibold">⚡ Performance</div>
                                <div id="log-stats-performance" class="text-xl text-white font-mono">0</div>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            💡 <strong>Dica:</strong> Use <code class="text-cyan-400">Logger.getLogStats()</code> no console para ver estatísticas detalhadas
                        </div>
                    </div>
                    
                    <!-- Outras Ferramentas de Dev -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-blue-500">
                        <h5 class="font-semibold text-blue-400 mb-2">📊 Monitoramento e Debug</h5>
                        <div class="text-sm themed-text-muted space-y-2">
                            <p>O sistema possui ferramentas de monitoramento integradas:</p>
                            <ul class="text-xs space-y-1 ml-4">
                                <li>• Sistema de logs estruturado (<code class="text-cyan-400">Logger</code>) ✨ <span class="text-green-400">MELHORADO</span></li>
                                <li>• Monitoramento de performance automático</li>
                                <li>• Tratamento centralizado de erros</li>
                                <li>• Cache inteligente e otimizações</li>
                                <li>• <span class="text-green-400">NOVO:</span> Logs categorizados por contexto</li>
                                <li>• <span class="text-green-400">NOVO:</span> Estatísticas em tempo real</li>
                                <li>• <span class="text-green-400">NOVO:</span> Interface melhorada com filtros</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Sistema de Gestão de Funcionalidades -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-blue-500">
                        <h5 class="font-semibold text-blue-400 mb-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                🚀 Gestão de Funcionalidades e Melhorias
                            </div>
                            <button onclick="openFeatureManagerModal()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-colors">
                                📋 Abrir Gestor
                            </button>
                        </h5>
                        
                        <div class="text-sm themed-text-muted space-y-3">
                            <p class="font-medium text-white">Sistema completo de gestão de funcionalidades com metodologia ágil</p>
                            
                            <!-- Estatísticas em Tempo Real -->
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-cyan-400">
                                <p class="font-medium text-cyan-300 mb-2">📊 Status Atual das Funcionalidades:</p>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div>
                                        <span class="text-gray-300">Total:</span>
                                        <span id="feature-stats-total" class="text-white font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-green-300">Implementadas:</span>
                                        <span id="feature-stats-implemented" class="text-green-400 font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-yellow-300">Em Desenvolvimento:</span>
                                        <span id="feature-stats-development" class="text-yellow-400 font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-blue-300">Backlog:</span>
                                        <span id="feature-stats-backlog" class="text-blue-400 font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-purple-300">Em Análise:</span>
                                        <span id="feature-stats-analysis" class="text-purple-400 font-mono ml-1">0</span>
                                    </div>
                                    <div>
                                        <span class="text-emerald-300">Aprovada:</span>
                                        <span id="feature-stats-approved" class="text-emerald-400 font-mono ml-1">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Funcionalidades Principais -->
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-green-400">
                                <p class="font-medium text-green-300 mb-2">🎯 Funcionalidades Principais:</p>
                                <ul class="text-xs space-y-1 text-gray-300">
                                    <li>• Sistema Kanban com 10 status (Backlog → Implementada)</li>
                                    <li>• Priorização: Crítica, Alta, Média, Baixa</li>
                                    <li>• Categorias: Bug, Feature, Melhoria, Performance, etc.</li>
                                    <li>• Estimativa de esforço e rastreabilidade completa</li>
                                    <li>• Dashboard com métricas e filtros avançados</li>
                                    <li>• Export/Import de roadmaps e relatórios</li>
                                </ul>
                            </div>
                            
                            <!-- Ações Rápidas -->
                            <div class="bg-gray-800 p-3 rounded border-l-2 border-purple-400">
                                <p class="font-medium text-purple-300 mb-2">⚡ Ações Rápidas:</p>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="openFeatureManagerModal('kanban')" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors">
                                        📋 Kanban
                                    </button>
                                    <button onclick="openFeatureManagerModal('add')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs transition-colors">
                                        ➕ Nova
                                    </button>
                                    <button onclick="openFeatureManagerModal('dashboard')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-colors">
                                        📊 Dashboard
                                    </button>
                                    <button onclick="exportFeatureRoadmap()" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs transition-colors">
                                        📁 Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-red-500">
                        <h5 class="font-semibold text-red-400 mb-2">⚠️ Aviso para Desenvolvedores</h5>
                        <p class="text-sm themed-text-muted">
                            Esta aba contém ferramentas avançadas. Use apenas se você souber o que está fazendo. 
                            Alterações incorretas podem afetar o funcionamento do sistema.
                        </p>
                    </div>
                    
                    <!-- Registro de Mudanças -->
                    <div class="themed-bg-surface-alt p-4 rounded-lg border-l-4 border-emerald-500">
                        <h5 class="font-semibold text-emerald-400 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            📋 Registro de Mudanças
                        </h5>
                        
                        <div class="bg-gray-900 rounded-lg border border-gray-700 max-h-96 overflow-y-auto">
                            <div class="p-4 space-y-4 text-sm">
                                
                                <!-- Outubro 2025 - Versão 3.14 - Sistema de Modais Avançado -->
                                <div class="border-l-2 border-blue-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-blue-400">� Sistema de Modais Avançado v3.14.0.7</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <div class="space-y-3">
                                        <!-- Sistema de ESC Global -->
                                        <div class="bg-gray-800 rounded p-3">
                                            <h7 class="font-medium text-green-400 text-sm">⌨️ Sistema Global de Fechamento com ESC</h7>
                                            <ul class="space-y-1 text-xs text-gray-300 ml-2 mt-1">
                                                <li>• Fechamento universal com tecla ESC para TODOS os modais</li>
                                                <li>• Mapeamento inteligente de 20+ modais com funções específicas</li>
                                                <li>• Sistema de fallback robusto para modais não mapeados</li>
                                                <li>• Ordem LIFO (Last In, First Out) - último aberto fecha primeiro</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Sistema de Exportação -->
                                        <div class="bg-gray-800 rounded p-3">
                                            <h7 class="font-medium text-purple-400 text-sm">📤 Sistema de Exportação Ficha → Biblioteca</h7>
                                            <ul class="space-y-1 text-xs text-gray-300 ml-2 mt-1">
                                                <li>• Botões discretos nas abas de Magias e Talentos</li>
                                                <li>• Exportação de magias cadastradas na ficha para biblioteca</li>
                                                <li>• Exportação de talentos cadastrados na ficha para biblioteca</li>
                                                <li>• Verificação de duplicatas com relatório detalhado</li>
                                                <li>• Mapeamento inteligente de categorias entre sistemas</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Sistema de Diagnóstico -->
                                        <div class="bg-gray-800 rounded p-3">
                                            <h7 class="font-medium text-yellow-400 text-sm">🔍 Modal de Diagnóstico Visual</h7>
                                            <ul class="space-y-1 text-xs text-gray-300 ml-2 mt-1">
                                                <li>• Interface visual amigável para diagnósticos (substitui console)</li>
                                                <li>• Log colorido com diferentes tipos de mensagem</li>
                                                <li>• Análise completa dos sistemas de backup</li>
                                                <li>• Modal arrastável integrado ao sistema centralizado</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Janelas Arrastáveis -->
                                        <div class="bg-gray-800 rounded p-3">
                                            <h7 class="font-medium text-cyan-400 text-sm">🌐 Sistema Centralizado de Janelas Arrastáveis</h7>
                                            <ul class="space-y-1 text-xs text-gray-300 ml-2 mt-1">
                                                <li>• Sistema centralizado aplicado a TODOS os modais (22+)</li>
                                                <li>• Auto-detecção inteligente de novos modais</li>
                                                <li>• Suporte a múltiplos padrões de estrutura</li>
                                                <li>• Performance otimizada e funcionalidade estável</li>
                                            </ul>
                                        </div>
                                        
                                        <!-- Correções e Melhorias -->
                                        <div class="bg-gray-800 rounded p-3">
                                            <h7 class="font-medium text-red-400 text-sm">� Correções e Melhorias</h7>
                                            <ul class="space-y-1 text-xs text-gray-300 ml-2 mt-1">
                                                <li>• Corrigido erro "HelpModal is not defined"</li>
                                                <li>• Mapeamento correto de funções de fechamento</li>
                                                <li>• Sistema de fallback com múltiplas camadas</li>
                                                <li>• Integração perfeita com pilha existente do ModalManager</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Sistema centralizado aplicado a TODOS os modais do sistema (22+ modais)</li>
                                        <li>✅ Auto-detecção inteligente de novos modais adicionados no futuro</li>
                                        <li>✅ Suporte a múltiplos padrões de estrutura de modal</li>
                                        <li>✅ Detecção automática de diferentes tipos de cabeçalho</li>
                                        <li>✅ Proteção contra arrastar em inputs, botões e controles</li>
                                        <li>✅ Margem de segurança para evitar modais fora da tela</li>
                                        <li>✅ Feedback visual melhorado durante o arraste</li>
                                        <li>✅ Z-index inteligente para manter modal no topo</li>
                                        <li>✅ Console logging para debug e monitoramento</li>
                                        <li>✅ Compatibilidade com modais: create, confirm, enhancement, currency-converter</li>
                                        <li>✅ Suporte para: edit-spell, edit-talent, edit-equipment, edit-npc, edit-note</li>
                                        <li>✅ Funcionamento em: help, shortcuts, backup, restore, libraries</li>
                                        <li>✅ Reset de posição aprimorado para qualquer modal</li>
                                    </ul>
                                </div>
                                
                                <!-- Outubro 2025 - Sistema de Janelas Arrastáveis Otimizado -->
                                <div class="border-l-2 border-purple-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-purple-400">🎯 Sistema de Janelas Arrastáveis Otimizado v3.14.0.2</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Reimplementado sistema de janelas arrastáveis baseado no sistRecados.html</li>
                                        <li>✅ Sistema simplificado usando position absolute e eventos mouse</li>
                                        <li>✅ Melhor performance e responsividade</li>
                                        <li>✅ Limitação automática dentro da área visível da tela</li>
                                        <li>✅ Feedback visual aprimorado no cabeçalho dos modais</li>
                                        <li>✅ Código mais limpo e manutenível</li>
                                        <li>✅ Removido sistema de redimensionamento complexo</li>
                                        <li>✅ Mantida compatibilidade com todas funcionalidades existentes</li>
                                    </ul>
                                </div>
                                
                                <!-- Outubro 2025 - Melhorias e Sistema de Janelas Arrastáveis -->
                                <div class="border-l-2 border-green-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-green-400">🖱️ Sistema de Janelas Arrastáveis v3.14.0.1</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Implementado sistema completo de janelas arrastáveis</li>
                                        <li>✅ Modais podem ser movidos clicando e arrastando pelo cabeçalho</li>
                                        <li>✅ Sistema de redimensionamento com handle no canto inferior direito</li>
                                        <li>✅ Reset automático de posição ao reabrir modais</li>
                                        <li>✅ Suporte para múltiplas janelas abertas simultaneamente</li>
                                        <li>✅ Corrigido bug do botão "Editar" no modal de detalhes Kanban</li>
                                        <li>✅ Melhorado modal de seleção de status com scroll interno</li>
                                        <li>✅ Adicionado estatísticas "Em Análise" e "Aprovada" na Central de Ajuda</li>
                                        <li>✅ Implementado sistema dinâmico de versionamento</li>
                                        <li>✅ Corrigido problema de versões duplicadas no rodapé</li>
                                        <li>✅ Novo formato de versionamento incremental (x.y.z.w)</li>
                                        <li>✅ Z-index otimizado para sobreposição correta de modais</li>
                                        <li>✅ Visual feedback melhorado para ações de arrastar</li>
                                        <li>✅ Compatibilidade mantida com todas funcionalidades existentes</li>
                                    </ul>
                                </div>
                                
                                <!-- Outubro 2025 - Sistema de Gestão de Funcionalidades -->
                                <div class="border-l-2 border-blue-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-blue-400">🚀 Sistema de Gestão de Funcionalidades v3.14.0.0</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Modal dedicado para gestão de desenvolvimento</li>
                                        <li>✅ Kanban Board com 5 colunas de status</li>
                                        <li>✅ Sistema CRUD completo para funcionalidades</li>
                                        <li>✅ Dashboard com métricas e estatísticas</li>
                                        <li>✅ Lista detalhada com filtros avançados</li>
                                        <li>✅ 10 status de workflow: Backlog → Implementada</li>
                                        <li>✅ Campos: título, descrição, prioridade, categoria, módulo</li>
                                        <li>✅ Sistema de prioridades (Crítica, Alta, Média, Baixa)</li>
                                        <li>✅ Categorias: Feature, Bug, Melhoria, Refatoração, etc.</li>
                                        <li>✅ Estimativa de esforço (Pequeno, Médio, Grande, Épico)</li>
                                        <li>✅ Integração com NotificationManager para feedback</li>
                                        <li>✅ Export/Import de funcionalidades em JSON</li>
                                        <li>✅ Dados de exemplo pré-carregados</li>
                                        <li>✅ Interface integrada na central de ajuda dev</li>
                                        <li>✅ Exposição global de funções para compatibilidade</li>
                                    </ul>
                                </div>
                                
                                <!-- Outubro 2025 - Biblioteca de Raças -->
                                <div class="border-l-2 border-orange-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-orange-400">🧬 Biblioteca de Raças v3.13.0.0</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Modal dedicado para gerenciamento de raças</li>
                                        <li>✅ 8 raças oficiais pré-cadastradas (Anão, Elfo, Humano, etc.)</li>
                                        <li>✅ Sistema CRUD completo: criar, editar, excluir raças</li>
                                        <li>✅ Ajustes de habilidades por raça (FOR, DES, CON, INT, SAB, CAR)</li>
                                        <li>✅ Campos: nome, tamanho, deslocamento, traços raciais</li>
                                        <li>✅ Import/Export de bibliotecas JSON</li>
                                        <li>✅ Sistema de busca por nome, tamanho, traços</li>
                                        <li>✅ Interface integrada ao padrão das outras bibliotecas</li>
                                        <li>✅ Correção: exibição de habilidades em português (FOR/DES/etc.)</li>
                                    </ul>
                                </div>
                                
                                <!-- Outubro 2025 - Versão 3.12.0.0 -->
                                <div class="border-l-2 border-emerald-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-emerald-400">🔧 Sistema de Backup Unificado v3.12.0.0</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Modal dedicado de backup com botão BKP no header</li>
                                        <li>✅ Unificação dos sistemas: manual + automático</li>
                                        <li>✅ Restauração melhorada: 2 locais + arquivo externo</li>
                                        <li>✅ Correção Logger.info() - TypeError resolvido</li>
                                        <li>✅ Diagnóstico de backup com botões funcionais</li>
                                        <li>✅ Atalhos dedicados: Alt+B, Alt+D, Alt+L, ESC</li>
                                    </ul>
                                </div>
                                
                                <!-- Sistema de Talentos Completo -->
                                <div class="border-l-2 border-purple-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-purple-400">🏆 Sistema de Talentos Completo</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Biblioteca principal integrada com CRUD completo</li>
                                        <li>✅ Sistema de origem para cálculo automático de pontos</li>
                                        <li>✅ 12 tipos oficiais do Tormenta RPG com cores específicas</li>
                                        <li>✅ Ferramenta colaborativa externa (cadastro-talentos-colaborativo.html)</li>
                                        <li>✅ Import/Export, busca por nome e filtros por categoria</li>
                                    </ul>
                                </div>
                                
                                <!-- Melhorias na Interface -->
                                <div class="border-l-2 border-cyan-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-cyan-400">🎨 Melhorias de Interface e UX</h6>
                                        <span class="text-xs text-gray-400">Out 2025</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Central de ajuda atualizada com funcionalidades reais</li>
                                        <li>✅ Correção de botões duplicados no header</li>
                                        <li>✅ Feedback visual aprimorado para todas as ações</li>
                                        <li>✅ Design responsivo otimizado para dispositivos móveis</li>
                                        <li>✅ Atalhos de teclado melhorados e documentados</li>
                                    </ul>
                                </div>
                                
                                <!-- Funcionalidades Base Consolidadas -->
                                <div class="border-l-2 border-gray-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-gray-400">⚙️ Base Consolidada</h6>
                                        <span class="text-xs text-gray-400">Implementações anteriores</span>
                                    </div>
                                    <ul class="space-y-1 text-xs text-gray-300 ml-2">
                                        <li>✅ Gerenciamento completo de fichas Tormenta RPG</li>
                                        <li>✅ Biblioteca de magias com sistema CRUD</li>
                                        <li>✅ Janela de resumo otimizada para combate</li>
                                        <li>✅ Sistema de versionamento centralizado</li>
                                        <li>✅ 8 temas visuais baseados em psicologia das cores</li>
                                        <li>✅ Auto-save e persistência local com localStorage</li>
                                        <li>✅ Sistema de logs estruturado para desenvolvimento</li>
                                    </ul>
                                </div>
                                
                                <!-- Estatísticas Atuais -->
                                <div class="border-l-2 border-blue-400 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-blue-400">📊 Status Atual do Sistema</h6>
                                        <span class="text-xs text-gray-400">Estado funcional</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-300">
                                        <div>Arquivos principais: <span class="text-white font-mono">4</span></div>
                                        <div>Modais funcionais: <span class="text-white font-mono">8+</span></div>
                                        <div>Tipos de talentos: <span class="text-white font-mono">12</span></div>
                                        <div>Sistemas de backup: <span class="text-white font-mono">Unificado</span></div>
                                        <div>Compatibilidade mobile: <span class="text-green-400 font-mono">✅</span></div>
                                        <div>Ferramentas CRUD: <span class="text-green-400 font-mono">100%</span></div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-400 italic text-center">
                            <span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Este registro mantém o histórico completo de todas as modificações e implementações realizadas no sistema
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t themed-border text-center">
                <p class="text-sm themed-text-muted">
                    Sistema de Gerenciamento de Fichas Tormenta RPG v<span id="modal-version"></span><br>
                    Desenvolvido por <span class="themed-text-primary">Sorentto (Biribinha)</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Diagnóstico do Sistema -->
    <div id="audit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print">
        <div class="bg-gray-900 text-white p-6 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <!-- Header do modal -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-orange-400 flex items-center">
                    🔍 Sistema de Diagnóstico e Manutenção
                </h3>
                <button onclick="closeModal('audit-modal')" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    ×
                </button>
            </div>

            <!-- Abas do sistema de auditoria -->
            <div class="flex border-b border-gray-700 mb-4">
                <button id="audit-tab-validation" onclick="switchAuditTab('validation')" class="px-4 py-2 text-orange-400 border-b-2 border-orange-400 font-semibold">
                    Validação de IDs
                </button>
                <button id="audit-tab-logs" onclick="switchAuditTab('logs')" class="px-4 py-2 text-gray-400 hover:text-white border-b-2 border-transparent">
                    Logs do Sistema
                </button>
                <button id="audit-tab-force" onclick="switchAuditTab('force')" class="px-4 py-2 text-gray-400 hover:text-white border-b-2 border-transparent">
                    Remoção Forçada
                </button>
            </div>

            <!-- Conteúdo das abas -->
            <div class="overflow-y-auto max-h-[60vh]">
                <!-- Aba de Validação de IDs -->
                <div id="audit-content-validation" class="audit-tab-content">
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-orange-300 mb-2">🔧 Validação e Correção de IDs</h4>
                        <p class="text-gray-300 text-sm mb-4">Esta ferramenta verifica a consistência dos IDs dos personagens e pode corrigir problemas automaticamente.</p>
                        
                        <div class="flex space-x-2 mb-4">
                            <button onclick="runIDValidation()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors">
                                🔍 Executar Validação
                            </button>
                            <button onclick="fixCharacterIDs()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors">
                                🔧 Corrigir IDs
                            </button>
                        </div>
                    </div>
                    
                    <div id="validation-results" class="bg-gray-800 p-4 rounded border border-gray-600">
                        <p class="text-gray-400 text-sm">Clique em "Executar Validação" para verificar a integridade dos dados.</p>
                    </div>
                </div>

                <!-- Aba de Logs do Sistema -->
                <div id="audit-content-logs" class="audit-tab-content hidden">
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-orange-300 mb-2">📋 Logs de Auditoria</h4>
                        <div class="flex flex-wrap items-center gap-2 mb-4">
                            <button onclick="loadAuditLogs()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors">
                                📥 Carregar Logs
                            </button>
                            <select id="log-level-filter" onchange="filterAuditLogs()" class="px-2 py-1 bg-gray-700 text-white rounded text-sm border border-gray-600">
                                <option value="">Todos os níveis</option>
                                <option value="ERROR">Erros</option>
                                <option value="WARN">Avisos</option>
                                <option value="INFO">Informações</option>
                                <option value="DEBUG">Debug</option>
                            </select>
                            <button onclick="exportAuditLogs()" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm transition-colors">
                                📤 Exportar
                            </button>
                            <button onclick="clearAuditLogs()" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors">
                                🗑️ Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div id="audit-logs-container" class="bg-gray-800 p-4 rounded border border-gray-600 max-h-96 overflow-y-auto">
                        <p class="text-gray-400 text-sm">Clique em "Carregar Logs" para visualizar o histórico de auditoria.</p>
                    </div>
                </div>

                <!-- Aba de Remoção Forçada -->
                <div id="audit-content-force" class="audit-tab-content hidden">
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-red-300 mb-2">⚠️ Remoção Forçada de Personagens</h4>
                        <p class="text-red-200 text-sm mb-4">
                            <strong>ATENÇÃO:</strong> Esta funcionalidade remove personagens diretamente do armazenamento, 
                            ignorando validações normais. Use apenas em casos de emergência quando a remoção normal falha.
                        </p>
                        
                        <button onclick="loadForceDeleteList()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded transition-colors mb-4">
                            📋 Listar Personagens para Remoção
                        </button>
                    </div>
                    
                    <div id="force-delete-container" class="bg-gray-800 p-4 rounded border border-gray-600">
                        <p class="text-gray-400 text-sm">Clique em "Listar Personagens" para ver todos os personagens disponíveis para remoção forçada.</p>
                    </div>
                </div>
            </div>

            <!-- Footer do modal -->
            <div class="mt-4 pt-4 border-t border-gray-700 text-center">
                <p class="text-xs text-gray-500">
                    Sistema de Diagnóstico v1.0 - Use com responsabilidade
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Diagnóstico de Backup -->
    <div id="diagnostic-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print">
        <div class="bg-gray-900 text-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden draggable-modal" onclick="event.stopPropagation()">
            <!-- Header do modal -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-yellow-400 flex items-center">
                    🔍 Diagnóstico dos Sistemas de Backup
                </h3>
                <button onclick="closeDiagnosticModal()" class="text-gray-400 hover:text-white transition-colors text-2xl">
                    ×
                </button>
            </div>
            
            <!-- Área de logs -->
            <div class="bg-black rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm" id="diagnostic-log-area">
                <div class="text-gray-400 text-center py-8">
                    Clique em "Executar Diagnóstico" para iniciar a análise...
                </div>
            </div>
            
            <!-- Controles -->
            <div class="flex justify-between items-center mt-4">
                <div class="flex gap-2">
                    <button onclick="runDiagnostic()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded transition-colors">
                        🔍 Executar Diagnóstico
                    </button>
                    <button onclick="clearDiagnosticLog()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                        🗑️ Limpar Log
                    </button>
                </div>
                <button onclick="closeDiagnosticModal()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- ========== FIM DOS MODAIS ========== -->

    <!-- Modal de Atalhos Rápidos -->
    <div id="quick-shortcuts-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeQuickShortcutsModal()">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-blue-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9 3a1 1 0 012 0v5.5a.5.5 0 001 0V4a1 1 0 112 0v4.5a.5.5 0 001 0V6a1 1 0 112 0v6a2.5 2.5 0 01-2.5 2.5h-1.086a3.5 3.5 0 01-1.664-.823L12 15.5V18a1 1 0 11-2 0v-2.5l-1.5-1.5C7.664 13.177 7 12.092 7 11V3z" clip-rule="evenodd"></path>
                    </svg>
                    ⌨️ Atalhos de Teclado
                </h3>
                <button onclick="closeQuickShortcutsModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-3">
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Salvar alterações</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-blue-300 rounded text-sm font-mono">Alt + S</kbd>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Novo personagem</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-green-300 rounded text-sm font-mono">Alt + N</kbd>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Exportar personagem</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-yellow-300 rounded text-sm font-mono">Alt + E</kbd>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Sistema de backup</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-orange-300 rounded text-sm font-mono">Alt + B</kbd>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Atalhos rápidos</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-purple-300 rounded text-sm font-mono">Alt + K</kbd>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Ajuda completa</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-cyan-300 rounded text-sm font-mono">F1</kbd>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="text-gray-200">Fechar modal</span>
                    <kbd class="px-2 py-1 bg-gray-900 text-red-300 rounded text-sm font-mono">Esc</kbd>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <p class="text-xs text-gray-400">Este modal desaparece automaticamente em <span id="shortcut-countdown">8</span> segundos</p>
            </div>
        </div>
    </div>

    <!-- Modal de Sistema de Backup -->
    <div id="backup-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeBackupModal()">
        <div class="themed-bg-surface text-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-blue-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    💾 Sistema de Backup
                </h3>
                <button onclick="closeBackupModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Painel de Ações -->
                <div class="space-y-3">
                    <h4 class="text-md font-semibold themed-text-primary-light mb-3">Ações de Backup</h4>
                    
                    <button onclick="manualBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Criar Backup Manual
                    </button>
                    
                    <button onclick="downloadBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Baixar Backup Atual
                    </button>
                    
                    <button onclick="openRestoreModal()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Restaurar Backup
                    </button>
                    
                    <!-- Input file oculto para restaurar de arquivo -->
                    <input type="file" id="backup-file-input" accept=".json" onchange="restoreBackupFromFile()" class="hidden">
                    
                    <button onclick="listBackups()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Listar Backups
                    </button>
                </div>
                
                <!-- Painel de Informações -->
                <div class="space-y-4">
                    <h4 class="text-md font-semibold themed-text-primary-light mb-3">Informações do Sistema</h4>
                    
                    <div class="themed-bg-surface-alt rounded-lg p-4 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm themed-text-muted">Backup Automático:</span>
                            <span class="text-sm text-green-400 font-semibold">✓ Ativo</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm themed-text-muted">Versões Mantidas:</span>
                            <span class="text-sm themed-text-base font-semibold">2 Últimas</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm themed-text-muted">Último Backup:</span>
                            <span id="last-backup-time" class="text-sm themed-text-base font-semibold">-</span>
                        </div>
                    </div>
                    
                    <div id="backup-status" class="themed-bg-surface-alt rounded-lg p-4">
                        <h5 class="text-sm font-semibold themed-text-primary-light mb-2">Status</h5>
                        <p class="text-sm themed-text-muted">Pronto para operações de backup.</p>
                    </div>
                    
                    <div class="text-xs themed-text-muted space-y-1">
                        <p><strong><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Dica:</strong> Backups são criados automaticamente ao salvar.</p>
                        <p><strong>⚠️ Importante:</strong> Sempre mantenha backups locais importantes.</p>
                        <p><strong>🔄 Sistema:</strong> Mantém as 2 versões mais recentes automaticamente.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Restauração de Backup -->
    <div id="restore-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeRestoreModal()">
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-green-400 flex items-center">
                    <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Restaurar Backup
                </h2>
                <button onclick="closeRestoreModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Restaurar de Backups Locais -->
                <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                    <h3 class="text-lg font-semibold text-blue-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Backups Locais
                    </h3>
                    <p class="text-sm text-gray-300 mb-4">Escolha um dos backups salvos localmente no sistema:</p>
                    
                    <div id="local-backups-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Lista de backups será preenchida aqui -->
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button onclick="refreshLocalBackups()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            🔄 Atualizar Lista
                        </button>
                    </div>
                </div>
                
                <!-- Restaurar de Arquivo -->
                <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                    <h3 class="text-lg font-semibold text-purple-400 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4" />
                        </svg>
                        Arquivo Externo
                    </h3>
                    <p class="text-sm text-gray-300 mb-4">Selecione um arquivo de backup JSON previamente baixado:</p>
                    
                    <button onclick="selectBackupFile()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Selecionar Arquivo JSON
                    </button>
                </div>
                
                <!-- Status da Operação -->
                <div id="restore-status" class="bg-slate-700 rounded-lg p-4 border border-slate-600 hidden">
                    <div class="flex items-center space-x-2">
                        <div id="restore-status-icon" class="inline-flex items-center justify-center w-5 h-5 bg-blue-500 text-white rounded-full text-sm">ℹ</div>
                        <div id="restore-status-text" class="text-sm text-gray-300">Aguardando ação...</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-slate-600 text-center">
                <p class="text-xs text-gray-400">
                    ⚠️ A restauração substituirá todos os dados atuais. Esta ação não pode ser desfeita.
                </p>
            </div>
        </div>
    </div>


    <!-- Modal da Biblioteca de Magias -->
    <div id="spell-library-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print p-2" onclick="closeSpellLibraryModal()">
        <div class="themed-bg-surface text-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-7xl mx-2 max-h-[95vh] overflow-hidden transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base md:text-lg font-bold text-violet-300 flex items-center">
                    <svg class="w-4 h-4 md:w-5 md:h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    📚 Biblioteca de Magias
                </h3>
                <button onclick="closeSpellLibraryModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="flex flex-col lg:flex-row h-[85vh] gap-4">
                <!-- Painel Esquerdo - Lista de Magias -->
                <div class="w-full lg:w-2/3 flex flex-col">
                    <div class="mb-4">
                        <div class="relative mb-3">
                            <input type="text" 
                                   id="library-spell-search-input" 
                                   oninput="filterLibrarySpells()" 
                                   placeholder="Buscar magia na biblioteca..." 
                                   class="w-full p-2 md:p-3 pl-8 md:pl-10 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-violet-500 focus:ring-2 focus:ring-violet-500 focus:ring-opacity-50 text-sm md:text-base">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 md:pl-3 pointer-events-none">
                                <svg class="h-4 w-4 md:h-5 md:w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 md:gap-2">
                            <button onclick="clearLibrarySearch()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                Limpar
                            </button>
                            <select id="library-type-filter" onchange="filterLibrarySpells()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                <option value="">Todos</option>
                                <option value="arcana">Arcana</option>
                                <option value="divina">Divina</option>
                            </select>
                            <select id="library-level-filter" onchange="filterLibrarySpells()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                <option value="">Níveis</option>
                                <option value="0">Nível 0</option>
                                <option value="1">Nível 1</option>
                                <option value="2">Nível 2</option>
                                <option value="3">Nível 3</option>
                                <option value="4">Nível 4</option>
                                <option value="5">Nível 5</option>
                                <option value="6">Nível 6</option>
                                <option value="7">Nível 7</option>
                                <option value="8">Nível 8</option>
                                <option value="9">Nível 9</option>
                            </select>
                            <button onclick="sortSpellsByLevel()" class="px-2 md:px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white text-xs rounded transition duration-150" title="Ordenar por nível (0-9)">
                                📚 Ordenar
                            </button>
                            <button onclick="exportSpellLibrary()" class="px-2 md:px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition duration-150">
                                Export. Tudo
                            </button>
                            <button onclick="exportSelectedSpells()" class="px-2 md:px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition duration-150">
                                Export. Sel.
                            </button>
                            <button onclick="importSpellLibrary()" class="px-2 md:px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded transition duration-150">
                                Importar
                            </button>
                            <button onclick="clearAllSpells()" class="px-2 md:px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition duration-150">
                                Excluir Todas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Magias da Biblioteca -->
                    <div id="spell-library-list" class="flex-1 overflow-y-auto space-y-2 themed-bg-surface-alt rounded-lg p-2 md:p-3">
                        <p class="text-center themed-text-muted py-8 text-sm">Nenhuma magia cadastrada na biblioteca.</p>
                    </div>
                    
                    <!-- Controles de Paginação -->
                    <div id="spell-pagination-controls" class="flex items-center justify-between mt-3 px-2 py-2 themed-bg-surface-alt rounded-lg text-sm hidden">
                        <div class="flex items-center gap-2">
                            <span class="themed-text-muted">Página:</span>
                            <button onclick="changeSpellPage(-1)" id="spell-prev-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                ← Anterior
                            </button>
                            <span id="spell-page-info" class="px-3 py-1 themed-bg-surface themed-text-base rounded border themed-border">1 / 1</span>
                            <button onclick="changeSpellPage(1)" id="spell-next-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Próxima →
                            </button>
                        </div>
                        <div class="themed-text-muted">
                            <span id="spell-total-info">0 magias</span>
                        </div>
                    </div>
                </div>

                <!-- Painel Direito - Cadastro de Nova Magia -->
                <div class="w-full lg:w-1/3 border-t lg:border-t-0 lg:border-l themed-border pt-4 lg:pt-0 lg:pl-4">
                    <h4 class="text-sm md:text-md font-bold text-green-400 mb-4 flex items-center">
                        <svg class="w-3 h-3 md:w-4 md:h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Cadastrar Nova Magia
                    </h4>
                    
                    <div class="space-y-3 max-h-[60vh] lg:max-h-[70vh] overflow-y-auto">
                        <input type="text" id="lib-spell-name" placeholder="Nome da Magia" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                        
                        <!-- Sistema de Tags para Níveis -->
                        <div class="space-y-2">
                            <label class="text-xs md:text-sm font-medium text-green-300">Níveis de Magia</label>
                            <div class="flex flex-wrap gap-1" id="spell-level-tags">
                                <!-- Tags aparecerão aqui -->
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <select id="spell-level-type" class="flex-1 p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                    <option value="Arcana">Arcana</option>
                                    <option value="Divina">Divina</option>
                                </select>
                                <input type="number" id="spell-level-number" placeholder="Nível" min="0" max="9" class="w-20 sm:w-16 p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                <button type="button" onclick="addSpellLevelTag()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 text-xs whitespace-nowrap">
                                    + Add
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-2">
                            <input type="text" id="lib-spell-school" placeholder="Escola/Descritor" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-spell-components" value="V, S, M" placeholder="Componentes" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-spell-time" placeholder="Tempo de Execução" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-spell-range" placeholder="Alcance" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-spell-target" placeholder="Alvo/Área" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-spell-duration" placeholder="Duração" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-spell-resistance" placeholder="Teste de Resistência" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                        </div>
                        
                        <textarea id="lib-spell-description" placeholder="Descrição da Magia" rows="3" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm"></textarea>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button onclick="addSpellToLibrary()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 text-sm">
                                Adicionar à Biblioteca
                            </button>
                            <button onclick="clearLibraryForm()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                                Limpar
                            </button>
                        </div>
                        
                        <!-- Informações sobre edição -->
                        <div id="library-edit-info" class="hidden p-3 bg-amber-900/20 rounded-lg border border-amber-700/30">
                            <p class="text-xs md:text-sm text-amber-200">
                                <strong>✏️ Editando:</strong> <span id="edit-spell-name"></span>
                            </p>
                            <div class="flex flex-col sm:flex-row gap-2 mt-2">
                                <button onclick="updateSpellInLibrary()" class="flex-1 py-1 bg-amber-600 text-white rounded text-xs md:text-sm hover:bg-amber-700 transition duration-150">
                                    Salvar Alterações
                                </button>
                                <button onclick="cancelLibraryEdit()" class="px-3 py-1 bg-gray-600 text-white rounded text-xs md:text-sm hover:bg-gray-700 transition duration-150">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal da Biblioteca de Talentos -->
    <div id="talent-library-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print p-2" onclick="closeTalentLibraryModal()">
        <div class="themed-bg-surface text-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-7xl mx-2 max-h-[95vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-base md:text-lg font-bold text-violet-300 flex items-center">
                    <svg class="w-4 h-4 md:w-5 md:h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    🎯 Biblioteca de Talentos
                </h3>
                <button onclick="closeTalentLibraryModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="flex flex-col lg:flex-row h-[85vh] gap-4">
                <!-- Painel Esquerdo - Lista de Talentos -->
                <div class="w-full lg:w-2/3 flex flex-col">
                    <div class="mb-4">
                        <div class="relative mb-3">
                            <input type="text" 
                                   id="talent-library-search-input" 
                                   oninput="resetTalentPagination(); filterLibraryTalents()" 
                                   placeholder="Buscar talento na biblioteca..." 
                                   class="w-full p-2 md:p-3 pl-8 md:pl-10 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-violet-500 focus:ring-2 focus:ring-violet-500 focus:ring-opacity-50 text-sm md:text-base">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 md:pl-3 pointer-events-none">
                                <svg class="h-4 w-4 md:h-5 md:w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 md:gap-2">
                            <button onclick="clearTalentLibrarySearch()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                Limpar
                            </button>
                            <select id="talent-type-filter" onchange="resetTalentPagination(); filterLibraryTalents()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                <option value="">Todos</option>
                                <option value="combate">Combate</option>
                                <option value="pericia">Perícia</option>
                                <option value="magia">Magia</option>
                                <option value="destino">Destino</option>
                                <option value="bencao">Bênção</option>
                                <option value="poderes">Poderes Concedidos</option>
                                <option value="tormenta">Tormenta</option>
                                <option value="raciais">Raciais</option>
                                <option value="regionais">Regionais</option>
                                <option value="epicos">Épicos</option>
                                <option value="negativos">Negativos</option>
                                <option value="jutsus">Jutsus</option>
                            </select>
                            <button onclick="exportTalentLibrary()" class="px-2 md:px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition duration-150">
                                Export. Tudo
                            </button>
                            <button onclick="exportSelectedTalents()" class="px-2 md:px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition duration-150">
                                Export. Sel.
                            </button>
                            <button onclick="importTalentLibrary()" class="px-2 md:px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded transition duration-150">
                                Importar
                            </button>
                            <button onclick="clearAllTalents()" class="px-2 md:px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition duration-150">
                                Excluir Todas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Talentos da Biblioteca -->
                    <div id="talent-library-list" class="flex-1 overflow-y-auto space-y-2 themed-bg-surface-alt rounded-lg p-2 md:p-3">
                        <p class="text-center themed-text-muted py-8 text-sm">Nenhum talento cadastrado na biblioteca.</p>
                    </div>
                    
                    <!-- Controles de Paginação -->
                    <div id="talent-pagination-controls" class="flex items-center justify-between mt-3 px-2 py-2 themed-bg-surface-alt rounded-lg text-sm hidden">
                        <div class="flex items-center gap-2">
                            <span class="themed-text-muted">Página:</span>
                            <button onclick="changeTalentPage(-1)" id="talent-prev-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                ← Anterior
                            </button>
                            <span id="talent-page-info" class="px-3 py-1 themed-bg-surface themed-text-base rounded border themed-border">1 / 1</span>
                            <button onclick="changeTalentPage(1)" id="talent-next-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Próxima →
                            </button>
                        </div>
                        <div class="themed-text-muted">
                            <span id="talent-total-info">0 talentos</span>
                        </div>
                    </div>
                </div>                        <!-- Painel Direito - Cadastro de Novo Talento -->
                        <div class="w-full lg:w-1/3 border-t lg:border-t-0 lg:border-l themed-border pt-4 lg:pt-0 lg:pl-4">
                            <h4 class="text-sm md:text-md font-bold text-green-400 mb-4 flex items-center">
                                <svg class="w-3 h-3 md:w-4 md:h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Cadastrar Novo Talento
                            </h4>
                            
                            <div class="space-y-3 max-h-[60vh] lg:max-h-[70vh] overflow-y-auto">
                                <input type="text" id="lib-talent-name" placeholder="Nome do Talento" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                
                                <select id="lib-talent-type" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                    <option value="combate">Talentos de Combate</option>
                                    <option value="pericia">Talentos de Perícia</option>
                                    <option value="magia">Talentos de Magia</option>
                                    <option value="destino">Talentos de Destino</option>
                                    <option value="bencao">Talentos de Bênção</option>
                                    <option value="poderes">Talentos de Poderes Concedidos</option>
                                    <option value="tormenta">Talentos da Tormenta</option>
                                    <option value="raciais">Talentos Raciais</option>
                                    <option value="regionais">Talentos Regionais</option>
                                    <option value="epicos">Talentos Épicos</option>
                                    <option value="negativos">Talentos Negativos</option>
                                    <option value="jutsus">Talentos de Jutsus</option>
                                </select>
                                
                                <input type="text" id="lib-talent-prerequisite" placeholder="Pré-requisitos" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                
                                <textarea id="lib-talent-description" placeholder="Descrição do Talento" rows="4" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm"></textarea>
                                
                                <textarea id="lib-talent-benefit" placeholder="Benefício" rows="3" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm"></textarea>
                                
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <button onclick="addTalentToLibrary()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 text-sm">
                                        Adicionar à Biblioteca
                                    </button>
                                    <button onclick="clearTalentLibraryForm()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                                        Limpar
                                    </button>
                                </div>
                                
                                <!-- Informações sobre edição -->
                                <div id="talent-library-edit-info" class="hidden p-3 bg-amber-900/20 rounded-lg border border-amber-700/30">
                                    <p class="text-xs md:text-sm text-amber-200">
                                        <strong>✏️ Editando:</strong> <span id="edit-talent-name"></span>
                                    </p>
                                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                                        <button onclick="updateTalentInLibrary()" class="flex-1 py-1 bg-amber-600 text-white rounded text-xs md:text-sm hover:bg-amber-700 transition duration-150">
                                            Salvar Alterações
                                        </button>
                                        <button onclick="cancelTalentLibraryEdit()" class="px-3 py-1 bg-gray-600 text-white rounded text-xs md:text-sm hover:bg-gray-700 transition duration-150">
                                            Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal da Biblioteca de Itens -->
    <div id="item-library-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print p-2" onclick="closeItemLibraryModal()">
        <div class="themed-bg-surface text-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[95vh] overflow-hidden border-t-4 border-yellow-500" onclick="event.stopPropagation()">
            
            <!-- Cabeçalho -->
            <div class="flex items-center justify-between p-4 md:p-6 border-b themed-border">
                <h3 class="text-xl md:text-2xl font-bold text-yellow-300 flex items-center">
                    <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 md:mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    📦 Biblioteca de Itens
                </h3>
                <button onclick="closeItemLibraryModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="flex flex-col lg:flex-row h-[85vh] gap-4 p-4">
                <!-- Painel Esquerdo - Lista de Itens -->
                <div class="w-full lg:w-2/3 flex flex-col">
                    <div class="mb-4">
                        <div class="relative mb-3">
                            <input type="text" 
                                   id="item-library-search-input" 
                                   oninput="resetItemPagination(); filterLibraryItems()" 
                                   placeholder="Buscar itens..." 
                                   class="w-full pl-8 md:pl-10 pr-3 py-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-yellow-500 text-xs md:text-sm">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 md:pl-3 pointer-events-none">
                                <svg class="h-4 w-4 md:h-5 md:w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 md:gap-2">
                            <button onclick="clearItemLibrarySearch()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                Limpar
                            </button>
                            <select id="item-category-filter" onchange="resetItemPagination(); filterLibraryItems()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                <option value="">Todas Categorias</option>
                                <option value="arma">Armas</option>
                                <option value="armadura">Armaduras</option>
                                <option value="escudo">Escudos</option>
                                <option value="item">Itens</option>
                            </select>
                            <select id="item-subcategory-filter" onchange="resetItemPagination(); filterLibraryItems()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                <option value="">Todas Subcategorias</option>
                                <!-- Subcategorias de Armas -->
                                <option value="simples">Simples</option>
                                <option value="marciais">Marciais</option>
                                <option value="exoticas">Exóticas</option>
                                <!-- Subcategorias de Armaduras/Escudos -->
                                <option value="leves">Leves</option>
                                <option value="medias">Médias</option>
                                <option value="pesadas">Pesadas</option>
                                <option value="pesados">Pesados</option>
                                <!-- Subcategorias de Itens -->
                                <option value="consumivel">Consumível</option>
                                <option value="ferramenta">Ferramenta</option>
                                <option value="equipamento">Equipamento</option>
                                <option value="servicos">Serviços</option>
                                <option value="tesouro">Tesouro</option>
                                <option value="outros">Outros</option>
                            </select>
                            <button onclick="exportItemLibrary()" class="px-2 md:px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition duration-150">
                                Export. Tudo
                            </button>
                            <button onclick="exportSelectedItems()" class="px-2 md:px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition duration-150">
                                Export. Sel.
                            </button>
                            <button onclick="importItemLibrary()" class="px-2 md:px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded transition duration-150">
                                Importar
                            </button>
                            <button onclick="clearAllItems()" class="px-2 md:px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition duration-150">
                                Excluir Todas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Itens da Biblioteca -->
                    <div id="item-library-list" class="flex-1 overflow-y-auto space-y-2 themed-bg-surface-alt rounded-lg p-2 md:p-3">
                        <p class="text-center themed-text-muted py-8 text-sm">Nenhum item cadastrado na biblioteca.</p>
                    </div>
                    
                    <!-- Controles de Paginação -->
                    <div id="item-pagination-controls" class="flex items-center justify-between mt-3 px-2 py-2 themed-bg-surface-alt rounded-lg text-sm hidden">
                        <div class="flex items-center gap-2">
                            <span class="themed-text-muted">Página:</span>
                            <button onclick="changeItemPage(-1)" id="item-prev-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                ← Anterior
                            </button>
                            <span id="item-page-info" class="px-3 py-1 themed-bg-surface themed-text-base rounded border themed-border">1 / 1</span>
                            <button onclick="changeItemPage(1)" id="item-next-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                Próxima →
                            </button>
                        </div>
                        <div class="themed-text-muted">
                            <span id="item-total-info">0 itens</span>
                        </div>
                    </div>
                </div>

                <!-- Painel Direito - Cadastro de Novo Item -->
                <div class="w-full lg:w-1/3 border-t lg:border-t-0 lg:border-l themed-border pt-4 lg:pt-0 lg:pl-4">
                    <h4 class="text-sm md:text-md font-bold text-green-400 mb-4 flex items-center">
                        <svg class="w-3 h-3 md:w-4 md:h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Cadastrar Novo Item
                    </h4>
                    
                    <div class="space-y-3 max-h-[60vh] lg:max-h-[70vh] overflow-y-auto">
                        <input type="text" id="lib-item-name" placeholder="Nome do Item" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                        
                        <select id="lib-item-category" onchange="updateItemSubcategories()" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <option value="arma">Arma</option>
                            <option value="armadura">Armadura</option>
                            <option value="escudo">Escudo</option>
                            <option value="item">Item</option>
                        </select>
                        
                        <select id="lib-item-subcategory" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <option value="simples">Simples</option>
                            <option value="marciais">Marciais</option>
                            <option value="exoticas">Exóticas</option>
                        </select>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="lib-item-price" placeholder="Preço (TO)" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            <input type="text" id="lib-item-weight" placeholder="Peso (Kg)" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                        </div>
                        
                        <!-- Campos específicos de armas -->
                        <div id="weapon-fields" class="space-y-2">
                            <select id="lib-item-combat-type" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                <option value="corpo-leve">Corpo a Corpo - Leve</option>
                                <option value="corpo-uma-mao">Corpo a Corpo - Uma Mão</option>
                                <option value="corpo-duas-maos">Corpo a Corpo - Duas Mãos</option>
                                <option value="distancia">Ataque a Distância</option>
                            </select>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="lib-item-damage" placeholder="Dano" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                <input type="text" id="lib-item-critical" placeholder="Crítico" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="lib-item-range" placeholder="Distância" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                <input type="text" id="lib-item-damage-type" placeholder="Tipo de Dano" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            </div>
                        </div>
                        
                        <!-- Campos específicos de armaduras -->
                        <div id="armor-fields" class="space-y-2 hidden">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="lib-item-ac-bonus" placeholder="Bônus CA" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                                <input type="text" id="lib-item-max-dex" placeholder="Máx. Dex" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                            </div>
                            <input type="text" id="lib-item-armor-penalty" placeholder="Penalidade Armadura" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm">
                        </div>
                        
                        <textarea id="lib-item-description" placeholder="Descrição do Item" rows="4" class="w-full p-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-green-500 text-sm"></textarea>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button onclick="addItemToLibrary()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 text-sm">
                                Adicionar à Biblioteca
                            </button>
                            <button onclick="clearItemLibraryForm()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                                Limpar
                            </button>
                        </div>
                        
                        <!-- Informações sobre edição -->
                        <div id="item-library-edit-info" class="hidden p-3 bg-amber-900/20 rounded-lg border border-amber-700/30">
                            <p class="text-xs md:text-sm text-amber-200">
                                <strong>✏️ Editando:</strong> <span id="edit-item-name"></span>
                            </p>
                            <div class="flex flex-col sm:flex-row gap-2 mt-2">
                                <button onclick="updateItemInLibrary()" class="flex-1 py-1 bg-amber-600 text-white rounded text-xs md:text-sm hover:bg-amber-700 transition duration-150">
                                    Salvar Alterações
                                </button>
                                <button onclick="cancelItemLibraryEdit()" class="px-3 py-1 bg-gray-600 text-white rounded text-xs md:text-sm hover:bg-gray-700 transition duration-150">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Itens da Biblioteca -->
    <div id="item-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print p-2" onclick="closeItemSelectionModal()">
        <div class="themed-bg-surface text-white p-4 md:p-6 rounded-lg shadow-xl max-w-5xl w-full max-h-[95vh] overflow-hidden transform transition-all duration-300 scale-95 opacity-0 flex flex-col" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <h3 class="text-lg font-bold text-blue-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    📦 Selecionar Item da Biblioteca
                </h3>
                <button onclick="closeItemSelectionModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
                <!-- Lista de Itens da Biblioteca -->
                <div class="lg:w-2/3 flex flex-col min-h-0">
                    <div class="mb-4 flex-shrink-0">
                        <div class="relative mb-3">
                            <input type="text" 
                                   id="item-selection-search" 
                                   oninput="filterItemSelection()" 
                                   placeholder="Buscar itens..." 
                                   class="w-full pl-10 pr-3 py-2 rounded-lg themed-bg-surface themed-text-base themed-border border focus:border-blue-500">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="h-5 w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <select id="item-selection-category" onchange="filterItemSelection()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded transition duration-150">
                                <option value="">Todas Categorias</option>
                                <option value="arma">Armas</option>
                                <option value="armadura">Armaduras</option>
                                <option value="escudo">Escudos</option>
                                <option value="item">Itens</option>
                            </select>
                            <select id="item-selection-subcategory" onchange="filterItemSelection()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded transition duration-150">
                                <option value="">Todas Subcategorias</option>
                                <option value="simples">Simples</option>
                                <option value="marciais">Marciais</option>
                                <option value="exoticas">Exóticas</option>
                                <option value="leves">Leves</option>
                                <option value="medias">Médias</option>
                                <option value="pesadas">Pesadas</option>
                                <option value="pesados">Pesados</option>
                                <option value="consumivel">Consumível</option>
                                <option value="ferramenta">Ferramenta</option>
                                <option value="equipamento">Equipamento</option>
                                <option value="servicos">Serviços</option>
                                <option value="tesouro">Tesouro</option>
                                <option value="outros">Outros</option>
                            </select>
                            <button onclick="clearItemSelectionSearch()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded transition duration-150">
                                Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div id="item-selection-list" class="flex-1 overflow-y-auto space-y-2 themed-bg-surface-alt rounded-lg p-3">
                        <p class="text-center themed-text-muted py-8">Nenhum item disponível na biblioteca. Cadastre itens na Biblioteca de Itens primeiro.</p>
                    </div>
                </div>
                
                <!-- Painel de Detalhes e Seleção -->
                <div class="lg:w-1/3 flex flex-col min-h-0">
                    <!-- Detalhes do Item (rolável) -->
                    <div class="flex-1 min-h-0 mb-4 overflow-y-auto">
                        <div id="item-selection-details" class="themed-bg-surface-alt rounded-lg p-4">
                            <p class="themed-text-muted text-center py-8">Selecione um item para ver os detalhes</p>
                        </div>
                    </div>
                    
                    <!-- Painel de Adição (fixo na parte inferior) -->
                    <div class="flex-shrink-0 p-4 themed-bg-surface-alt rounded-lg border-t-2 border-green-500">
                        <h4 class="font-bold text-green-400 mb-3">Adicionar ao Personagem</h4>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="add-enhancement-checkbox" class="rounded">
                                <label for="add-enhancement-checkbox" class="text-sm">Adicionar aprimoramento</label>
                            </div>
                            <div id="enhancement-fields" class="hidden space-y-2">
                                <input type="text" id="enhancement-name" placeholder="Nome do aprimoramento" class="w-full p-2 rounded themed-bg-surface themed-text-base themed-border border text-sm">
                                <input type="number" id="enhancement-bonus" placeholder="Bônus (+1, +2, etc.)" class="w-full p-2 rounded themed-bg-surface themed-text-base themed-border border text-sm">
                            </div>
                            <button onclick="addSelectedItemToCharacter()" id="add-item-btn" disabled class="w-full py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-500 disabled:cursor-not-allowed">
                                Adicionar Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Magias da Biblioteca -->
    <div id="spell-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeSpellSelectionModal()">
        <div class="themed-bg-surface text-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-blue-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    ⚡ Adicionar Magia às Preparadas
                </h3>
                <button onclick="closeSpellSelectionModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>

            <!-- Busca -->
            <div class="relative mb-4">
                <input type="text" 
                       id="selection-spell-search-input" 
                       oninput="filterSelectionSpells()" 
                       placeholder="Buscar magia na biblioteca..." 
                       class="w-full p-3 pl-10 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="h-5 w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- Lista de Magias para Seleção -->
            <div id="spell-selection-list" class="max-h-[60vh] overflow-y-auto space-y-2 themed-bg-surface-alt rounded-lg p-3">
                <p class="text-center themed-text-muted py-8">Nenhuma magia disponível na biblioteca. Cadastre magias na Biblioteca de Magias primeiro.</p>
            </div>

            <!-- Controles de Paginação -->
            <div id="spell-selection-pagination" class="flex items-center justify-between mt-4 p-3 bg-gray-700/30 rounded-lg">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-400">Magias por página:</span>
                    <select id="spell-selection-per-page" onchange="changeSpellSelectionPerPage()" class="bg-gray-600 text-white text-sm px-2 py-1 rounded">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-400">
                        Página <span id="spell-selection-current-page">1</span> de <span id="spell-selection-total-pages">1</span>
                        (Mostrando <span id="spell-selection-showing-from">0</span> a <span id="spell-selection-showing-to">0</span> de <span id="spell-selection-total-spells">0</span> magias)
                    </span>
                </div>

                <div class="flex items-center gap-1">
                    <button id="spell-selection-prev-btn" onclick="changeSpellSelectionPage(-1)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        ⬅️ Anterior
                    </button>
                    <button id="spell-selection-next-btn" onclick="changeSpellSelectionPage(1)" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        Próximo ➡️
                    </button>
                </div>
            </div>

            <!-- Informações -->
            <div class="mt-4 p-3 bg-blue-900/20 rounded-lg border border-blue-700/30">
                <p class="text-sm text-blue-200">
                    <strong><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Dica:</strong> Selecione as magias da biblioteca que deseja adicionar às suas magias preparadas. 
                    Se não encontrar a magia desejada, use o botão "Biblioteca de Magias" no cabeçalho para cadastrá-la primeiro.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Talentos da Biblioteca -->
    <div id="talent-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeTalentSelectionModal()">
        <div class="themed-bg-surface text-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-blue-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Adicionar Talentos da Biblioteca
                </h3>
                <button onclick="closeTalentSelectionModal()" class="text-gray-400 hover:text-white transition duration-150">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Busca -->
            <div class="relative mb-4">
                <input type="text" 
                       id="talent-selection-search" 
                       oninput="filterTalentSelection()" 
                       placeholder="Buscar talentos na biblioteca..." 
                       class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- Filtros -->
            <div class="flex flex-wrap gap-2 mb-4">
                <select id="talent-selection-type-filter" onchange="filterTalentSelection()" class="px-3 py-1 bg-slate-700 text-white border border-slate-600 rounded text-sm">
                    <option value="">Todos os Tipos</option>
                    <option value="combate">Talentos de Combate</option>
                    <option value="pericia">Talentos de Perícia</option>
                    <option value="magia">Talentos de Magia</option>
                    <option value="destino">Talentos de Destino</option>
                    <option value="bencao">Talentos de Bênção</option>
                    <option value="poderes">Talentos de Poderes Concedidos</option>
                    <option value="tormenta">Talentos da Tormenta</option>
                    <option value="raciais">Talentos Raciais</option>
                    <option value="regionais">Talentos Regionais</option>
                    <option value="epicos">Talentos Épicos</option>
                    <option value="negativos">Talentos Negativos</option>
                    <option value="jutsus">Talentos de Jutsus</option>
                </select>
            </div>

            <!-- Origem dos Talentos -->
            <div class="mb-4 p-3 bg-slate-700 rounded-lg border border-slate-600">
                <h4 class="text-sm font-semibold text-blue-300 mb-2"><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Origem do Talento (para calculadora de pontos)</h4>
                <div class="flex flex-wrap gap-3 text-sm">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="talent-origin" value="Comprado" class="mr-2" checked>
                        <span class="text-yellow-300">📀 Comprado (consome pontos)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="talent-origin" value="Classe" class="mr-2">
                        <span class="text-green-300">🎓 Classe (gratuito)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="talent-origin" value="Raça" class="mr-2">
                        <span class="text-orange-300">🧬 Raça (gratuito)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="talent-origin" value="Desvantagem" class="mr-2">
                        <span class="text-red-300">⚠️ Desvantagem (gera pontos)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="talent-origin" value="Outro" class="mr-2">
                        <span class="text-gray-300">🎁 Outro (gratuito)</span>
                    </label>
                </div>
            </div>

            <!-- Botão de Adicionar -->
            <div class="mb-4">
                <button onclick="addSelectedTalentsToCharacter()" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition duration-150 text-sm">
                    ✅ Adicionar Selecionados
                </button>
            </div>

            <!-- Controles de Paginação -->
            <div class="flex justify-between items-center mb-4 p-3 bg-slate-700 rounded-lg border border-slate-600">
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-300">Itens por página:</label>
                    <select id="talent-selection-per-page" onchange="changeTalentSelectionPerPage()" class="px-2 py-1 bg-slate-600 text-white border border-slate-500 rounded text-sm">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="talent-selection-page-info" class="text-sm text-gray-300">Carregando...</span>
                    <div class="flex space-x-2">
                        <button id="talent-selection-prev-btn" onclick="changeTalentSelectionPage('prev')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition duration-150">
                            ← Anterior
                        </button>
                        <button id="talent-selection-next-btn" onclick="changeTalentSelectionPage('next')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition duration-150">
                            Próximo →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Talentos para Seleção -->
            <div id="talent-selection-list" class="max-h-[50vh] overflow-y-auto bg-slate-800 rounded-lg p-4">
                <p class="text-center text-gray-400 py-8">Nenhum talento disponível na biblioteca. Cadastre talentos na Biblioteca de Talentos primeiro.</p>
            </div>

            <!-- Informações -->
            <div class="mt-4 p-3 bg-blue-900/20 rounded-lg border border-blue-700/30">
                <p class="text-sm text-blue-200">
                    <strong><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>Dica:</strong> Selecione os talentos da biblioteca que deseja adicionar aos seus talentos adquiridos. 
                    Se não encontrar o talento desejado, use o botão "Biblioteca de Talentos" no cabeçalho para cadastrá-lo primeiro.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal da Biblioteca de Raças -->
    <div id="race-library-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print p-2" onclick="closeRaceLibraryModal()">
        <div class="themed-bg-surface text-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden border-t-4 border-orange-500" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b themed-border">
                <h3 class="text-xl font-bold themed-text-primary flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    🧬 Biblioteca de Raças
                </h3>
                <button onclick="closeRaceLibraryModal()" class="themed-text-muted hover:themed-text-base transition duration-150">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="flex flex-col lg:flex-row h-full max-h-[80vh]">
                <!-- Coluna Esquerda: Lista de Raças -->
                <div class="w-full lg:w-1/2 p-4 overflow-y-auto themed-bg-surface-alt">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-2">
                        <h4 class="text-lg font-semibold themed-text-primary">Raças Cadastradas</h4>
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="race-library-search" placeholder="Buscar raças..." 
                                   class="px-3 py-1 text-black rounded border border-gray-300 text-sm flex-grow md:flex-grow-0 md:w-40"
                                   onkeyup="filterRaceLibrary()">
                            <button onclick="clearRaceLibrarySearch()" class="px-2 md:px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition duration-150">
                                Limpar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Botões de Ação -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="exportRaceLibrary()" class="px-2 md:px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition duration-150">
                            💾 Exportar
                        </button>
                        <button onclick="importRaceLibrary()" class="px-2 md:px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded transition duration-150">
                            📂 Importar
                        </button>
                    </div>
                    
                    <!-- Lista de Raças -->
                    <div id="race-library-list" class="space-y-3">
                        <!-- Raças serão carregadas aqui -->
                    </div>
                </div>
                
                <!-- Coluna Direita: Formulário de Cadastro -->
                <div class="w-full lg:w-1/2 p-4 overflow-y-auto">
                    <h4 class="text-lg font-semibold themed-text-primary mb-4">
                        <span id="race-form-title">Cadastrar Nova Raça</span>
                    </h4>
                    
                    <form id="race-library-form" class="space-y-4">
                        <!-- Nome da Raça -->
                        <div>
                            <label class="block text-sm font-medium themed-text-base mb-1">Nome da Raça *</label>
                            <input type="text" id="race-name" required 
                                   class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                   placeholder="Ex: Anão, Elfo, Goblin">
                        </div>
                        
                        <!-- Tamanho e Deslocamento -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium themed-text-base mb-1">Tamanho</label>
                                <select id="race-size" class="w-full px-3 py-2 text-black rounded border border-gray-300">
                                    <option value="Minúsculo">Minúsculo</option>
                                    <option value="Diminuto">Diminuto</option>
                                    <option value="Miúdo">Miúdo</option>
                                    <option value="Pequeno">Pequeno</option>
                                    <option value="Médio" selected>Médio</option>
                                    <option value="Grande">Grande</option>
                                    <option value="Enorme">Enorme</option>
                                    <option value="Descomunal">Descomunal</option>
                                    <option value="Colossal">Colossal</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium themed-text-base mb-1">Deslocamento</label>
                                <input type="text" id="race-movement" 
                                       class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                       placeholder="Ex: 9m, 6m">
                            </div>
                        </div>
                        
                        <!-- Ajustes de Habilidade -->
                        <div>
                            <label class="block text-sm font-medium themed-text-base mb-2">Ajustes de Habilidade</label>
                            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                                <div class="text-center">
                                    <label class="block text-xs font-medium themed-text-muted mb-1">FOR</label>
                                    <input type="number" id="race-str" value="0" 
                                           class="w-full px-2 py-1 text-black rounded border border-gray-300 text-center text-sm">
                                </div>
                                <div class="text-center">
                                    <label class="block text-xs font-medium themed-text-muted mb-1">DES</label>
                                    <input type="number" id="race-dex" value="0" 
                                           class="w-full px-2 py-1 text-black rounded border border-gray-300 text-center text-sm">
                                </div>
                                <div class="text-center">
                                    <label class="block text-xs font-medium themed-text-muted mb-1">CON</label>
                                    <input type="number" id="race-con" value="0" 
                                           class="w-full px-2 py-1 text-black rounded border border-gray-300 text-center text-sm">
                                </div>
                                <div class="text-center">
                                    <label class="block text-xs font-medium themed-text-muted mb-1">INT</label>
                                    <input type="number" id="race-int" value="0" 
                                           class="w-full px-2 py-1 text-black rounded border border-gray-300 text-center text-sm">
                                </div>
                                <div class="text-center">
                                    <label class="block text-xs font-medium themed-text-muted mb-1">SAB</label>
                                    <input type="number" id="race-wis" value="0" 
                                           class="w-full px-2 py-1 text-black rounded border border-gray-300 text-center text-sm">
                                </div>
                                <div class="text-center">
                                    <label class="block text-xs font-medium themed-text-muted mb-1">CAR</label>
                                    <input type="number" id="race-cha" value="0" 
                                           class="w-full px-2 py-1 text-black rounded border border-gray-300 text-center text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Traços Raciais -->
                        <div>
                            <label class="block text-sm font-medium themed-text-base mb-1">Traços Raciais</label>
                            <textarea id="race-traits" rows="4" 
                                      class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                      placeholder="Descreva os traços raciais especiais..."></textarea>
                        </div>
                        
                        <!-- Botões de Ação -->
                        <div class="flex gap-2 pt-4">
                            <button type="submit" id="race-submit-btn" 
                                    class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition duration-150 font-medium">
                                Cadastrar Raça
                            </button>
                            <button type="button" onclick="clearRaceLibraryForm()" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                                Limpar
                            </button>
                        </div>
                        
                        <!-- Botão de Cancelar (só aparece durante edição) -->
                        <div id="race-cancel-edit" class="hidden">
                            <button type="button" onclick="cancelRaceLibraryEdit()" 
                                    class="w-full px-3 py-1 bg-gray-600 text-white rounded text-xs md:text-sm hover:bg-gray-700 transition duration-150">
                                Cancelar Edição
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal do Sistema de Gestão de Funcionalidades -->
    <div id="feature-manager-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeFeatureManagerModal()">
        <div class="themed-bg-surface text-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[95vh] overflow-hidden border-t-4 border-blue-500" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b themed-border">
                <h3 class="text-xl font-bold themed-text-primary flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    🚀 Gestão de Funcionalidades
                </h3>
                <button onclick="closeFeatureManagerModal()" class="themed-text-muted hover:themed-text-base transition duration-150">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Tabs do Feature Manager -->
            <div class="flex border-b themed-border bg-gray-800">
                <button onclick="switchFeatureTab('kanban')" id="feature-tab-kanban" class="px-4 py-2 text-sm font-medium bg-blue-600 text-white">
                    📋 Kanban
                </button>
                <button onclick="switchFeatureTab('list')" id="feature-tab-list" class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white">
                    📝 Lista
                </button>
                <button onclick="switchFeatureTab('dashboard')" id="feature-tab-dashboard" class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white">
                    📊 Dashboard
                </button>
                <button onclick="switchFeatureTab('add')" id="feature-tab-add" class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white">
                    ➕ Adicionar
                </button>
            </div>
            
            <div class="h-full max-h-[75vh] overflow-y-auto">
                <!-- Tab Kanban -->
                <div id="feature-content-kanban" class="feature-tab-content p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 h-full">
                        <!-- Backlog -->
                        <div class="bg-gray-800 rounded-lg p-3">
                            <h4 class="font-semibold text-gray-300 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>
                                Backlog
                                <span id="kanban-backlog-count" class="ml-2 text-xs bg-gray-600 px-2 py-1 rounded">0</span>
                            </h4>
                            <div id="kanban-backlog" class="space-y-2 min-h-40">
                                <!-- Cards serão inseridos aqui -->
                            </div>
                        </div>
                        
                        <!-- Em Análise -->
                        <div class="bg-gray-800 rounded-lg p-3">
                            <h4 class="font-semibold text-yellow-300 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                Em Análise
                                <span id="kanban-analysis-count" class="ml-2 text-xs bg-yellow-600 px-2 py-1 rounded">0</span>
                            </h4>
                            <div id="kanban-analysis" class="space-y-2 min-h-40">
                                <!-- Cards serão inseridos aqui -->
                            </div>
                        </div>
                        
                        <!-- Aprovada -->
                        <div class="bg-gray-800 rounded-lg p-3">
                            <h4 class="font-semibold text-blue-300 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                Aprovada
                                <span id="kanban-approved-count" class="ml-2 text-xs bg-blue-600 px-2 py-1 rounded">0</span>
                            </h4>
                            <div id="kanban-approved" class="space-y-2 min-h-40">
                                <!-- Cards serão inseridos aqui -->
                            </div>
                        </div>
                        
                        <!-- Em Desenvolvimento -->
                        <div class="bg-gray-800 rounded-lg p-3">
                            <h4 class="font-semibold text-orange-300 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-orange-500 rounded-full mr-2"></span>
                                Em Desenvolvimento
                                <span id="kanban-development-count" class="ml-2 text-xs bg-orange-600 px-2 py-1 rounded">0</span>
                            </h4>
                            <div id="kanban-development" class="space-y-2 min-h-40">
                                <!-- Cards serão inseridos aqui -->
                            </div>
                        </div>
                        
                        <!-- Implementada -->
                        <div class="bg-gray-800 rounded-lg p-3">
                            <h4 class="font-semibold text-green-300 mb-3 flex items-center">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                Implementada
                                <span id="kanban-implemented-count" class="ml-2 text-xs bg-green-600 px-2 py-1 rounded">0</span>
                            </h4>
                            <div id="kanban-implemented" class="space-y-2 min-h-40">
                                <!-- Cards serão inseridos aqui -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Lista -->
                <div id="feature-content-list" class="feature-tab-content hidden p-4">
                    <div class="mb-4 flex flex-wrap gap-2">
                        <input type="text" id="feature-search" placeholder="Buscar funcionalidades..." 
                               class="px-3 py-2 text-black rounded border border-gray-300 flex-grow">
                        <select id="feature-filter-status" class="px-3 py-2 text-black rounded border border-gray-300">
                            <option value="">Todos os Status</option>
                            <option value="Backlog">Backlog</option>
                            <option value="Em Análise">Em Análise</option>
                            <option value="Aprovada">Aprovada</option>
                            <option value="Em Desenvolvimento">Em Desenvolvimento</option>
                            <option value="Implementada">Implementada</option>
                        </select>
                        <select id="feature-filter-priority" class="px-3 py-2 text-black rounded border border-gray-300">
                            <option value="">Todas as Prioridades</option>
                            <option value="Crítica">Crítica</option>
                            <option value="Alta">Alta</option>
                            <option value="Média">Média</option>
                            <option value="Baixa">Baixa</option>
                        </select>
                        <button onclick="filterFeatureList()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                            🔍 Filtrar
                        </button>
                    </div>
                    
                    <div id="feature-list-container" class="space-y-3">
                        <!-- Lista de funcionalidades -->
                    </div>
                </div>
                
                <!-- Tab Dashboard -->
                <div id="feature-content-dashboard" class="feature-tab-content hidden p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <!-- Métricas Gerais -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-semibold text-white mb-3">📊 Métricas Gerais</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Total de Funcionalidades:</span>
                                    <span id="dashboard-total" class="font-mono">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Implementadas:</span>
                                    <span id="dashboard-implemented" class="font-mono text-green-400">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Em Desenvolvimento:</span>
                                    <span id="dashboard-development" class="font-mono text-orange-400">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Taxa de Conclusão:</span>
                                    <span id="dashboard-completion-rate" class="font-mono text-blue-400">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Por Prioridade -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-semibold text-white mb-3">🎯 Por Prioridade</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-red-400">Crítica:</span>
                                    <span id="dashboard-critical" class="font-mono">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-orange-400">Alta:</span>
                                    <span id="dashboard-high" class="font-mono">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-400">Média:</span>
                                    <span id="dashboard-medium" class="font-mono">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-400">Baixa:</span>
                                    <span id="dashboard-low" class="font-mono">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Por Categoria -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-semibold text-white mb-3">🏷️ Por Categoria</h4>
                            <div id="dashboard-categories" class="space-y-2 text-sm">
                                <!-- Será preenchido dinamicamente -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Funcionalidades Recentes -->
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-semibold text-white mb-3">⚡ Funcionalidades Recentes</h4>
                        <div id="dashboard-recent" class="space-y-2">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Tab Adicionar -->
                <div id="feature-content-add" class="feature-tab-content hidden p-4">
                    <div class="max-w-2xl mx-auto">
                        <h4 class="text-lg font-semibold text-white mb-4">
                            <span id="feature-form-title">➕ Adicionar Nova Funcionalidade</span>
                        </h4>
                        
                        <form id="feature-form" class="space-y-4">
                            <!-- Título -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Título *</label>
                                <input type="text" id="feature-title" required 
                                       class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                       placeholder="Nome curto e descritivo da funcionalidade">
                            </div>
                            
                            <!-- Descrição -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Descrição *</label>
                                <textarea id="feature-description" required rows="3"
                                          class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                          placeholder="Detalhamento completo da melhoria/funcionalidade"></textarea>
                            </div>
                            
                            <!-- Grid de campos -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Prioridade -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Prioridade</label>
                                    <select id="feature-priority" class="w-full px-3 py-2 text-black rounded border border-gray-300">
                                        <option value="Baixa">Baixa</option>
                                        <option value="Média" selected>Média</option>
                                        <option value="Alta">Alta</option>
                                        <option value="Crítica">Crítica</option>
                                    </select>
                                </div>
                                
                                <!-- Categoria -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Categoria</label>
                                    <select id="feature-category" class="w-full px-3 py-2 text-black rounded border border-gray-300">
                                        <option value="Feature">Feature</option>
                                        <option value="Bug">Bug</option>
                                        <option value="Melhoria">Melhoria</option>
                                        <option value="Refatoração">Refatoração</option>
                                        <option value="Documentação">Documentação</option>
                                        <option value="Performance">Performance</option>
                                        <option value="UI/UX">UI/UX</option>
                                        <option value="Segurança">Segurança</option>
                                    </select>
                                </div>
                                
                                <!-- Módulo -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Módulo/Área</label>
                                    <select id="feature-module" class="w-full px-3 py-2 text-black rounded border border-gray-300">
                                        <option value="Geral">Geral</option>
                                        <option value="Fichas">Fichas</option>
                                        <option value="Bibliotecas">Bibliotecas</option>
                                        <option value="Backup">Backup</option>
                                        <option value="Interface">Interface</option>
                                        <option value="Performance">Performance</option>
                                        <option value="Mobile">Mobile</option>
                                        <option value="Acessibilidade">Acessibilidade</option>
                                    </select>
                                </div>
                                
                                <!-- Esforço -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Esforço Estimado</label>
                                    <select id="feature-effort" class="w-full px-3 py-2 text-black rounded border border-gray-300">
                                        <option value="Pequeno">Pequeno (< 2h)</option>
                                        <option value="Médio" selected>Médio (2-8h)</option>
                                        <option value="Grande">Grande (8-24h)</option>
                                        <option value="Épico">Épico (> 24h)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Autor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Criador/Autor</label>
                                <input type="text" id="feature-author" 
                                       class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                       placeholder="Quem sugeriu esta funcionalidade" value="Sorentto">
                            </div>
                            
                            <!-- Observações -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Observações</label>
                                <textarea id="feature-notes" rows="2"
                                          class="w-full px-3 py-2 text-black rounded border border-gray-300"
                                          placeholder="Informações adicionais, dependências, etc."></textarea>
                            </div>
                            
                            <!-- Botões -->
                            <div class="flex gap-2 pt-4">
                                <button type="submit" id="feature-submit-btn" 
                                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 font-medium">
                                    Adicionar Funcionalidade
                                </button>
                                <button type="button" onclick="clearFeatureForm()" 
                                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 text-sm">
                                    Limpar
                                </button>
                            </div>
                            
                            <!-- Botão de Cancelar (só aparece durante edição) -->
                            <div id="feature-cancel-edit" class="hidden">
                                <button type="button" onclick="cancelFeatureEdit()" 
                                        class="w-full px-3 py-1 bg-gray-600 text-white rounded text-xs md:text-sm hover:bg-gray-700 transition duration-150">
                                    Cancelar Edição
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Status -->
    <div id="status-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden no-print" style="z-index: 1000;" onclick="closeStatusSelectionModal()">
        <div class="themed-bg-surface text-white rounded-xl shadow-2xl w-full max-w-lg max-h-[85vh] flex flex-col border-t-4 border-green-500" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b themed-border">
                <h3 class="text-lg font-bold themed-text-primary flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                    </svg>
                    🔄 Alterar Status
                </h3>
                <button onclick="closeStatusSelectionModal()" class="themed-text-muted hover:themed-text-base transition duration-150">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 max-h-[60vh]">
                <!-- Funcionalidade sendo alterada -->
                <div class="mb-4 p-3 bg-gray-800 rounded-lg">
                    <h4 id="status-feature-title" class="font-medium text-white mb-1">Nome da Funcionalidade</h4>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Status atual:</span>
                        <span id="status-current-status" class="text-xs px-2 py-1 rounded bg-gray-500 text-white">
                            Status
                        </span>
                    </div>
                </div>
                
                <!-- Seleção de novo status -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-3">Novo Status:</label>
                    <div class="space-y-2 max-h-[35vh] overflow-y-auto pr-2" id="status-options">
                        <!-- Os options serão inseridos dinamicamente -->
                    </div>
                </div>
            </div>
                
            <!-- Botões de ação (fixo no final) -->
            <div class="p-4 border-t themed-border bg-gray-900"></div>
                <div class="flex gap-3">
                    <button onclick="confirmStatusChange()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 font-medium">
                        ✅ Confirmar
                    </button>
                    <button onclick="closeStatusSelectionModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 font-medium">
                        ❌ Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Funcionalidade -->
    <div id="feature-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print" onclick="closeFeatureDetailsModal()">
        <div class="themed-bg-surface text-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden border-t-4 border-blue-500" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b themed-border">
                <h3 class="text-xl font-bold themed-text-primary flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="feature-details-title">Detalhes da Funcionalidade</span>
                </h3>
                <button onclick="closeFeatureDetailsModal()" class="themed-text-muted hover:themed-text-base transition duration-150">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <!-- Cabeçalho com Status e Prioridade -->
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 id="feature-details-name" class="text-2xl font-bold text-white mb-2">Nome da Funcionalidade</h4>
                        <div class="flex gap-2 flex-wrap">
                            <span id="feature-details-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-500 text-white">
                                Status
                            </span>
                            <span id="feature-details-priority" class="px-3 py-1 rounded-full text-sm font-medium">
                                Prioridade
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Descrição -->
                <div class="mb-6">
                    <h5 class="text-lg font-semibold text-blue-300 mb-2">📝 Descrição</h5>
                    <p id="feature-details-description" class="text-gray-300 leading-relaxed bg-gray-800 p-4 rounded-lg">
                        Descrição da funcionalidade
                    </p>
                </div>
                
                <!-- Informações Técnicas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h6 class="font-semibold text-purple-300 mb-3">🏷️ Informações Técnicas</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Categoria:</span>
                                <span id="feature-details-category" class="text-white font-medium">Feature</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Módulo:</span>
                                <span id="feature-details-module" class="text-white font-medium">Geral</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Esforço:</span>
                                <span id="feature-details-effort" class="text-white font-medium">Médio</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h6 class="font-semibold text-green-300 mb-3">👤 Informações do Projeto</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Autor:</span>
                                <span id="feature-details-author" class="text-white font-medium">Sorentto</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Criado em:</span>
                                <span id="feature-details-created" class="text-white font-medium">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Atualizado em:</span>
                                <span id="feature-details-updated" class="text-white font-medium">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Observações -->
                <div id="feature-details-notes-section" class="mb-6">
                    <h5 class="text-lg font-semibold text-yellow-300 mb-2">📋 Observações</h5>
                    <div id="feature-details-notes" class="text-gray-300 bg-gray-800 p-4 rounded-lg">
                        Nenhuma observação adicional.
                    </div>
                </div>
                
                <!-- Ações -->
                <div class="flex gap-3 pt-4 border-t border-gray-700">
                    <button onclick="editFeatureFromDetails()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 font-medium">
                        ✏️ Editar
                    </button>
                    <button onclick="changeFeatureStatusFromDetails()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 font-medium">
                        🔄 Alterar Status
                    </button>
                    <button onclick="deleteFeatureFromDetails()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 font-medium">
                        🗑️ Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Item Manual -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">✚ Adicionar Item Manualmente</h3>
                <button onclick="closeModal('add-item-modal')" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" id="modal-item-name" placeholder="Nome do Item" class="md:col-span-2 w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <input type="number" id="modal-item-cost" placeholder="Custo (T$)" class="w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:border-blue-500 focus:outline-none">
                </div>
                
                <select id="modal-item-type" onchange="toggleModalWeaponFields()" class="w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:border-blue-500 focus:outline-none">
                    <option value="Outro">Outro</option>
                    <option value="Arma">Arma</option>
                    <option value="Armadura">Armadura</option>
                    <option value="Escudo">Escudo</option>
                    <option value="Anel">Anel</option>
                    <option value="Botas">Botas</option>
                    <option value="Joia">Joia</option>
                </select>
        
                <input type="number" id="modal-item-ca-bonus" placeholder="Bônus na CA (se aplicável)" class="w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:border-blue-500 focus:outline-none">
        
                <!-- Campos de Arma -->
                <div id="modal-weapon-fields" class="hidden space-y-3 p-4 bg-gray-800 rounded-lg border border-gray-700">
                     <h6 class="text-sm font-semibold text-blue-300">⚔️ Detalhes da Arma</h6>
                     <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="modal-weapon-bonus" placeholder="Bônus de Ataque (+2)" class="p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <input type="text" id="modal-weapon-damage" placeholder="Dano (1d10)" class="p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <input type="text" id="modal-weapon-threat" placeholder="Ameaça (19-20)" class="p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none col-span-2">
                     </div>
                     <textarea id="modal-weapon-special" placeholder="Característica Especial" rows="2" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"></textarea>
                </div>
        
                <textarea id="modal-item-description" placeholder="Descrição geral do item" rows="3" class="w-full p-2 rounded-lg bg-gray-800 text-white border border-gray-700 focus:border-blue-500 focus:outline-none"></textarea>
        
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal('add-item-modal')" class="flex-1 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition duration-150">
                        Cancelar
                    </button>
                    <button onclick="addItemFromModal()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150">
                        ✚ Adicionar Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Principal do App -->
    <div id="app-container" class="max-w-7xl mx-auto">
        <header class="header flex justify-between items-start mb-8 pb-4 themed-border border-b">
            <div>
                <h1 class="text-3xl font-extrabold themed-text-base">
                    <span class="themed-text-primary">Tormenta</span> <span class="themed-text-secondary">Fichas</span> (T-RPG)
                </h1>
                <div class="mt-2 text-xs themed-text-muted">
                    <p>Autor: Sorentto (Biribinha) | Email: sorentto@ymail.com | Versão: <span id="header-version">3.14.0.9</span></p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm themed-text-muted">Dados salvos localmente.</span>
                <button onclick="openSpellLibraryModal()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Biblioteca de Magias - Gerenciar Todas as Magias">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </button>
                <button onclick="openTalentLibraryModal()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Biblioteca de Talentos - Gerenciar Todos os Talentos">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </button>
                <button onclick="openItemLibraryModal()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Biblioteca de Itens - Gerenciar Armas, Armaduras e Itens">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </button>
                <button onclick="openRaceLibraryModal()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Biblioteca de Raças - Gerenciar Todas as Raças">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </button>
                <button onclick="openBackupModal()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Sistema de Backup - Criar e Gerenciar Backups">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                </button>
                <button onclick="cycleTheme()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Mudar Tema">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                </button>
                <button onclick="openHelpModal()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Central de Ajuda - Atalhos e Funcionalidades">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button onclick="showCharacterList()" class="no-print p-2 themed-bg-surface-alt themed-bg-button-hover rounded-full transition duration-150 themed-text-base" title="Voltar para a Lista de Personagens">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main id="main-content">
            <!-- Loading e Erro (Simplificado para apenas iniciar) -->
            <div id="loading-view" class="flex flex-col items-center justify-center h-64 themed-text-muted">
                <svg class="animate-spin h-8 w-8 themed-text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4">Carregando dados locais...</p>
        </div>

        <!-- 1. Lista de Personagens (Home/Dashboard Inicial) -->
        <div id="character-list-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold themed-text-base">Meus Personagens</h2>
                <div class="flex space-x-2">
                    <button onclick="importCharacter()" class="px-4 py-2 themed-bg-button themed-bg-button-hover text-white font-bold rounded-lg transition duration-150 shadow-md">Importar Personagem</button>
                    <button onclick="openModal('create-modal')" class="px-6 py-2 themed-bg-primary themed-bg-primary-hover text-white font-bold rounded-lg transition duration-150 shadow-md">
                        + Novo Personagem
                    </button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="handleFileImport(event)">
                </div>
            </div>

            <div id="char-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Personagens serão injetados aqui -->
            </div>
            
            <p id="no-chars-message" class="text-center mt-12 text-gray-500 hidden">
                Nenhum personagem encontrado. Crie o seu primeiro herói de Arton!
            </p>
        </div>

        <!-- 2. Dashboard e Ficha do Personagem -->
        <div id="character-sheet-view" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Coluna 1: Dashboard e Informações Principais -->
            <div class="lg:col-span-1 space-y-6">
                 <div class="flex flex-col space-y-2">
                    <div class="flex space-x-2 no-print">
                        <button onclick="generatePrintableView()" class="themed-bg-primary themed-bg-primary-hover px-6 py-2 w-full font-bold rounded-lg transition duration-150 text-white">Gerar Resumo</button>
                        <button onclick="saveCurrentCharacter()" class="bg-green-600 text-white px-6 py-2 w-full font-bold rounded-lg hover:bg-green-700 transition duration-150">Salvar Alterações</button>
                    </div>
                    <span id="save-feedback" class="text-green-400 text-sm text-center h-4 block"></span>
                </div>

                <!-- Informações Básicas -->
                <div class="char-details-container p-4 themed-bg-surface rounded-xl shadow-lg border-l-4 themed-border-primary">
                    <div class="flex flex-col items-center">
                        <img id="char-detail-portrait" src="https://placehold.co/128x128/1f2937/f3f4f6?text=?" alt="Retrato do Personagem" class="w-32 h-32 rounded-full object-cover object-top border-4 themed-border mb-4">
                        <div class="w-full flex space-x-2">
                            <input type="text" id="char-detail-imageUrl" oninput="updateCharacterDetails('imageUrl', this.value)" placeholder="URL da imagem" class="flex-grow themed-bg-surface-alt text-center text-xs p-2 rounded themed-border themed-ring-focus border">
                            <button onclick="document.getElementById('image-upload-input').click()" class="px-3 themed-bg-button themed-text-base text-xs rounded themed-bg-button-hover">Buscar</button>
                        </div>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                    </div>
                    <hr class="themed-border my-4">
                    <h3 class="text-xl font-bold mb-3 themed-text-primary-light">Dados Principais</h3>
                    <div class="space-y-2 text-sm">
                        <p><span class="font-semibold themed-text-muted">Nome:</span> <input type="text" id="char-detail-name" oninput="updateCharacterDetails('name', this.value)" class="print-hidden-input w-full bg-transparent themed-border border-b p-1"></p>
                        <p><span class="font-semibold themed-text-muted">Jogador:</span> <input type="text" id="char-detail-player" oninput="updateCharacterDetails('player', this.value)" class="print-hidden-input w-full bg-transparent themed-border border-b p-1"></p>
                        <p class="flex items-center gap-2">
                            <span class="font-semibold themed-text-muted">Raça:</span> 
                            <div class="flex items-center gap-2 flex-1">
                                <select id="char-detail-race" onchange="updateCharacterRace(this.value)" class="flex-1 bg-transparent themed-border border-b p-1 themed-text-base">
                                    <option value="">Selecione uma raça...</option>
                                </select>
                                <div class="relative">
                                    <div id="race-info-icon" class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help hidden" title="">
                                        ℹ
                                    </div>
                                </div>
                            </div>
                        </p>
                        <p><span class="font-semibold themed-text-muted">Classe/Nível:</span> <input type="text" id="char-detail-classLevel" oninput="updateCharacterDetails('classLevel', this.value)" class="print-hidden-input w-full bg-transparent themed-border border-b p-1"></p>
                        <p><span class="font-semibold themed-text-muted">Tendência:</span> <input type="text" id="char-detail-tendency" oninput="updateCharacterDetails('tendency', this.value)" class="print-hidden-input w-full bg-transparent themed-border border-b p-1"></p>
                    </div>
                    <hr class="themed-border my-4">
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <p><span class="font-semibold themed-text-muted">Idade:</span> <span id="display-char-age" class="themed-text-base">N/A</span></p>
                        <p><span class="font-semibold themed-text-muted">Sexo:</span> <span id="display-char-sex" class="themed-text-base">N/A</span></p>
                        <p><span class="font-semibold themed-text-muted">Tamanho:</span> <span id="display-char-size" class="themed-text-base">N/A</span></p>
                        <p><span class="font-semibold themed-text-muted">Divindade:</span> <span id="display-char-divinity" class="themed-text-base">N/A</span></p>
                        <p><span class="font-semibold themed-text-muted">Desloc.:</span> <span id="display-char-speed" class="themed-text-base">N/A</span></p>
                    </div>
                </div>

                <!-- Dashboard: PV, CA, PM e Pontos de Ação -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-card p-4 themed-bg-surface rounded-xl text-center border-b-4 border-red-500">
                        <p class="text-sm font-semibold text-red-400">PV Atual</p>
                        <input type="number" id="char-detail-pv-current" oninput="updateCharacterDetails('pvCurrent', parseInt(this.value) || 0)" class="print-hidden-input text-4xl font-extrabold w-full bg-transparent themed-text-base text-center mb-1">
                        <p class="text-xs themed-text-muted">Total: <input type="number" id="char-detail-pv-total" oninput="updateCharacterDetails('pvTotal', parseInt(this.value) || 0)" class="print-hidden-input w-12 bg-transparent border-none text-xs themed-text-muted text-center"></p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-2">
                            <div id="pv-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-card p-4 themed-bg-surface rounded-xl text-center border-b-4 border-sky-500">
                        <div class="flex items-center justify-center space-x-2">
                             <p class="text-sm font-semibold text-sky-400">CA</p>
                             <div class="group relative flex items-center">
                                <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                <span id="ca-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                            </div>
                        </div>
                        <span id="char-detail-ca-total" class="text-4xl font-extrabold w-full bg-transparent themed-text-base text-center">10</span>
                        <div class="text-xs themed-text-muted mt-2 grid grid-cols-2 gap-1 no-print">
                            <span class="text-right">Tamanho:</span> 
                            <input type="number" id="char-detail-sizeMod" value="0" oninput="updateCharacterDetails('sizeModifier', parseInt(this.value) || 0)" class="w-10 themed-bg-surface-alt rounded text-center themed-text-base">
                            <span class="text-right">Outros:</span> 
                            <input type="number" id="char-detail-ca-other" value="0" oninput="updateCharacterDetails('caOtherBonus', parseInt(this.value) || 0)" class="w-10 themed-bg-surface-alt rounded text-center themed-text-base">
                        </div>
                    </div>
                    <div class="stat-card p-4 themed-bg-surface rounded-xl text-center border-b-4 border-amber-500">
                        <p class="text-sm font-semibold text-amber-400">PM Atual</p>
                        <input type="number" id="char-detail-pm-current" oninput="updateCharacterDetails('pmCurrent', parseInt(this.value) || 0)" class="print-hidden-input text-4xl font-extrabold w-full bg-transparent themed-text-base text-center mb-1">
                        <p class="text-xs themed-text-muted">Total: <input type="number" id="char-detail-pm-total" oninput="updateCharacterDetails('pmTotal', parseInt(this.value) || 0)" class="print-hidden-input w-12 bg-transparent border-none text-xs themed-text-muted text-center"></p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-2">
                            <div id="pm-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-card p-4 themed-bg-surface rounded-xl text-center border-b-4 border-lime-500">
                        <div class="grid grid-cols-2 themed-border divide-x h-full items-center">
                            <div class="pr-2">
                                <p class="text-sm font-semibold text-lime-400">Pts Ação</p>
                                <input type="number" id="char-detail-actionPoints" oninput="updateCharacterDetails('actionPoints', parseInt(this.value) || 0)" class="print-hidden-input text-4xl font-extrabold w-full bg-transparent themed-text-base text-center">
                            </div>
                            <div class="pl-2">
                                <p class="text-sm font-semibold themed-text-muted">RD</p>
                                <input type="number" id="char-detail-rd" oninput="updateCharacterDetails('rd', parseInt(this.value) || 0)" class="print-hidden-input text-4xl font-extrabold w-full bg-transparent themed-text-base text-center">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ataques e Bônus de Dano -->
                <div class="char-details-container p-4 themed-bg-surface rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-3 themed-text-primary-light">Ataques e Bônus de Dano</h3>
                    
                    <div class="mb-4">
                        <label for="char-detail-bba" class="flex items-center space-x-2 text-sm font-medium themed-text-muted">
                            <span>BBA (Bônus Base de Ataque)</span>
                            <div class="group relative flex items-center">
                                <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                <span class="absolute bottom-full left-1/2 z-10 mb-2 w-48 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg">
                                    Procure a tabela da sua classe no livro para descobrir qual é o seu BBA por nível.
                                </span>
                            </div>
                        </label>
                         <input type="number" id="char-detail-bba" oninput="updateCharacterDetails('bba', parseInt(this.value) || 0)" class="w-full mt-1 p-2 rounded-lg themed-bg-surface-alt themed-border themed-text-base text-center font-bold text-lg border">
                    </div>
            
                    <div class="space-y-3">
                        <!-- Ataque Corpo a Corpo -->
                        <div class="p-3 themed-bg-surface-alt rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <p class="font-semibold text-red-400">Ataque Corpo a Corpo</p>
                                    <div class="group relative flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span id="ataque-corpo-a-corpo-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                    </div>
                                </div>
                                <span id="ataque-corpo-a-corpo-total" class="text-2xl font-extrabold themed-text-base">+0</span>
                            </div>
                            <div class="text-xs themed-text-muted mt-2 grid grid-cols-2 gap-2 no-print items-center">
                                <span>Outros:</span>
                                <input type="number" id="ataque-corpo-a-corpo-outros" oninput="updateCharacterDetails('ataqueCorpoACorpoOutros', parseInt(this.value) || 0)" value="0" class="w-full themed-bg-surface rounded p-1 text-center themed-text-base">
                            </div>
                        </div>
            
                        <!-- Ataque à Distância -->
                        <div class="p-3 themed-bg-surface-alt rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <p class="font-semibold text-sky-400">Ataque à Distância</p>
                                    <div class="group relative flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span id="ataque-distancia-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                    </div>
                                </div>
                                <span id="ataque-distancia-total" class="text-2xl font-extrabold themed-text-base">+0</span>
                            </div>
                            <div class="text-xs themed-text-muted mt-2 grid grid-cols-2 gap-2 no-print items-center">
                                <span>Outros:</span>
                                <input type="number" id="ataque-distancia-outros" oninput="updateCharacterDetails('ataqueDistanciaOutros', parseInt(this.value) || 0)" value="0" class="w-full themed-bg-surface rounded p-1 text-center themed-text-base">
                            </div>
                        </div>
                        
                        <!-- Ataque Mágico -->
                        <div class="p-3 themed-bg-surface-alt rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <p class="font-semibold text-purple-400">Ataque Mágico</p>
                                    <div class="group relative flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span id="ataque-magico-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                    </div>
                                </div>
                                <span id="ataque-magico-total" class="text-2xl font-extrabold themed-text-base">+0</span>
                            </div>
                            <div class="text-xs themed-text-muted mt-2 grid grid-cols-2 gap-2 no-print items-center">
                                <span>Hab. Chave:</span>
                                <select id="ataque-magico-attr" onchange="updateCharacterDetails('ataqueMagicoAttr', this.value)" class="w-full themed-bg-surface rounded p-1 text-center themed-text-base">
                                    <option value="INT">INT</option>
                                    <option value="SAB">SAB</option>
                                    <option value="CAR">CAR</option>
                                </select>
                                <span>Outros:</span>
                                <input type="number" id="ataque-magico-outros" oninput="updateCharacterDetails('ataqueMagicoOutros', parseInt(this.value) || 0)" value="0" class="w-full themed-bg-surface rounded p-1 text-center themed-text-base">
                            </div>
                        </div>
                    </div>
            
                    <hr class="themed-border my-4">
            
                    <div class="space-y-3">
                         <h4 class="text-lg font-semibold themed-text-secondary">Bônus de Dano</h4>
                         <!-- Dano Corpo a Corpo -->
                         <div class="p-3 themed-bg-surface-alt rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <p class="font-semibold text-red-400">Corpo a Corpo / Arremesso</p>
                                     <div class="group relative flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span id="dano-corpo-a-corpo-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                    </div>
                                </div>
                                <span id="dano-corpo-a-corpo-total" class="text-2xl font-extrabold themed-text-base">+0</span>
                            </div>
                             <div class="text-xs themed-text-muted mt-2 grid grid-cols-2 gap-2 no-print items-center">
                                <span>Hab. Chave:</span>
                                <select id="dano-corpo-a-corpo-attr" onchange="updateCharacterDetails('danoCorpoACorpoAttr', this.value)" class="w-full themed-bg-surface rounded p-1 text-center themed-text-base">
                                    <option value="FOR">FOR</option>
                                    <option value="DES">DES</option>
                                </select>
                            </div>
                         </div>
                         <!-- Dano Disparo -->
                         <div class="p-3 themed-bg-surface-alt rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <p class="font-semibold text-sky-400">Disparo</p>
                                     <div class="group relative flex items-center">
                                        <div class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span id="dano-disparo-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                    </div>
                                </div>
                                <span id="dano-disparo-total" class="text-2xl font-extrabold themed-text-base">+0</span>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- Testes de Resistência -->
                <div class="char-details-container p-4 themed-bg-surface rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-3 themed-text-primary-light">Testes de Resistência</h3>
                    <div id="resistances-container" class="grid grid-cols-3 gap-3">
                        
                        <!-- Fortitude -->
                        <div class="p-2 themed-bg-surface-alt rounded-lg text-center border-b-2 border-red-500">
                            <div class="flex items-center justify-center space-x-2">
                                <p class="text-xs font-semibold text-red-400">Fortitude (CON)</p>
                                <div class="group relative flex items-center">
                                    <div class="w-3 h-3 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                    <span id="fortitude-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                </div>
                            </div>
                            <span id="res-fortitude-total" class="text-3xl font-extrabold themed-text-base">+0</span>
                            <input type="number" id="res-fortitude-other" placeholder="Outros" value="0" oninput="updateResistanceOther('fortitude', parseInt(this.value) || 0)" class="print-hidden-input w-full mt-1 bg-transparent themed-border border-b text-xs text-center themed-text-muted">
                        </div>
                        
                        <!-- Reflexos -->
                        <div class="p-2 themed-bg-surface-alt rounded-lg text-center border-b-2 border-sky-500">
                            <div class="flex items-center justify-center space-x-2">
                                <p class="text-xs font-semibold text-sky-400">Reflexos (DES)</p>
                                <div class="group relative flex items-center">
                                    <div class="w-3 h-3 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                    <span id="reflexos-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                </div>
                            </div>
                            <span id="res-reflexos-total" class="text-3xl font-extrabold themed-text-base">+0</span>
                            <input type="number" id="res-reflexos-other" placeholder="Outros" value="0" oninput="updateResistanceOther('reflexos', parseInt(this.value) || 0)" class="print-hidden-input w-full mt-1 bg-transparent themed-border border-b text-xs text-center themed-text-muted">
                        </div>

                        <!-- Vontade -->
                        <div class="p-2 themed-bg-surface-alt rounded-lg text-center border-b-2 border-lime-500">
                           <div class="flex items-center justify-center space-x-2">
                                <p class="text-xs font-semibold text-lime-400">Vontade (SAB)</p>
                                <div class="group relative flex items-center">
                                    <div class="w-3 h-3 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                    <span id="vontade-tooltip" class="absolute bottom-full left-1/2 z-10 mb-2 w-64 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg"></span>
                                </div>
                            </div>
                            <span id="res-vontade-total" class="text-3xl font-extrabold themed-text-base">+0</span>
                            <input type="number" id="res-vontade-other" placeholder="Outros" value="0" oninput="updateResistanceOther('vontade', parseInt(this.value) || 0)" class="print-hidden-input w-full mt-1 bg-transparent themed-border border-b text-xs text-center themed-text-muted">
                        </div>

                    </div>
                </div>

            </div>

            <!-- Coluna 2 e 3: Abas de Detalhes -->
            <div class="lg:col-span-2">
                <div class="char-details-container themed-bg-surface rounded-xl shadow-2xl p-6">
                    <!-- Abas -->
                    <div class="tabs flex border-b themed-border mb-6 no-print overflow-x-auto">
                        <button onclick="changeTab('tab-atributos')" class="tab-button active-tab themed-text-base px-4 py-2 font-semibold transition duration-150 border-b-2 themed-border-primary whitespace-nowrap">Atributos</button>
                        <button onclick="changeTab('tab-magias')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">Magias</button>
                        <button onclick="changeTab('tab-talentos')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">Talentos</button>
                        <button onclick="changeTab('tab-pericias')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">Perícias</button>
                        <button onclick="changeTab('tab-equipamentos')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">Equipamentos</button>
                        <button onclick="changeTab('tab-npcs')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">NPCs</button>
                        <button onclick="changeTab('tab-notas')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">Notas</button>
                        <button onclick="changeTab('tab-historico')" class="tab-button themed-text-muted px-4 py-2 font-semibold transition duration-150 border-transparent hover:themed-text-primary whitespace-nowrap">Histórico</button>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div class="tab-content">
                        
                        <div id="tab-atributos" class="active-tab">
                            <div id="attributes-container-tab" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Atributos serão injetados aqui -->
                            </div>
                        </div>
                        
                        <!-- Aba 1: Magias (ESTRUTURADA) -->
                        <div id="tab-magias" class="hidden">
                            <h4 class="text-lg font-semibold themed-text-primary-light mb-3">⚡ Magias Preparadas</h4>
                            <div class="relative mb-4 no-print">
                                <label for="spell-search-input" class="sr-only">Buscar magias preparadas</label>
                                <input type="text" 
                                       id="spell-search-input" 
                                       oninput="filterSpells()" 
                                       placeholder="Buscar magia preparada por nome, nível, escola..." 
                                       class="w-full p-2 pl-10 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-violet-500 focus:ring-2 focus:ring-violet-500 focus:ring-opacity-50"
                                       role="searchbox"
                                       aria-label="Buscar magias preparadas por nome, nível ou escola">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none" aria-hidden="true">
                                    <svg class="h-5 w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Botões de Ação -->
                            <div class="no-print flex space-x-2 mb-4">
                                <button onclick="openSpellSelectionModal()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Adicionar Magia
                                </button>
                                <button onclick="importPreparedSpells()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                    </svg>
                                    Importar Magias
                                </button>
                                <button onclick="exportCharacterSpellsToLibrary()" 
                                        class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition duration-150 flex items-center justify-center"
                                        title="Exportar magias da ficha para a biblioteca">
                                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    ⚡→📚
                                </button>
                            </div>
                            
                            <div id="magias-list" class="space-y-3"></div>
                            
                            <!-- Controles de Paginação das Magias da Ficha -->
                            <div id="character-spells-pagination-controls" class="flex items-center justify-between mt-3 px-2 py-2 themed-bg-surface-alt rounded-lg text-sm hidden">
                                <div class="flex items-center gap-2">
                                    <span class="themed-text-muted">Página:</span>
                                    <button onclick="changeCharacterSpellPage(-1)" id="character-spell-prev-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                        ← Anterior
                                    </button>
                                    <span id="character-spell-page-info" class="px-3 py-1 themed-bg-surface themed-text-base rounded border themed-border">1 / 1</span>
                                    <button onclick="changeCharacterSpellPage(1)" id="character-spell-next-btn" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                        Próxima →
                                    </button>
                                </div>
                                <div class="themed-text-muted">
                                    <span id="character-spell-total-info">0 magias</span>
                                </div>
                            </div>
                            
                            <!-- Informação sobre magias preparadas vazia -->
                            <div id="empty-prepared-spells" class="hidden text-center py-8 themed-text-muted">
                                <svg class="w-16 h-16 mx-auto mb-4 themed-text-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                                <p class="text-lg font-medium mb-2">Nenhuma magia preparada</p>
                                <p class="text-sm">Use o botão "Adicionar Magia" para selecionar magias da biblioteca ou "Importar Magias" para carregar de um arquivo.</p>
                            </div>
                        </div>

                        <!-- Aba 2: Talentos Adquiridos (REFORMULADA) -->
                        <div id="tab-talentos" class="hidden">
                            <h4 class="text-lg font-semibold themed-text-primary-light mb-3">Talentos Adquiridos</h4>
                            
                            <!-- Botões de Ação -->
                            <div class="flex flex-wrap gap-2 mb-4 no-print">
                                <button onclick="openTalentSelectionModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 text-sm">
                                    ⭐ Adicionar Talento
                                </button>
                                <button onclick="importTalentsFromLibrary()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 text-sm">
                                    📥 Importar da Biblioteca
                                </button>
                                <button onclick="exportCharacterTalentsToLibrary()" 
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-150 text-sm"
                                        title="Exportar talentos da ficha para a biblioteca">
                                    📤 Exportar → 📚
                                </button>
                            </div>
                            
                            <div class="relative mb-4 no-print">
                                <label for="talent-search-input" class="sr-only">Buscar talentos</label>
                                <input type="text" 
                                       id="talent-search-input" 
                                       oninput="filterTalents()" 
                                       placeholder="Buscar talentos adquiridos..." 
                                       class="w-full p-2 pl-10 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-violet-500 focus:ring-2 focus:ring-violet-500 focus:ring-opacity-50"
                                       role="searchbox"
                                       aria-label="Buscar talentos por nome, tipo ou pré-requisito">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none" aria-hidden="true">
                                    <svg class="h-5 w-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Mensagem explicativa -->
                            <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 mb-4 no-print">
                                <p class="text-sm text-blue-200">
                                    <span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span><strong>Dica:</strong> Use "Adicionar Talento" para selecionar da biblioteca ou "Biblioteca de Talentos" no cabeçalho para gerenciar todos os talentos.
                                    <br>Se não encontrar o talento desejado, use o botão "Biblioteca de Talentos" no cabeçalho para cadastrá-lo primeiro.
                                </p>
                            </div>
                        
                            <!-- NOVO: Calculadora de Talentos -->
                            <div class="no-print p-4 themed-bg-surface-alt rounded-lg mb-6 space-y-3">
                                <h5 class="text-md font-bold themed-text-secondary text-center">Pontos de Talento para Comprar</h5>
                                <div class="grid grid-cols-2 md:grid-cols-6 gap-3 text-center items-end">
                                    <div>
                                        <label class="block text-xs font-semibold themed-text-muted">Por Nível</label>
                                        <span id="talent-points-level" class="block w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">0</span>
                                    </div>
                                    <div>
                                        <label for="talent-points-race" class="block text-xs font-semibold themed-text-muted">Por Raça</label>
                                        <input type="number" id="talent-points-race" oninput="updateTalentPoints('race', this.value)" class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                                    </div>
                                    <div>
                                        <label for="talent-points-class" class="block text-xs font-semibold themed-text-muted">Por Classe</label>
                                        <input type="number" id="talent-points-class" oninput="updateTalentPoints('class', this.value)" class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold themed-text-muted">Por Desvantagens</label>
                                        <span id="talent-points-disadvantages" class="block w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">0</span>
                                    </div>
                                    <div>
                                        <label for="talent-points-extra" class="block text-xs font-semibold themed-text-muted">Extras (Mestre)</label>
                                        <input type="number" id="talent-points-extra" oninput="updateTalentPoints('extra', this.value)" class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                                    </div>
                                    <div class="bg-gray-900/50 p-2 rounded">
                                        <label class="block text-xs font-bold themed-text-primary-light">TOTAL</label>
                                        <span id="talent-points-total" class="text-xl font-bold themed-text-secondary">0 / 0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="talents-list" class="space-y-3"></div>
                            
                            <!-- Controles de Paginação dos Talentos da Ficha -->
                            <div id="character-talents-pagination" class="flex items-center justify-between mt-3 px-2 py-2 themed-bg-surface-alt rounded-lg text-sm hidden">
                                <div class="flex items-center gap-2">
                                    <span class="themed-text-muted">Página:</span>
                                    <button onclick="changeCharacterTalentPage(-1)" id="prev-character-talents" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                        ← Anterior
                                    </button>
                                    <span id="character-talents-page-info" class="px-3 py-1 themed-bg-surface themed-text-base rounded border themed-border">
                                        <span id="character-talents-range">1-7</span> de <span id="character-talents-total">0</span>
                                    </span>
                                    <button onclick="changeCharacterTalentPage(1)" id="next-character-talents" class="px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                        Próxima →
                                    </button>
                                </div>
                            </div>

                            <div class="no-print mt-6 border-t themed-border pt-4">
                                <h5 class="text-md font-bold text-green-400 mb-3">Cadastrar Novo Talento</h5>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                                    <input type="text" id="talent-name" placeholder="Nome do Talento (Ex: Trespassar)" class="sm:col-span-2 w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-green-500">
                                    <select id="talent-type" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border">
                                        <option value="Comprado">Comprado</option>
                                        <option value="Classe">Classe</option>
                                        <option value="Raça">Raça</option>
                                        <option value="Desvantagem">Desvantagem</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <input type="text" id="talent-prerequisite" placeholder="Pré-requisito (Ex: For 13, BBA +1)" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base mb-2 themed-border border focus:border-green-500">
                                <textarea id="talent-benefit" placeholder="Benefício/Descrição (Ex: Você pode fazer um ataque adicional...)" rows="3" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base mb-4 themed-border border focus:border-green-500"></textarea>
                        
                                <button onclick="addTalent()" class="w-full py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150">Adicionar Talento</button>
                            </div>
                        </div>

                        <!-- Aba 3: Perícias -->
                        <div id="tab-pericias" class="hidden">
                            <h4 class="text-lg font-semibold themed-text-primary-light mb-3">Perícias - Bônus Calculado</h4>
                            <div class="text-sm themed-text-muted mb-4 p-3 themed-bg-surface-alt rounded-lg">
                                <p>Regra de Graduações (Baseado em Nível Total):</p>
                                <p class="font-bold">T: Nível + 3 Graduações | NT: Nível / 2 Graduações (arred. p/ baixo)</p>
                            </div>
                            
                            <!-- Cabeçalho da Tabela de Perícias -->
                            <div class="grid grid-cols-12 gap-1 font-bold text-xs themed-text-muted py-2 border-b themed-border">
                                <span class="col-span-4 pl-2">PERÍCIA (CHAVE)</span>
                                <span class="col-span-1 text-center" title="Treinada (T) ou Não-Treinada (NT)">T/NT</span>
                                <div class="col-span-2 text-center flex items-center justify-center space-x-1">
                                    <span title="Graduações">GRAD</span>
                                    <div class="group relative flex items-center">
                                        <div class="w-3 h-3 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span class="absolute bottom-full left-1/2 z-10 mb-2 w-56 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg">T (Treinada): Nível + 3<br>NT (Não Treinada): Metade do Nível</span>
                                    </div>
                                </div>
                                <span class="col-span-2 text-center" title="Modificador de Habilidade">MOD. HAB.</span>
                                <span class="col-span-2 text-center" title="Outros Bônus">OUTROS</span>
                                <div class="col-span-1 text-center themed-text-secondary flex items-center justify-center space-x-1">
                                    <span title="Bônus Final">TOTAL</span>
                                    <div class="group relative flex items-center">
                                        <div class="w-3 h-3 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs cursor-help">ℹ</div>
                                        <span class="absolute bottom-full left-1/2 z-10 mb-2 w-48 -translate-x-1/2 transform rounded-lg bg-black/80 px-3 py-2 text-center text-xs text-white opacity-0 transition-opacity group-hover:opacity-100 shadow-lg">GRAD + MOD. HAB. + OUTROS</span>
                                    </div>
                                </div>
                            </div>

                            <div id="skills-list" class="space-y-1">
                                <!-- Perícias serão injetadas aqui -->
                            </div>
                            
                            <!-- Controles de Paginação das Perícias -->
                            <div id="character-skills-pagination" class="no-print mt-4 flex items-center justify-between text-sm themed-text-secondary" style="display: none;">
                                <button onclick="changeCharacterSkillsPage(-1)" id="prev-character-skills" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    « Anterior
                                </button>
                                <span id="character-skills-page-info" class="flex items-center gap-2">
                                    <span id="character-skills-range">0-0</span> de <span id="character-skills-total">0</span>
                                </span>
                                <button onclick="changeCharacterSkillsPage(1)" id="next-character-skills" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo »
                                </button>
                            </div>
                            
                            <!-- NOVO: Cadastro de Perícia Customizada -->
                            <div class="no-print mt-8 border-t themed-border pt-4">
                                <h5 class="text-md font-bold text-amber-400 mb-3">Cadastrar Nova Perícia (Customizada)</h5>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="md:col-span-2">
                                        <label for="new-skill-name" class="block text-xs font-semibold themed-text-muted mb-1">Nome da Perícia</label>
                                        <input type="text" id="new-skill-name" placeholder="Ex: Acrobacia Subterrânea" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-amber-500">
                                    </div>
                                    <div>
                                        <label for="new-skill-attr" class="block text-xs font-semibold themed-text-muted mb-1">Atributo Chave</label>
                                        <select id="new-skill-attr" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-amber-500">
                                            <option value="0" disabled selected>-- Selecione --</option>
                                            <option value="FOR">Força (FOR)</option>
                                            <option value="DES">Destreza (DES)</option>
                                            <option value="CON">Constituição (CON)</option>
                                            <option value="INT">Inteligência (INT)</option>
                                            <option value="SAB">Sabedoria (SAB)</option>
                                            <option value="CAR">Carisma (CAR)</option>
                                        </select>
                                    </div>
                                </div>
                                <button onclick="addCustomSkill()" class="w-full py-2 mt-4 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700 transition duration-150">Adicionar Perícia</button>
                            </div>
                        </div>
                        
                        <!-- Aba 4: Equipamentos -->
                        <div id="tab-equipamentos" class="hidden">
                            <h4 class="text-lg font-semibold themed-text-primary-light mb-3">Equipamentos e Finanças</h4>
                            
                            <!-- Seção de Finanças -->
                            <div class="no-print p-4 themed-bg-surface-alt rounded-lg mb-6 space-y-3">
                                <div class="flex justify-center items-center gap-2">
                                    <h5 class="text-md font-bold themed-text-secondary text-center">Gestão de Tibares (T$)</h5>
                                    <button onclick="openModal('currency-converter-modal')" class="p-1.5 themed-bg-surface rounded-full hover:themed-bg-button-hover transition-colors" title="Calculadora de Câmbio">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center items-end">
                                    <div>
                                        <label for="char-detail-initialTibar" class="block text-xs font-semibold themed-text-muted">Grana Inicial</label>
                                        <input type="number" id="char-detail-initialTibar" oninput="updateFinancials('initialTibar', this.value)" class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                                    </div>
                                    <div>
                                        <label for="char-detail-missionGains" class="block text-xs font-semibold themed-text-muted">Ganhos em Missões</label>
                                        <input type="number" id="char-detail-missionGains" oninput="updateFinancials('missionGains', this.value)" class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold themed-text-muted">Custo dos Itens</label>
                                        <span id="display-items-cost" class="block w-full themed-bg-surface text-center themed-text-base rounded-md p-2 mt-1 themed-border border">0</span>
                                    </div>
                                    <div class="bg-gray-900/50 p-2 rounded">
                                        <label class="block text-xs font-bold themed-text-primary-light">SALDO FINAL</label>
                                        <span id="display-total-tibar" class="text-xl font-bold themed-text-secondary">0</span>
                                    </div>
                                </div>
                            </div>

                            <hr class="themed-border my-6">
                            
            <!-- Seção de Controles de Equipamentos -->
            <div class="no-print space-y-4 mb-6">
                <h5 class="text-lg font-semibold themed-text-primary-light">Gerenciar Equipamentos</h5>
                
                <!-- Botões de Ação -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="openItemSelectionModal()" class="px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 text-center">
                        <div class="text-2xl mb-1">📦</div>
                        <div class="text-sm">Adicionar da Biblioteca</div>
                    </button>
                    <button onclick="openModal('add-item-modal')" class="px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 text-center">
                        <div class="text-2xl mb-1">✚</div>
                        <div class="text-sm">Adicionar Manualmente</div>
                    </button>
                    <button onclick="exportCharacterInventory()" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition duration-150 text-center" title="Exportar inventário como JSON">
                        <div class="text-2xl mb-1">📄</div>
                        <div class="text-sm">Exportar Inventário</div>
                    </button>
                    <button onclick="clearCharacterInventory()" class="px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition duration-150 text-center" title="Excluir todos os itens do inventário">
                        <div class="text-2xl mb-1">🗑️</div>
                        <div class="text-sm">Limpar Inventário</div>
                    </button>
                </div>
            </div>
            
            <!-- Seção do Inventário -->
            <div>
                <h4 class="text-lg font-semibold themed-text-primary-light mb-3">Inventário</h4>
                <div id="equipment-list" class="space-y-3"></div>
                
                <!-- Controles de Paginação dos Equipamentos -->
                <div id="character-equipment-pagination" class="no-print mt-4 flex items-center justify-between text-sm themed-text-secondary" style="display: none;">
                    <button onclick="changeCharacterEquipmentPage(-1)" id="prev-character-equipment" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        « Anterior
                    </button>
                    <span id="character-equipment-page-info" class="flex items-center gap-2">
                        <span id="character-equipment-range">0-0</span> de <span id="character-equipment-total">0</span>
                    </span>
                    <button onclick="changeCharacterEquipmentPage(1)" id="next-character-equipment" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        Próximo »
                    </button>
                </div>
            </div>
                        </div>

                        <!-- Aba 5: NPCs (Diário de Bordo) -->
                        <div id="tab-npcs" class="hidden">
                            <h4 class="text-lg font-semibold themed-text-primary-light mb-3">NPCs Conhecidos e Relações</h4>
                            <div id="npcs-list" class="space-y-3"></div>
                            
                            <!-- Controles de Paginação dos NPCs -->
                            <div id="character-npcs-pagination" class="no-print mt-4 flex items-center justify-between text-sm themed-text-secondary" style="display: none;">
                                <button onclick="changeCharacterNpcsPage(-1)" id="prev-character-npcs" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    « Anterior
                                </button>
                                <span id="character-npcs-page-info" class="flex items-center gap-2">
                                    <span id="character-npcs-range">0-0</span> de <span id="character-npcs-total">0</span>
                                </span>
                                <button onclick="changeCharacterNpcsPage(1)" id="next-character-npcs" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo »
                                </button>
                            </div>
                            
                            <div class="no-print mt-4 border-t themed-border pt-4">
                                <input type="text" id="new-npc-name" placeholder="Nome do NPC" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base mb-2">
                                <textarea id="new-npc-note" placeholder="Nota sobre o NPC (Onde conheceu, relação, etc.)" rows="2" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base mb-2"></textarea>
                                <button onclick="addNpc()" class="w-full py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition duration-150">Adicionar NPC</button>
                            </div>
                        </div>

                        <!-- Aba 6: Notas (Campanha/Acontecimentos) -->
                        <div id="tab-notas" class="hidden">
                            <h4 class="text-lg font-semibold themed-text-primary-light mb-3">Notas Importantes da Campanha</h4>
                            <div id="notes-list" class="space-y-3"></div>
                            
                            <!-- Controles de Paginação das Notas -->
                            <div id="character-notes-pagination" class="no-print mt-4 flex items-center justify-between text-sm themed-text-secondary" style="display: none;">
                                <button onclick="changeCharacterNotesPage(-1)" id="prev-character-notes" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    « Anterior
                                </button>
                                <span id="character-notes-page-info" class="flex items-center gap-2">
                                    <span id="character-notes-range">0-0</span> de <span id="character-notes-total">0</span>
                                </span>
                                <button onclick="changeCharacterNotesPage(1)" id="next-character-notes" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo »
                                </button>
                            </div>
                            
                            <div class="no-print mt-4 border-t themed-border pt-4">
                                <input type="text" id="new-note-title" placeholder="Resumo da Nota (Ex: Encontramos a masmorra)" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base mb-2">
                                <textarea id="new-note-text" placeholder="Descrição completa do acontecimento." rows="3" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base mb-2"></textarea>
                                <button onclick="addNote()" class="w-full py-2 bg-fuchsia-600 text-white rounded-lg hover:bg-fuchsia-700 transition duration-150">Adicionar Nota</button>
                            </div>
                        </div>
                        
                        <!-- Aba 7: Histórico -->
                        <div id="tab-historico" class="hidden space-y-6">
                            <!-- Cabeçalho do Histórico -->
                            <div class="text-center p-4 themed-bg-surface-alt rounded-lg">
                                <div class="flex items-center justify-center space-x-2">
                                    <h2 id="history-char-name" class="text-2xl font-bold themed-text-primary-light">Nome do Personagem</h2>
                                    <span class="text-2xl font-bold themed-text-primary-light">-</span>
                                    <input type="text" id="char-detail-nickname" oninput="updateCharacterDetails('nickname', this.value)" placeholder="Apelido" class="print-hidden-input text-2xl font-bold themed-text-primary-light bg-transparent p-1 w-auto">
                                </div>
                                <div class="flex items-center justify-center mt-2">
                                    <span class="text-lg italic themed-text-muted">"</span>
                                    <input type="text" id="char-detail-catchphrase" oninput="updateCharacterDetails('catchphrase', this.value)" placeholder="Frase de Efeito" class="print-hidden-input text-lg italic themed-text-muted bg-transparent text-center p-1 flex-grow">
                                    <span class="text-lg italic themed-text-muted">",</span>
                                    <span id="history-char-name-quote" class="text-lg italic themed-text-muted ml-1">Nome do Personagem</span>
                                </div>
                            </div>
                        
                            <!-- Lista de Itens do Histórico -->
                            <h4 class="text-lg font-semibold themed-text-primary-light">Características e Relações</h4>
                            <div id="history-items-list" class="space-y-3">
                                <!-- Itens do histórico serão injetados aqui -->
                            </div>
                            
                            <!-- Controles de Paginação do Histórico -->
                            <div id="character-history-pagination" class="no-print mt-4 flex items-center justify-between text-sm themed-text-secondary" style="display: none;">
                                <button onclick="changeCharacterHistoryPage(-1)" id="prev-character-history" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    « Anterior
                                </button>
                                <span id="character-history-page-info" class="flex items-center gap-2">
                                    <span id="character-history-range">0-0</span> de <span id="character-history-total">0</span>
                                </span>
                                <button onclick="changeCharacterHistoryPage(1)" id="next-character-history" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo »
                                </button>
                            </div>
                        
                            <!-- Formulário para Adicionar Item -->
                            <div class="no-print mt-6 border-t themed-border pt-4">
                                <h5 class="text-md font-bold text-green-400 mb-3">Adicionar Característica</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                                    <div class="md:col-span-1">
                                        <label for="new-history-item-desc" class="block text-xs font-semibold themed-text-muted mb-1">Descrição</label>
                                        <input type="text" id="new-history-item-desc" placeholder="Ex: Mestre Li, o Sábio Cego" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-green-500">
                                    </div>
                                    <div>
                                        <label for="new-history-item-type" class="block text-xs font-semibold themed-text-muted mb-1">Tipo</label>
                                        <select id="new-history-item-type" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-green-500">
                                            <option value="Idade">Idade</option>
                                            <option value="Sexo">Sexo</option>
                                            <option value="Tamanho">Tamanho</option>
                                            <option value="Divindade">Divindade</option>
                                            <option value="Deslocamento">Deslocamento</option>
                                            <option value="Família">Família</option>
                                            <option value="Mentores">Mentores</option>
                                            <option value="Rivais">Rivais</option>
                                            <option value="Aliados">Aliados</option>
                                            <option value="Organizações">Organizações</option>
                                            <option value="Traços de Personalidade">Traços de Personalidade</option>
                                            <option value="Medos/Fraquezas">Medos/Fraquezas</option>
                                            <option value="Origem/Local de Nascimento">Origem/Local de Nascimento</option>
                                            <option value="Status Social">Status Social</option>
                                            <option value="Crenças/Valores">Crenças/Valores</option>
                                            <option value="Objetivos">Objetivos</option>
                                            <option value="Posses Importantes">Posses Importantes</option>
                                            <option value="Outro">Outro</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label for="new-history-item-details" class="block text-xs font-semibold themed-text-muted mb-1">Detalhes (opcional)</label>
                                    <textarea id="new-history-item-details" placeholder="Adicione mais detalhes sobre esta característica, pessoa ou evento..." rows="3" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-green-500"></textarea>
                                </div>
                                <button onclick="addHistoryItem()" class="w-full py-2 mt-4 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150">Adicionar</button>
                            </div>
                            
                            <hr class="themed-border my-6 no-print">

                            <!-- Seção de Idiomas -->
                            <div>
                                <h4 class="text-lg font-semibold themed-text-primary-light">Idiomas Conhecidos</h4>
                                <div id="languages-list" class="flex flex-wrap gap-2 mt-3 mb-4">
                                    <!-- Idiomas serão injetados aqui via JS -->
                                </div>
    
                                <!-- Formulário para Adicionar Idioma -->
                                <div class="no-print mt-4 border-t themed-border pt-4">
                                    <h5 class="text-md font-bold text-sky-400 mb-3">Adicionar Idioma</h5>
                                    <div class="flex items-center gap-3">
                                        <select id="new-language-select" class="w-full p-2 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-sky-500">
                                            <!-- Opções de idiomas injetadas via JS -->
                                        </select>
                                        <button onclick="addLanguage()" class="px-6 py-2 bg-sky-600 text-white rounded-lg font-semibold hover:bg-sky-700 transition duration-150 whitespace-nowrap">Adicionar</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Textarea para Histórico Completo -->
                            <div class="mt-6 border-t themed-border pt-4">
                                <h4 class="text-lg font-semibold themed-text-primary-light mb-3">História Completa</h4>
                                <textarea id="char-detail-fullHistory" oninput="updateCharacterDetails('fullHistory', this.value)" placeholder="Descreva a jornada do seu personagem, suas origens, motivações e os eventos que o moldaram..." rows="10" class="w-full p-3 rounded-lg themed-bg-surface-alt themed-text-base themed-border border focus:border-primary"></textarea>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Script principal do aplicativo (Usando localStorage para persistência) -->
    <script type="module">
        // === BIBLIOTECA DE ITENS ===
        
        // Variáveis globais para biblioteca de itens
        let itemLibrary = [];
        let currentItemPageData = 1;
        let itemsPerPage = 20;
        let editingItemId = null;

        // Inicializar biblioteca de itens
        function initializeItemLibrary() {
            try {
                const stored = localStorage.getItem('item_library');
                if (stored) {
                    itemLibrary = JSON.parse(stored);
                    console.log('Biblioteca de itens carregada:', itemLibrary.length, 'itens');
                } else {
                    itemLibrary = [];
                    console.log('Biblioteca de itens inicializada vazia');
                }
            } catch (e) {
                console.error('Erro ao carregar biblioteca de itens:', e);
                itemLibrary = [];
            }
        }

        // Salvar biblioteca de itens
        function saveItemLibrary() {
            const startTime = performance.now();
            
            try {
                const itemDataSize = JSON.stringify(itemLibrary).length;
                
                // Verificar se os dados estão ficando grandes
                if (itemDataSize > 500000) { // 500KB
                    Logger.warn('Biblioteca de itens está ficando grande', 'LIBRARY', { 
                        tamanho: `${Math.round(itemDataSize/1024)}KB`,
                        totalItens: itemLibrary.length 
                    });
                }
                
                localStorage.setItem('item_library', JSON.stringify(itemLibrary));
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                // Log de performance se demorar mais que 100ms
                if (duration > 100) {
                    Logger.performance('Salvamento da biblioteca de itens demorou', 'LIBRARY', { 
                        tempo: `${duration.toFixed(2)}ms`,
                        totalItens: itemLibrary.length 
                    });
                }
                
                Logger.library('info', 'Biblioteca de itens salva com sucesso', { 
                    totalItens: itemLibrary.length,
                    tempo: `${duration.toFixed(2)}ms`
                });
                
            } catch (error) {
                Logger.error('Erro ao salvar biblioteca de itens', 'LIBRARY', error);
            }
        }

        // Abrir modal da biblioteca de itens
        function openItemLibraryModal() {
            const modal = document.getElementById('item-library-modal');
            if (modal) {
                // Gerenciar stack de modais se ModalManager existir
                if (window.ModalManager && ModalManager.currentModal) {
                    ModalManager.modalStack.push(ModalManager.currentModal);
                }
                
                modal.classList.remove('hidden');
                
                if (window.ModalManager) {
                    ModalManager.currentModal = 'item-library-modal';
                }
                
                if (itemLibrary.length === 0) {
                    initializeItemLibrary();
                }
                
                resetItemPagination();
                loadItemLibraryList();
                updateItemSubcategories();
            }
        }

        // Fechar modal da biblioteca de itens
        function closeItemLibraryModal() {
            const modal = document.getElementById('item-library-modal');
            if (modal) {
                modal.classList.add('hidden');
                
                // Gerenciar stack de modais se ModalManager existir
                if (window.ModalManager && ModalManager.modalStack.length > 0) {
                    ModalManager.currentModal = ModalManager.modalStack.pop();
                } else if (window.ModalManager) {
                    ModalManager.currentModal = null;
                }
            }
            
            clearItemLibraryForm();
            editingItemId = null;
        }

        // Limpar formulário da biblioteca de itens
        function clearItemLibraryForm() {
            document.getElementById('lib-item-name').value = '';
            document.getElementById('lib-item-category').value = 'arma';
            document.getElementById('lib-item-subcategory').value = 'simples';
            document.getElementById('lib-item-price').value = '';
            document.getElementById('lib-item-weight').value = '';
            document.getElementById('lib-item-combat-type').value = 'corpo-leve';
            document.getElementById('lib-item-damage').value = '';
            document.getElementById('lib-item-critical').value = '';
            document.getElementById('lib-item-range').value = '';
            document.getElementById('lib-item-damage-type').value = '';
            document.getElementById('lib-item-ac-bonus').value = '';
            document.getElementById('lib-item-max-dex').value = '';
            document.getElementById('lib-item-armor-penalty').value = '';
            document.getElementById('lib-item-description').value = '';
            
            // Ocultar info de edição
            document.getElementById('item-library-edit-info').classList.add('hidden');
            editingItemId = null;
            
            // Mostrar campos apropriados
            updateItemSubcategories();
        }

        // Atualizar subcategorias baseado na categoria
        function updateItemSubcategories() {
            const category = document.getElementById('lib-item-category').value;
            const subcategorySelect = document.getElementById('lib-item-subcategory');
            const weaponFields = document.getElementById('weapon-fields');
            const armorFields = document.getElementById('armor-fields');
            
            // Limpar opções
            subcategorySelect.innerHTML = '';
            
            // Definir subcategorias baseado na categoria
            const subcategories = {
                arma: [
                    { value: 'simples', text: 'Simples' },
                    { value: 'marciais', text: 'Marciais' },
                    { value: 'exoticas', text: 'Exóticas' }
                ],
                armadura: [
                    { value: 'leves', text: 'Leves' },
                    { value: 'medias', text: 'Médias' },
                    { value: 'pesadas', text: 'Pesadas' }
                ],
                escudo: [
                    { value: 'leves', text: 'Leves' },
                    { value: 'pesados', text: 'Pesados' }
                ],
                item: [
                    { value: 'consumivel', text: 'Consumível' },
                    { value: 'ferramenta', text: 'Ferramenta' },
                    { value: 'equipamento', text: 'Equipamento' },
                    { value: 'servicos', text: 'Serviços' },
                    { value: 'tesouro', text: 'Tesouro' },
                    { value: 'outros', text: 'Outros' }
                ]
            };
            
            // Adicionar opções
            subcategories[category].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.value;
                option.textContent = sub.text;
                subcategorySelect.appendChild(option);
            });
            
            // Mostrar/ocultar campos específicos
            if (category === 'arma') {
                weaponFields.classList.remove('hidden');
                armorFields.classList.add('hidden');
            } else if (category === 'armadura' || category === 'escudo') {
                weaponFields.classList.add('hidden');
                armorFields.classList.remove('hidden');
            } else {
                weaponFields.classList.add('hidden');
                armorFields.classList.add('hidden');
            }
        }

        // Adicionar item à biblioteca
        function addItemToLibrary() {
            const name = document.getElementById('lib-item-name').value.trim();
            const category = document.getElementById('lib-item-category').value;
            const subcategory = document.getElementById('lib-item-subcategory').value;
            const price = document.getElementById('lib-item-price').value.trim();
            const weight = document.getElementById('lib-item-weight').value.trim();
            const description = document.getElementById('lib-item-description').value.trim();

            if (!name) {
                alert('Por favor, insira o nome do item.');
                return;
            }

            // Verificar se já existe um item com o mesmo nome
            if (itemLibrary.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                alert('Já existe um item com este nome na biblioteca.');
                return;
            }

            const newItem = {
                id: Utils.generateUUID(),
                name: name,
                category: category,
                subcategory: subcategory,
                price: price,
                weight: weight,
                description: description
            };

            // Adicionar campos específicos baseado na categoria
            if (category === 'arma') {
                newItem.combatType = document.getElementById('lib-item-combat-type').value;
                newItem.damage = document.getElementById('lib-item-damage').value.trim();
                newItem.critical = document.getElementById('lib-item-critical').value.trim();
                newItem.range = document.getElementById('lib-item-range').value.trim();
                newItem.damageType = document.getElementById('lib-item-damage-type').value.trim();
            } else if (category === 'armadura' || category === 'escudo') {
                newItem.acBonus = document.getElementById('lib-item-ac-bonus').value.trim();
                newItem.maxDex = document.getElementById('lib-item-max-dex').value.trim();
                newItem.armorPenalty = document.getElementById('lib-item-armor-penalty').value.trim();
            }

            itemLibrary.push(newItem);
            saveItemLibrary();
            loadItemLibraryList();
            clearItemLibraryForm();

            showMessage('Item adicionado à biblioteca com sucesso!', 'success');
            console.log('Item adicionado:', newItem);
        }

        // Editar item da biblioteca
        function editItemFromLibrary(itemId) {
            const item = itemLibrary.find(i => i.id === itemId);
            if (!item) return;

            // Preencher formulário
            document.getElementById('lib-item-name').value = item.name || '';
            document.getElementById('lib-item-category').value = item.category || 'arma';
            document.getElementById('lib-item-price').value = item.price || '';
            document.getElementById('lib-item-weight').value = item.weight || '';
            document.getElementById('lib-item-description').value = item.description || '';

            // Atualizar subcategorias primeiro
            updateItemSubcategories();
            
            // Depois definir subcategoria
            document.getElementById('lib-item-subcategory').value = item.subcategory || '';

            // Preencher campos específicos
            if (item.category === 'arma') {
                document.getElementById('lib-item-combat-type').value = item.combatType || 'corpo-leve';
                document.getElementById('lib-item-damage').value = item.damage || '';
                document.getElementById('lib-item-critical').value = item.critical || '';
                document.getElementById('lib-item-range').value = item.range || '';
                document.getElementById('lib-item-damage-type').value = item.damageType || '';
            } else if (item.category === 'armadura' || item.category === 'escudo') {
                document.getElementById('lib-item-ac-bonus').value = item.acBonus || '';
                document.getElementById('lib-item-max-dex').value = item.maxDex || '';
                document.getElementById('lib-item-armor-penalty').value = item.armorPenalty || '';
            }

            // Mostrar info de edição
            editingItemId = itemId;
            document.getElementById('edit-item-name').textContent = item.name;
            document.getElementById('item-library-edit-info').classList.remove('hidden');
        }

        // Atualizar item na biblioteca
        function updateItemInLibrary() {
            if (!editingItemId) return;

            const itemIndex = itemLibrary.findIndex(i => i.id === editingItemId);
            if (itemIndex === -1) return;

            const name = document.getElementById('lib-item-name').value.trim();
            if (!name) {
                alert('Por favor, insira o nome do item.');
                return;
            }

            // Verificar se o nome não conflita com outro item
            const conflictItem = itemLibrary.find(item => 
                item.name.toLowerCase() === name.toLowerCase() && 
                item.id !== editingItemId
            );
            if (conflictItem) {
                alert('Já existe outro item com este nome na biblioteca.');
                return;
            }

            const category = document.getElementById('lib-item-category').value;
            const updatedItem = {
                ...itemLibrary[itemIndex],
                name: name,
                category: category,
                subcategory: document.getElementById('lib-item-subcategory').value,
                price: document.getElementById('lib-item-price').value.trim(),
                weight: document.getElementById('lib-item-weight').value.trim(),
                description: document.getElementById('lib-item-description').value.trim()
            };

            // Atualizar campos específicos baseado na categoria
            if (category === 'arma') {
                updatedItem.combatType = document.getElementById('lib-item-combat-type').value;
                updatedItem.damage = document.getElementById('lib-item-damage').value.trim();
                updatedItem.critical = document.getElementById('lib-item-critical').value.trim();
                updatedItem.range = document.getElementById('lib-item-range').value.trim();
                updatedItem.damageType = document.getElementById('lib-item-damage-type').value.trim();
                // Remover campos de armadura se existirem
                delete updatedItem.acBonus;
                delete updatedItem.maxDex;
                delete updatedItem.armorPenalty;
            } else if (category === 'armadura' || category === 'escudo') {
                updatedItem.acBonus = document.getElementById('lib-item-ac-bonus').value.trim();
                updatedItem.maxDex = document.getElementById('lib-item-max-dex').value.trim();
                updatedItem.armorPenalty = document.getElementById('lib-item-armor-penalty').value.trim();
                // Remover campos de arma se existirem
                delete updatedItem.combatType;
                delete updatedItem.damage;
                delete updatedItem.critical;
                delete updatedItem.range;
                delete updatedItem.damageType;
            } else {
                // Para itens normais, remover todos os campos específicos
                delete updatedItem.combatType;
                delete updatedItem.damage;
                delete updatedItem.critical;
                delete updatedItem.range;
                delete updatedItem.damageType;
                delete updatedItem.acBonus;
                delete updatedItem.maxDex;
                delete updatedItem.armorPenalty;
            }

            itemLibrary[itemIndex] = updatedItem;
            saveItemLibrary();
            loadItemLibraryList();
            clearItemLibraryForm();

            showMessage('Item atualizado com sucesso!', 'success');
            console.log('Item atualizado:', updatedItem);
        }

        // Cancelar edição de item
        function cancelItemLibraryEdit() {
            clearItemLibraryForm();
        }

        // Remover item da biblioteca
        function removeItemFromLibrary(itemId) {
            const item = itemLibrary.find(i => i.id === itemId);
            if (!item) return;

            if (confirm(`Tem certeza que deseja remover "${item.name}" da biblioteca?`)) {
                itemLibrary = itemLibrary.filter(i => i.id !== itemId);
                saveItemLibrary();
                loadItemLibraryList();
                showMessage('Item removido da biblioteca.', 'success');
            }
        }

        // Carregar lista da biblioteca de itens
        function loadItemLibraryList() {
            filterLibraryItems();
        }

        // Função para normalizar subcategorias (compatibilidade com acentos)
        function normalizeSubcategory(subcategory) {
            if (!subcategory) return '';
            const normalized = subcategory.toLowerCase().trim();
            
            // Mapeamento de compatibilidade
            const mappings = {
                'serviços': 'servicos',
                'servicos': 'servicos',
                'consumível': 'consumivel',
                'consumivel': 'consumivel',
                'exóticas': 'exoticas',
                'exoticas': 'exoticas',
                'médias': 'medias',
                'medias': 'medias'
            };
            
            return mappings[normalized] || normalized;
        }

        // Filtrar itens da biblioteca
        function filterLibraryItems() {
            const searchTerm = document.getElementById('item-library-search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('item-category-filter').value;
            const subcategoryFilter = document.getElementById('item-subcategory-filter').value;

            let filtered = itemLibrary.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                
                // Usar normalização para subcategorias
                const normalizedItemSubcategory = normalizeSubcategory(item.subcategory);
                const normalizedFilterSubcategory = normalizeSubcategory(subcategoryFilter);
                const matchesSubcategory = !subcategoryFilter || normalizedItemSubcategory === normalizedFilterSubcategory;

                return matchesSearch && matchesCategory && matchesSubcategory;
            });

            displayItemLibraryPage(filtered);
        }

        // Exibir página de itens da biblioteca
        function displayItemLibraryPage(filteredItems) {
            const container = document.getElementById('item-library-list');
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Verificar se a página atual ainda é válida
            if (currentItemPageData > totalPages && totalPages > 0) {
                currentItemPageData = totalPages;
            }
            
            if (totalItems === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8 text-sm">Nenhum item encontrado com os filtros aplicados.</p>';
                document.getElementById('item-pagination-controls').classList.add('hidden');
                return;
            }

            const startIndex = (currentItemPageData - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageItems = filteredItems.slice(startIndex, endIndex);

            container.innerHTML = '';
            pageItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 themed-bg-surface-alt rounded-lg border-l-4 border-blue-500 hover:themed-bg-button-hover transition duration-150';
                
                // Construir informações específicas baseado na categoria
                let specificInfo = '';
                if (item.category === 'arma') {
                    specificInfo = `
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <span><strong>Dano:</strong> ${item.damage || 'N/A'}</span>
                            <span><strong>Crítico:</strong> ${item.critical || 'N/A'}</span>
                            <span><strong>Tipo:</strong> ${item.combatType || 'N/A'}</span>
                            <span><strong>Alcance:</strong> ${item.range || 'N/A'}</span>
                        </div>`;
                } else if (item.category === 'armadura' || item.category === 'escudo') {
                    specificInfo = `
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <span><strong>Bônus CA:</strong> ${item.acBonus || 'N/A'}</span>
                            <span><strong>Máx. Dex:</strong> ${item.maxDex || 'N/A'}</span>
                            <span><strong>Penalidade:</strong> ${item.armorPenalty || 'N/A'}</span>
                        </div>`;
                }
                
                // Ícone baseado na categoria
                const categoryIcons = {
                    arma: '⚔️',
                    armadura: '🛡️',
                    escudo: '🛡️',
                    item: '📦'
                };
                
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <span class="text-lg mr-2">${categoryIcons[item.category] || '📦'}</span>
                                <h4 class="font-bold text-white">${item.name}</h4>
                                <span class="ml-2 px-2 py-1 bg-blue-600 text-white text-xs rounded">${item.subcategory || item.category}</span>
                            </div>
                            <div class="text-xs themed-text-muted mb-2">
                                <span><strong>Preço:</strong> ${formatPrice(item.price)}</span>
                                <span class="ml-3"><strong>Peso:</strong> ${formatWeight(item.weight)}</span>
                            </div>
                            ${specificInfo}
                            ${item.description ? `
                                <div class="mt-2">
                                    <div id="item-desc-short-${item.id}" class="text-xs themed-text-base">
                                        ${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}
                                        ${item.description.length > 100 ? `
                                            <button onclick="toggleItemDescription('${item.id}')" class="ml-1 text-blue-400 hover:text-blue-300 transition-colors" title="Ver descrição completa">
                                                <svg id="item-desc-arrow-${item.id}" class="inline w-3 h-3 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                    <div id="item-desc-full-${item.id}" class="text-xs themed-text-base hidden">
                                        ${item.description}
                                        ${item.description.length > 100 ? `
                                            <button onclick="toggleItemDescription('${item.id}')" class="ml-1 text-blue-400 hover:text-blue-300 transition-colors" title="Recolher descrição">
                                                <svg id="item-desc-arrow-full-${item.id}" class="inline w-3 h-3 transition-transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col gap-1 ml-3">
                            <button onclick="editItemFromLibrary('${item.id}')" class="p-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-xs transition duration-150" title="Editar">
                                ✏️
                            </button>
                            <button onclick="removeItemFromLibrary('${item.id}')" class="p-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs transition duration-150" title="Remover">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });

            // Atualizar controles de paginação
            updateItemPaginationControls(totalPages, totalItems);
        }

        // Atualizar controles de paginação de itens
        function updateItemPaginationControls(totalPages, totalItems) {
            const paginationDiv = document.getElementById('item-pagination-controls');
            const prevBtn = document.getElementById('item-prev-btn');
            const nextBtn = document.getElementById('item-next-btn');
            const pageInfo = document.getElementById('item-page-info');
            const totalInfo = document.getElementById('item-total-info');

            if (totalPages <= 1) {
                paginationDiv.classList.add('hidden');
                return;
            }

            paginationDiv.classList.remove('hidden');
            
            prevBtn.disabled = currentItemPageData <= 1;
            nextBtn.disabled = currentItemPageData >= totalPages;
            
            pageInfo.textContent = `${currentItemPageData} / ${totalPages}`;
            totalInfo.textContent = `${totalItems} itens`;
        }

        // Mudar página de itens
        function changeItemPage(direction) {
            const searchTerm = document.getElementById('item-library-search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('item-category-filter').value;
            const subcategoryFilter = document.getElementById('item-subcategory-filter').value;

            let filtered = itemLibrary.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                
                // Usar normalização para subcategorias
                const normalizedItemSubcategory = normalizeSubcategory(item.subcategory);
                const normalizedFilterSubcategory = normalizeSubcategory(subcategoryFilter);
                const matchesSubcategory = !subcategoryFilter || normalizedItemSubcategory === normalizedFilterSubcategory;

                return matchesSearch && matchesCategory && matchesSubcategory;
            });

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            
            if (direction === 1 && currentItemPageData < totalPages) {
                currentItemPageData++;
            } else if (direction === -1 && currentItemPageData > 1) {
                currentItemPageData--;
            }
            
            displayItemLibraryPage(filtered);
        }

        // Resetar paginação de itens
        function resetItemPagination() {
            currentItemPageData = 1;
        }

        // Limpar busca da biblioteca de itens
        function clearItemLibrarySearch() {
            document.getElementById('item-library-search-input').value = '';
            document.getElementById('item-category-filter').value = '';
            document.getElementById('item-subcategory-filter').value = '';
            resetItemPagination();
            filterLibraryItems();
        }

        // Exportar biblioteca de itens completa
        function exportItemLibrary() {
            if (itemLibrary.length === 0) {
                alert('Não há itens na biblioteca para exportar.');
                return;
            }

            const dataStr = JSON.stringify(itemLibrary, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `biblioteca-itens-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage(`Biblioteca de itens exportada: ${itemLibrary.length} itens`, 'success');
        }

        // Exportar itens selecionados
        function exportSelectedItems() {
            // Por enquanto, exporta todos os itens filtrados
            // No futuro, pode implementar seleção individual
            exportItemLibrary();
        }

        // Importar biblioteca de itens
        function importItemLibrary() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedItems = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedItems)) {
                            alert('Arquivo JSON inválido. Deve conter um array de itens.');
                            return;
                        }
                        
                        let importedCount = 0;
                        let skippedCount = 0;
                        
                        importedItems.forEach(item => {
                            if (!item.name || !item.category) {
                                skippedCount++;
                                return;
                            }
                            
                            // Verificar se já existe
                            const exists = itemLibrary.some(existing => 
                                existing.name.toLowerCase() === item.name.toLowerCase()
                            );
                            
                            if (!exists) {
                                // Garantir que tem um ID válido
                                if (!item.id) {
                                    item.id = Utils.generateUUID();
                                }
                                itemLibrary.push(item);
                                importedCount++;
                            } else {
                                skippedCount++;
                            }
                        });
                        
                        saveItemLibrary();
                        loadItemLibraryList();
                        
                        showMessage(
                            `Importação concluída! ${importedCount} itens importados, ${skippedCount} ignorados (duplicados ou inválidos).`,
                            'success'
                        );
                        
                    } catch (error) {
                        console.error('Erro ao importar:', error);
                        alert('Erro ao processar arquivo JSON. Verifique o formato.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Limpar todos os itens
        function clearAllItems() {
            if (itemLibrary.length === 0) {
                alert('A biblioteca já está vazia.');
                return;
            }
            
            if (confirm(`Tem certeza que deseja remover TODOS os ${itemLibrary.length} itens da biblioteca? Esta ação é irreversível.`)) {
                itemLibrary = [];
                saveItemLibrary();
                loadItemLibraryList();
                showMessage('Todos os itens foram removidos da biblioteca.', 'info');
            }
        }

        // Função para formatar preço (evita duplicação de unidades)
        function formatPrice(price) {
            if (!price || price === 'N/A') return 'N/A';
            
            const priceStr = String(price).trim();
            
            // Se já contém TO, não adiciona novamente
            if (priceStr.toLowerCase().includes('to') || 
                priceStr.toLowerCase().includes('tibares') ||
                priceStr.toLowerCase().includes('moeda')) {
                return priceStr;
            }
            
            // Se é apenas número, adiciona TO
            return `${priceStr} TO`;
        }

        // Função para formatar peso (evita duplicação de unidades)
        function formatWeight(weight) {
            if (!weight || weight === 'N/A') return 'N/A';
            
            const weightStr = String(weight).trim();
            
            // Se já contém kg, g, ou outras unidades, não adiciona novamente
            if (weightStr.toLowerCase().includes('kg') || 
                weightStr.toLowerCase().includes('g') ||
                weightStr.toLowerCase().includes('quilo') ||
                weightStr.toLowerCase().includes('grama')) {
                return weightStr;
            }
            
            // Se é apenas número, adiciona kg
            return `${weightStr} kg`;
        }

        // Alternar exibição da descrição completa do item
        function toggleItemDescription(itemId) {
            const shortDesc = document.getElementById(`item-desc-short-${itemId}`);
            const fullDesc = document.getElementById(`item-desc-full-${itemId}`);
            const arrow = document.getElementById(`item-desc-arrow-${itemId}`);
            const arrowFull = document.getElementById(`item-desc-arrow-full-${itemId}`);
            
            if (shortDesc && fullDesc) {
                if (shortDesc.classList.contains('hidden')) {
                    // Mostrar descrição curta, ocultar completa
                    shortDesc.classList.remove('hidden');
                    fullDesc.classList.add('hidden');
                } else {
                    // Mostrar descrição completa, ocultar curta
                    shortDesc.classList.add('hidden');
                    fullDesc.classList.remove('hidden');
                }
            }
        }

        // Tornar funções globais
        window.openItemLibraryModal = openItemLibraryModal;
        window.closeItemLibraryModal = closeItemLibraryModal;
        window.clearItemLibraryForm = clearItemLibraryForm;
        window.updateItemSubcategories = updateItemSubcategories;
        window.addItemToLibrary = addItemToLibrary;
        window.editItemFromLibrary = editItemFromLibrary;
        window.updateItemInLibrary = updateItemInLibrary;
        window.cancelItemLibraryEdit = cancelItemLibraryEdit;
        window.removeItemFromLibrary = removeItemFromLibrary;
        window.filterLibraryItems = filterLibraryItems;
        window.changeItemPage = changeItemPage;
        window.resetItemPagination = resetItemPagination;
        window.clearItemLibrarySearch = clearItemLibrarySearch;
        window.exportItemLibrary = exportItemLibrary;
        window.exportSelectedItems = exportSelectedItems;
        window.importItemLibrary = importItemLibrary;
        window.clearAllItems = clearAllItems;
        window.toggleItemDescription = toggleItemDescription;

        // === SISTEMA DE SELEÇÃO DE ITENS PARA PERSONAGEM ===
        
        let selectedItemData = null;

        // Abrir modal de seleção de itens
        function openItemSelectionModal() {
            const modal = document.getElementById('item-selection-modal');
            if (modal) {
                // Gerenciar stack de modais se ModalManager existir
                if (window.ModalManager && ModalManager.currentModal) {
                    ModalManager.modalStack.push(ModalManager.currentModal);
                }
                
                modal.classList.remove('hidden');
                
                if (window.ModalManager) {
                    ModalManager.currentModal = 'item-selection-modal';
                }
                
                // Animar modal
                setTimeout(() => {
                    const modalContent = modal.querySelector('div > div');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                // Inicializar biblioteca se necessário
                if (itemLibrary.length === 0) {
                    initializeItemLibrary();
                }
                
                loadItemSelectionList();
            }
        }

        // Fechar modal de seleção de itens
        function closeItemSelectionModal() {
            const modal = document.getElementById('item-selection-modal');
            if (modal) {
                const modalContent = modal.querySelector('div > div');
                modalContent.classList.add('scale-95', 'opacity-0');
                modalContent.classList.remove('scale-100', 'opacity-100');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    
                    // Gerenciar stack de modais se ModalManager existir
                    if (window.ModalManager && ModalManager.modalStack.length > 0) {
                        ModalManager.currentModal = ModalManager.modalStack.pop();
                    } else if (window.ModalManager) {
                        ModalManager.currentModal = null;
                    }
                }, 300);
            }
            
            selectedItemData = null;
            clearItemSelectionDetails();
        }

        // Carregar lista de itens para seleção
        function loadItemSelectionList() {
            filterItemSelection();
        }

        // Filtrar itens para seleção
        function filterItemSelection() {
            const container = document.getElementById('item-selection-list');
            if (!container) return;
            
            const searchTerm = document.getElementById('item-selection-search').value.toLowerCase();
            const categoryFilter = document.getElementById('item-selection-category').value;
            const subcategoryFilter = document.getElementById('item-selection-subcategory').value;
            
            if (itemLibrary.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhum item disponível na biblioteca. Cadastre itens na Biblioteca de Itens primeiro.</p>';
                return;
            }
            
            let filtered = itemLibrary.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                
                // Usar normalização para subcategorias
                const normalizedItemSubcategory = normalizeSubcategory(item.subcategory);
                const normalizedFilterSubcategory = normalizeSubcategory(subcategoryFilter);
                const matchesSubcategory = !subcategoryFilter || normalizedItemSubcategory === normalizedFilterSubcategory;

                return matchesSearch && matchesCategory && matchesSubcategory;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhum item encontrado com os filtros aplicados.</p>';
                return;
            }
            
            container.innerHTML = '';
            filtered.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 themed-bg-surface rounded-lg border-l-4 border-blue-500 hover:themed-bg-button-hover transition duration-150 cursor-pointer';
                itemDiv.onclick = () => selectItemForCharacter(item);
                
                // Ícone baseado na categoria
                const categoryIcons = {
                    arma: '⚔️',
                    armadura: '🛡️',
                    escudo: '🛡️',
                    item: '📦'
                };
                
                itemDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">${categoryIcons[item.category] || '📦'}</span>
                            <div>
                                <h4 class="font-bold text-white">${item.name}</h4>
                                <div class="text-xs themed-text-muted">
                                    <span>${item.subcategory || item.category}</span>
                                    <span class="ml-2">${formatPrice(item.price)}</span>
                                    <span class="ml-2">${formatWeight(item.weight)}</span>
                                </div>
                            </div>
                        </div>
                        <svg class="w-5 h-5 themed-text-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        // Selecionar item para adicionar ao personagem
        function selectItemForCharacter(item) {
            selectedItemData = item;
            
            // Remover seleção anterior
            document.querySelectorAll('#item-selection-list > div').forEach(div => {
                div.classList.remove('border-yellow-500', 'bg-yellow-900/20');
                div.classList.add('border-blue-500');
            });
            
            // Destacar item selecionado
            event.currentTarget.classList.remove('border-blue-500');
            event.currentTarget.classList.add('border-yellow-500', 'bg-yellow-900/20');
            
            // Mostrar detalhes
            showItemSelectionDetails(item);
            
            // Habilitar botão de adicionar
            document.getElementById('add-item-btn').disabled = false;
            
            // Mostrar/ocultar campos de aprimoramento baseado no tipo
            updateEnhancementVisibility(item);
        }

        // Mostrar detalhes do item selecionado
        function showItemSelectionDetails(item) {
            const container = document.getElementById('item-selection-details');
            
            // Construir informações específicas baseado na categoria
            let specificInfo = '';
            if (item.category === 'arma') {
                specificInfo = `
                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div><strong>Dano:</strong> ${item.damage || 'N/A'}</div>
                        <div><strong>Crítico:</strong> ${item.critical || 'N/A'}</div>
                        <div><strong>Tipo:</strong> ${item.combatType || 'N/A'}</div>
                        <div><strong>Alcance:</strong> ${item.range || 'N/A'}</div>
                    </div>`;
            } else if (item.category === 'armadura' || item.category === 'escudo') {
                specificInfo = `
                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div><strong>Bônus CA:</strong> ${item.acBonus || 'N/A'}</div>
                        <div><strong>Máx. Dex:</strong> ${item.maxDex || 'N/A'}</div>
                        <div class="col-span-2"><strong>Penalidade:</strong> ${item.armorPenalty || 'N/A'}</div>
                    </div>`;
            }
            
            // Ícone baseado na categoria
            const categoryIcons = {
                arma: '⚔️',
                armadura: '🛡️',
                escudo: '🛡️',
                item: '📦'
            };
            
            container.innerHTML = `
                <div class="text-center mb-4">
                    <span class="text-3xl">${categoryIcons[item.category] || '📦'}</span>
                    <h3 class="font-bold text-lg text-white mt-2">${item.name}</h3>
                    <p class="text-sm themed-text-muted">${item.subcategory || item.category}</p>
                </div>
                
                <div class="space-y-3">
                    <div class="text-sm">
                        <div><strong>Preço:</strong> ${formatPrice(item.price)}</div>
                        <div><strong>Peso:</strong> ${formatWeight(item.weight)}</div>
                    </div>
                    
                    ${specificInfo}
                    
                    ${item.description ? `
                        <div>
                            <strong class="text-sm">Descrição:</strong>
                            <p class="text-sm themed-text-base mt-1 bg-black/20 p-2 rounded">${item.description}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Limpar detalhes da seleção
        function clearItemSelectionDetails() {
            const container = document.getElementById('item-selection-details');
            container.innerHTML = '<p class="themed-text-muted text-center py-8">Selecione um item para ver os detalhes</p>';
            
            document.getElementById('add-item-btn').disabled = true;
            document.getElementById('add-enhancement-checkbox').checked = false;
            document.getElementById('enhancement-fields').classList.add('hidden');
        }

        // Atualizar visibilidade dos campos de aprimoramento
        function updateEnhancementVisibility(item) {
            const checkbox = document.getElementById('add-enhancement-checkbox');
            const fields = document.getElementById('enhancement-fields');
            
            // Mostrar opção de aprimoramento apenas para armas, armaduras e escudos
            if (item.category === 'arma' || item.category === 'armadura' || item.category === 'escudo') {
                checkbox.parentElement.style.display = 'flex';
                
                // Event listener para mostrar/ocultar campos
                checkbox.onchange = function() {
                    if (this.checked) {
                        fields.classList.remove('hidden');
                    } else {
                        fields.classList.add('hidden');
                        document.getElementById('enhancement-name').value = '';
                        document.getElementById('enhancement-bonus').value = '';
                    }
                };
            } else {
                checkbox.parentElement.style.display = 'none';
                checkbox.checked = false;
                fields.classList.add('hidden');
            }
        }

        // Limpar busca da seleção
        function clearItemSelectionSearch() {
            document.getElementById('item-selection-search').value = '';
            document.getElementById('item-selection-category').value = '';
            document.getElementById('item-selection-subcategory').value = '';
            filterItemSelection();
        }

        // Adicionar item selecionado ao personagem
        function addSelectedItemToCharacter() {
            if (!selectedItemData) return;
            if (!currentCharacterId || !characters[currentCharacterId]) {
                alert('Nenhum personagem selecionado!');
                return;
            }
            
            const item = selectedItemData;
            const addEnhancement = document.getElementById('add-enhancement-checkbox').checked;
            
            // Construir objeto do item para o personagem
            let itemName = item.name;
            let itemType = 'Outro';
            let caBonus = 0;
            let cost = parseFloat(item.price?.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            let description = item.description || '';
            
            // Definir tipo baseado na categoria
            if (item.category === 'arma') {
                itemType = 'Arma';
            } else if (item.category === 'armadura') {
                itemType = 'Armadura';
                caBonus = parseFloat(item.acBonus) || 0;
            } else if (item.category === 'escudo') {
                itemType = 'Escudo';
                caBonus = parseFloat(item.acBonus) || 0;
            }
            
            // Adicionar campos específicos de arma
            let weaponBonus = '';
            let weaponDamage = '';
            let weaponThreat = '';
            let weaponSpecial = '';
            
            if (item.category === 'arma') {
                weaponDamage = item.damage || '';
                weaponThreat = item.critical || '';
            }
            
            // Aplicar aprimoramento se selecionado
            if (addEnhancement) {
                const enhancementName = document.getElementById('enhancement-name').value.trim();
                const enhancementBonus = parseInt(document.getElementById('enhancement-bonus').value) || 0;
                
                if (enhancementName) {
                    itemName += ` ${enhancementName}`;
                    if (enhancementBonus > 0) {
                        itemName += ` +${enhancementBonus}`;
                        caBonus += enhancementBonus; // Aplicar bônus também à CA se for armadura/escudo
                        cost *= (1 + enhancementBonus); // Aumentar custo baseado no bônus
                        
                        // Para armas, aplicar bônus de ataque
                        if (item.category === 'arma' && enhancementBonus > 0) {
                            weaponBonus = `+${enhancementBonus}`;
                        }
                    }
                }
            }
            
            // Criar objeto do item seguindo o padrão da função addEquipment
            const newItem = {
                id: crypto.randomUUID(),
                name: itemName,
                type: itemType,
                cost: Math.round(cost),
                caBonus: caBonus,
                description: description,
                enhancements: []
            };
            
            // Adicionar campos específicos de arma se aplicável
            if (itemType === 'Arma') {
                newItem.bonus = weaponBonus;
                newItem.damage = weaponDamage;
                newItem.threat = weaponThreat;
                newItem.special = weaponSpecial;
            }
            
            // Adicionar item diretamente ao inventário do personagem
            const charData = characters[currentCharacterId];
            charData.equipment.push(newItem);
            hasUnsavedChanges = true;
            
            // Atualizar interface
            renderEquipmentList(charData.equipment);
            calculateAndRenderTibar(charData);
            calculateAndRenderCA(charData);
            
            // Fechar modal
            closeItemSelectionModal();
            
            // Mostrar mensagem de sucesso
            showMessage(`Item "${itemName}" adicionado ao inventário de ${charData.name || 'Personagem'} com sucesso!`, 'success');
            
            // Limpar seleção
            selectedItemData = null;
            document.getElementById('add-item-btn').disabled = true;
            
            // Reset campos de aprimoramento
            document.getElementById('add-enhancement-checkbox').checked = false;
            document.getElementById('enhancement-name').value = '';
            document.getElementById('enhancement-bonus').value = '';
            document.getElementById('enhancement-fields').classList.add('hidden');
        }

        // Tornar funções globais
        window.openItemSelectionModal = openItemSelectionModal;
        window.closeItemSelectionModal = closeItemSelectionModal;
        window.filterItemSelection = filterItemSelection;
        window.clearItemSelectionSearch = clearItemSelectionSearch;
        window.addSelectedItemToCharacter = addSelectedItemToCharacter;

        // === CONFIGURAÇÕES E CONSTANTES ===
        const CONFIG = {
            VERSION: "3.14.0.9", // Versão atual do sistema
            
            // === SISTEMA DE VERSIONAMENTO E CHANGELOG ===
            // Formato: MAJOR.MINOR.PATCH.BUILD
            // - MAJOR (3): Mudanças incompatíveis na API
            // - MINOR (14): Novas funcionalidades mantendo compatibilidade
            // - PATCH (0): Correções de bugs mantendo compatibilidade  
            // - BUILD (1-9): Pequenas melhorias e ajustes
            //
            // REGRAS DE CHANGELOG:
            // - Changelog condensado: agrupa versões BUILD (x.x.x.1-9) em uma única entrada
            // - Nova entrada no changelog apenas quando MINOR ou MAJOR mudam
            // - Versões BUILD são documentadas internamente mas não no changelog público
            // - Exemplo: v3.14.0.1 até v3.14.0.9 = uma entrada "v3.14.0"
            //           v3.15.0.0 = nova entrada "v3.15.0"
            //
            // WHEN BUILD chega a 9, incrementa PATCH e volta BUILD para 1
            // WHEN PATCH chega a 9, incrementa MINOR e volta PATCH para 0
            
            AUTO_SAVE_INTERVAL: 60000, // 1 minuto
            MAX_CHARACTERS: 50,
            DEBOUNCE_DELAY: 300,
            BACKUP_INTERVAL: 300000, // 5 minutos
            MAX_BACKUP_VERSIONS: 5,
            PERFORMANCE_THRESHOLD: 100 // ms
        };

        // === SISTEMA DE BACKUP DE ARQUIVOS ===
        /**
         * FileBackupManager - Gerencia backup automático de arquivos do sistema
         * 
         * Funcionalidades:
         * - Mantém as 2 últimas versões do arquivo principal
         * - Backup automático antes de modificações importantes
         * - Restauração de versões anteriores
         * - Limpeza automática de backups antigos
         */
        class FileBackupManager {
            static backupCount = 2; // Número máximo de backups
            static backupPrefix = 'sgptrpg_backup_';
            
            static async createBackup(reason = 'manual') {
                try {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const currentVersion = CONFIG.VERSION;
                    
                    // Simular leitura do arquivo atual (em uma aplicação real seria fetch do servidor)
                    const currentContent = document.documentElement.outerHTML;
                    
                    const backupInfo = {
                        timestamp: timestamp,
                        version: currentVersion,
                        reason: reason,
                        size: currentContent.length,
                        filename: `${this.backupPrefix}${currentVersion}_${timestamp}.html`
                    };
                    
                    // Salvar backup info no localStorage
                    const existingBackups = this.getBackupList();
                    existingBackups.unshift(backupInfo);
                    
                    // Manter apenas os últimos N backups
                    if (existingBackups.length > this.backupCount) {
                        const removed = existingBackups.splice(this.backupCount);
                        removed.forEach(backup => {
                            localStorage.removeItem(`file_backup_${backup.timestamp}`);
                        });
                    }
                    
                    // Salvar conteúdo do backup
                    localStorage.setItem(`file_backup_${timestamp}`, currentContent);
                    localStorage.setItem('file_backup_list', JSON.stringify(existingBackups));
                    
                    Logger.info('Backup de arquivo criado', backupInfo);
                    
                    if (window.NotificationManager) {
                        NotificationManager.show(
                            `💾 Backup criado: ${backupInfo.filename}`,
                            'success',
                            3000
                        );
                    }
                    
                    return backupInfo;
                } catch (e) {
                    ErrorHandler.handle(e, 'FileBackupManager.createBackup');
                    return null;
                }
            }
            
            static getBackupList() {
                try {
                    const backups = localStorage.getItem('file_backup_list');
                    return backups ? JSON.parse(backups) : [];
                } catch (e) {
                    Logger.error('Erro ao ler lista de backups', e);
                    return [];
                }
            }
            
            static getBackupContent(timestamp) {
                try {
                    return localStorage.getItem(`file_backup_${timestamp}`);
                } catch (e) {
                    Logger.error('Erro ao ler conteúdo do backup', e);
                    return null;
                }
            }
            
            static async restoreBackup(timestamp) {
                try {
                    const content = this.getBackupContent(timestamp);
                    if (!content) {
                        throw new Error('Backup não encontrado');
                    }
                    
                    // Criar backup da versão atual antes de restaurar
                    await this.createBackup('pre_restore');
                    
                    // Em uma aplicação real, isso enviaria o conteúdo para o servidor
                    // Por ora, vamos mostrar o conteúdo em uma nova janela
                    const restoreWindow = window.open('', '_blank');
                    restoreWindow.document.write(content);
                    restoreWindow.document.close();
                    
                    Logger.info('Backup restaurado', { timestamp });
                    
                    if (window.NotificationManager) {
                        NotificationManager.show(
                            '🔄 Backup restaurado em nova janela',
                            'success',
                            4000
                        );
                    }
                    
                    return true;
                } catch (e) {
                    ErrorHandler.handle(e, 'FileBackupManager.restoreBackup');
                    return false;
                }
            }
            
            static downloadBackup(timestamp) {
                try {
                    const content = this.getBackupContent(timestamp);
                    const backups = this.getBackupList();
                    const backupInfo = backups.find(b => b.timestamp === timestamp);
                    
                    if (!content || !backupInfo) {
                        throw new Error('Backup não encontrado');
                    }
                    
                    const blob = new Blob([content], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = backupInfo.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    Logger.info('Backup baixado', backupInfo);
                    
                    if (window.NotificationManager) {
                        NotificationManager.show(
                            `⬇️ Download: ${backupInfo.filename}`,
                            'success',
                            3000
                        );
                    }
                } catch (e) {
                    ErrorHandler.handle(e, 'FileBackupManager.downloadBackup');
                }
            }
            
            static clearAllBackups() {
                try {
                    const backups = this.getBackupList();
                    backups.forEach(backup => {
                        localStorage.removeItem(`file_backup_${backup.timestamp}`);
                    });
                    localStorage.removeItem('file_backup_list');
                    
                    Logger.info('Todos os backups foram removidos');
                    
                    if (window.NotificationManager) {
                        NotificationManager.show(
                            '🗑️ Todos os backups foram removidos',
                            'info',
                            3000
                        );
                    }
                } catch (e) {
                    ErrorHandler.handle(e, 'FileBackupManager.clearAllBackups');
                }
            }
            
            static getBackupStats() {
                const backups = this.getBackupList();
                const totalSize = backups.reduce((sum, backup) => sum + (backup.size || 0), 0);
                
                return {
                    count: backups.length,
                    totalSize: totalSize,
                    totalSizeMB: (totalSize / (1024 * 1024)).toFixed(2),
                    oldestBackup: backups[backups.length - 1],
                    newestBackup: backups[0]
                };
            }
        }

        // === SISTEMA DE VERSIONING ===
        /**
         * VersionManager - Gerencia a versão do sistema de forma centralizada
         * 
         * Como usar durante desenvolvimento:
         * 1. Para alterar a versão: CONFIG.VERSION = "nova.versao.aqui"
         * 2. Para atualizar automaticamente: VersionManager.setVersion("nova.versao.aqui")
         * 3. Via console: updateSystemVersion("nova.versao.aqui")
         * 4. Verificar versão atual: getCurrentVersion()
         * 
         * A versão é automaticamente aplicada em:
         * - Header principal (elemento #header-version)
         * - Modal de ajuda (elemento #modal-version)
         * - Central de ajuda - aba Dev (elemento #help-current-version)
         * - Metadados de novos personagens (CharacterManager)
         */
        class VersionManager {
            static updateVersionElements() {
                // Atualizar elementos com ID específico
                const headerVersion = document.getElementById('header-version');
                const modalVersion = document.getElementById('modal-version');
                const helpCurrentVersion = document.getElementById('help-current-version');
                
                if (headerVersion) {
                    headerVersion.textContent = CONFIG.VERSION;
                }
                
                if (modalVersion) {
                    modalVersion.textContent = CONFIG.VERSION;
                }
                
                if (helpCurrentVersion) {
                    helpCurrentVersion.textContent = CONFIG.VERSION;
                }
                
                Logger.debug('Versão atualizada em todos os elementos', CONFIG.VERSION);
            }
            
            static getVersion() {
                return CONFIG.VERSION;
            }
            
            static setVersion(newVersion) {
                // Criar backup antes de mudança de versão importante
                if (CONFIG.VERSION !== newVersion) {
                    FileBackupManager.createBackup(`version_change_${CONFIG.VERSION}_to_${newVersion}`);
                }
                
                CONFIG.VERSION = newVersion;
                this.updateVersionElements();
                Logger.info('Versão do sistema atualizada', newVersion);
            }
        }

        // === SISTEMA DE LOGS MELHORADO ===
        class Logger {
            static debug(message, data = null, context = 'SYSTEM') {
                if (console.debug) {
                    console.debug(`[DEBUG] [${context}] ${message}`, data);
                }
                this.logToStorage('debug', message, data, context);
            }

            static info(message, data = null, context = 'SYSTEM') {
                console.info(`[INFO] [${context}] ${message}`, data);
                this.logToStorage('info', message, data, context);
            }

            static warn(message, data = null, context = 'SYSTEM') {
                console.warn(`[WARN] [${context}] ${message}`, data);
                this.logToStorage('warn', message, data, context);
            }

            static error(message, error = null, context = 'SYSTEM') {
                console.error(`[ERROR] [${context}] ${message}`, error);
                this.logToStorage('error', message, error, context);
            }

            static performance(message, data = null, context = 'PERFORMANCE') {
                console.warn(`[PERFORMANCE] [${context}] ${message}`, data);
                this.logToStorage('performance', message, data, context);
            }

            // Novos métodos por categoria para facilitar uso
            static character(level, message, data = null) {
                this[level](message, data, 'CHARACTER');
            }

            static library(level, message, data = null) {
                this[level](message, data, 'LIBRARY');
            }

            static storage(level, message, data = null) {
                this[level](message, data, 'STORAGE');
            }

            static ui(level, message, data = null) {
                this[level](message, data, 'UI');
            }

            static pagination(level, message, data = null) {
                this[level](message, data, 'PAGINATION');
            }

            static logToStorage(level, message, data, context) {
                try {
                    if (isLocalStorageAvailable) {
                        const logs = JSON.parse(localStorage.getItem('tormenta_logs') || '[]');
                        const logEntry = {
                            id: crypto.randomUUID(),
                            timestamp: new Date().toISOString(),
                            timestampReadable: new Date().toLocaleString('pt-BR'),
                            level,
                            message,
                            context: context || 'SYSTEM',
                            data: data ? (typeof data === 'object' ? JSON.stringify(data) : data.toString()) : null,
                            stack: data instanceof Error ? data.stack : null,
                            userAgent: navigator.userAgent,
                            url: window.location.href,
                            version: CONFIG.VERSION,
                            sessionId: this.getSessionId()
                        };
                        
                        logs.push(logEntry);
                        
                        // Manter apenas os últimos 150 logs (aumentei de 100)
                        if (logs.length > 150) logs.splice(0, logs.length - 150);
                        
                        localStorage.setItem('tormenta_logs', JSON.stringify(logs));
                        
                        // Atualizar estatísticas em tempo real
                        this.updateLogStats();
                    }
                } catch (e) {
                    console.warn('Não foi possível salvar log:', e);
                }
            }

            static getSessionId() {
                if (!this.sessionId) {
                    this.sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                }
                return this.sessionId;
            }

            static getLogStats() {
                try {
                    const logs = this.getLogs();
                    const stats = {
                        total: logs.length,
                        byLevel: {},
                        byContext: {},
                        byTimeRange: {
                            last1Hour: 0,
                            last24Hours: 0,
                            older: 0
                        }
                    };

                    const now = new Date();
                    const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

                    logs.forEach(log => {
                        // Por nível
                        stats.byLevel[log.level] = (stats.byLevel[log.level] || 0) + 1;
                        
                        // Por contexto
                        stats.byContext[log.context] = (stats.byContext[log.context] || 0) + 1;
                        
                        // Por tempo
                        const logTime = new Date(log.timestamp);
                        if (logTime > oneHourAgo) {
                            stats.byTimeRange.last1Hour++;
                        } else if (logTime > oneDayAgo) {
                            stats.byTimeRange.last24Hours++;
                        } else {
                            stats.byTimeRange.older++;
                        }
                    });

                    return stats;
                } catch (e) {
                    console.error('Erro ao calcular estatísticas de logs:', e);
                    return { total: 0, byLevel: {}, byContext: {}, byTimeRange: {} };
                }
            }

            static updateLogStats() {
                try {
                    const stats = this.getLogStats();
                    
                    // Atualizar elementos na página se existirem
                    const statsElements = {
                        'log-stats-total': stats.total,
                        'log-stats-errors': stats.byLevel.error || 0,
                        'log-stats-warnings': stats.byLevel.warn || 0,
                        'log-stats-performance': stats.byLevel.performance || 0
                    };

                    Object.entries(statsElements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = value;
                    });
                } catch (e) {
                    // Silencioso - não queremos log de erro aqui para evitar recursão
                }
            }
            
            static getLogs() {
                try {
                    return JSON.parse(localStorage.getItem('tormenta_logs') || '[]');
                } catch (e) {
                    console.error('Erro ao carregar logs:', e);
                    return [];
                }
            }
            
            static clearLogs() {
                localStorage.removeItem('tormenta_logs');
                console.log('Logs limpos com sucesso');
            }
            
            static exportLogs() {
                const logs = this.getLogs();
                const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system_logs_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            static getLogStats() {
                const logs = this.getLogs();
                const stats = {
                    total: logs.length,
                    errors: logs.filter(log => log.level === 'error').length,
                    warnings: logs.filter(log => log.level === 'warning').length,
                    performance: logs.filter(log => log.level === 'performance').length,
                    lastLog: logs[logs.length - 1] || null,
                    oldestLog: logs[0] || null
                };
                return stats;
            }
        }

        // === TRATAMENTO DE ERROS ===
        class ErrorHandler {
            static handle(error, context = '', showToUser = true) {
                Logger.error('Erro capturado', error, context);
                
                if (showToUser) {
                    this.showUserFriendlyMessage(error, context);
                }
            }

            static showUserFriendlyMessage(error, context) {
                let message = 'Ocorreu um erro inesperado.';
                
                if (error.name === 'QuotaExceededError') {
                    message = 'Armazenamento local cheio. Considere exportar alguns personagens.';
                } else if (error.message.includes('localStorage')) {
                    message = 'Problema com armazenamento local. Suas alterações podem não ser salvas.';
                } else if (context.includes('import')) {
                    message = 'Erro ao importar arquivo. Verifique se o formato está correto.';
                } else if (context.includes('export')) {
                    message = 'Erro ao exportar personagem. Tente novamente.';
                }

                NotificationManager.show(message, 'error');
            }
        }

        // === SISTEMA DE NOTIFICAÇÕES ===
        class NotificationManager {
            static show(message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
                
                const colors = {
                    info: 'bg-blue-600 text-white',
                    success: 'bg-green-600 text-white',
                    warning: 'bg-yellow-600 text-white',
                    error: 'bg-red-600 text-white'
                };
                
                notification.className += ` ${colors[type] || colors.info}`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animar entrada
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Auto remover
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        // === UTILITÁRIOS ===
        const Utils = {
            debounce(func, delay) {
                let timeoutId;
                return function (...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            },

            formatNumber(num) {
                if (num === null || num === undefined) return '0';
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            },

            validateInput(input, type) {
                switch (type) {
                    case 'number':
                        return !isNaN(input) && isFinite(input);
                    case 'string':
                        return typeof input === 'string' && input.length > 0;
                    case 'email':
                        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
                    default:
                        return true;
                }
            },

            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            generateUUID() {
                return crypto.randomUUID ? crypto.randomUUID() : 
                    'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
            },

            measurePerformance(operation, func) {
                const start = performance.now();
                const result = func();
                const duration = performance.now() - start;
                Logger.performance(operation, duration);
                return result;
            }
        };

        // === VALIDADOR DE DADOS ===
        class DataValidator {
            static validateCharacter(charData) {
                const errors = [];
                
                if (!charData.name || charData.name.trim().length === 0) {
                    errors.push('Nome do personagem é obrigatório');
                }
                
                if (charData.name && charData.name.length > 50) {
                    errors.push('Nome muito longo (máximo 50 caracteres)');
                }
                
                // Validar atributos
                const requiredAttrs = ['FOR', 'DES', 'CON', 'INT', 'SAB', 'CAR'];
                requiredAttrs.forEach(attr => {
                    if (!charData.attributes || !charData.attributes[attr]) {
                        errors.push(`Atributo ${attr} está faltando`);
                    } else {
                        const value = charData.attributes[attr].value;
                        if (!Utils.validateInput(value, 'number') || value < 1 || value > 50) {
                            errors.push(`Valor inválido para ${attr}: ${value}`);
                        }
                    }
                });
                
                return errors;
            }

            static validateEquipment(equipment) {
                const errors = [];
                
                if (!equipment.name || equipment.name.trim().length === 0) {
                    errors.push('Nome do equipamento é obrigatório');
                }
                
                if (equipment.cost && equipment.cost < 0) {
                    errors.push('Custo não pode ser negativo');
                }
                
                return errors;
            }
        }

        // === SISTEMA DE BACKUP AUTOMÁTICO ===
        class BackupManager {
            static createBackup(charId) {
                try {
                    if (!isLocalStorageAvailable || !characters[charId]) return false;
                    
                    const backupKey = `tormenta_backup_${charId}`;
                    const existingBackups = JSON.parse(localStorage.getItem(backupKey) || '[]');
                    
                    const backup = {
                        id: Utils.generateUUID(),
                        timestamp: new Date().toISOString(),
                        data: JSON.parse(JSON.stringify(characters[charId])) // Deep copy
                    };
                    
                    existingBackups.unshift(backup);
                    
                    // Manter apenas as últimas versões
                    if (existingBackups.length > CONFIG.MAX_BACKUP_VERSIONS) {
                        existingBackups.splice(CONFIG.MAX_BACKUP_VERSIONS);
                    }
                    
                    localStorage.setItem(backupKey, JSON.stringify(existingBackups));
                    Logger.debug(`Backup criado para personagem ${charId}`);
                    return true;
                } catch (e) {
                    ErrorHandler.handle(e, 'backup');
                    return false;
                }
            }
            
            static getBackups(charId) {
                try {
                    if (!isLocalStorageAvailable) return [];
                    const backupKey = `tormenta_backup_${charId}`;
                    return JSON.parse(localStorage.getItem(backupKey) || '[]');
                } catch (e) {
                    ErrorHandler.handle(e, 'getBackups');
                    return [];
                }
            }
            
            static restoreBackup(charId, backupId) {
                try {
                    const backups = this.getBackups(charId);
                    const backup = backups.find(b => b.id === backupId);
                    
                    if (backup) {
                        characters[charId] = backup.data;
                        saveCharactersToLocalStorage();
                        NotificationManager.show('Backup restaurado com sucesso!', 'success');
                        return true;
                    }
                    return false;
                } catch (e) {
                    ErrorHandler.handle(e, 'restoreBackup');
                    return false;
                }
            }
            
            static startAutoBackup() {
                if (backupInterval) clearInterval(backupInterval);
                
                backupInterval = setInterval(() => {
                    if (currentCharacterId && hasUnsavedChanges) {
                        this.createBackup(currentCharacterId);
                    }
                }, CONFIG.BACKUP_INTERVAL);
                
                Logger.debug('Auto backup iniciado');
            }
            
            static stopAutoBackup() {
                if (backupInterval) {
                    clearInterval(backupInterval);
                    backupInterval = null;
                    Logger.debug('Auto backup parado');
                }
            }
        }

        // === GERENCIADOR DE PERSONAGENS ===
        class CharacterManager {
            static validateAndCreate(name, player) {
                const errors = [];
                
                if (!name || name.trim().length === 0) {
                    errors.push('Nome do personagem é obrigatório');
                }
                
                if (name && name.length > 50) {
                    errors.push('Nome muito longo (máximo 50 caracteres)');
                }
                
                if (Object.keys(characters).length >= CONFIG.MAX_CHARACTERS) {
                    errors.push(`Máximo de ${CONFIG.MAX_CHARACTERS} personagens atingido`);
                }
                
                if (errors.length > 0) {
                    NotificationManager.show(errors.join('. '), 'error');
                    return null;
                }
                
                return this.createCharacter(name.trim(), player?.trim() || '');
            }
            
            static createCharacter(name, player) {
                const charId = Utils.generateUUID();
                const charData = this.getDefaultCharacterData(name, player);
                
                characters[charId] = charData;
                BackupManager.createBackup(charId);
                saveCharactersToLocalStorage();
                
                Logger.debug(`Personagem criado: ${name} (${charId})`);
                NotificationManager.show(`Personagem "${name}" criado com sucesso!`, 'success');
                
                return charId;
            }
            
            static getDefaultCharacterData(name, player) {
                return {
                    id: Utils.generateUUID(),
                    name: name,
                    player: player,
                    race: "",
                    classLevel: "",
                    tendency: "",
                    age: "",
                    sex: "",
                    size: "",
                    divinity: "",
                    speed: 9,
                    imageUrl: "https://placehold.co/128x128/1f2937/f3f4f6?text=?",
                    
                    // Atributos
                    attributes: {
                        FOR: { value: 10, mod: 0 },
                        DES: { value: 10, mod: 0 },
                        CON: { value: 10, mod: 0 },
                        INT: { value: 10, mod: 0 },
                        SAB: { value: 10, mod: 0 },
                        CAR: { value: 10, mod: 0 }
                    },
                    
                    // Status
                    pvCurrent: 1, pvTotal: 1,
                    pmCurrent: 0, pmTotal: 0,
                    actionPoints: 0, rd: 0,
                    
                    // Combate
                    bba: 0,
                    caOtherBonus: 0,
                    sizeModifier: 0,
                    ataqueCorpoACorpoOutros: 0,
                    ataqueDistanciaOutros: 0,
                    ataqueMagicoOutros: 0,
                    danoCorpoACorpoOutros: 0,
                    danoDisparoOutros: 0,
                    
                    // Resistências
                    resFortitudeOutros: 0,
                    resReflexosOutros: 0,
                    resVontadeOutros: 0,
                    resistances: { fortitude: 0, reflexos: 0, vontade: 0 },
                    
                    // Dados diversos
                    skills: initializeSkillsData(),
                    languages: [],
                    spells: [],
                    talents: [],
                    equipment: [],
                    npcs: [],
                    notes: [],
                    historyItems: [],
                    history: "",
                    money: { tl: 0, to: 0, tp: 0, ts: 0 },
                    
                    // Metadados
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    version: CONFIG.VERSION
                };
            }
            
            static updateCharacter(charId, updates) {
                if (!characters[charId]) return false;
                
                try {
                    const validationErrors = DataValidator.validateCharacter({
                        ...characters[charId],
                        ...updates
                    });
                    
                    if (validationErrors.length > 0) {
                        NotificationManager.show(validationErrors.join('. '), 'warning');
                        return false;
                    }
                    
                    Object.assign(characters[charId], updates);
                    characters[charId].updatedAt = new Date().toISOString();
                    hasUnsavedChanges = true;
                    
                    return true;
                } catch (e) {
                    ErrorHandler.handle(e, 'updateCharacter');
                    return false;
                }
            }
        }

        // === SISTEMA DE CACHE E PERFORMANCE ===
        class CacheManager {
            static cache = new Map();
            static maxCacheSize = 100;
            static cacheTimeout = 300000; // 5 minutos
            
            static set(key, value, ttl = this.cacheTimeout) {
                // Limpar cache se muito grande
                if (this.cache.size >= this.maxCacheSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    value: value,
                    timestamp: Date.now(),
                    ttl: ttl
                });
            }
            
            static get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                // Verificar se expirou
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            }
            
            static invalidate(pattern) {
                const keys = Array.from(this.cache.keys());
                keys.forEach(key => {
                    if (key.includes(pattern)) {
                        this.cache.delete(key);
                    }
                });
            }
            
            static clear() {
                this.cache.clear();
            }
        }

        // === OTIMIZADOR DE RENDERIZAÇÃO ===
        class RenderOptimizer {
            static pendingUpdates = new Set();
            static isUpdateScheduled = false;
            
            static scheduleUpdate(updateFunction, key = null) {
                if (key) {
                    this.pendingUpdates.add({ fn: updateFunction, key });
                } else {
                    this.pendingUpdates.add({ fn: updateFunction, key: Math.random() });
                }
                
                if (!this.isUpdateScheduled) {
                    this.isUpdateScheduled = true;
                    requestAnimationFrame(() => {
                        this.flushUpdates();
                    });
                }
            }
            
            static flushUpdates() {
                const uniqueUpdates = new Map();
                
                // Deduplicate by key
                this.pendingUpdates.forEach(update => {
                    uniqueUpdates.set(update.key, update.fn);
                });
                
                // Execute updates
                uniqueUpdates.forEach(fn => {
                    try {
                        fn();
                    } catch (e) {
                        ErrorHandler.handle(e, 'renderUpdate', false);
                    }
                });
                
                this.pendingUpdates.clear();
                this.isUpdateScheduled = false;
            }
            
            static optimizeList(items, renderFunction, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                // Virtual scrolling para listas grandes
                if (items.length > 50) {
                    this.implementVirtualScrolling(items, renderFunction, container);
                } else {
                    container.innerHTML = items.map(renderFunction).join('');
                }
            }
            
            static implementVirtualScrolling(items, renderFunction, container) {
                const itemHeight = 60; // altura estimada de cada item
                const containerHeight = container.clientHeight;
                const visibleItems = Math.ceil(containerHeight / itemHeight) + 5; // buffer
                
                let scrollTop = container.scrollTop || 0;
                let startIndex = Math.floor(scrollTop / itemHeight);
                let endIndex = Math.min(startIndex + visibleItems, items.length);
                
                const visibleItemsData = items.slice(startIndex, endIndex);
                const offset = startIndex * itemHeight;
                
                container.innerHTML = `
                    <div style="height: ${items.length * itemHeight}px; position: relative;">
                        <div style="transform: translateY(${offset}px);">
                            ${visibleItemsData.map(renderFunction).join('')}
                        </div>
                    </div>
                `;
                
                // Add scroll listener for dynamic updates
                container.addEventListener('scroll', Utils.debounce(() => {
                    this.implementVirtualScrolling(items, renderFunction, container);
                }, 100));
            }
        }

        // === SISTEMA DE LAZY LOADING ===
        class LazyLoader {
            static loadedSections = new Set();
            
            static loadSection(sectionId, loadFunction) {
                if (this.loadedSections.has(sectionId)) {
                    return Promise.resolve();
                }
                
                return new Promise((resolve, reject) => {
                    try {
                        const result = loadFunction();
                        this.loadedSections.add(sectionId);
                        resolve(result);
                    } catch (e) {
                        reject(e);
                    }
                });
            }
            
            static unloadSection(sectionId) {
                this.loadedSections.delete(sectionId);
                CacheManager.invalidate(sectionId);
            }
        }

        // === SISTEMA DE VALIDAÇÃO EM TEMPO REAL ===
        class RealTimeValidator {
            static init() {
                this.setupCharacterNameValidation();
                this.setupFormValidation();
            }
            
            static setupCharacterNameValidation() {
                const nameInput = document.getElementById('char-name-input');
                const errorDiv = document.getElementById('char-name-error');
                const createBtn = document.getElementById('create-character-btn');
                
                if (!nameInput || !errorDiv || !createBtn) return;
                
                const validateName = Utils.debounce((value) => {
                    const errors = [];
                    
                    if (!value || value.trim().length === 0) {
                        errors.push('Nome é obrigatório');
                    } else if (value.length > 50) {
                        errors.push('Nome muito longo (máximo 50 caracteres)');
                    } else if (value.length < 2) {
                        errors.push('Nome muito curto (mínimo 2 caracteres)');
                    }
                    
                    // Verificar nomes duplicados
                    const existingNames = Object.values(characters).map(char => char.name.toLowerCase());
                    if (existingNames.includes(value.toLowerCase())) {
                        errors.push('Já existe um personagem com este nome');
                    }
                    
                    if (errors.length > 0) {
                        errorDiv.textContent = errors.join('. ');
                        errorDiv.classList.remove('hidden');
                        nameInput.classList.add('border-red-500');
                        createBtn.disabled = true;
                    } else {
                        errorDiv.classList.add('hidden');
                        nameInput.classList.remove('border-red-500');
                        createBtn.disabled = false;
                    }
                }, 300);
                
                nameInput.addEventListener('input', (e) => {
                    validateName(e.target.value);
                });
                
                nameInput.addEventListener('blur', (e) => {
                    validateName(e.target.value);
                });
            }
            
            static setupFormValidation() {
                // Validação para campos numéricos
                document.addEventListener('input', (e) => {
                    if (e.target.type === 'number') {
                        this.validateNumberInput(e.target);
                    }
                });
            }
            
            static validateNumberInput(input) {
                const value = parseFloat(input.value);
                const min = parseFloat(input.min) || -Infinity;
                const max = parseFloat(input.max) || Infinity;
                
                let isValid = true;
                let errorMessage = '';
                
                if (isNaN(value)) {
                    isValid = false;
                    errorMessage = 'Valor deve ser um número';
                } else if (value < min) {
                    isValid = false;
                    errorMessage = `Valor mínimo: ${min}`;
                } else if (value > max) {
                    isValid = false;
                    errorMessage = `Valor máximo: ${max}`;
                }
                
                // Aplicar estilo visual
                if (isValid) {
                    input.classList.remove('border-red-500');
                    this.removeFieldError(input);
                } else {
                    input.classList.add('border-red-500');
                    this.showFieldError(input, errorMessage);
                }
                
                return isValid;
            }
            
            static showFieldError(field, message) {
                let errorDiv = field.parentElement.querySelector('.field-error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'field-error text-red-400 text-xs mt-1';
                    errorDiv.setAttribute('role', 'alert');
                    field.parentElement.appendChild(errorDiv);
                }
                errorDiv.textContent = message;
            }
            
            static removeFieldError(field) {
                const errorDiv = field.parentElement.querySelector('.field-error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
        }

        // Variáveis de Estado
        let characters = {}; // { id: data, ... }
        let currentCharacterId = null;
        const LOCAL_STORAGE_KEY = 'tormenta_chars_local_data';
        let hasUnsavedChanges = false;
        let autoSaveInterval = null;
        let backupInterval = null;
        
        // === SISTEMA DE AUTO-SAVE MELHORADO ===
        class AutoSaveManager {
            static start() {
                if (autoSaveInterval) this.stop();
                
                autoSaveInterval = setInterval(() => {
                    if (hasUnsavedChanges && currentCharacterId) {
                        this.performAutoSave();
                    }
                }, CONFIG.AUTO_SAVE_INTERVAL);
                
                Logger.debug('Auto-save iniciado');
            }
            
            static stop() {
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                    Logger.debug('Auto-save parado');
                }
            }
            
            static performAutoSave() {
                try {
                    saveCharactersToLocalStorage();
                    hasUnsavedChanges = false;
                    
                    // Feedback visual discreto
                    const indicator = document.createElement('div');
                    indicator.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-3 py-1 rounded-lg text-sm z-50 opacity-0 transition-opacity duration-300';
                    indicator.textContent = 'Salvo automaticamente';
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => indicator.classList.remove('opacity-0'), 100);
                    setTimeout(() => {
                        indicator.classList.add('opacity-0');
                        setTimeout(() => indicator.remove(), 300);
                    }, 2000);
                    
                    Logger.debug('Auto-save realizado com sucesso');
                } catch (e) {
                    ErrorHandler.handle(e, 'autoSave', false);
                }
            }
        }

        // === GERENCIADOR DE MODAIS ===
        class ModalManager {
            static currentModal = null;
            static modalStack = [];
            
            static open(modalId, data = null) {
                try {
                    const modal = document.getElementById(modalId);
                    if (!modal) {
                        Logger.error(`Modal não encontrado: ${modalId}`);
                        return false;
                    }
                    
                    // Fechar modal atual se existir
                    if (this.currentModal) {
                        this.modalStack.push(this.currentModal);
                    }
                    
                    this.currentModal = modalId;
                    modal.classList.remove('hidden');
                    
                    // Adicionar listener para ESC
                    document.addEventListener('keydown', this.handleKeydown);
                    
                    // Focar no primeiro input se existir
                    const firstInput = modal.querySelector('input, textarea, select');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                    
                    Logger.debug(`Modal aberto: ${modalId}`);
                    return true;
                } catch (e) {
                    ErrorHandler.handle(e, 'openModal');
                    return false;
                }
            }
            
            static close(modalId = null) {
                try {
                    const targetModal = modalId || this.currentModal;
                    if (!targetModal) return false;
                    
                    const modal = document.getElementById(targetModal);
                    if (modal) {
                        modal.classList.add('hidden');
                        
                        // Limpar formulário se for modal de criação
                        if (targetModal.includes('create') || targetModal.includes('edit')) {
                            this.clearModalForm(modal);
                        }
                    }
                    
                    // Restaurar modal anterior se existir
                    if (this.modalStack.length > 0 && !modalId) {
                        this.currentModal = this.modalStack.pop();
                    } else {
                        this.currentModal = null;
                        document.removeEventListener('keydown', this.handleKeydown);
                    }
                    
                    Logger.debug(`Modal fechado: ${targetModal}`);
                    return true;
                } catch (e) {
                    ErrorHandler.handle(e, 'closeModal');
                    return false;
                }
            }
            
            static closeAll() {
                this.modalStack = [];
                if (this.currentModal) {
                    this.close();
                }
            }
            
            static handleKeydown = (e) => {
                if (e.key === 'Escape' && this.currentModal) {
                    this.close();
                }
            }
            
            static clearModalForm(modal) {
                const inputs = modal.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
        
        // NOVO TRATAMENTO DE ERRO: Verifica se o localStorage está disponível para evitar "SecurityError: The operation is insecure."
        let isLocalStorageAvailable = false;
        try {
            // Tenta realizar uma operação de teste
            localStorage.setItem('test_availability', 'test');
            localStorage.removeItem('test_availability');
            isLocalStorageAvailable = true;
        } catch (e) {
            console.warn("localStorage indisponível (Operation is insecure). O progresso não será salvo no dispositivo.", e);
            // Avisa o usuário no dashboard
            document.getElementById('user-info').textContent = "⚠️ Salve manual: O armazenamento local falhou.";
        }

        // Estrutura de Perícias base (Removido Conhecimento e Ofício)
        const SKILLS_BASE = [
            { name: "Acrobacia", attr: "DES", trainedOnly: true },
            { name: "Adestrar Animais", attr: "CAR", trainedOnly: true },
            { name: "Atletismo", attr: "FOR", trainedOnly: false },
            { name: "Cavalgar", attr: "DES", trainedOnly: false },
            { name: "Cura", attr: "SAB", trainedOnly: true },
            { name: "Diplomacia", attr: "CAR", trainedOnly: false },
            { name: "Enganação", attr: "CAR", trainedOnly: false },
            { name: "Furtividade", attr: "DES", trainedOnly: false },
            { name: "Identificar Magia", attr: "INT", trainedOnly: true },
            { name: "Iniciativa", attr: "DES", trainedOnly: false },
            { name: "Intimidação", attr: "CAR", trainedOnly: false },
            { name: "Intuição", attr: "SAB", trainedOnly: false },
            { name: "Ladinagem", attr: "DES", trainedOnly: true },
            { name: "Obter Informação", attr: "CAR", trainedOnly: false },
            { name: "Percepção", attr: "SAB", trainedOnly: false },
            { name: "Sobrevivência", attr: "SAB", trainedOnly: false },
        ];

        const LANGUAGES_LIST = [
            "Abissal", "Anão", "Aquan", "Auran", "Celestial", "Dracônico", "Élfico", 
            "Goblin", "Gigante", "Gnoll", "Halfling", "Ignan", "Infernal", "Orc", 
            "Silvestre", "Táurico", "Terran", "Valkar"
        ];

        // === GERENCIADOR DE ACESSIBILIDADE ===
        class AccessibilityManager {
            static init() {
                this.setupKeyboardNavigation();
                this.setupFocusManagement();
                this.setupSkipLinks();
            }
            
            static setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // Esc para fechar modal de atalhos rápidos
                    if (e.key === 'Escape') {
                        const quickShortcutsModal = document.getElementById('quick-shortcuts-modal');
                        if (quickShortcutsModal && !quickShortcutsModal.classList.contains('hidden')) {
                            closeQuickShortcutsModal();
                            return;
                        }
                    }
                    
                    // Alt+S para salvar (evita conflito com "Salvar página" do navegador)
                    if (e.altKey && e.key === 's') {
                        e.preventDefault();
                        if (currentCharacterId) {
                            window.saveCurrentCharacter();
                        }
                    }
                    
                    // Alt+N para novo personagem (evita conflito com "Nova aba" do navegador)
                    if (e.altKey && e.key === 'n') {
                        e.preventDefault();
                        ModalManager.open('create-modal');
                    }
                    
                    // Alt+E para exportar (evita conflitos com navegador)
                    if (e.altKey && e.key === 'e') {
                        e.preventDefault();
                        if (currentCharacterId) {
                            window.exportCharacter(currentCharacterId);
                        }
                    }
                    
                    // Alt+H ou F1 para abrir ajuda (evita conflito com Ctrl+H do navegador)
                    if ((e.altKey && e.key.toLowerCase() === 'h') || e.key === 'F1') {
                        e.preventDefault();
                        ModalManager.open('help-modal');
                        HelpSystem.updateDynamicHelpTexts();
                        // Focar na primeira aba
                        setTimeout(() => {
                            const firstTab = document.getElementById('help-tab-shortcuts');
                            if (firstTab) firstTab.focus();
                        }, 100);
                    }
                    
                    // Alt+K para mostrar atalhos rápidos (mais fácil de testar)
                    if (e.altKey && (e.key === 'k' || e.key === 'K' || e.code === 'KeyK')) {
                        e.preventDefault();
                        console.log('🔍 Testando atalho Alt+K para atalhos rápidos...');
                        if (window.HelpSystem && typeof HelpSystem.showKeyboardShortcuts === 'function') {
                            HelpSystem.showKeyboardShortcuts();
                            console.log('✅ HelpSystem.showKeyboardShortcuts() executado com sucesso!');
                        } else {
                            console.warn('⚠️ HelpSystem não disponível, usando fallback...');
                            // Fallback se HelpSystem não estiver disponível
                            if (window.NotificationManager) {
                                NotificationManager.show(
                                    '⌨️ Atalhos: Alt+S (Salvar) | Alt+N (Novo) | Alt+E (Exportar) | Esc (Fechar) | F1 (Ajuda)',
                                    'info',
                                    6000
                                );
                                console.log('✅ Fallback com NotificationManager executado!');
                            } else {
                                console.warn('⚠️ NotificationManager também não disponível, usando alert...');
                                alert('⌨️ Atalhos Principais:\nAlt+S: Salvar\nAlt+N: Novo personagem\nAlt+E: Exportar\nF1: Ajuda\nEsc: Fechar modal');
                            }
                        }
                    }
                    
                    // Alt+B para abrir modal de backup
                    if (e.altKey && (e.key === 'b' || e.key === 'B')) {
                        e.preventDefault();
                        console.log('🔍 Atalho Alt+B para backup acionado...');
                        if (window.openBackupModal) {
                            openBackupModal();
                            console.log('✅ Modal de backup aberto com sucesso!');
                        } else {
                            console.warn('⚠️ Modal de backup não disponível');
                        }
                    }
                    
                    // Tab navigation melhorada para abas
                    if (e.key === 'Tab' && e.target.classList.contains('tab-button')) {
                        const tabs = document.querySelectorAll('.tab-button');
                        const currentIndex = Array.from(tabs).indexOf(e.target);
                        
                        if (e.shiftKey && currentIndex > 0) {
                            e.preventDefault();
                            tabs[currentIndex - 1].focus();
                        } else if (!e.shiftKey && currentIndex < tabs.length - 1) {
                            e.preventDefault();
                            tabs[currentIndex + 1].focus();
                        }
                    }
                    
                    // Enter ou Space para ativar botões de aba
                    if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('tab-button')) {
                        e.preventDefault();
                        e.target.click();
                    }
                });
            }
            
            static setupFocusManagement() {
                // Gerenciar foco após mudanças dinâmicas
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList') {
                            // Focar primeiro elemento interativo em novos conteúdos
                            const newNodes = Array.from(mutation.addedNodes);
                            newNodes.forEach(node => {
                                if (node.nodeType === Node.ELEMENT_NODE) {
                                    const firstFocusable = node.querySelector('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');
                                    if (firstFocusable && node.classList.contains('modal-content')) {
                                        setTimeout(() => firstFocusable.focus(), 100);
                                    }
                                }
                            });
                        }
                    });
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }
            
            static setupSkipLinks() {
                // Adicionar skip links se não existirem
                if (!document.querySelector('.skip-link')) {
                    const skipLink = document.createElement('a');
                    skipLink.href = '#main-content';
                    skipLink.className = 'skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded z-50';
                    skipLink.textContent = 'Pular para conteúdo principal';
                    document.body.insertBefore(skipLink, document.body.firstChild);
                }
            }
            
            static announceToScreenReader(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                
                document.body.appendChild(announcement);
                setTimeout(() => announcement.remove(), 1000);
            }
        }

        // === SISTEMA DE NAVEGAÇÃO POR TABS ===
        class TabManager {
            static activeTab = null;
            
            static switch(tabId) {
                try {
                    // Esconder todas as abas
                    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // Remover estado ativo de todos os botões
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('themed-bg-primary', 'text-white');
                        btn.classList.add('themed-bg-surface-alt', 'themed-text-muted');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    
                    // Mostrar aba ativa
                    const activeTabContent = document.getElementById(`tab-${tabId}`);
                    const activeTabButton = document.querySelector(`[onclick*="${tabId}"]`);
                    
                    if (activeTabContent) {
                        activeTabContent.classList.remove('hidden');
                        activeTabContent.setAttribute('aria-hidden', 'false');
                    }
                    
                    if (activeTabButton) {
                        activeTabButton.classList.remove('themed-bg-surface-alt', 'themed-text-muted');
                        activeTabButton.classList.add('themed-bg-primary', 'text-white');
                        activeTabButton.setAttribute('aria-selected', 'true');
                    }
                    
                    this.activeTab = tabId;
                    AccessibilityManager.announceToScreenReader(`Aba ${tabId} ativada`);
                    Logger.debug(`Tab switched to: ${tabId}`);
                } catch (e) {
                    ErrorHandler.handle(e, 'tabSwitch');
                }
            }
        }

        // Mapeamento para nomes de atributos (para exibição)
        const ATTR_MAP = {
            FOR: "Força", DES: "Destreza", CON: "Constituição",
            INT: "Inteligência", SAB: "Sabedoria", CAR: "Carisma"
        };
        
        // --- SISTEMA DE TEMAS ---
        const THEMES = {
            dark: {
                name: 'Padrão',
                '--color-bg': '#111827',
                '--color-surface': '#1f2937',
                '--color-surface-alt': '#374151',
                '--color-border': '#4b5563',
                '--color-primary': '#8b5cf6',
                '--color-primary-hover': '#7c3aed',
                '--color-primary-light': '#a78bfa',
                '--color-secondary': '#fcd34d',
                '--color-text-base': '#f3f4f6',
                '--color-text-muted': '#9ca3af',
                '--color-button-bg': '#4b5563',
                '--color-button-bg-hover': '#6b7280'
            },
            light: {
                name: 'Claro',
                '--color-bg': '#f3f4f6',
                '--color-surface': '#ffffff',
                '--color-surface-alt': '#f9fafb',
                '--color-border': '#e5e7eb',
                '--color-primary': '#7c3aed',
                '--color-primary-hover': '#6d28d9',
                '--color-primary-light': '#8b5cf6',
                '--color-secondary': '#f59e0b',
                '--color-text-base': '#111827',
                '--color-text-muted': '#6b7280',
                '--color-button-bg': '#e5e7eb',
                '--color-button-bg-hover': '#d1d5db'
            },
            arton: {
                name: 'Floresta',
                '--color-bg': '#292524',
                '--color-surface': '#44403c',
                '--color-surface-alt': '#57534e',
                '--color-border': '#78716c',
                '--color-primary': '#a3e635',
                '--color-primary-hover': '#84cc16',
                '--color-primary-light': '#bef264',
                '--color-secondary': '#fbbf24',
                '--color-text-base': '#f5f5f4',
                '--color-text-muted': '#a8a29e',
                '--color-button-bg': '#78716c',
                '--color-button-bg-hover': '#a1a1aa'
            },
            dragon: {
                name: 'Dragão Vermelho',
                '--color-bg': '#1a0f0f',
                '--color-surface': '#2d1b1b',
                '--color-surface-alt': '#3f2626',
                '--color-border': '#5c3333',
                '--color-primary': '#dc2626',
                '--color-primary-hover': '#b91c1c',
                '--color-primary-light': '#ef4444',
                '--color-secondary': '#f59e0b',
                '--color-text-base': '#fecaca',
                '--color-text-muted': '#fca5a5',
                '--color-button-bg': '#5c3333',
                '--color-button-bg-hover': '#7f1d1d'
            },
            ocean: {
                name: 'Oceano Profundo',
                '--color-bg': '#0f172a',
                '--color-surface': '#1e293b',
                '--color-surface-alt': '#334155',
                '--color-border': '#475569',
                '--color-primary': '#0ea5e9',
                '--color-primary-hover': '#0284c7',
                '--color-primary-light': '#38bdf8',
                '--color-secondary': '#06b6d4',
                '--color-text-base': '#e2e8f0',
                '--color-text-muted': '#cbd5e1',
                '--color-button-bg': '#475569',
                '--color-button-bg-hover': '#64748b'
            },
            aurora: {
                name: 'Aurora Élfica',
                '--color-bg': '#1a0d1a',
                '--color-surface': '#2d1b2d',
                '--color-surface-alt': '#3f2a3f',
                '--color-border': '#5c3d5c',
                '--color-primary': '#ec4899',
                '--color-primary-hover': '#db2777',
                '--color-primary-light': '#f472b6',
                '--color-secondary': '#a855f7',
                '--color-text-base': '#fce7f3',
                '--color-text-muted': '#f9a8d4',
                '--color-button-bg': '#5c3d5c',
                '--color-button-bg-hover': '#7c2d7c'
            },
            forge: {
                name: 'Forja Anã',
                '--color-bg': '#1c1411',
                '--color-surface': '#2c2017',
                '--color-surface-alt': '#3d2b1f',
                '--color-border': '#57452a',
                '--color-primary': '#ea580c',
                '--color-primary-hover': '#c2410c',
                '--color-primary-light': '#fb923c',
                '--color-secondary': '#d97706',
                '--color-text-base': '#fed7aa',
                '--color-text-muted': '#fdba74',
                '--color-button-bg': '#57452a',
                '--color-button-bg-hover': '#78350f'
            },
            shadow: {
                name: 'Noite Sombria',
                '--color-bg': '#0f0a14',
                '--color-surface': '#1a0f21',
                '--color-surface-alt': '#2a1a35',
                '--color-border': '#3d2849',
                '--color-primary': '#6b21a8',
                '--color-primary-hover': '#581c87',
                '--color-primary-light': '#8b5ac0',
                '--color-secondary': '#94a3b8',
                '--color-text-base': '#e2e8f0',
                '--color-text-muted': '#cbd5e1',
                '--color-button-bg': '#3d2849',
                '--color-button-bg-hover': '#553c65'
            }
        };
        let currentTheme = 'dark';
        const themeOrder = ['dark', 'light', 'arton', 'dragon', 'ocean', 'aurora', 'forge', 'shadow'];

        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (!theme) return;
            const root = document.documentElement;
            Object.keys(theme).forEach(key => {
                if (key !== 'name') {
                    root.style.setProperty(key, theme[key]);
                }
            });
            currentTheme = themeName;
        }

        function loadSavedTheme() {
            if (isLocalStorageAvailable) {
                try {
                    const saved = localStorage.getItem('tormenta_theme');
                    if (saved && THEMES[saved]) {
                        applyTheme(saved);
                    } else {
                        applyTheme('dark'); // Padrão
                    }
                } catch (e) {
                    console.warn("Não foi possível carregar tema salvo");
                    applyTheme('dark');
                }
            }
            
            // Atualizar tooltip após carregar tema
            setTimeout(() => {
                const themeName = THEMES[currentTheme].name;
                const themeButton = document.querySelector('[title*="Mudar Tema"]');
                if (themeButton) {
                    themeButton.setAttribute('title', `Mudar Tema (Atual: ${themeName})`);
                }
            }, 100);
        }

        window.cycleTheme = function() {
            const currentIndex = themeOrder.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themeOrder.length;
            const nextTheme = themeOrder[nextIndex];
            applyTheme(nextTheme);
            
            // Mostrar notificação com o nome do tema
            const themeName = THEMES[nextTheme].name;
            if (window.NotificationManager) {
                NotificationManager.show(`Tema alterado para: ${themeName}`, 'info');
            }
            
            // Atualizar tooltip do botão
            const themeButton = document.querySelector('[title*="Mudar Tema"]');
            if (themeButton) {
                themeButton.setAttribute('title', `Mudar Tema (Atual: ${themeName})`);
            }
            
            if (isLocalStorageAvailable) {
                try {
                    localStorage.setItem('tormenta_theme', nextTheme);
                } catch (e) {
                    console.warn("Não foi possível salvar preferência de tema");
                }
            }
        }


        // --- UTILS ---

        /**
         * Tenta extrair o Nível Total do Personagem da string de Classe/Nível.
         */
        function getCharacterLevel(classLevelString) {
            if (!classLevelString) return 1;
            const parts = classLevelString.match(/\d+/g);
            if (parts && parts.length > 0) {
                return parts.reduce((sum, current) => sum + parseInt(current), 0);
            }
            return 1; // Padrão
        }
        
        function populateLanguageDropdown() {
            const select = document.getElementById('new-language-select');
            LANGUAGES_LIST.sort().forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.innerText = lang;
                select.appendChild(option);
            });
        }

        /**
         * Calcula o bônus de CA, Dano e Resistência com base no nível.
         */
        function getBonusPorNivel(level) {
            if (level >= 20) return 10;
            if (level >= 18) return 9;
            if (level >= 16) return 8;
            if (level >= 14) return 7;
            if (level >= 12) return 6;
            if (level >= 10) return 5;
            if (level >= 8) return 4;
            if (level >= 6) return 3;
            if (level >= 4) return 2;
            if (level >= 2) return 1;
            return 0;
        }

        /**
         * Inicializa o objeto de perícias com valores padrão.
         */
        function initializeSkillsData() {
            const skillsData = {};
            // Inicializa as skills base
            SKILLS_BASE.forEach(skill => {
                skillsData[skill.name] = {
                    isTrained: false, 
                    otherBonus: 0,
                };
            });
            return skillsData;
        }

        /**
         * Calcula o modificador base de resistência (Fort, Ref, Von).
         */
        function calculateResistance(level, attrMod, otherBonus) {
            const levelBonus = Math.floor(level / 2);
            return levelBonus + attrMod + (otherBonus || 0);
        }

        // --- LÓGICA DE PERSISTÊNCIA LOCAL ---
        
        /**
         * Salva o objeto 'characters' completo no localStorage.
         */
        function saveCharactersToLocalStorage() {
            const startTime = performance.now();
            
            console.log('💾 DEBUG saveCharactersToLocalStorage - iniciando...');
            console.log('💾 DEBUG saveCharactersToLocalStorage - isLocalStorageAvailable:', isLocalStorageAvailable);
            console.log('💾 DEBUG saveCharactersToLocalStorage - characters:', Object.keys(characters));
            
            if (!isLocalStorageAvailable) {
                Logger.warn('LocalStorage não disponível - dados não serão persistidos', 'STORAGE');
                return;
            }
            
            try {
                const charactersData = JSON.stringify(characters);
                const dataSize = charactersData.length;
                const numCharacters = Object.keys(characters).length;
                
                // Verificar se os dados estão ficando grandes
                if (dataSize > 1000000) { // 1MB
                    Logger.warn('Dados de personagens estão ficando muito grandes', 'CHARACTER', { 
                        tamanho: `${Math.round(dataSize/1024)}KB`,
                        totalPersonagens: numCharacters,
                        recomendacao: 'Considere fazer backup e limpar personagens antigos'
                    });
                } else if (dataSize > 500000) { // 500KB
                    Logger.warn('Dados de personagens estão ficando grandes', 'CHARACTER', { 
                        tamanho: `${Math.round(dataSize/1024)}KB`,
                        totalPersonagens: numCharacters
                    });
                }
                
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(characters));
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                // Log de performance se demorar mais que 50ms
                if (duration > 50) {
                    Logger.performance('Salvamento de personagens demorou', 'CHARACTER', { 
                        tempo: `${duration.toFixed(2)}ms`,
                        totalPersonagens: numCharacters,
                        tamanhoKB: Math.round(dataSize/1024)
                    });
                }
                
                Logger.character('info', 'Personagens salvos no localStorage', { 
                    totalPersonagens: numCharacters,
                    tamanhoKB: Math.round(dataSize/1024),
                    tempo: `${duration.toFixed(2)}ms`
                });
                
                console.log('💾 DEBUG saveCharactersToLocalStorage - salvo com sucesso');
                
            } catch (e) {
                Logger.error('Erro ao salvar personagens no localStorage', 'STORAGE', {
                    error: e.message,
                    totalPersonagens: Object.keys(characters).length
                });
                console.error("Erro ao salvar no localStorage. Dados não persistirão.", e);
                document.getElementById('user-info').textContent = "⚠️ Salve manual: O armazenamento local falhou.";
            }
        }
        
        /**
         * Carrega o objeto 'characters' do localStorage.
         */
        function loadCharactersFromLocalStorage() {
            if (!isLocalStorageAvailable) return; // Só tenta se estiver disponível

            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    characters = JSON.parse(storedData);
                } else {
                    characters = {}; // Inicia vazio se não houver dados
                }
                // Garante que a estrutura de dados esteja presente em fichas antigas
                Object.values(characters).forEach(char => {
                    char.skills = char.skills || initializeSkillsData();
                    char.resistances = char.resistances || { fortitude: 0, reflexos: 0, vontade: 0 };
                    char.customSkills = char.customSkills || [];
                    char.equipment = char.equipment || [];
                    char.equipment.forEach(item => item.cost = item.cost || 0);
                    char.sizeModifier = char.sizeModifier || 0;
                    char.caOtherBonus = char.caOtherBonus || 0;
                    char.initialTibar = char.initialTibar || 0;
                    char.missionGains = char.missionGains || 0;
                    char.rd = char.rd || 0;
                    char.bba = char.bba || 0;
                    char.ataqueCorpoACorpoOutros = char.ataqueCorpoACorpoOutros || 0;
                    char.ataqueDistanciaOutros = char.ataqueDistanciaOutros || 0;
                    char.ataqueMagicoOutros = char.ataqueMagicoOutros || 0;
                    char.ataqueMagicoAttr = char.ataqueMagicoAttr || 'INT';
                    char.danoCorpoACorpoAttr = char.danoCorpoACorpoAttr || 'FOR';
                    char.imageUrl = char.imageUrl || '';
                    char.nickname = char.nickname || '';
                    char.catchphrase = char.catchphrase || '';
                    char.fullHistory = char.fullHistory || '';
                    char.historyItems = char.historyItems || [];
                    char.languages = char.languages || [];
                    char.historyItems.forEach(item => item.details = item.details || '');
                    char.talentPoints = char.talentPoints || { race: 0, class: 0, extra: 0 };
                    if (char.talentPoints.class === undefined) { char.talentPoints.class = 0; }
                    delete char.talentPoints.disadvantages;
                    if (char.talents) {
                        char.talents.forEach(t => t.type = t.type || 'Comprado'); // Default old talents to 'Comprado'
                    }

                    if (char.talents && char.talents.length > 0 && typeof char.talents[0] === 'string') {
                        char.talents = char.talents.map(t => ({ id: crypto.randomUUID(), name: t, prerequisite: '', benefit: '', type: 'Comprado' }));
                    }
                });
            } catch (e) {
                // Se der erro, significa que os dados podem estar corrompidos, então reseta.
                console.error("Erro ao carregar do localStorage. Dados resetados. (Pode ser corrupção de dados)", e);
                characters = {}; 
            }
        }

        // --- LÓGICA DO PERSONAGEM (Exposta ao Window para onchange/onclick) ---
        
        /**
         * Template inicial para um novo personagem.
         */
        function getNewCharacterTemplate(name, player) {
            return {
                id: crypto.randomUUID(),
                name: name || "Novo Herói",
                player: player || "Jogador",
                race: "Humano",
                classLevel: "Guerreiro 1",
                tendency: "Neutro Bom",
                pvTotal: 15,
                pvCurrent: 15,
                pmTotal: 0,
                pmCurrent: 0,
                actionPoints: 1,
                rd: 0,
                bba: 0,
                sizeModifier: 0,
                caOtherBonus: 0,
                ataqueCorpoACorpoOutros: 0,
                ataqueDistanciaOutros: 0,
                ataqueMagicoOutros: 0,
                ataqueMagicoAttr: 'INT',
                danoCorpoACorpoAttr: 'FOR',
                initialTibar: 0,
                missionGains: 0,
                imageUrl: '',
                attributes: {
                    FOR: { value: 10, mod: 0, other: 0, temp: 0 },
                    DES: { value: 10, mod: 0, other: 0, temp: 0 },
                    CON: { value: 10, mod: 0, other: 0, temp: 0 },
                    INT: { value: 10, mod: 0, other: 0, temp: 0 },
                    SAB: { value: 10, mod: 0, other: 0, temp: 0 },
                    CAR: { value: 10, mod: 0, other: 0, temp: 0 },
                },
                resistances: { fortitude: 0, reflexos: 0, vontade: 0 }, 
                skills: initializeSkillsData(), 
                customSkills: [],
                spells: [], 
                talents: [], 
                equipment: [],
                npcs: [], 
                notes: [],
                nickname: "",
                catchphrase: "",
                fullHistory: "",
                historyItems: [],
                languages: [],
                talentPoints: { race: 0, class: 0, extra: 0 },
                createdAt: new Date().toISOString()
            };
        }

        window.createNewCharacter = function() {
            try {
                const name = document.getElementById('char-name-input').value.trim();
                const player = document.getElementById('player-name-input').value.trim();

                const charId = CharacterManager.validateAndCreate(name, player);
                if (!charId) return;
                
                ModalManager.close('create-modal');
                window.selectCharacter(charId);
            } catch (e) {
                ErrorHandler.handle(e, 'createNewCharacter');
            }
        }

        window.updateCharacterDetails = function(field, value) {
            try {
                if (!currentCharacterId || !characters[currentCharacterId]) {
                    Logger.error('Tentativa de atualizar personagem inexistente');
                    return;
                }

                // Validação específica por campo
                if (field === 'name' && (!value || value.trim().length === 0)) {
                    NotificationManager.show('Nome não pode estar vazio', 'warning');
                    return;
                }

                // Sanitizar HTML para campos de texto
                const sanitizedValue = typeof value === 'string' ? Utils.sanitizeHTML(value) : value;

                characters[currentCharacterId][field] = sanitizedValue;
                characters[currentCharacterId].updatedAt = new Date().toISOString();
                hasUnsavedChanges = true;
                
                // Atualizações específicas da interface
                if (field === 'imageUrl') {
                    const img = document.getElementById('char-detail-portrait');
                    if (img) {
                        img.src = sanitizedValue || 'https://placehold.co/128x128/1f2937/f3f4f6?text=?';
                        img.onerror = () => {
                            img.src = 'https://placehold.co/128x128/1f2937/f3f4f6?text=?';
                            NotificationManager.show('Erro ao carregar imagem', 'warning');
                        };
                    }
                } else if (field === 'name') {
                    const nameElements = document.querySelectorAll('#history-char-name, #history-char-name-quote');
                    nameElements.forEach(el => el.innerText = sanitizedValue || '');
                }
                
                // Campos que requerem atualização completa
                const fullRefreshFields = ['classLevel', 'sizeModifier', 'caOtherBonus', 'bba', 'ataqueCorpoACorpoOutros', 'ataqueDistanciaOutros', 'ataqueMagicoOutros', 'ataqueMagicoAttr', 'danoCorpoACorpoAttr'];
                if (fullRefreshFields.includes(field)) {
                    Utils.measurePerformance('fullRefresh', () => {
                        renderCharacterSheet(characters[currentCharacterId], false);
                    });
                }
                
                // Atualizar barras de status
                if (['pvCurrent', 'pvTotal', 'pmCurrent', 'pmTotal'].includes(field)) {
                    updateStatusBars(characters[currentCharacterId]);
                }
            } catch (e) {
                ErrorHandler.handle(e, 'updateCharacterDetails');
            }
        }

        // Função para popular a dropdown de raças
        window.populateRaceDropdown = function() {
            const raceSelect = document.getElementById('char-detail-race');
            if (!raceSelect) return;

            // Limpar opções existentes (exceto a primeira)
            while (raceSelect.options.length > 1) {
                raceSelect.remove(1);
            }

            // Adicionar raças da biblioteca
            if (raceLibrary && raceLibrary.length > 0) {
                raceLibrary.forEach(race => {
                    const option = document.createElement('option');
                    option.value = race.name;
                    option.textContent = race.name;
                    raceSelect.appendChild(option);
                });
            }
        }

        // Função para atualizar raça do personagem
        window.updateCharacterRace = function(raceName) {
            try {
                if (!currentCharacterId || !characters[currentCharacterId]) return;

                // Atualizar o campo raça
                updateCharacterDetails('race', raceName);

                // Encontrar dados da raça na biblioteca
                const raceData = raceLibrary.find(race => race.name === raceName);
                const infoIcon = document.getElementById('race-info-icon');

                if (raceData && infoIcon) {
                    // Mostrar ícone de informação
                    infoIcon.classList.remove('hidden');
                    
                    // Criar tooltip com informações da raça
                    const tooltip = `${raceData.name}
Tamanho: ${raceData.size}
Movimento: ${raceData.movement}
Modificadores: FOR ${raceData.abilityMods.str >= 0 ? '+' : ''}${raceData.abilityMods.str}, DES ${raceData.abilityMods.dex >= 0 ? '+' : ''}${raceData.abilityMods.dex}, CON ${raceData.abilityMods.con >= 0 ? '+' : ''}${raceData.abilityMods.con}, INT ${raceData.abilityMods.int >= 0 ? '+' : ''}${raceData.abilityMods.int}, SAB ${raceData.abilityMods.wis >= 0 ? '+' : ''}${raceData.abilityMods.wis}, CAR ${raceData.abilityMods.cha >= 0 ? '+' : ''}${raceData.abilityMods.cha}
Características: ${raceData.traits}`;
                    
                    infoIcon.title = tooltip;
                } else if (infoIcon) {
                    // Esconder ícone se não há dados da raça
                    infoIcon.classList.add('hidden');
                    infoIcon.title = '';
                }
            } catch (e) {
                ErrorHandler.handle(e, 'updateCharacterRace');
            }
        }

        // Função para sincronizar dropdown com valor atual
        window.syncRaceDropdown = function() {
            const raceSelect = document.getElementById('char-detail-race');
            if (!raceSelect || !currentCharacterId || !characters[currentCharacterId]) return;

            const currentRace = characters[currentCharacterId].race || '';
            raceSelect.value = currentRace;

            // Atualizar ícone de informação
            updateCharacterRace(currentRace);
        }
        
        /**
         * Atualiza o bônus "Outros" de uma resistência.
         */
        window.updateResistanceOther = function(resKey, value) {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            
            const charData = characters[currentCharacterId];
            
            // Garantir que resistances existe
            if (!charData.resistances) {
                charData.resistances = { fortitude: 0, reflexos: 0, vontade: 0 };
            }
            
            charData.resistances[resKey] = parseInt(value) || 0;
            hasUnsavedChanges = true;
            renderResistances(charData);
        }

        /**
         * Atualiza um atributo e salva localmente.
         */
        window.updateAttribute = function(attrKey, subKey, value) {
            if (!currentCharacterId || !characters[currentCharacterId] || !characters[currentCharacterId].attributes[attrKey]) return;
            
            const charData = characters[currentCharacterId];
            charData.attributes[attrKey][subKey] = parseInt(value) || 0;
            
            const baseValue = charData.attributes[attrKey].value || 0;
            const otherMod = charData.attributes[attrKey].other || 0;
            const tempMod = charData.attributes[attrKey].temp || 0;
            
            const totalValue = baseValue + otherMod + tempMod;
            const newMod = Math.floor((totalValue - 10) / 2);
            charData.attributes[attrKey].mod = newMod;
            hasUnsavedChanges = true;

            const attrDiv = document.querySelector(`#attributes-container-tab [data-attr-key="${attrKey}"]`);
            if (attrDiv) {
                const modSpan = attrDiv.querySelector('span.text-4xl');
                modSpan.innerText = newMod >= 0 ? `+${newMod}` : newMod;
            }
            
            calculateAndRenderCA(charData);
            renderResistances(charData);
            renderAtaquesEDano(charData);
            renderSkillsList(charData.attributes);
        }
        
        /**
         * Altera o status de treinamento (T/NT) ou o bônus "Outros" de uma perícia.
         */
        window.updateSkillData = function(skillName, key, value) {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const charData = characters[currentCharacterId];
            
            charData.skills[skillName] = charData.skills[skillName] || { isTrained: false, otherBonus: 0 };

            if (key === 'isTrained') {
                charData.skills[skillName].isTrained = value;
            } else if (key === 'otherBonus') {
                charData.skills[skillName].otherBonus = parseInt(value) || 0;
            }
            hasUnsavedChanges = true;
            renderSkillsList(charData.attributes);
        }

        /**
         * Adiciona uma nova perícia customizada.
         */
        window.addCustomSkill = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;

            const name = document.getElementById('new-skill-name').value.trim();
            const attr = document.getElementById('new-skill-attr').value;

            if (!name || attr === '0') return;
            
            const allSkills = [...SKILLS_BASE, ...(characters[currentCharacterId].customSkills || [])];
            if (allSkills.some(skill => skill.name.toLowerCase() === name.toLowerCase())) {
                alert("Perícia com este nome já existe!");
                return;
            }

            const charData = characters[currentCharacterId];
            const newSkill = { 
                id: crypto.randomUUID(), 
                name: name, 
                attr: attr,
                trainedOnly: true,
                isCustom: true
            };

            charData.customSkills.push(newSkill);
            charData.skills[name] = { isTrained: true, otherBonus: 0 }; 
            hasUnsavedChanges = true;
            
            document.getElementById('new-skill-name').value = '';
            document.getElementById('new-skill-attr').value = '0';
            renderSkillsList(charData.attributes);
        }

        window.addLanguage = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;

            const select = document.getElementById('new-language-select');
            const languageName = select.value;
            
            const charData = characters[currentCharacterId];

            // Evita duplicados
            if (charData.languages.some(lang => lang.name === languageName)) {
                return;
            }

            const newLanguage = {
                id: crypto.randomUUID(),
                name: languageName
            };

            charData.languages.push(newLanguage);
            hasUnsavedChanges = true;
            renderLanguagesList(charData.languages);
        }

        // --- FILTROS DE PESQUISA COM DEBOUNCE ---
        const debouncedFilterSpells = Utils.debounce(function() {
            if (!currentCharacterId) return;
            
            Utils.measurePerformance('filterSpells', () => {
                resetCharacterSpellPagination(); // Reset pagination when filtering
                const searchTerm = document.getElementById('spell-search-input').value.toLowerCase();
                const charData = characters[currentCharacterId];
                const allSpells = charData.spells || [];

                if (!searchTerm) {
                    renderSpellsList(allSpells, 'magias-list');
                    return;
                }

                const filteredSpells = allSpells.filter(spell => {
                    // Change: Use startsWith for name search for more intuitive filtering as you type.
                    // Keep `includes` for other fields to allow broader searching.
                    return (spell.name && spell.name.toLowerCase().startsWith(searchTerm)) ||
                        (spell.level && spell.level.toLowerCase().includes(searchTerm)) ||
                        (spell.school && spell.school.toLowerCase().includes(searchTerm)) ||
                        (spell.description && spell.description.toLowerCase().includes(searchTerm));
                });

                renderSpellsList(filteredSpells, 'magias-list');
            });
        }, CONFIG.DEBOUNCE_DELAY);

        window.filterSpells = debouncedFilterSpells;

        const debouncedFilterTalents = Utils.debounce(function() {
            if (!currentCharacterId) return;
            
            Utils.measurePerformance('filterTalents', () => {
                const searchTerm = document.getElementById('talent-search-input').value.toLowerCase();
                const charData = characters[currentCharacterId];
                const allTalents = charData.talents || [];

                if (!searchTerm) {
                    renderTalentsList(allTalents, 'talents-list');
                    return;
                }

                const filteredTalents = allTalents.filter(talent => {
                    // Change: Use startsWith for name search for more intuitive filtering as you type.
                    // Keep `includes` for other fields to allow broader searching.
                    return (talent.name && talent.name.toLowerCase().startsWith(searchTerm)) ||
                        (talent.prerequisite && talent.prerequisite.toLowerCase().includes(searchTerm)) ||
                        (talent.benefit && talent.benefit.toLowerCase().includes(searchTerm)) ||
                        (talent.type && talent.type.toLowerCase().includes(searchTerm));
                });

                renderTalentsList(filteredTalents, 'talents-list');
            });
        }, CONFIG.DEBOUNCE_DELAY);

        window.filterTalents = debouncedFilterTalents;


        // --- CRUD DE LISTAS ---

        window.addSpell = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const spell = {
                id: crypto.randomUUID(), 
                name: document.getElementById('spell-name').value.trim(),
                level: document.getElementById('spell-level').value.trim(),
                school: document.getElementById('spell-school').value.trim(),
                components: document.getElementById('spell-components').value.trim(),
                time: document.getElementById('spell-time').value.trim(),
                range: document.getElementById('spell-range').value.trim(),
                target: document.getElementById('spell-target').value.trim(),
                duration: document.getElementById('spell-duration').value.trim(),
                resistance: document.getElementById('spell-resistance').value.trim(),
                description: document.getElementById('spell-description').value.trim()
            };
            if (!spell.name) return;

            const charData = characters[currentCharacterId];
            charData.spells.push(spell);
            hasUnsavedChanges = true;

            // Limpa campos
            ['spell-name', 'spell-level', 'spell-school', 'spell-components', 'spell-time', 'spell-range', 'spell-target', 'spell-duration', 'spell-resistance', 'spell-description'].forEach(id => document.getElementById(id).value = '');
            
            document.getElementById('spell-search-input').value = '';
            resetCharacterSpellPagination(); // Reset pagination after adding spell
            renderSpellsList(charData.spells, 'magias-list');
        }
        
        window.addTalent = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const talent = {
                id: crypto.randomUUID(),
                name: document.getElementById('talent-name').value.trim(),
                type: document.getElementById('talent-type').value,
                prerequisite: document.getElementById('talent-prerequisite').value.trim(),
                benefit: document.getElementById('talent-benefit').value.trim()
            };
            if (!talent.name) return;

            const charData = characters[currentCharacterId];
            charData.talents.push(talent);
            hasUnsavedChanges = true;

            document.getElementById('talent-name').value = '';
            document.getElementById('talent-prerequisite').value = '';
            document.getElementById('talent-benefit').value = '';

            document.getElementById('talent-search-input').value = '';
            renderCharacterTalentsWithPagination(charData.talents);
            updateTalentCalculator(charData);
        }

        window.addEquipment = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const item = {
                id: crypto.randomUUID(),
                name: document.getElementById('item-name').value.trim() || "Item sem nome",
                type: document.getElementById('item-type').value,
                cost: parseInt(document.getElementById('item-cost').value) || 0,
                caBonus: parseInt(document.getElementById('item-ca-bonus').value) || 0,
                description: document.getElementById('item-description').value.trim(),
                enhancements: [],
            };

            if (item.type === 'Arma') {
                item.bonus = document.getElementById('weapon-bonus').value.trim();
                item.damage = document.getElementById('weapon-damage').value.trim();
                item.threat = document.getElementById('weapon-threat').value.trim();
                item.special = document.getElementById('weapon-special').value.trim();
            }

            const charData = characters[currentCharacterId];
            charData.equipment.push(item);
            hasUnsavedChanges = true;

            // Limpa campos
            ['item-name', 'item-cost', 'item-ca-bonus', 'item-description', 'weapon-bonus', 'weapon-damage', 'weapon-threat', 'weapon-special'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('item-type').value = 'Outro';
            toggleWeaponFields();

            renderCharacterEquipmentWithPagination(charData.equipment);
            calculateAndRenderTibar(charData);
            calculateAndRenderCA(charData);
        }

        // Função para exportar inventário do personagem
        window.exportCharacterInventory = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) {
                alert('Nenhum personagem selecionado!');
                return;
            }

            const charData = characters[currentCharacterId];
            const inventoryData = {
                characterName: charData.name || 'Personagem sem nome',
                exportDate: new Date().toISOString(),
                equipment: charData.equipment || []
            };

            const dataStr = JSON.stringify(inventoryData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `inventario_${charData.name || 'personagem'}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Inventário de ${charData.name || 'Personagem'} exportado com sucesso!\nItens: ${inventoryData.equipment.length}`);
        }

        // Função para limpar todo o inventário do personagem
        window.clearCharacterInventory = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) {
                alert('Nenhum personagem selecionado!');
                return;
            }

            const charData = characters[currentCharacterId];
            const itemCount = charData.equipment ? charData.equipment.length : 0;

            if (itemCount === 0) {
                alert('O inventário já está vazio!');
                return;
            }

            if (confirm(`Tem certeza que deseja remover TODOS os ${itemCount} itens do inventário de ${charData.name || 'Personagem'}?\n\nEsta ação não pode ser desfeita!`)) {
                charData.equipment = [];
                hasUnsavedChanges = true;

                // Atualiza a interface
                renderCharacterEquipmentWithPagination(charData.equipment);
                calculateAndRenderTibar(charData);
                calculateAndRenderCA(charData);

                alert(`Inventário de ${charData.name || 'Personagem'} foi limpo com sucesso!\n${itemCount} itens removidos.`);
            }
        }

        // Função para alternar campos de arma no modal
        window.toggleModalWeaponFields = function() {
            const itemType = document.getElementById('modal-item-type').value;
            const weaponFields = document.getElementById('modal-weapon-fields');
            
            if (itemType === 'Arma') {
                weaponFields.classList.remove('hidden');
            } else {
                weaponFields.classList.add('hidden');
                // Limpar campos de arma se não for arma
                document.getElementById('modal-weapon-bonus').value = '';
                document.getElementById('modal-weapon-damage').value = '';
                document.getElementById('modal-weapon-threat').value = '';
                document.getElementById('modal-weapon-special').value = '';
            }
        }

        // Função para adicionar item através do modal
        window.addItemFromModal = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) {
                alert('Nenhum personagem selecionado!');
                return;
            }

            const item = {
                id: crypto.randomUUID(),
                name: document.getElementById('modal-item-name').value.trim() || "Item sem nome",
                type: document.getElementById('modal-item-type').value,
                cost: parseInt(document.getElementById('modal-item-cost').value) || 0,
                caBonus: parseInt(document.getElementById('modal-item-ca-bonus').value) || 0,
                description: document.getElementById('modal-item-description').value.trim(),
                enhancements: [],
            };

            if (item.type === 'Arma') {
                item.bonus = document.getElementById('modal-weapon-bonus').value.trim();
                item.damage = document.getElementById('modal-weapon-damage').value.trim();
                item.threat = document.getElementById('modal-weapon-threat').value.trim();
                item.special = document.getElementById('modal-weapon-special').value.trim();
            }

            const charData = characters[currentCharacterId];
            charData.equipment.push(item);
            hasUnsavedChanges = true;

            // Limpa campos do modal
            ['modal-item-name', 'modal-item-cost', 'modal-item-ca-bonus', 'modal-item-description', 
             'modal-weapon-bonus', 'modal-weapon-damage', 'modal-weapon-threat', 'modal-weapon-special'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('modal-item-type').value = 'Outro';
            toggleModalWeaponFields();

            // Atualiza interface
            renderEquipmentList(charData.equipment);
            calculateAndRenderTibar(charData);
            calculateAndRenderCA(charData);

            // Fecha modal
            closeModal('add-item-modal');

            // Mostra mensagem de sucesso
            alert(`Item "${item.name}" adicionado ao inventário com sucesso!`);
        }

        window.openEnhancementModal = function(itemId) {
            document.getElementById('enhancement-item-id').value = itemId;
            openModal('enhancement-modal');
        }
        
        window.addEnhancement = function() {
            const itemId = document.getElementById('enhancement-item-id').value;
            const enhancementText = document.getElementById('enhancement-text').value.trim();
            if (!enhancementText || !itemId || !currentCharacterId) return;

            const charData = characters[currentCharacterId];
            const item = charData.equipment.find(e => e.id === itemId);
            if (item) {
                item.enhancements.push(enhancementText);
                hasUnsavedChanges = true;
                renderEquipmentList(charData.equipment);
                closeModal('enhancement-modal');
                document.getElementById('enhancement-text').value = '';
            }
        }

        window.removeEnhancement = function(itemId, index) {
            if (!currentCharacterId) return;
            const charData = characters[currentCharacterId];
            const item = charData.equipment.find(e => e.id === itemId);
            if(item && item.enhancements[index] !== undefined) {
                item.enhancements.splice(index, 1);
                hasUnsavedChanges = true;
                renderEquipmentList(charData.equipment);
            }
        }
        
        window.addHistoryItem = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;

            const description = document.getElementById('new-history-item-desc').value.trim();
            const type = document.getElementById('new-history-item-type').value;
            const details = document.getElementById('new-history-item-details').value.trim();

            if (!description) return;
            
            const charData = characters[currentCharacterId];
            const newItem = { 
                id: crypto.randomUUID(), 
                description: description, 
                type: type,
                details: details
            };

            charData.historyItems.push(newItem);
            hasUnsavedChanges = true;
            
            document.getElementById('new-history-item-desc').value = '';
            document.getElementById('new-history-item-details').value = '';
            resetCharacterHistoryPage();
            renderCharacterHistoryWithPagination(charData.historyItems);
            updateDerivedMainDetails(charData);
        }

        window.removeItemById = function(field, itemId) {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const charData = characters[currentCharacterId];
            
            charData[field] = (charData[field] || []).filter(item => item.id !== itemId);
            hasUnsavedChanges = true;
            
            if (field === 'customSkills') {
                const skillToRemove = charData.customSkills.find(s => s.id === itemId);
                if (skillToRemove) delete charData.skills[skillToRemove.name];
                renderSkillsList(charData.attributes);
            } else {
                const renderMap = {
                    spells: () => filterSpells(),
                    talents: () => {
                        filterTalents();
                        updateTalentCalculator(charData);
                    },
                    equipment: () => {
                        renderEquipmentList(charData.equipment);
                        calculateAndRenderTibar(charData);
                        calculateAndRenderCA(charData);
                    },
                    npcs: () => renderCharacterNpcsWithPagination(charData.npcs),
                    notes: () => renderCharacterNotesWithPagination(charData.notes),
                    historyItems: () => {
                        renderHistoryItemsList(charData.historyItems);
                        updateDerivedMainDetails(charData);
                    },
                    languages: () => renderLanguagesList(charData.languages),
                };
                if (renderMap[field]) renderMap[field]();
            }

        }
        
        window.addNpc = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const name = document.getElementById('new-npc-name').value.trim();
            const note = document.getElementById('new-npc-note').value.trim();
            if (!name && !note) return;

            const charData = characters[currentCharacterId];
            charData.npcs.push({ id: crypto.randomUUID(), name: name || "NPC Sem Nome", note: note || "(Sem nota)" });
            hasUnsavedChanges = true;
            document.getElementById('new-npc-name').value = '';
            document.getElementById('new-npc-note').value = '';
            renderJournalList('npcs', charData.npcs, 'npcs-list', 'NPC', 'note'); 
        }
        
        window.addNote = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) return;
            const title = document.getElementById('new-note-title').value.trim();
            const text = document.getElementById('new-note-text').value.trim();
            if (!title && !text) return;

            const charData = characters[currentCharacterId];
            charData.notes.push({ id: crypto.randomUUID(), date: new Date().toLocaleDateString('pt-BR'), title: title || "Nota sem título", text: text });
            hasUnsavedChanges = true;
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-text').value = '';
            resetCharacterNotesPage();
            renderCharacterNotesWithPagination(charData.notes); 
        }

        // --- EDIÇÃO DE ITENS ---

        // Magias
        window.openEditSpellModal = function(spellId) {
            if (!currentCharacterId) return;
            const spell = characters[currentCharacterId].spells.find(s => s.id === spellId);
            if (!spell) return;

            document.getElementById('edit-spell-id').value = spell.id;
            document.getElementById('edit-spell-name').value = spell.name;
            document.getElementById('edit-spell-level').value = spell.level;
            document.getElementById('edit-spell-school').value = spell.school;
            document.getElementById('edit-spell-components').value = spell.components;
            document.getElementById('edit-spell-time').value = spell.time;
            document.getElementById('edit-spell-range').value = spell.range;
            document.getElementById('edit-spell-target').value = spell.target;
            document.getElementById('edit-spell-duration').value = spell.duration;
            document.getElementById('edit-spell-resistance').value = spell.resistance;
            document.getElementById('edit-spell-description').value = spell.description;

            openModal('edit-spell-modal');
        }

        window.saveEditedSpell = function() {
            if (!currentCharacterId) return;
            const spellId = document.getElementById('edit-spell-id').value;
            const spell = characters[currentCharacterId].spells.find(s => s.id === spellId);
            if (!spell) return;

            spell.name = document.getElementById('edit-spell-name').value;
            spell.level = document.getElementById('edit-spell-level').value;
            spell.school = document.getElementById('edit-spell-school').value;
            spell.components = document.getElementById('edit-spell-components').value;
            spell.time = document.getElementById('edit-spell-time').value;
            spell.range = document.getElementById('edit-spell-range').value;
            spell.target = document.getElementById('edit-spell-target').value;
            spell.duration = document.getElementById('edit-spell-duration').value;
            spell.resistance = document.getElementById('edit-spell-resistance').value;
            spell.description = document.getElementById('edit-spell-description').value;
            
            hasUnsavedChanges = true;
            filterSpells();
            closeModal('edit-spell-modal');
        }

        // === BIBLIOTECA DE MAGIAS ===
        let spellLibrary = JSON.parse(localStorage.getItem('spellLibrary')) || [];
        let currentEditingLibrarySpell = null;
        let currentSpellLevels = []; // Array para armazenar as tags de nível
        let selectedSpells = new Set(); // Set para armazenar IDs das magias selecionadas

        // Variáveis de paginação da biblioteca de magias
        let currentSpellPage = 1;
        const spellsPerPage = 20;
        
        // Variáveis de paginação das magias da ficha do personagem
        let currentCharacterSpellPage = 1;
        const characterSpellsPerPage = 5;
        
        // Variáveis de paginação do modal de seleção de magias
        let currentSpellSelectionPage = 1;
        let spellSelectionPerPage = 20;
        
        // Variáveis de paginação do modal de seleção de talentos
        let currentTalentSelectionPage = 1;
        let talentSelectionPerPage = 20;
        
        // Variáveis de paginação das abas da ficha do personagem
        let currentCharacterTalentPage = 1;
        let currentCharacterEquipmentPage = 1;
        let currentCharacterSkillsPage = 1;
        let currentCharacterNpcsPage = 1;
        let currentCharacterNotesPage = 1;
        let currentCharacterHistoryPage = 1;
        const characterItemsPerPage = 5;

        // Sistema de Tags para Níveis de Magia
        window.addSpellLevelTag = function() {
            const type = document.getElementById('spell-level-type').value;
            const number = document.getElementById('spell-level-number').value;
            
            if (!number || number < 0 || number > 9) {
                alert('Por favor, digite um nível válido (0-9)');
                return;
            }
            
            const levelTag = `${type} ${number}`;
            
            // Verificar se já existe
            if (currentSpellLevels.includes(levelTag)) {
                alert('Este nível já foi adicionado!');
                return;
            }
            
            currentSpellLevels.push(levelTag);
            document.getElementById('spell-level-number').value = '';
            renderSpellLevelTags();
        }

        function renderSpellLevelTags() {
            const container = document.getElementById('spell-level-tags');
            container.innerHTML = currentSpellLevels.map((level, index) => {
                const tagColor = getSpellLevelTagColor(level);
                
                return `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${tagColor} text-white">
                        ${Utils.sanitizeHTML(level)}
                        <button type="button" onclick="removeSpellLevelTag(${index})" class="ml-2 text-gray-200 hover:text-white">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </span>
                `;
            }).join('');
        }

        window.removeSpellLevelTag = function(index) {
            currentSpellLevels.splice(index, 1);
            renderSpellLevelTags();
        }

        function clearSpellLevelTags() {
            currentSpellLevels = [];
            renderSpellLevelTags();
        }

        function setSpellLevelTags(levelString) {
            if (!levelString) {
                currentSpellLevels = [];
            } else {
                // Tentar parsear o formato antigo "Arcana 4, Divina 2"
                currentSpellLevels = levelString.split(',').map(s => s.trim()).filter(s => s);
            }
            renderSpellLevelTags();
        }

        // Função auxiliar para determinar cor da tag baseada no tipo
        function getSpellLevelTagColor(level) {
            if (level.toLowerCase().includes('arcana')) {
                return 'bg-blue-600';
            } else if (level.toLowerCase().includes('divina')) {
                return 'bg-yellow-600'; // Dourado
            }
            return 'bg-violet-600'; // Cor padrão para tipos não reconhecidos
        }

        // Abrir modal da biblioteca de magias
        window.openSpellLibraryModal = function() {
            const modal = document.getElementById('spell-library-modal');
            modal.classList.remove('hidden');
            modal.querySelector('.themed-bg-surface').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.themed-bg-surface').classList.add('scale-100', 'opacity-100');
            
            // Inicializar sistema de tags e limpar seleções
            clearSpellLevelTags();
            selectedSpells.clear();
            
            loadSpellLibraryList();
            
            // Adicionar listener para ESC
            document.addEventListener('keydown', handleLibraryModalKeydown);
        }

        // Fechar modal da biblioteca de magias
        window.closeSpellLibraryModal = function() {
            const modal = document.getElementById('spell-library-modal');
            modal.querySelector('.themed-bg-surface').classList.remove('scale-100', 'opacity-100');
            modal.querySelector('.themed-bg-surface').classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // Remover listener do ESC
            document.removeEventListener('keydown', handleLibraryModalKeydown);
            
            // Limpar formulário e cancelar edição
            clearLibraryForm();
            cancelLibraryEdit();
        }

        // Handler para tecla ESC no modal da biblioteca
        function handleLibraryModalKeydown(event) {
            if (event.key === 'Escape') {
                closeSpellLibraryModal();
            }
        }

        // Adicionar magia à biblioteca
        window.addSpellToLibrary = function() {
            const name = document.getElementById('lib-spell-name').value.trim();
            if (!name) {
                alert('Nome da magia é obrigatório!');
                return;
            }

            if (currentSpellLevels.length === 0) {
                alert('Adicione pelo menos um nível de magia!');
                return;
            }

            const newSpell = {
                id: Utils.generateUUID(),
                name: name,
                level: currentSpellLevels.join(', '), // Converter tags para string
                school: document.getElementById('lib-spell-school').value.trim(),
                components: document.getElementById('lib-spell-components').value.trim() || 'V, S, M',
                time: document.getElementById('lib-spell-time').value.trim(),
                range: document.getElementById('lib-spell-range').value.trim(),
                target: document.getElementById('lib-spell-target').value.trim(),
                duration: document.getElementById('lib-spell-duration').value.trim(),
                resistance: document.getElementById('lib-spell-resistance').value.trim(),
                description: document.getElementById('lib-spell-description').value.trim()
            };

            spellLibrary.push(newSpell);
            localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
            
            clearLibraryForm();
            resetSpellPagination();
            loadSpellLibraryList();
            hasUnsavedChanges = true;
        }

        // Limpar formulário da biblioteca
        window.clearLibraryForm = function() {
            document.getElementById('lib-spell-name').value = '';
            clearSpellLevelTags();
            document.getElementById('lib-spell-school').value = '';
            document.getElementById('lib-spell-components').value = 'V, S, M'; // Valor padrão
            document.getElementById('lib-spell-time').value = '';
            document.getElementById('lib-spell-range').value = '';
            document.getElementById('lib-spell-target').value = '';
            document.getElementById('lib-spell-duration').value = '';
            document.getElementById('lib-spell-resistance').value = '';
            document.getElementById('lib-spell-description').value = '';
        }

        // Carregar lista da biblioteca de magias
        function loadSpellLibraryList() {
            const container = document.getElementById('spell-library-list');
            const paginationControls = document.getElementById('spell-pagination-controls');
            
            if (spellLibrary.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhuma magia cadastrada na biblioteca.</p>';
                paginationControls.classList.add('hidden');
                return;
            }

            const filteredSpells = filterLibrarySpellsData();
            
            if (filteredSpells.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhuma magia encontrada com os filtros aplicados.</p>';
                paginationControls.classList.add('hidden');
                return;
            }

            // Cálculos de paginação
            const totalPages = Math.ceil(filteredSpells.length / spellsPerPage);
            const startIndex = (currentSpellPage - 1) * spellsPerPage;
            const endIndex = startIndex + spellsPerPage;
            const currentPageSpells = filteredSpells.slice(startIndex, endIndex);

            // Atualizar controles de paginação
            updateSpellPaginationControls(currentSpellPage, totalPages, filteredSpells.length);

            container.innerHTML = currentPageSpells.map(spell => `
                <div class="themed-bg-surface border themed-border rounded-lg p-3 hover:border-violet-500 transition duration-150">
                    <div class="flex items-start">
                        <!-- Checkbox de Seleção -->
                        <div class="flex items-center mr-3">
                            <input type="checkbox" 
                                   id="spell-select-${spell.id}" 
                                   ${selectedSpells.has(spell.id) ? 'checked' : ''}
                                   onchange="toggleSpellSelection('${spell.id}')"
                                   class="w-4 h-4 text-violet-600 bg-gray-700 border-gray-600 rounded focus:ring-violet-500 focus:ring-2">
                        </div>
                        
                        <div class="flex-1">
                            <h5 class="font-bold text-violet-300 text-sm">${Utils.sanitizeHTML(spell.name)}</h5>
                            
                            <!-- Tags de Nível -->
                            ${spell.level ? `
                                <div class="flex flex-wrap gap-1 mt-1 mb-2">
                                    ${spell.level.split(',').map(level => `
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getSpellLevelTagColor(level.trim())} text-white">
                                            ${Utils.sanitizeHTML(level.trim())}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="grid grid-cols-2 gap-2 text-xs themed-text-muted mt-1">
                                ${spell.school ? `<span><strong>Escola:</strong> ${Utils.sanitizeHTML(spell.school)}</span>` : ''}
                                ${spell.components ? `<span><strong>Componentes:</strong> ${Utils.sanitizeHTML(spell.components)}</span>` : ''}
                                ${spell.time ? `<span><strong>Tempo:</strong> ${Utils.sanitizeHTML(spell.time)}</span>` : ''}
                                ${spell.range ? `<span><strong>Alcance:</strong> ${Utils.sanitizeHTML(spell.range)}</span>` : ''}
                                ${spell.duration ? `<span><strong>Duração:</strong> ${Utils.sanitizeHTML(spell.duration)}</span>` : ''}
                            </div>
                            ${spell.description ? `<p class="text-xs mt-2 themed-text-base">${Utils.sanitizeHTML(spell.description)}</p>` : ''}
                        </div>
                        
                        <div class="flex space-x-1 ml-2">
                            <button onclick="editLibrarySpell('${spell.id}')" class="text-amber-400 hover:text-amber-500 p-1" title="Editar Magia">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="removeLibrarySpell('${spell.id}')" class="text-red-400 hover:text-red-500 p-1" title="Excluir da Biblioteca">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Atualizar controles de paginação
        function updateSpellPaginationControls(currentPage, totalPages, totalItems) {
            const paginationControls = document.getElementById('spell-pagination-controls');
            const pageInfo = document.getElementById('spell-page-info');
            const totalInfo = document.getElementById('spell-total-info');
            const prevBtn = document.getElementById('spell-prev-btn');
            const nextBtn = document.getElementById('spell-next-btn');

            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageInfo.textContent = `${currentPage} / ${totalPages}`;
            totalInfo.textContent = `${totalItems} magias`;

            // Controlar estado dos botões
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Mudar página
        window.changeSpellPage = function(direction) {
            const filteredSpells = filterLibrarySpellsData();
            const totalPages = Math.ceil(filteredSpells.length / spellsPerPage);
            
            const newPage = currentSpellPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentSpellPage = newPage;
                loadSpellLibraryList();
            }
        }

        // Reset da página quando filtros mudarem
        window.resetSpellPagination = function() {
            currentSpellPage = 1;
        }

        // Filtrar magias da biblioteca
        window.filterLibrarySpells = function() {
            resetSpellPagination();
            loadSpellLibraryList();
        }

        function filterLibrarySpellsData() {
            const searchTerm = document.getElementById('library-spell-search-input').value.toLowerCase().trim();
            const typeFilter = document.getElementById('library-type-filter').value.toLowerCase();
            const levelFilter = document.getElementById('library-level-filter').value;
            
            let filtered = spellLibrary;
            
            // Filtro por busca de texto
            if (searchTerm) {
                filtered = filtered.filter(spell => 
                    spell.name.toLowerCase().includes(searchTerm) ||
                    spell.level.toLowerCase().includes(searchTerm) ||
                    spell.school.toLowerCase().includes(searchTerm) ||
                    spell.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Filtro por tipo de magia (arcana/divina)
            if (typeFilter) {
                filtered = filtered.filter(spell => 
                    spell.level.toLowerCase().includes(typeFilter)
                );
            }
            
            // Filtro por nível de magia
            if (levelFilter) {
                filtered = filtered.filter(spell => {
                    // Extrair números do campo level (ex: "Arcana 1, Divina 2" → [1, 2])
                    const levelNumbers = spell.level.match(/\d+/g);
                    return levelNumbers && levelNumbers.includes(levelFilter);
                });
            }
            
            return filtered;
        }

        // Limpar busca da biblioteca
        window.clearLibrarySearch = function() {
            document.getElementById('library-spell-search-input').value = '';
            document.getElementById('library-type-filter').value = '';
            document.getElementById('library-level-filter').value = '';
            resetSpellPagination();
            loadSpellLibraryList();
        }

        // Ordenar magias por nível (0-9)
        window.sortSpellsByLevel = function() {
            if (spellLibrary.length === 0) {
                alert('Biblioteca vazia! Não há magias para ordenar.');
                return;
            }

            const confirmed = confirm('Deseja ordenar as magias por nível (0-9)?\n\nIsso irá reorganizar permanentemente a ordem das magias na biblioteca.');
            
            if (!confirmed) return;

            // Função para extrair o menor nível de uma magia
            function getMinLevel(spell) {
                const levelNumbers = spell.level.match(/\d+/g);
                if (!levelNumbers || levelNumbers.length === 0) return 999; // Magias sem nível vão para o final
                return Math.min(...levelNumbers.map(n => parseInt(n)));
            }

            // Ordenar por nível e depois por nome
            spellLibrary.sort((a, b) => {
                const levelA = getMinLevel(a);
                const levelB = getMinLevel(b);
                
                // Primeiro critério: nível
                if (levelA !== levelB) {
                    return levelA - levelB;
                }
                
                // Segundo critério: nome (alfabético)
                return a.name.localeCompare(b.name, 'pt-BR', { 
                    ignorePunctuation: true, 
                    sensitivity: 'base' 
                });
            });

            // Salvar a nova ordem
            localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
            resetSpellPagination();
            loadSpellLibraryList();
            hasUnsavedChanges = true;
            
            alert('Magias ordenadas com sucesso por nível (0-9)!');
        }

        // Gerenciar seleção de magias
        window.toggleSpellSelection = function(spellId) {
            if (selectedSpells.has(spellId)) {
                selectedSpells.delete(spellId);
            } else {
                selectedSpells.add(spellId);
            }
        }

        // Exportar magias selecionadas
        window.exportSelectedSpells = function() {
            if (selectedSpells.size === 0) {
                alert('Nenhuma magia selecionada! Marque as checkboxes das magias que deseja exportar.');
                return;
            }

            const selectedSpellsData = spellLibrary.filter(spell => selectedSpells.has(spell.id));
            const dataStr = JSON.stringify(selectedSpellsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `magias-selecionadas-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Limpar seleção após exportar
            selectedSpells.clear();
            loadSpellLibraryList();
        }

        // Editar magia da biblioteca
        window.editLibrarySpell = function(spellId) {
            const spell = spellLibrary.find(s => s.id === spellId);
            if (!spell) return;

            currentEditingLibrarySpell = spellId;
            
            // Preencher formulário
            document.getElementById('lib-spell-name').value = spell.name;
            setSpellLevelTags(spell.level || ''); // Carregar tags de nível
            document.getElementById('lib-spell-school').value = spell.school || '';
            document.getElementById('lib-spell-components').value = spell.components || 'V, S, M';
            document.getElementById('lib-spell-time').value = spell.time || '';
            document.getElementById('lib-spell-range').value = spell.range || '';
            document.getElementById('lib-spell-target').value = spell.target || '';
            document.getElementById('lib-spell-duration').value = spell.duration || '';
            document.getElementById('lib-spell-resistance').value = spell.resistance || '';
            document.getElementById('lib-spell-description').value = spell.description || '';
            
            // Mostrar modo de edição
            document.getElementById('library-edit-info').classList.remove('hidden');
            document.getElementById('edit-spell-name').textContent = spell.name;
        }

        // Atualizar magia na biblioteca
        window.updateSpellInLibrary = function() {
            if (!currentEditingLibrarySpell) return;
            
            const spell = spellLibrary.find(s => s.id === currentEditingLibrarySpell);
            if (!spell) return;

            const name = document.getElementById('lib-spell-name').value.trim();
            if (!name) {
                alert('Nome da magia é obrigatório!');
                return;
            }

            if (currentSpellLevels.length === 0) {
                alert('Adicione pelo menos um nível de magia!');
                return;
            }

            spell.name = name;
            spell.level = currentSpellLevels.join(', '); // Converter tags para string
            spell.school = document.getElementById('lib-spell-school').value.trim();
            spell.components = document.getElementById('lib-spell-components').value.trim() || 'V, S, M';
            spell.time = document.getElementById('lib-spell-time').value.trim();
            spell.range = document.getElementById('lib-spell-range').value.trim();
            spell.target = document.getElementById('lib-spell-target').value.trim();
            spell.duration = document.getElementById('lib-spell-duration').value.trim();
            spell.resistance = document.getElementById('lib-spell-resistance').value.trim();
            spell.description = document.getElementById('lib-spell-description').value.trim();

            localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
            
            cancelLibraryEdit();
            clearLibraryForm();
            loadSpellLibraryList();
            hasUnsavedChanges = true;
        }

        // Cancelar edição na biblioteca
        window.cancelLibraryEdit = function() {
            currentEditingLibrarySpell = null;
            document.getElementById('library-edit-info').classList.add('hidden');
        }

        // Remover magia da biblioteca
        window.removeLibrarySpell = function(spellId) {
            if (!confirm('Tem certeza que deseja excluir esta magia da biblioteca?')) return;
            
            spellLibrary = spellLibrary.filter(s => s.id !== spellId);
            localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
            
            resetSpellPagination();
            loadSpellLibraryList();
            hasUnsavedChanges = true;
        }

        // Exportar biblioteca de magias
        window.exportSpellLibrary = function() {
            if (spellLibrary.length === 0) {
                alert('Biblioteca vazia! Não há magias para exportar.');
                return;
            }

            const dataStr = JSON.stringify(spellLibrary, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `biblioteca-magias-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Função para converter formato de nível de magia
        function convertSpellLevelFormat(level) {
            if (!level || typeof level !== 'string') return level;
            
            const originalLevel = level;
            
            // Converter "1º Arcano, 1º Divino" para "Arcana 1, Divina 1"
            const convertedLevel = level
                .replace(/(\d+)º\s+Arcano/gi, 'Arcana $1')
                .replace(/(\d+)º\s+Divino/gi, 'Divina $1')
                .replace(/(\d+)º\s+Arcana/gi, 'Arcana $1')  // Caso já esteja parcialmente convertido
                .replace(/(\d+)º\s+Divina/gi, 'Divina $1'); // Caso já esteja parcialmente convertido
            
            // Log para debug se houve conversão
            if (originalLevel !== convertedLevel) {
                console.log(`🔄 Nível convertido: "${originalLevel}" → "${convertedLevel}"`);
            }
            
            return convertedLevel;
        }

        // Importar biblioteca de magias
        window.importSpellLibrary = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedSpells = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedSpells)) {
                            alert('Arquivo inválido! O arquivo deve conter um array de magias.');
                            return;
                        }
                        
                        let importedCount = 0;
                        let convertedCount = 0;
                        
                        importedSpells.forEach(spell => {
                            if (spell.name) {
                                // Verificar se já existe
                                const exists = spellLibrary.some(s => s.name.toLowerCase() === spell.name.toLowerCase());
                                if (!exists) {
                                    const originalLevel = spell.level || '';
                                    const convertedLevel = convertSpellLevelFormat(originalLevel);
                                    
                                    // Contar conversões
                                    if (originalLevel !== convertedLevel) {
                                        convertedCount++;
                                    }
                                    
                                    spellLibrary.push({
                                        id: Utils.generateUUID(),
                                        name: spell.name,
                                        level: convertedLevel,
                                        school: spell.school || '',
                                        components: spell.components || '',
                                        time: spell.time || '',
                                        range: spell.range || '',
                                        target: spell.target || '',
                                        duration: spell.duration || '',
                                        resistance: spell.resistance || '',
                                        description: spell.description || ''
                                    });
                                    importedCount++;
                                }
                            }
                        });
                        
                        localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
                        loadSpellLibraryList();
                        hasUnsavedChanges = true;
                        
                        let successMessage = `Biblioteca importada com sucesso! ${importedCount} magias adicionadas.`;
                        if (convertedCount > 0) {
                            successMessage += `\n\n✨ ${convertedCount} magias tiveram seus níveis automaticamente convertidos para o formato correto.`;
                        }
                        
                        alert(successMessage);
                        
                    } catch (error) {
                        alert('Erro ao importar arquivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Excluir todas as magias da biblioteca
        window.clearAllSpells = function() {
            if (spellLibrary.length === 0) {
                alert('A biblioteca já está vazia!');
                return;
            }

            const confirmed = confirm(
                `ATENÇÃO: Esta ação irá excluir TODAS as ${spellLibrary.length} magias da biblioteca!\n\n` +
                'Esta ação não pode ser desfeita.\n\n' +
                'Tem certeza que deseja continuar?'
            );

            if (confirmed) {
                const secondConfirm = confirm(
                    'CONFIRMAÇÃO FINAL:\n\n' +
                    'Todas as magias serão permanentemente excluídas.\n\n' +
                    'Clique em OK para confirmar a exclusão total.'
                );

                if (secondConfirm) {
                    spellLibrary.length = 0; // Limpar array
                    localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
                    resetSpellPagination();
                    loadSpellLibraryList();
                    hasUnsavedChanges = true;
                    alert('Todas as magias foram excluídas da biblioteca!');
                }
            }
        }

        // === SELEÇÃO DE MAGIAS PARA PREPARADAS ===

        // Abrir modal de seleção de magias
        window.openSpellSelectionModal = function() {
            if (!currentCharacterId) return;
            
            const modal = document.getElementById('spell-selection-modal');
            modal.classList.remove('hidden');
            modal.querySelector('.themed-bg-surface').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.themed-bg-surface').classList.add('scale-100', 'opacity-100');
            
            loadSpellSelectionList();
            
            // Adicionar listener para ESC
            document.addEventListener('keydown', handleSelectionModalKeydown);
        }

        // Fechar modal de seleção
        window.closeSpellSelectionModal = function() {
            const modal = document.getElementById('spell-selection-modal');
            modal.querySelector('.themed-bg-surface').classList.remove('scale-100', 'opacity-100');
            modal.querySelector('.themed-bg-surface').classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // Remover listener do ESC
            document.removeEventListener('keydown', handleSelectionModalKeydown);
        }

        // Handler para tecla ESC no modal de seleção
        function handleSelectionModalKeydown(event) {
            if (event.key === 'Escape') {
                closeSpellSelectionModal();
            }
        }

        // Carregar lista de magias para seleção
        function loadSpellSelectionList() {
            Logger.ui('info', 'Carregando lista de magias para seleção', { 
                total: spellLibrary.length,
                page: currentSpellSelectionPage,
                perPage: spellSelectionPerPage
            });
            
            const container = document.getElementById('spell-selection-list');
            
            if (spellLibrary.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhuma magia disponível na biblioteca. Cadastre magias na Biblioteca de Magias primeiro.</p>';
                updateSpellSelectionPagination(0, 0);
                return;
            }

            const filteredSpells = filterSelectionSpellsData();
            const preparedSpellIds = characters[currentCharacterId].spells.map(s => s.libraryId).filter(id => id);
            
            if (filteredSpells.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhuma magia encontrada com os filtros aplicados.</p>';
                updateSpellSelectionPagination(0, 0);
                return;
            }

            // Implementa paginação
            const startIndex = (currentSpellSelectionPage - 1) * spellSelectionPerPage;
            const endIndex = startIndex + spellSelectionPerPage;
            const paginatedSpells = filteredSpells.slice(startIndex, endIndex);
            
            // Calcula total de páginas
            const totalPages = Math.ceil(filteredSpells.length / spellSelectionPerPage);

            container.innerHTML = paginatedSpells.map(spell => {
                const isAlreadyPrepared = preparedSpellIds.includes(spell.id);
                return `
                    <div class="themed-bg-surface border themed-border rounded-lg p-3 hover:border-blue-500 transition duration-150 ${isAlreadyPrepared ? 'opacity-50' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold text-blue-300 text-sm">${Utils.sanitizeHTML(spell.name)}</h5>
                                
                                <!-- Tags de Nível -->
                                ${spell.level ? `
                                    <div class="flex flex-wrap gap-1 mt-1 mb-2">
                                        ${spell.level.split(',').map(level => `
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getSpellLevelTagColor(level.trim())} text-white">
                                                ${Utils.sanitizeHTML(level.trim())}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                <div class="grid grid-cols-2 gap-2 text-xs themed-text-muted mt-1">
                                    ${spell.school ? `<span><strong>Escola:</strong> ${Utils.sanitizeHTML(spell.school)}</span>` : ''}
                                    ${spell.components ? `<span><strong>Componentes:</strong> ${Utils.sanitizeHTML(spell.components)}</span>` : ''}
                                    ${spell.time ? `<span><strong>Tempo:</strong> ${Utils.sanitizeHTML(spell.time)}</span>` : ''}
                                </div>
                                ${spell.description ? `<p class="text-xs mt-2 themed-text-base">${Utils.sanitizeHTML(spell.description)}</p>` : ''}
                            </div>
                            <div class="ml-2">
                                ${isAlreadyPrepared ? 
                                    '<span class="text-xs text-green-400 font-medium">✓ Já Preparada</span>' :
                                    `<button onclick="addSpellToPrepared('${spell.id}')" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition duration-150">Preparar</button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Atualiza controles de paginação
            updateSpellSelectionPagination(currentSpellSelectionPage, totalPages);
            
            Logger.ui('info', 'Lista de magias carregada com sucesso', {
                filtered: filteredSpells.length,
                displayed: paginatedSpells.length,
                page: currentSpellSelectionPage,
                totalPages: totalPages
            });
        }

        // Filtrar magias para seleção
        window.filterSelectionSpells = function() {
            currentSpellSelectionPage = 1; // Reset para primeira página ao filtrar
            loadSpellSelectionList();
        }

        // Atualizar controles de paginação do modal de seleção de magias
        function updateSpellSelectionPagination(currentPage, totalPages) {
            const pageInfo = document.getElementById('spell-selection-page-info');
            const prevBtn = document.getElementById('spell-selection-prev-btn');
            const nextBtn = document.getElementById('spell-selection-next-btn');
            
            if (pageInfo && prevBtn && nextBtn) {
                pageInfo.textContent = totalPages > 0 ? `Página ${currentPage} de ${totalPages}` : 'Nenhum resultado';
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
                
                prevBtn.className = `px-3 py-1 rounded text-sm transition duration-150 ${
                    currentPage <= 1 
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                }`;
                
                nextBtn.className = `px-3 py-1 rounded text-sm transition duration-150 ${
                    currentPage >= totalPages || totalPages === 0
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                }`;
            }
        }

        // Navegar páginas do modal de seleção de magias
        window.changeSpellSelectionPage = function(direction) {
            if (direction === 'prev' && currentSpellSelectionPage > 1) {
                currentSpellSelectionPage--;
            } else if (direction === 'next') {
                currentSpellSelectionPage++;
            }
            
            Logger.pagination('info', 'Navegação de página no modal de seleção', {
                direction: direction,
                newPage: currentSpellSelectionPage,
                perPage: spellSelectionPerPage
            });
            
            loadSpellSelectionList();
        }

        // Alterar quantidade de itens por página do modal de seleção
        window.changeSpellSelectionPerPage = function() {
            const select = document.getElementById('spell-selection-per-page');
            spellSelectionPerPage = parseInt(select.value);
            currentSpellSelectionPage = 1; // Reset para primeira página
            
            Logger.pagination('info', 'Alteração de itens por página no modal de seleção', {
                newPerPage: spellSelectionPerPage,
                resetToPage: currentSpellSelectionPage
            });
            
            loadSpellSelectionList();
        }

        // Atualizar controles de paginação do modal de seleção de talentos
        function updateTalentSelectionPagination(currentPage, totalPages) {
            const pageInfo = document.getElementById('talent-selection-page-info');
            const prevBtn = document.getElementById('talent-selection-prev-btn');
            const nextBtn = document.getElementById('talent-selection-next-btn');
            
            if (pageInfo && prevBtn && nextBtn) {
                pageInfo.textContent = totalPages > 0 ? `Página ${currentPage} de ${totalPages}` : 'Nenhum resultado';
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
                
                prevBtn.className = `px-3 py-1 rounded text-sm transition duration-150 ${
                    currentPage <= 1 
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                }`;
                
                nextBtn.className = `px-3 py-1 rounded text-sm transition duration-150 ${
                    currentPage >= totalPages || totalPages === 0
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                }`;
            }
        }

        // Navegar páginas do modal de seleção de talentos
        window.changeTalentSelectionPage = function(direction) {
            if (direction === 'prev' && currentTalentSelectionPage > 1) {
                currentTalentSelectionPage--;
            } else if (direction === 'next') {
                currentTalentSelectionPage++;
            }
            
            Logger.pagination('info', 'Navegação de página no modal de seleção de talentos', {
                direction: direction,
                newPage: currentTalentSelectionPage,
                perPage: talentSelectionPerPage
            });
            
            filterTalentSelection();
        }

        // Alterar quantidade de itens por página do modal de seleção de talentos
        window.changeTalentSelectionPerPage = function() {
            const select = document.getElementById('talent-selection-per-page');
            talentSelectionPerPage = parseInt(select.value);
            currentTalentSelectionPage = 1; // Reset para primeira página
            
            Logger.pagination('info', 'Alteração de itens por página no modal de seleção de talentos', {
                newPerPage: talentSelectionPerPage,
                resetToPage: currentTalentSelectionPage
            });
            
            filterTalentSelection();
        }

        function filterSelectionSpellsData() {
            const searchTerm = document.getElementById('selection-spell-search-input').value.toLowerCase().trim();
            
            if (!searchTerm) return spellLibrary;
            
            return spellLibrary.filter(spell => 
                spell.name.toLowerCase().includes(searchTerm) ||
                spell.level.toLowerCase().includes(searchTerm) ||
                spell.school.toLowerCase().includes(searchTerm) ||
                spell.description.toLowerCase().includes(searchTerm)
            );
        }

        // Adicionar magia às preparadas
        window.addSpellToPrepared = function(librarySpellId) {
            if (!currentCharacterId) return;
            
            const librarySpell = spellLibrary.find(s => s.id === librarySpellId);
            if (!librarySpell) return;
            
            // Verificar se já está preparada
            const alreadyPrepared = characters[currentCharacterId].spells.some(s => s.libraryId === librarySpellId);
            if (alreadyPrepared) {
                alert('Esta magia já está preparada!');
                return;
            }
            
            // Criar cópia da magia da biblioteca para as preparadas
            const preparedSpell = {
                id: Utils.generateUUID(),
                libraryId: librarySpellId,
                name: librarySpell.name,
                level: librarySpell.level,
                school: librarySpell.school,
                components: librarySpell.components,
                time: librarySpell.time,
                range: librarySpell.range,
                target: librarySpell.target,
                duration: librarySpell.duration,
                resistance: librarySpell.resistance,
                description: librarySpell.description
            };
            
            characters[currentCharacterId].spells.push(preparedSpell);
            localStorage.setItem('characters', JSON.stringify(characters));
            
            hasUnsavedChanges = true;
            filterSpells(); // Atualizar lista de magias preparadas
            loadSpellSelectionList(); // Atualizar lista de seleção
        }

        // Importar magias preparadas
        window.importPreparedSpells = function() {
            if (!currentCharacterId) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let spellsToImport = [];
                        
                        // Detectar formato do arquivo
                        if (Array.isArray(importedData)) {
                            spellsToImport = importedData;
                        } else if (importedData.spells && Array.isArray(importedData.spells)) {
                            spellsToImport = importedData.spells;
                        } else {
                            alert('Formato de arquivo inválido!');
                            return;
                        }
                        
                        let importedCount = 0;
                        spellsToImport.forEach(spell => {
                            if (spell.name) {
                                // Verificar se já existe nas preparadas
                                const exists = characters[currentCharacterId].spells.some(s => s.name.toLowerCase() === spell.name.toLowerCase());
                                if (!exists) {
                                    characters[currentCharacterId].spells.push({
                                        id: Utils.generateUUID(),
                                        libraryId: spell.libraryId || null,
                                        name: spell.name,
                                        level: spell.level || '',
                                        school: spell.school || '',
                                        components: spell.components || '',
                                        time: spell.time || '',
                                        range: spell.range || '',
                                        target: spell.target || '',
                                        duration: spell.duration || '',
                                        resistance: spell.resistance || '',
                                        description: spell.description || ''
                                    });
                                    importedCount++;
                                }
                            }
                        });
                        
                        localStorage.setItem('characters', JSON.stringify(characters));
                        hasUnsavedChanges = true;
                        filterSpells();
                        
                        alert(`Magias importadas com sucesso! ${importedCount} magias adicionadas às preparadas.`);
                        
                    } catch (error) {
                        alert('Erro ao importar arquivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Exportar magias da ficha para a biblioteca
        window.exportCharacterSpellsToLibrary = function() {
            if (!currentCharacterId || !characters[currentCharacterId] || !characters[currentCharacterId].spells) {
                alert('Nenhuma ficha carregada ou sem magias para exportar!');
                return;
            }

            const characterSpells = characters[currentCharacterId].spells;
            if (characterSpells.length === 0) {
                alert('Não há magias na ficha para exportar!');
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            const addedSpells = [];

            characterSpells.forEach(spell => {
                // Verificar se já existe na biblioteca (por nome)
                const existsInLibrary = spellLibrary.some(libSpell => 
                    libSpell.name.toLowerCase().trim() === spell.name.toLowerCase().trim()
                );

                if (!existsInLibrary) {
                    // Adicionar à biblioteca
                    const librarySpell = {
                        id: Utils.generateUUID(),
                        name: spell.name,
                        level: spell.level || '',
                        school: spell.school || '',
                        components: spell.components || '',
                        time: spell.time || '',
                        range: spell.range || '',
                        target: spell.target || '',
                        duration: spell.duration || '',
                        resistance: spell.resistance || '',
                        description: spell.description || ''
                    };
                    
                    spellLibrary.push(librarySpell);
                    addedSpells.push(spell.name);
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            if (addedCount > 0) {
                localStorage.setItem('spellLibrary', JSON.stringify(spellLibrary));
                hasUnsavedChanges = true;
                
                // Atualizar lista da biblioteca se estiver aberta
                if (!document.getElementById('spell-library-modal').classList.contains('hidden')) {
                    loadSpellLibraryList();
                }

                let message = `Exportação concluída!\n\n`;
                message += `✅ ${addedCount} magias adicionadas à biblioteca\n`;
                if (skippedCount > 0) {
                    message += `⚠️ ${skippedCount} magias ignoradas (já existem na biblioteca)\n`;
                }
                if (addedSpells.length > 0) {
                    message += `\nMagias adicionadas:\n• ${addedSpells.join('\n• ')}`;
                }
                
                alert(message);
            } else {
                alert('Nenhuma magia foi exportada.\nTodas as magias da ficha já existem na biblioteca.');
            }
        }

        // === BIBLIOTECA DE TALENTOS ===
        let talentLibrary = [];
        let currentEditingTalentId = null;

        // Variáveis de paginação para talentos
        let currentTalentPage = 1;
        const talentsPerPage = 20;

        // Inicializar biblioteca de talentos
        function initializeTalentLibrary() {
            const saved = localStorage.getItem('talentLibrary');
            console.log('🔍 DEBUG initializeTalentLibrary - localStorage value:', saved);
            
            if (saved) {
                try {
                    talentLibrary = JSON.parse(saved);
                    console.log('🔍 DEBUG initializeTalentLibrary - parsed talentLibrary:', talentLibrary);
                    console.log('🔍 DEBUG initializeTalentLibrary - talentLibrary.length:', talentLibrary.length);
                    
                    // DEBUG: Examinar estrutura de cada talento carregado
                    if (talentLibrary.length > 0) {
                        console.log('🔍 DEBUG - Estrutura dos talentos carregados do localStorage:');
                        talentLibrary.forEach((talent, index) => {
                            console.log(`🔍 DEBUG talento carregado ${index}:`, talent);
                            console.log(`🔍 DEBUG talento carregado ${index} - propriedades:`, Object.keys(talent));
                        });
                    }
                } catch (e) {
                    console.error('Erro ao carregar biblioteca de talentos:', e);
                    talentLibrary = [];
                }
            } else {
                console.log('🔍 DEBUG initializeTalentLibrary - nenhum dado no localStorage');
                talentLibrary = [];
            }
        }

        // Salvar biblioteca de talentos
        function saveTalentLibrary() {
            localStorage.setItem('talentLibrary', JSON.stringify(talentLibrary));
            hasUnsavedChanges = true;
        }

        // Abrir modal da biblioteca de talentos
        window.openTalentLibraryModal = function() {
            const modal = document.getElementById('talent-library-modal');
            if (modal) {
                modal.classList.remove('hidden');
                loadTalentLibraryList();
                clearTalentLibraryForm();
            }
        }

        // Fechar modal da biblioteca de talentos
        window.closeTalentLibraryModal = function() {
            const modal = document.getElementById('talent-library-modal');
            if (modal) {
                modal.classList.add('hidden');
                currentEditingTalentId = null;
                clearTalentLibraryForm();
            }
        }

        // Limpar formulário da biblioteca de talentos
        window.clearTalentLibraryForm = function() {
            document.getElementById('lib-talent-name').value = '';
            document.getElementById('lib-talent-type').value = 'combate';
            document.getElementById('lib-talent-prerequisite').value = '';
            document.getElementById('lib-talent-description').value = '';
            document.getElementById('lib-talent-benefit').value = '';
            
            // Ocultar informações de edição
            const editInfo = document.getElementById('talent-library-edit-info');
            if (editInfo) editInfo.classList.add('hidden');
            
            currentEditingTalentId = null;
        }

        // Adicionar talento à biblioteca
        window.addTalentToLibrary = function() {
            const name = document.getElementById('lib-talent-name').value.trim();
            const type = document.getElementById('lib-talent-type').value;
            const prerequisite = document.getElementById('lib-talent-prerequisite').value.trim();
            const description = document.getElementById('lib-talent-description').value.trim();
            const benefit = document.getElementById('lib-talent-benefit').value.trim();
            
            if (!name) {
                alert('Por favor, insira o nome do talento');
                return;
            }
            
            // Verificar se já existe (exceto se estiver editando)
            const exists = talentLibrary.some(t => 
                t.name.toLowerCase() === name.toLowerCase() && 
                t.id !== currentEditingTalentId
            );
            
            if (exists) {
                alert('Um talento com esse nome já existe na biblioteca');
                return;
            }
            
            const talent = {
                id: Utils.generateUUID(),
                name: name,
                type: type,
                prerequisite: prerequisite,
                description: description,
                benefit: benefit
            };
            
            // DEBUG: Verificar estrutura do talento criado manualmente
            console.log('🔍 DEBUG addTalentToLibrary - Talento criado manualmente:', talent);
            console.log('🔍 DEBUG addTalentToLibrary - propriedades:', Object.keys(talent));
            
            talentLibrary.push(talent);
            saveTalentLibrary();
            resetTalentPagination();
            loadTalentLibraryList();
            clearTalentLibraryForm();
            
            alert('Talento adicionado à biblioteca com sucesso!');
        }

        // Editar talento da biblioteca
        window.editTalentFromLibrary = function(talentId) {
            const talent = talentLibrary.find(t => t.id === talentId);
            if (!talent) return;
            
            // Preencher formulário
            document.getElementById('lib-talent-name').value = talent.name;
            document.getElementById('lib-talent-type').value = talent.type;
            document.getElementById('lib-talent-prerequisite').value = talent.prerequisite || '';
            document.getElementById('lib-talent-description').value = talent.description || '';
            document.getElementById('lib-talent-benefit').value = talent.benefit || '';
            
            // Mostrar informações de edição
            const editInfo = document.getElementById('talent-library-edit-info');
            const editName = document.getElementById('edit-talent-name');
            if (editInfo && editName) {
                editName.textContent = talent.name;
                editInfo.classList.remove('hidden');
            }
            
            currentEditingTalentId = talentId;
        }

        // Atualizar talento na biblioteca
        window.updateTalentInLibrary = function() {
            if (!currentEditingTalentId) return;
            
            const name = document.getElementById('lib-talent-name').value.trim();
            const type = document.getElementById('lib-talent-type').value;
            const prerequisite = document.getElementById('lib-talent-prerequisite').value.trim();
            const description = document.getElementById('lib-talent-description').value.trim();
            const benefit = document.getElementById('lib-talent-benefit').value.trim();
            
            if (!name) {
                alert('Por favor, insira o nome do talento');
                return;
            }
            
            // Verificar se já existe outro talento com o mesmo nome
            const exists = talentLibrary.some(t => 
                t.name.toLowerCase() === name.toLowerCase() && 
                t.id !== currentEditingTalentId
            );
            
            if (exists) {
                alert('Um talento com esse nome já existe na biblioteca');
                return;
            }
            
            const talentIndex = talentLibrary.findIndex(t => t.id === currentEditingTalentId);
            if (talentIndex === -1) return;
            
            talentLibrary[talentIndex] = {
                ...talentLibrary[talentIndex],
                name: name,
                type: type,
                prerequisite: prerequisite,
                description: description,
                benefit: benefit
            };
            
            saveTalentLibrary();
            loadTalentLibraryList();
            clearTalentLibraryForm();
            
            alert('Talento atualizado com sucesso!');
        }

        // Cancelar edição de talento
        window.cancelTalentLibraryEdit = function() {
            clearTalentLibraryForm();
        }

        // Remover talento da biblioteca
        window.removeTalentFromLibrary = function(talentId) {
            const talent = talentLibrary.find(t => t.id === talentId);
            if (!talent) return;
            
            if (confirm(`Tem certeza que deseja remover o talento "${talent.name}" da biblioteca?`)) {
                talentLibrary = talentLibrary.filter(t => t.id !== talentId);
                saveTalentLibrary();
                resetTalentPagination();
                loadTalentLibraryList();
            }
        }

        // Carregar lista da biblioteca de talentos
        function loadTalentLibraryList() {
            filterLibraryTalents();
        }

        // Filtrar talentos da biblioteca
        window.filterLibraryTalents = function() {
            const container = document.getElementById('talent-library-list');
            const paginationControls = document.getElementById('talent-pagination-controls');
            if (!container) return;
            
            const searchTerm = document.getElementById('talent-library-search-input')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('talent-type-filter')?.value || '';
            
            let filteredTalents = talentLibrary;
            
            // Filtrar por busca
            if (searchTerm) {
                filteredTalents = filteredTalents.filter(talent => 
                    talent.name.toLowerCase().includes(searchTerm) ||
                    talent.type.toLowerCase().includes(searchTerm) ||
                    (talent.prerequisite && talent.prerequisite.toLowerCase().includes(searchTerm)) ||
                    (talent.description && talent.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtrar por tipo
            if (typeFilter) {
                filteredTalents = filteredTalents.filter(talent => talent.type === typeFilter);
            }
            
            if (filteredTalents.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8 text-sm">Nenhum talento encontrado.</p>';
                paginationControls.classList.add('hidden');
                return;
            }

            // Cálculos de paginação
            const totalPages = Math.ceil(filteredTalents.length / talentsPerPage);
            const startIndex = (currentTalentPage - 1) * talentsPerPage;
            const endIndex = startIndex + talentsPerPage;
            const currentPageTalents = filteredTalents.slice(startIndex, endIndex);

            // Atualizar controles de paginação
            updateTalentPaginationControls(currentTalentPage, totalPages, filteredTalents.length);
            
            container.innerHTML = currentPageTalents.map(talent => `
                <div class="bg-slate-700 rounded-lg p-4 border border-slate-600 relative">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-green-400 text-lg">${Utils.sanitizeHTML(talent.name)}</h4>
                        <div class="flex space-x-1">
                            <button onclick="editTalentFromLibrary('${talent.id}')" class="text-blue-400 hover:text-blue-300 text-sm" title="Editar">
                                ✏️
                            </button>
                            <button onclick="removeTalentFromLibrary('${talent.id}')" class="text-red-400 hover:text-red-300 text-sm" title="Remover">
                                🗑️
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${getTalentTypeColor(talent.type)}">
                            ${getTalentTypeLabel(talent.type)}
                        </span>
                    </div>
                    
                    ${talent.prerequisite ? `<p class="text-sm text-amber-300 mb-2"><strong>Pré-requisitos:</strong> ${Utils.sanitizeHTML(talent.prerequisite)}</p>` : ''}
                    
                    ${talent.description ? `
                        <div class="text-sm text-gray-300 mb-2">
                            <strong>Descrição:</strong><br>
                            ${Utils.sanitizeHTML(talent.description)}
                        </div>
                    ` : ''}
                    
                    ${talent.benefit ? `
                        <div class="text-sm text-gray-300 bg-slate-800 p-2 rounded">
                            <strong>Benefício:</strong><br>
                            ${Utils.sanitizeHTML(talent.benefit)}
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 flex space-x-2">
                        <input type="checkbox" id="select-talent-${talent.id}" onchange="toggleTalentSelection('${talent.id}')" class="mr-1">
                        <label for="select-talent-${talent.id}" class="text-xs text-gray-400">Selecionar para exportar</label>
                    </div>
                </div>
            `).join('');
        }

        // Obter cor do tipo de talento
        function getTalentTypeColor(type) {
            const colors = {
                'combate': 'bg-red-600 text-white',
                'pericia': 'bg-blue-600 text-white',
                'magia': 'bg-purple-600 text-white',
                'destino': 'bg-yellow-600 text-black',
                'bencao': 'bg-green-600 text-white',
                'poderes': 'bg-indigo-600 text-white',
                'tormenta': 'bg-red-800 text-white',
                'raciais': 'bg-orange-600 text-white',
                'regionais': 'bg-teal-600 text-white',
                'epicos': 'bg-pink-600 text-white',
                'negativos': 'bg-gray-600 text-white',
                'jutsus': 'bg-cyan-600 text-white'
            };
            return colors[type] || 'bg-gray-600 text-white';
        }

        // Obter label do tipo de talento
        function getTalentTypeLabel(type) {
            const labels = {
                'combate': 'Combate',
                'pericia': 'Perícia',
                'magia': 'Magia',
                'destino': 'Destino',
                'bencao': 'Bênção',
                'poderes': 'Poderes Concedidos',
                'tormenta': 'Tormenta',
                'raciais': 'Raciais',
                'regionais': 'Regionais',
                'epicos': 'Épicos',
                'negativos': 'Negativos',
                'jutsus': 'Jutsus'
            };
            return labels[type] || 'Desconhecido';
        }

        // Limpar busca da biblioteca de talentos
        window.clearTalentLibrarySearch = function() {
            const searchInput = document.getElementById('talent-library-search-input');
            const typeFilter = document.getElementById('talent-type-filter');
            
            if (searchInput) searchInput.value = '';
            if (typeFilter) typeFilter.value = '';
            
            resetTalentPagination();
            filterLibraryTalents();
        }

        // Atualizar controles de paginação para talentos
        function updateTalentPaginationControls(currentPage, totalPages, totalItems) {
            const paginationControls = document.getElementById('talent-pagination-controls');
            const pageInfo = document.getElementById('talent-page-info');
            const totalInfo = document.getElementById('talent-total-info');
            const prevBtn = document.getElementById('talent-prev-btn');
            const nextBtn = document.getElementById('talent-next-btn');

            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageInfo.textContent = `${currentPage} / ${totalPages}`;
            totalInfo.textContent = `${totalItems} talentos`;

            // Controlar estado dos botões
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Mudar página dos talentos
        window.changeTalentPage = function(direction) {
            const searchTerm = document.getElementById('talent-library-search-input')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('talent-type-filter')?.value || '';
            
            let filteredTalents = talentLibrary;
            
            // Aplicar mesmos filtros para calcular total de páginas
            if (searchTerm) {
                filteredTalents = filteredTalents.filter(talent => 
                    talent.name.toLowerCase().includes(searchTerm) ||
                    talent.type.toLowerCase().includes(searchTerm) ||
                    (talent.prerequisite && talent.prerequisite.toLowerCase().includes(searchTerm)) ||
                    (talent.description && talent.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (typeFilter) {
                filteredTalents = filteredTalents.filter(talent => talent.type === typeFilter);
            }
            
            const totalPages = Math.ceil(filteredTalents.length / talentsPerPage);
            const newPage = currentTalentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentTalentPage = newPage;
                filterLibraryTalents();
            }
        }

        // Reset da página quando filtros mudarem
        window.resetTalentPagination = function() {
            currentTalentPage = 1;
        }

        // Togglear seleção de talento
        let selectedTalentIds = new Set();
        window.toggleTalentSelection = function(talentId) {
            const checkbox = document.getElementById(`select-talent-${talentId}`);
            if (checkbox && checkbox.checked) {
                selectedTalentIds.add(talentId);
            } else {
                selectedTalentIds.delete(talentId);
            }
        }

        // Exportar biblioteca de talentos
        window.exportTalentLibrary = function() {
            if (talentLibrary.length === 0) {
                alert('Não há talentos na biblioteca para exportar');
                return;
            }
            
            const dataStr = JSON.stringify(talentLibrary, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `biblioteca-talentos-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            alert(`Biblioteca exportada com ${talentLibrary.length} talentos!`);
        }

        // Exportar talentos selecionados
        window.exportSelectedTalents = function() {
            if (selectedTalentIds.size === 0) {
                alert('Nenhum talento selecionado para exportar');
                return;
            }
            
            const selectedTalents = talentLibrary.filter(talent => selectedTalentIds.has(talent.id));
            
            const dataStr = JSON.stringify(selectedTalents, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `talentos-selecionados-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            alert(`Exportados ${selectedTalents.length} talentos selecionados!`);
        }

        // Importar biblioteca de talentos
        window.importTalentLibrary = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedTalents = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedTalents)) {
                            alert('Arquivo inválido! O arquivo deve conter um array de talentos.');
                            return;
                        }
                        
                        let importedCount = 0;
                        importedTalents.forEach(talent => {
                            if (talent.name) {
                                // Verificar se já existe
                                const exists = talentLibrary.some(t => t.name.toLowerCase() === talent.name.toLowerCase());
                                if (!exists) {
                                    talentLibrary.push({
                                        id: Utils.generateUUID(),
                                        name: talent.name,
                                        type: talent.type || 'combate',
                                        prerequisite: talent.prerequisite || '',
                                        description: talent.description || '',
                                        benefit: talent.benefit || ''
                                    });
                                    importedCount++;
                                }
                            }
                        });
                        
                        saveTalentLibrary();
                        loadTalentLibraryList();
                        
                        alert(`Biblioteca importada com sucesso! ${importedCount} talentos adicionados.`);
                        
                    } catch (error) {
                        console.error('Erro ao importar:', error);
                        alert('Erro ao importar arquivo. Verifique se é um arquivo JSON válido.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Excluir todos os talentos da biblioteca
        window.clearAllTalents = function() {
            if (talentLibrary.length === 0) {
                alert('A biblioteca já está vazia!');
                return;
            }

            const confirmed = confirm(
                `ATENÇÃO: Esta ação irá excluir TODOS os ${talentLibrary.length} talentos da biblioteca!\n\n` +
                'Esta ação não pode ser desfeita.\n\n' +
                'Tem certeza que deseja continuar?'
            );

            if (confirmed) {
                const secondConfirm = confirm(
                    'CONFIRMAÇÃO FINAL:\n\n' +
                    'Todos os talentos serão permanentemente excluídos.\n\n' +
                    'Clique em OK para confirmar a exclusão total.'
                );

                if (secondConfirm) {
                    talentLibrary.length = 0; // Limpar array
                    saveTalentLibrary();
                    resetTalentPagination();
                    loadTalentLibraryList();
                    alert('Todos os talentos foram excluídos da biblioteca!');
                }
            }
        }

        // === MODAL DE SELEÇÃO DE TALENTOS ===

        // Abrir modal de seleção de talentos
        window.openTalentSelectionModal = function() {
            if (!currentCharacterId) {
                alert('Por favor, selecione um personagem primeiro');
                return;
            }
            
            const modal = document.getElementById('talent-selection-modal');
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    const modalContent = modal.querySelector('.transform');
                    if (modalContent) {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                    }
                }, 10);
                loadTalentSelectionList();
            }
        }

        // Fechar modal de seleção de talentos
        window.closeTalentSelectionModal = function() {
            const modal = document.getElementById('talent-selection-modal');
            if (modal) {
                const modalContent = modal.querySelector('.transform');
                if (modalContent) {
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // DEBUG: Função para renderizar com chaves corretas
        window.renderCharacterListFixed = function() {
            console.log('🔧 FIXED renderCharacterList - iniciando...');
            
            const container = document.getElementById('char-list-container');
            container.innerHTML = '';
            
            // Usar Object.entries para ter tanto a chave quanto o objeto
            const charEntries = Object.entries(characters);
            console.log('🔧 FIXED - charEntries:', charEntries.length);
            
            if (charEntries.length === 0) {
                document.getElementById('no-chars-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-chars-message').classList.add('hidden');

            charEntries
                .sort(([,a], [,b]) => new Date(b.createdAt) - new Date(a.createdAt))
                .forEach(([charId, char]) => {
                    console.log(`🔧 FIXED - renderizando: ${char.name} com CHAVE: ${charId} vs OBJECT ID: ${char.id}`);
                    
                    const charCard = document.createElement('div');
                    charCard.className = 'stat-card themed-bg-surface p-6 rounded-xl shadow-lg border-t-4 themed-border-secondary flex flex-col justify-between';
                    
                    // USAR A CHAVE DO OBJETO, NÃO O char.id
                    const cardHTML = [
                        '<div class="flex items-center space-x-4">',
                        `<img src="${char.imageUrl || 'https://placehold.co/80x80/1f2937/f3f4f6?text=?'}" alt="Retrato de ${char.name}" class="w-20 h-20 rounded-full object-cover object-top border-2 themed-border flex-shrink-0">`,
                        '<div class="flex-grow min-w-0">',
                        `<h3 class="text-xl font-bold themed-text-primary-light mb-1 truncate">${char.name}</h3>`,
                        `<p class="text-sm themed-text-muted mb-2">${char.classLevel} (${char.race})</p>`,
                        `<p class="text-xs themed-text-muted">J: ${char.player}</p>`,
                        '</div>',
                        '</div>',
                        '<div class="mt-4 flex justify-between items-center">',
                        `<button onclick="selectCharacter('${charId}')" class="px-4 py-1 text-sm themed-bg-primary themed-bg-primary-hover text-white rounded-lg transition duration-150">Ver Ficha</button>`,
                        '<div class="flex space-x-2">',
                        `<button onclick="event.stopPropagation(); exportCharacter('${charId}')" class="px-3 py-1 text-sm themed-bg-button themed-bg-button-hover text-white rounded-lg transition">Exportar</button>`,
                        `<button onclick="confirmDeleteCharacter('${charId}', '${char.name.replace(/'/g, "\\'")}')" class="text-red-400 hover:text-red-500 p-1 rounded-full hover:bg-gray-700 transition">`,
                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>',
                        '</button>',
                        '</div>',
                        '</div>'
                    ].join('');
                    
                    charCard.innerHTML = cardHTML;
                    container.appendChild(charCard);
                });
        }

        // DEBUG: Função para investigar a discrepância de IDs
        window.debugIdDiscrepancy = function() {
            console.log('🔍 INVESTIGAÇÃO ID DISCREPANCY:');
            console.log('🔍 Object.keys(characters):', Object.keys(characters));
            
            const charArray = Object.values(characters);
            console.log('🔍 Object.values(characters) IDs:', charArray.map(c => c.id));
            console.log('🔍 Object.values(characters) nomes:', charArray.map(c => c.name));
            
            Object.entries(characters).forEach(([key, char]) => {
                console.log(`🔍 KEY: ${key} -> OBJECT ID: ${char.id} -> NOME: ${char.name}`);
                if (key !== char.id) {
                    console.log(`🚨 DISCREPÂNCIA! KEY (${key}) != OBJECT ID (${char.id})`);
                }
            });
        }

        // DEBUG: Função para forçar re-renderização da lista
        window.forceRefreshCharacterList = function() {
            console.log('🔄 FORÇA - Forçando re-renderização...');
            
            // Recarregar dados do localStorage
            loadCharactersFromLocalStorage();
            
            // Aguardar um pouco para garantir que carregou
            setTimeout(() => {
                console.log('🔄 FORÇA - Dados recarregados, renderizando...');
                renderCharacterList();
            }, 100);
        }

        // === SISTEMA DE AUDITORIA E LOGGING AVANÇADO ===
        class AuditLogger {
            static logs = [];
            static maxLogs = 1000;
            
            static log(level, category, message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    level,
                    category,
                    message,
                    data: data ? JSON.parse(JSON.stringify(data)) : null,
                    id: Utils.generateUUID()
                };
                
                this.logs.unshift(logEntry);
                
                // Manter apenas os últimos 1000 logs
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(0, this.maxLogs);
                }
                
                // Console output com formatação
                const prefix = this.getPrefix(level, category);
                console.log(`${prefix} ${message}`, data || '');
                
                // Salvar no localStorage se for crítico
                if (level === 'ERROR' || level === 'CRITICAL') {
                    this.saveToStorage();
                }
            }
            
            static getPrefix(level, category) {
                const prefixes = {
                    DEBUG: '🔍',
                    INFO: '<span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs">ℹ</span>',
                    WARN: '⚠️',
                    ERROR: '❌',
                    CRITICAL: '🚨',
                    AUDIT: '📋'
                };
                return `${prefixes[level] || '📝'} [${category}]`;
            }
            
            static saveToStorage() {
                try {
                    const auditLogs = this.logs.slice(0, 100); // Salvar apenas os 100 mais recentes
                    localStorage.setItem('sgptrpg_audit_logs', JSON.stringify(auditLogs));
                } catch (e) {
                    console.error('Falha ao salvar logs de auditoria:', e);
                }
            }
            
            static loadFromStorage() {
                try {
                    const saved = localStorage.getItem('sgptrpg_audit_logs');
                    if (saved) {
                        const oldLogs = JSON.parse(saved);
                        this.logs = [...oldLogs, ...this.logs];
                    }
                } catch (e) {
                    console.error('Falha ao carregar logs de auditoria:', e);
                }
            }
            
            static getLogs(filter = {}) {
                let filtered = this.logs;
                
                if (filter.level) {
                    filtered = filtered.filter(log => log.level === filter.level);
                }
                if (filter.category) {
                    filtered = filtered.filter(log => log.category === filter.category);
                }
                if (filter.since) {
                    filtered = filtered.filter(log => new Date(log.timestamp) >= filter.since);
                }
                
                return filtered;
            }
            
            static exportLogs() {
                const logsData = {
                    exportDate: new Date().toISOString(),
                    totalLogs: this.logs.length,
                    logs: this.logs
                };
                
                const blob = new Blob([JSON.stringify(logsData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sgptrpg_audit_logs_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // === SISTEMA DE VALIDAÇÃO DE IDS ===
        class IDValidator {
            static validateCharacterConsistency() {
                const issues = [];
                
                Object.entries(characters).forEach(([key, char]) => {
                    // Verificar se a chave bate com o ID do objeto
                    if (key !== char.id) {
                        issues.push({
                            type: 'ID_MISMATCH',
                            severity: 'CRITICAL',
                            charName: char.name,
                            keyId: key,
                            objectId: char.id,
                            message: `Personagem "${char.name}": chave (${key}) não bate com object.id (${char.id})`
                        });
                    }
                    
                    // Verificar se o ID é válido (formato UUID)
                    if (!char.id || typeof char.id !== 'string' || char.id.length < 10) {
                        issues.push({
                            type: 'INVALID_ID',
                            severity: 'ERROR',
                            charName: char.name,
                            charId: char.id,
                            message: `Personagem "${char.name}" tem ID inválido: ${char.id}`
                        });
                    }
                });
                
                // Log dos problemas encontrados
                issues.forEach(issue => {
                    AuditLogger.log(issue.severity, 'ID_VALIDATION', issue.message, issue);
                });
                
                return issues;
            }
            
            static fixCharacterIds() {
                const fixes = [];
                
                Object.entries(characters).forEach(([key, char]) => {
                    if (key !== char.id) {
                        const oldId = char.id;
                        char.id = key; // Corrigir o ID do objeto para bater com a chave
                        
                        fixes.push({
                            charName: char.name,
                            oldId: oldId,
                            newId: key
                        });
                        
                        AuditLogger.log('INFO', 'ID_FIX', `Corrigido ID do personagem "${char.name}": ${oldId} → ${key}`);
                    }
                });
                
                if (fixes.length > 0) {
                    saveCharactersToLocalStorage();
                    AuditLogger.log('INFO', 'ID_FIX', `Corrigidos ${fixes.length} IDs de personagens`);
                }
                
                return fixes;
            }
        }

        // DEBUG: Função para testar exclusão com ID correto
        window.deleteCorrectCharacter = function() {
            const correctId = '70a02d9c-d60e-4741-9ffd-e98efbef0f52';
            console.log('🎯 Tentando excluir com ID correto:', correctId);
            confirmDeleteCharacter(correctId, 'jdjjdss');
        }

        // DEBUG: Função para investigar discrepância
        window.debugCharacterDiscrepancy = function() {
            console.log('🔍 INVESTIGAÇÃO: Analisando discrepância...');
            console.log('🔍 Object.keys(characters):', Object.keys(characters));
            console.log('🔍 characters object completo:', characters);
            
            // Verificar se o ID específico existe
            const targetId = '875ce26c-b819-49c2-9d42-5d9699afd32c';
            console.log('🔍 characters[targetId]:', characters[targetId]);
            console.log('🔍 targetId existe em characters?', targetId in characters);
            
            // Verificar todos os personagens e seus IDs
            Object.entries(characters).forEach(([id, char]) => {
                console.log(`🔍 ID: ${id} -> Nome: ${char.name}`);
            });
            
            // Verificar localStorage
            const saved = localStorage.getItem('tormenta_chars_local_data');
            if (saved) {
                const parsedChars = JSON.parse(saved);
                console.log('🔍 localStorage IDs:', Object.keys(parsedChars));
                Object.entries(parsedChars).forEach(([id, char]) => {
                    console.log(`🔍 localStorage ID: ${id} -> Nome: ${char.name}`);
                });
            }
        }

        // DEBUG: Função para testar exclusão diretamente
        window.testDeleteCharacter = function(charId) {
            console.log('🧪 TESTE testDeleteCharacter - charId:', charId);
            
            if (typeof charId === 'string') {
                console.log('🧪 TESTE - ID é string, chamando deleteCharacter...');
                deleteCharacter(charId);
            } else {
                console.log('🧪 TESTE - ID não é string:', typeof charId);
            }
        }

        // DEBUG: Função para testar confirmação de exclusão
        window.testConfirmDeleteCharacter = function(charId, charName) {
            console.log('🧪 TESTE confirmDeleteCharacter - charId:', charId, 'charName:', charName);
            
            try {
                confirmDeleteCharacter(charId, charName);
                console.log('🧪 TESTE - confirmDeleteCharacter executado sem erro');
            } catch (e) {
                console.error('🧪 TESTE - Erro em confirmDeleteCharacter:', e);
            }
        }

        // DEBUG: Função para forçar salvamento no localStorage
        window.forceSaveToLocalStorage = function() {
            console.log('🔧 Forçando salvamento...');
            console.log('🔧 characters:', Object.keys(characters));
            console.log('🔧 isLocalStorageAvailable:', isLocalStorageAvailable);
            
            try {
                localStorage.setItem('tormenta_chars_local_data', JSON.stringify(characters));
                console.log('✅ Salvamento forçado realizado com sucesso!');
                
                // Verificar se foi salvo
                const saved = localStorage.getItem('tormenta_chars_local_data');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    console.log('✅ Verificação: personagens salvos:', Object.keys(parsed));
                } else {
                    console.log('❌ Verificação: nada foi salvo');
                }
            } catch (e) {
                console.error('❌ Erro no salvamento forçado:', e);
            }
        }

        // DEBUG: Função para verificar personagem específico
        window.checkForCharacter = function(name) {
            console.log('🔍 Verificando personagem:', name);
            console.log('🔍 Personagens atuais em memória:', Object.keys(characters));
            
            // Verificar em memória
            const foundInMemory = Object.values(characters).find(char => 
                char.name && char.name.toLowerCase().includes(name.toLowerCase())
            );
            
            if (foundInMemory) {
                console.log('✅ Encontrado em memória:', foundInMemory);
            } else {
                console.log('❌ Não encontrado em memória');
            }
            
            // Verificar no localStorage
            const saved = localStorage.getItem('tormenta_chars_local_data');
            if (saved) {
                try {
                    const parsedChars = JSON.parse(saved);
                    console.log('🔍 Personagens no localStorage:', Object.keys(parsedChars));
                    
                    const foundInStorage = Object.values(parsedChars).find(char => 
                        char.name && char.name.toLowerCase().includes(name.toLowerCase())
                    );
                    
                    if (foundInStorage) {
                        console.log('✅ Encontrado no localStorage:', foundInStorage);
                    } else {
                        console.log('❌ Não encontrado no localStorage');
                    }
                } catch (e) {
                    console.error('❌ Erro ao analisar localStorage:', e);
                }
            } else {
                console.log('❌ Nenhum dado no localStorage');
            }
        }

        // DEBUG: Função para verificar estado da biblioteca de talentos
        window.debugTalentLibrary = function() {
            console.log('🔍 DEBUG FUNÇÃO MANUAL - Estado atual:');
            console.log('🔍 talentLibrary:', talentLibrary);
            console.log('🔍 talentLibrary.length:', talentLibrary.length);
            console.log('🔍 localStorage talentLibrary:', localStorage.getItem('talentLibrary'));
            
            if (talentLibrary.length > 0) {
                console.log('🔍 Estrutura detalhada de cada talento:');
                talentLibrary.forEach((talent, index) => {
                    console.log(`🔍 Talento ${index}:`, talent);
                    console.log(`🔍 Talento ${index} - Propriedades:`, Object.keys(talent));
                    console.log(`🔍 Talento ${index} - Nome: "${talent.name}", Tipo: "${talent.type}"`);
                });
            }
            
            // Testar filtro de seleção
            const container = document.getElementById('talent-selection-list');
            if (container) {
                console.log('🔍 Container de seleção encontrado, chamando filterTalentSelection...');
                filterTalentSelection();
            } else {
                console.log('🔍 Container de seleção não encontrado');
            }
        }

        // Carregar lista de talentos para seleção
        function loadTalentSelectionList() {
            Logger.ui('info', 'Carregando lista de talentos para seleção', { 
                total: talentLibrary.length,
                page: currentTalentSelectionPage,
                perPage: talentSelectionPerPage
            });
            
            // DEBUG: Verificar estado da biblioteca de talentos
            console.log('🔍 DEBUG loadTalentSelectionList - talentLibrary:', talentLibrary);
            console.log('🔍 DEBUG loadTalentSelectionList - talentLibrary.length:', talentLibrary.length);
            
            // Garantir que a biblioteca está inicializada
            if (!talentLibrary || talentLibrary.length === 0) {
                console.log('🔍 DEBUG - Biblioteca de talentos vazia, tentando inicializar...');
                initializeTalentLibrary();
                console.log('🔍 DEBUG - Após inicialização, talentLibrary.length:', talentLibrary.length);
            }
            
            filterTalentSelection();
        }

        // Filtrar talentos para seleção
        window.filterTalentSelection = function() {
            // Reset para primeira página ao filtrar
            currentTalentSelectionPage = 1;
            
            Logger.ui('info', 'Filtrando talentos para seleção', { 
                total: talentLibrary.length,
                page: currentTalentSelectionPage,
                perPage: talentSelectionPerPage
            });
            
            const container = document.getElementById('talent-selection-list');
            if (!container) return;
            
            const searchTerm = document.getElementById('talent-selection-search')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('talent-selection-type-filter')?.value || '';
            
            // DEBUG: Verificar dados iniciais
            console.log('🔍 DEBUG filterTalentSelection - talentLibrary:', talentLibrary);
            console.log('🔍 DEBUG filterTalentSelection - talentLibrary.length:', talentLibrary.length);
            console.log('🔍 DEBUG filterTalentSelection - searchTerm:', searchTerm);
            console.log('🔍 DEBUG filterTalentSelection - typeFilter:', typeFilter);
            
            // DEBUG: Verificar estrutura de cada talento
            if (talentLibrary.length > 0) {
                console.log('🔍 DEBUG - Estrutura dos talentos na biblioteca:');
                talentLibrary.forEach((talent, index) => {
                    console.log(`🔍 DEBUG talento ${index}:`, talent);
                    console.log(`🔍 DEBUG talento ${index} - propriedades:`, Object.keys(talent));
                });
            }
            
            let filteredTalents = talentLibrary;
            
            // Filtrar por busca
            if (searchTerm) {
                filteredTalents = filteredTalents.filter(talent => 
                    talent.name.toLowerCase().includes(searchTerm) ||
                    talent.type.toLowerCase().includes(searchTerm) ||
                    (talent.prerequisite && talent.prerequisite.toLowerCase().includes(searchTerm)) ||
                    (talent.description && talent.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtrar por tipo
            if (typeFilter) {
                filteredTalents = filteredTalents.filter(talent => talent.type === typeFilter);
            }
            
            // Filtrar talentos já adquiridos
            const characterTalents = characters[currentCharacterId]?.talents || [];
            const acquiredTalentNames = characterTalents.map(t => t.name.toLowerCase());
            filteredTalents = filteredTalents.filter(talent => 
                !acquiredTalentNames.includes(talent.name.toLowerCase())
            );
            
            if (filteredTalents.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhum talento disponível na biblioteca. Cadastre talentos na Biblioteca de Talentos primeiro.</p>';
                updateTalentSelectionPagination(0, 0);
                return;
            }
            
            // Implementa paginação
            const startIndex = (currentTalentSelectionPage - 1) * talentSelectionPerPage;
            const endIndex = startIndex + talentSelectionPerPage;
            const paginatedTalents = filteredTalents.slice(startIndex, endIndex);
            
            // Calcula total de páginas
            const totalPages = Math.ceil(filteredTalents.length / talentSelectionPerPage);
            
            container.innerHTML = paginatedTalents.map(talent => `
                <div class="bg-slate-700 rounded-lg p-4 border border-slate-600 mb-2">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-bold text-green-400">${Utils.sanitizeHTML(talent.name)}</h4>
                        <input type="checkbox" id="select-talent-modal-${talent.id}" class="mt-1">
                    </div>
                    
                    <div class="mb-2">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${getTalentTypeColor(talent.type)}">
                            ${getTalentTypeLabel(talent.type)}
                        </span>
                    </div>
                    
                    ${talent.prerequisite ? `<p class="text-sm text-amber-300 mb-2"><strong>Pré-requisitos:</strong> ${Utils.sanitizeHTML(talent.prerequisite)}</p>` : ''}
                    
                    ${talent.description ? `
                        <div class="text-sm text-gray-300 mb-2">
                            <strong>Descrição:</strong><br>
                            ${Utils.sanitizeHTML(talent.description)}
                        </div>
                    ` : ''}
                    
                    ${talent.benefit ? `
                        <div class="text-sm text-gray-300">
                            <strong>Benefício:</strong><br>
                            ${Utils.sanitizeHTML(talent.benefit)}
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // Atualiza controles de paginação
            updateTalentSelectionPagination(currentTalentSelectionPage, totalPages);
            
            Logger.ui('info', 'Lista de talentos carregada com sucesso', {
                filtered: filteredTalents.length,
                displayed: paginatedTalents.length,
                page: currentTalentSelectionPage,
                totalPages: totalPages
            });
        }

        // Adicionar talentos selecionados ao personagem
        window.addSelectedTalentsToCharacter = function() {
            if (!currentCharacterId) return;
            
            const checkboxes = document.querySelectorAll('#talent-selection-list input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Nenhum talento selecionado');
                return;
            }
            
            // Obter origem selecionada
            const originRadios = document.querySelectorAll('input[name="talent-origin"]');
            let selectedOrigin = 'Comprado'; // padrão
            for (const radio of originRadios) {
                if (radio.checked) {
                    selectedOrigin = radio.value;
                    break;
                }
            }
            
            let addedCount = 0;
            checkboxes.forEach(checkbox => {
                const talentId = checkbox.id.replace('select-talent-modal-', '');
                const talent = talentLibrary.find(t => t.id === talentId);
                
                if (talent) {
                    // Verificar se já existe
                    const exists = characters[currentCharacterId].talents.some(t => 
                        t.name.toLowerCase() === talent.name.toLowerCase()
                    );
                    
                    if (!exists) {
                        characters[currentCharacterId].talents.push({
                            id: Utils.generateUUID(),
                            name: talent.name,
                            type: selectedOrigin, // Usar a origem selecionada para cálculo de pontos
                            category: talent.type, // Manter categoria original (combate, magia, etc.)
                            prerequisite: talent.prerequisite,
                            description: talent.description,
                            benefit: talent.benefit,
                            libraryId: talent.id
                        });
                        addedCount++;
                    }
                }
            });
            
            if (addedCount > 0) {
                saveData();
                filterTalents(); // Atualizar lista de talentos adquiridos
                updateTalentCalculator(characters[currentCharacterId]); // Atualizar calculadora
                alert(`${addedCount} talento(s) adicionado(s) como "${selectedOrigin}" com sucesso!`);
                closeTalentSelectionModal();
            } else {
                alert('Todos os talentos selecionados já foram adquiridos');
            }
        }

        // Importar talentos da biblioteca para o personagem
        window.importTalentsFromLibrary = function() {
            if (!currentCharacterId) {
                alert('Por favor, selecione um personagem primeiro');
                return;
            }
            
            if (talentLibrary.length === 0) {
                alert('Não há talentos na biblioteca para importar');
                return;
            }
            
            // Perguntar qual origem usar para todos os talentos
            const origins = [
                'Comprado (consome pontos)',
                'Classe (gratuito)',
                'Raça (gratuito)', 
                'Desvantagem (gera pontos)',
                'Outro (gratuito)'
            ];
            
            let selectedOriginIndex = prompt(
                `Escolha a origem para TODOS os talentos importados:\n\n` +
                origins.map((origin, i) => `${i + 1}. ${origin}`).join('\n') +
                `\n\nDigite o número (1-5):`
            );
            
            if (!selectedOriginIndex || selectedOriginIndex < 1 || selectedOriginIndex > 5) {
                alert('Importação cancelada');
                return;
            }
            
            const originValues = ['Comprado', 'Classe', 'Raça', 'Desvantagem', 'Outro'];
            const selectedOrigin = originValues[parseInt(selectedOriginIndex) - 1];
            
            if (confirm(`Deseja importar TODOS os talentos da biblioteca como "${selectedOrigin}" para este personagem?`)) {
                let importedCount = 0;
                
                talentLibrary.forEach(talent => {
                    // Verificar se já existe
                    const exists = characters[currentCharacterId].talents.some(t => 
                        t.name.toLowerCase() === talent.name.toLowerCase()
                    );
                    
                    if (!exists) {
                        characters[currentCharacterId].talents.push({
                            id: Utils.generateUUID(),
                            name: talent.name,
                            type: selectedOrigin, // Usar origem selecionada
                            category: talent.type, // Manter categoria original
                            prerequisite: talent.prerequisite,
                            description: talent.description,
                            benefit: talent.benefit,
                            libraryId: talent.id
                        });
                        importedCount++;
                    }
                });
                
                if (importedCount > 0) {
                    saveData();
                    filterTalents();
                    updateTalentCalculator(characters[currentCharacterId]); // Atualizar calculadora
                    alert(`${importedCount} talento(s) importado(s) como "${selectedOrigin}" da biblioteca com sucesso!`);
                } else {
                    alert('Todos os talentos da biblioteca já foram adquiridos por este personagem');
                }
            }
        }

        // Exportar talentos da ficha para a biblioteca
        window.exportCharacterTalentsToLibrary = function() {
            if (!currentCharacterId || !characters[currentCharacterId] || !characters[currentCharacterId].talents) {
                alert('Nenhuma ficha carregada ou sem talentos para exportar!');
                return;
            }

            const characterTalents = characters[currentCharacterId].talents;
            if (characterTalents.length === 0) {
                alert('Não há talentos na ficha para exportar!');
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            const addedTalents = [];

            characterTalents.forEach(talent => {
                // Verificar se já existe na biblioteca (por nome)
                const existsInLibrary = talentLibrary.some(libTalent => 
                    libTalent.name.toLowerCase().trim() === talent.name.toLowerCase().trim()
                );

                if (!existsInLibrary) {
                    // Mapear categoria do personagem para tipo da biblioteca
                    let libraryType = 'combate'; // padrão
                    
                    // Mapear baseado na categoria original se disponível
                    if (talent.category) {
                        libraryType = talent.category;
                    } else if (talent.type) {
                        // Mapear por tipo se não tiver categoria
                        switch(talent.type.toLowerCase()) {
                            case 'classe':
                                libraryType = 'classe';
                                break;
                            case 'raça':
                                libraryType = 'racial';
                                break;
                            case 'desvantagem':
                                libraryType = 'desvantagem';
                                break;
                            case 'magia':
                                libraryType = 'magia';
                                break;
                            default:
                                libraryType = 'combate';
                        }
                    }

                    // Adicionar à biblioteca
                    const libraryTalent = {
                        id: Utils.generateUUID(),
                        name: talent.name,
                        type: libraryType,
                        prerequisite: talent.prerequisite || '',
                        description: talent.description || '',
                        benefit: talent.benefit || talent.description || ''
                    };
                    
                    // DEBUG: Verificar estrutura do talento sendo exportado
                    console.log('🔍 DEBUG exportCharacterTalentsToLibrary - Talento original:', talent);
                    console.log('🔍 DEBUG exportCharacterTalentsToLibrary - Talento para biblioteca:', libraryTalent);
                    console.log('🔍 DEBUG exportCharacterTalentsToLibrary - libraryType:', libraryType);
                    
                    talentLibrary.push(libraryTalent);
                    addedTalents.push(talent.name);
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            if (addedCount > 0) {
                localStorage.setItem('talentLibrary', JSON.stringify(talentLibrary));
                hasUnsavedChanges = true;
                
                // Atualizar lista da biblioteca se estiver aberta
                if (!document.getElementById('talent-library-modal').classList.contains('hidden')) {
                    loadTalentLibraryList();
                }

                let message = `Exportação concluída!\n\n`;
                message += `✅ ${addedCount} talentos adicionados à biblioteca\n`;
                if (skippedCount > 0) {
                    message += `⚠️ ${skippedCount} talentos ignorados (já existem na biblioteca)\n`;
                }
                if (addedTalents.length > 0) {
                    message += `\nTalentos adicionados:\n• ${addedTalents.join('\n• ')}`;
                }
                
                alert(message);
            } else {
                alert('Nenhum talento foi exportado.\nTodos os talentos da ficha já existem na biblioteca.');
            }
        }

        // Talentos
        window.openEditTalentModal = function(talentId) {
            if (!currentCharacterId) return;
            const talent = characters[currentCharacterId].talents.find(t => t.id === talentId);
            if (!talent) return;

            document.getElementById('edit-talent-id').value = talent.id;
            document.getElementById('edit-talent-name').value = talent.name;
            document.getElementById('edit-talent-type').value = talent.type || 'Comprado';
            document.getElementById('edit-talent-prerequisite').value = talent.prerequisite;
            document.getElementById('edit-talent-benefit').value = talent.benefit;

            openModal('edit-talent-modal');
        }

        window.saveEditedTalent = function() {
            if (!currentCharacterId) return;
            const talentId = document.getElementById('edit-talent-id').value;
            const charData = characters[currentCharacterId];
            const talent = charData.talents.find(t => t.id === talentId);
            if (!talent) return;

            talent.name = document.getElementById('edit-talent-name').value;
            talent.type = document.getElementById('edit-talent-type').value;
            talent.prerequisite = document.getElementById('edit-talent-prerequisite').value;
            talent.benefit = document.getElementById('edit-talent-benefit').value;
            
            hasUnsavedChanges = true;
            filterTalents();
            updateTalentCalculator(charData);
            closeModal('edit-talent-modal');
        }

        // Equipamentos
        window.openEditEquipmentModal = function(itemId) {
            if (!currentCharacterId) return;
            const item = characters[currentCharacterId].equipment.find(e => e.id === itemId);
            if (!item) return;

            document.getElementById('edit-equipment-id').value = item.id;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-cost').value = item.cost || 0;
            
            const typeSelect = document.getElementById('edit-item-type');
            typeSelect.innerHTML = document.getElementById('item-type').innerHTML; // Clone options
            typeSelect.value = item.type;

            document.getElementById('edit-item-ca-bonus').value = item.caBonus;
            document.getElementById('edit-item-description').value = item.description;

            if (item.type === 'Arma') {
                document.getElementById('edit-weapon-bonus').value = item.bonus || '';
                document.getElementById('edit-weapon-damage').value = item.damage || '';
                document.getElementById('edit-weapon-threat').value = item.threat || '';
                document.getElementById('edit-weapon-special').value = item.special || '';
            }
            toggleEditWeaponFields();
            openModal('edit-equipment-modal');
        }
        
        window.toggleEditWeaponFields = function() {
            const type = document.getElementById('edit-item-type').value;
            document.getElementById('edit-weapon-fields').classList.toggle('hidden', type !== 'Arma');
        }

        window.saveEditedEquipment = function() {
            if (!currentCharacterId) return;
            const itemId = document.getElementById('edit-equipment-id').value;
            const charData = characters[currentCharacterId];
            const item = charData.equipment.find(e => e.id === itemId);
            if (!item) return;

            item.name = document.getElementById('edit-item-name').value;
            item.cost = parseInt(document.getElementById('edit-item-cost').value) || 0;
            item.type = document.getElementById('edit-item-type').value;
            item.caBonus = parseInt(document.getElementById('edit-item-ca-bonus').value) || 0;
            item.description = document.getElementById('edit-item-description').value;

            if (item.type === 'Arma') {
                item.bonus = document.getElementById('edit-weapon-bonus').value;
                item.damage = document.getElementById('edit-weapon-damage').value;
                item.threat = document.getElementById('edit-weapon-threat').value;
                item.special = document.getElementById('edit-weapon-special').value;
            }

            hasUnsavedChanges = true;
            renderEquipmentList(charData.equipment);
            calculateAndRenderTibar(charData);
            calculateAndRenderCA(charData);
            closeModal('edit-equipment-modal');
        }
        
        // NPCs
        window.openEditNpcModal = function(npcId) {
             if (!currentCharacterId) return;
            const npc = characters[currentCharacterId].npcs.find(n => n.id === npcId);
            if (!npc) return;

            document.getElementById('edit-npc-id').value = npc.id;
            document.getElementById('edit-npc-name').value = npc.name;
            document.getElementById('edit-npc-note').value = npc.note;
            openModal('edit-npc-modal');
        }

        window.saveEditedNpc = function() {
            if (!currentCharacterId) return;
            const npcId = document.getElementById('edit-npc-id').value;
            const npc = characters[currentCharacterId].npcs.find(n => n.id === npcId);
            if (!npc) return;

            npc.name = document.getElementById('edit-npc-name').value;
            npc.note = document.getElementById('edit-npc-note').value;
            
            hasUnsavedChanges = true;
            renderJournalList('npcs', characters[currentCharacterId].npcs, 'npcs-list', 'NPC', 'note');
            closeModal('edit-npc-modal');
        }

        // Notas
        window.openEditNoteModal = function(noteId) {
             if (!currentCharacterId) return;
            const note = characters[currentCharacterId].notes.find(n => n.id === noteId);
            if (!note) return;

            document.getElementById('edit-note-id').value = note.id;
            document.getElementById('edit-note-title').value = note.title;
            document.getElementById('edit-note-text').value = note.text;
            openModal('edit-note-modal');
        }

        window.saveEditedNote = function() {
            if (!currentCharacterId) return;
            const noteId = document.getElementById('edit-note-id').value;
            const note = characters[currentCharacterId].notes.find(n => n.id === noteId);
            if (!note) return;

            note.title = document.getElementById('edit-note-title').value;
            note.text = document.getElementById('edit-note-text').value;
            
            hasUnsavedChanges = true;
            renderCharacterNotesWithPagination(characters[currentCharacterId].notes);
            closeModal('edit-note-modal');
        }
        
        // Itens de Histórico
        window.openEditHistoryItemModal = function(itemId) {
            if (!currentCharacterId) return;
            const item = characters[currentCharacterId].historyItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('edit-historyItem-id').value = item.id;
            document.getElementById('edit-historyItem-description').value = item.description;
            
            const typeSelect = document.getElementById('edit-historyItem-type');
            typeSelect.innerHTML = document.getElementById('new-history-item-type').innerHTML; // Clone options
            typeSelect.value = item.type;

            document.getElementById('edit-historyItem-details').value = item.details;
            openModal('edit-historyItem-modal');
        }

        window.saveEditedHistoryItem = function() {
            if (!currentCharacterId) return;
            const itemId = document.getElementById('edit-historyItem-id').value;
            const item = characters[currentCharacterId].historyItems.find(i => i.id === itemId);
            if (!item) return;

            item.description = document.getElementById('edit-historyItem-description').value;
            item.type = document.getElementById('edit-historyItem-type').value;
            item.details = document.getElementById('edit-historyItem-details').value;
            
            hasUnsavedChanges = true;
            renderCharacterHistoryWithPagination(characters[currentCharacterId].historyItems);
            updateDerivedMainDetails(characters[currentCharacterId]);
            closeModal('edit-historyItem-modal');
        }

        window.confirmDeleteCharacter = function(charId, charName) {
            console.log('🎯 DEBUG confirmDeleteCharacter - iniciando...');
            console.log('🎯 DEBUG confirmDeleteCharacter - charId:', charId);
            console.log('🎯 DEBUG confirmDeleteCharacter - charName:', charName);
            
            document.getElementById('confirm-message').innerHTML = `Tem certeza que deseja deletar o personagem <strong>${charName}</strong>? Esta ação é irreversível.`;
            const confirmButton = document.getElementById('confirm-action-button');
            const modal = document.getElementById('confirm-modal');
            
            console.log('🎯 DEBUG confirmDeleteCharacter - confirmButton encontrado:', !!confirmButton);
            console.log('🎯 DEBUG confirmDeleteCharacter - modal encontrado:', !!modal);
            
            // Reset styles for deletion
            modal.querySelector('.border-t-4').classList.remove('border-yellow-500');
            modal.querySelector('.border-t-4').classList.add('border-red-500');
            confirmButton.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150';
            confirmButton.innerText = 'Excluir';

            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            console.log('🎯 DEBUG confirmDeleteCharacter - configurando onclick...');
            newConfirmButton.onclick = () => {
                console.log('🎯 DEBUG confirmDeleteCharacter - botão clicado, chamando deleteCharacter...');
                deleteCharacter(charId);
            };
            
            console.log('🎯 DEBUG confirmDeleteCharacter - abrindo modal...');
            openModal('confirm-modal');
        }

        function deleteCharacter(charId) {
            console.log('🗑️ DEBUG deleteCharacter - charId:', charId);
            console.log('🗑️ DEBUG deleteCharacter - characters antes:', Object.keys(characters));
            
            if (!charId) {
                console.log('🗑️ DEBUG deleteCharacter - charId inválido, retornando');
                return;
            }
            
            console.log('🗑️ DEBUG deleteCharacter - fechando modal...');
            window.closeModal('confirm-modal');
            
            console.log('🗑️ DEBUG deleteCharacter - removendo personagem...');
            delete characters[charId];
            
            console.log('🗑️ DEBUG deleteCharacter - characters depois:', Object.keys(characters));
            console.log('🗑️ DEBUG deleteCharacter - salvando no localStorage...');
            saveCharactersToLocalStorage();
            
            if (currentCharacterId === charId) {
                console.log('🗑️ DEBUG deleteCharacter - resetando currentCharacterId');
                currentCharacterId = null;
            }
            
            console.log('🗑️ DEBUG deleteCharacter - chamando showCharacterList...');
            window.showCharacterList();
            console.log('🗑️ DEBUG deleteCharacter - fim da função');
        }


        // --- RENDERIZAÇÃO E UI ---

        function updateDerivedMainDetails(charData) {
            const historyItems = charData.historyItems || [];
            
            const detailsMap = {
                Idade: { id: 'display-char-age', value: 'N/A' },
                Sexo: { id: 'display-char-sex', value: 'N/A' },
                Tamanho: { id: 'display-char-size', value: 'N/A' },
                Divindade: { id: 'display-char-divinity', value: 'N/A' },
                Deslocamento: { id: 'display-char-speed', value: 'N/A' }
            };

            // Find the last entry for each type
            for (let i = historyItems.length - 1; i >= 0; i--) {
                const item = historyItems[i];
                if (detailsMap[item.type] && detailsMap[item.type].value === 'N/A') {
                    detailsMap[item.type].value = item.description || 'N/A';
                }
            }
            
            // Update the DOM
            Object.values(detailsMap).forEach(detail => {
                const el = document.getElementById(detail.id);
                if (el) {
                    el.innerText = detail.value;
                }
            });
        }

        window.renderCharacterList = function() {
            console.log('📋 DEBUG renderCharacterList - iniciando...');
            console.log('📋 DEBUG renderCharacterList - characters:', Object.keys(characters));
            
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('character-sheet-view').classList.add('hidden');
            document.getElementById('character-list-view').classList.remove('hidden');

            const container = document.getElementById('char-list-container');
            console.log('📋 DEBUG renderCharacterList - container encontrado:', !!container);
            
            // FORÇA limpeza completa do container
            container.innerHTML = '';
            // Força um reflow para garantir que o DOM foi limpo
            container.offsetHeight;
            
            // CORREÇÃO: Usar Object.entries para ter acesso à chave correta
            const charEntries = Object.entries(characters);
            console.log('📋 DEBUG renderCharacterList - charEntries.length:', charEntries.length);
            
            if (charEntries.length === 0) {
                console.log('📋 DEBUG renderCharacterList - sem personagens, mostrando mensagem');
                document.getElementById('no-chars-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-chars-message').classList.add('hidden');

            charEntries.sort(([,a], [,b]) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(([charKey, char]) => {
                console.log(`📋 DEBUG renderCharacterList - renderizando char: ${char.name} com CHAVE: ${charKey} vs OBJECT ID: ${char.id}`);
                
                const charCard = document.createElement('div');
                charCard.className = 'stat-card themed-bg-surface p-6 rounded-xl shadow-lg border-t-4 themed-border-secondary flex flex-col justify-between';
                
                // CORREÇÃO: Usar charKey em vez de char.id nos botões
                const cardHTML = [
                    '<div class="flex items-center space-x-4">',
                    `<img src="${char.imageUrl || 'https://placehold.co/80x80/1f2937/f3f4f6?text=?'}" alt="Retrato de ${char.name}" class="w-20 h-20 rounded-full object-cover object-top border-2 themed-border flex-shrink-0">`,
                    '<div class="flex-grow min-w-0">',
                    `<h3 class="text-xl font-bold themed-text-primary-light mb-1 truncate">${char.name}</h3>`,
                    `<p class="text-sm themed-text-muted mb-2">${char.classLevel} (${char.race})</p>`,
                    `<p class="text-xs themed-text-muted">J: ${char.player}</p>`,
                    '</div>',
                    '</div>',
                    '<div class="mt-4 flex justify-between items-center">',
                    `<button onclick="selectCharacter('${charKey}')" class="px-4 py-1 text-sm themed-bg-primary themed-bg-primary-hover text-white rounded-lg transition duration-150">Ver Ficha</button>`,
                    '<div class="flex space-x-2">',
                    `<button onclick="event.stopPropagation(); exportCharacter('${charKey}')" class="px-3 py-1 text-sm themed-bg-button themed-bg-button-hover text-white rounded-lg transition">Exportar</button>`,
                    `<button onclick="confirmDeleteCharacter('${charKey}', '${char.name.replace(/'/g, "\\'")}')" class="text-red-400 hover:text-red-500 p-1 rounded-full hover:bg-gray-700 transition">`,
                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>',
                    '</button>',
                    '</div>',
                    '</div>'
                ].join('');
                
                charCard.innerHTML = cardHTML;
                
                console.log(`📋 DEBUG renderCharacterList - HTML gerado para ${char.name}:`, cardHTML.substring(0, 200) + '...');
                container.appendChild(charCard);
            });
        }

        window.selectCharacter = function(id) {
            currentCharacterId = id;
            if (characters[id]) {
                hasUnsavedChanges = false;
                document.getElementById('character-list-view').classList.add('hidden');
                document.getElementById('character-sheet-view').classList.remove('hidden');
                renderCharacterSheet(characters[id]);
                
                // Sincronizar dropdown de raças com valor atual
                syncRaceDropdown();
                
                changeTab('tab-atributos');
            } else {
                console.error("Personagem não encontrado com ID:", id);
                window.showCharacterList();
            }
        }

        function renderCharacterSheet(charData, resetUnsavedFlag = true) {
            if (resetUnsavedFlag) {
                hasUnsavedChanges = false;
                 document.getElementById('save-feedback').innerText = "";
            }
            // Dados Principais e de Histórico
            ['name', 'player', 'race', 'classLevel', 'tendency', 'imageUrl', 'nickname', 'catchphrase', 'fullHistory'].forEach(field => {
                const el = document.getElementById(`char-detail-${field}`);
                if (el) {
                    const key = field.charAt(0).toLowerCase() + field.slice(1);
                    el.value = charData[key] || '';
                }
            });
            document.getElementById('char-detail-portrait').src = charData.imageUrl || 'https://placehold.co/128x128/1f2937/f3f4f6?text=?';

            // Atualiza o nome do personagem na aba de histórico
            document.getElementById('history-char-name').innerText = charData.name || 'Nome do Personagem';
            document.getElementById('history-char-name-quote').innerText = charData.name || 'Nome do Personagem';

            // Finanças
            document.getElementById('char-detail-initialTibar').value = charData.initialTibar || 0;
            document.getElementById('char-detail-missionGains').value = charData.missionGains || 0;

            // Reset search fields before rendering lists
            const spellSearch = document.getElementById('spell-search-input');
            if (spellSearch) spellSearch.value = '';
            const talentSearch = document.getElementById('talent-search-input');
            if (talentSearch) talentSearch.value = '';


            // Dashboard de Status
            ['pv-current', 'pv-total', 'pm-current', 'pm-total', 'actionPoints', 'rd'].forEach(field => {
                const key = field.replace(/-(\w)/g, (match, p1) => p1.toUpperCase());
                const el = document.getElementById(`char-detail-${field}`);
                if (el) el.value = charData[key] === undefined ? 0 : charData[key];
            });

            document.getElementById('char-detail-sizeMod').value = charData.sizeModifier || 0;
            document.getElementById('char-detail-ca-other').value = charData.caOtherBonus || 0;

            updateStatusBars(charData);
            calculateAndRenderCA(charData);
            renderAttributes(charData);
            renderResistances(charData);
            renderAtaquesEDano(charData);
            updateDerivedMainDetails(charData);
            updateTalentCalculator(charData);
            calculateAndRenderTibar(charData);
            
            // Reset pagination when loading character data
            resetCharacterSpellPagination();
            resetCharacterTalentPagination();
            resetCharacterEquipmentPagination();
            resetCharacterSkillsPage();
            resetCharacterNpcsPage();
            resetCharacterNotesPage();
            resetCharacterHistoryPage();
            
            // Listas com paginação
            renderCharacterSpellsWithPagination(charData.spells || []); 
            renderCharacterTalentsWithPagination(charData.talents || []);
            renderCharacterSkillsWithPagination(charData.attributes);
            renderCharacterEquipmentWithPagination(charData.equipment || []);
            renderCharacterNpcsWithPagination(charData.npcs || []);
            renderCharacterNotesWithPagination(charData.notes || []);
            renderCharacterHistoryWithPagination(charData.historyItems || []);
            renderLanguagesList(charData.languages || []);
        }
        
        function calculateAndRenderCA(charData) {
            if (!charData) return;
            const level = getCharacterLevel(charData.classLevel);
            const levelBonus = Math.floor(level / 2);
            const desMod = charData.attributes.DES.mod;
            
            let armorBonus = 0;
            let shieldBonus = 0;
            (charData.equipment || []).forEach(item => {
                if(item.type === 'Armadura' && item.caBonus > armorBonus) armorBonus = item.caBonus;
                if(item.type === 'Escudo' && item.caBonus > shieldBonus) shieldBonus = item.caBonus;
            });

            const sizeMod = charData.sizeModifier || 0;
            const otherBonus = charData.caOtherBonus || 0;

            const totalCA = 10 + levelBonus + desMod + armorBonus + shieldBonus + sizeMod + otherBonus;
            document.getElementById('char-detail-ca-total').innerText = totalCA;
            document.getElementById('ca-tooltip').innerText = `10 + ${levelBonus} (Metade Nível) + ${desMod} (DES) + ${armorBonus} (Armadura) + ${shieldBonus} (Escudo) + ${sizeMod} (Tamanho) + ${otherBonus} (Outros)`;
        }

        function renderAttributes(charData) {
            const attrContainer = document.getElementById('attributes-container-tab');
            attrContainer.innerHTML = '';
            for (const key in charData.attributes) {
                const attr = charData.attributes[key];
                const mod = attr.mod;
                
                const attrDiv = document.createElement('div');
                attrDiv.className = 'p-3 themed-bg-surface-alt rounded-lg border-b-2 themed-border-secondary'; 
                attrDiv.dataset.attrKey = key;
                attrDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="text-lg font-bold themed-text-primary-light">${ATTR_MAP[key] || key}</p>
                        <span class="text-4xl font-extrabold themed-text-base bg-gray-800 px-3 py-1 rounded-lg">${mod >= 0 ? '+' : ''}${mod}</span>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-2 text-center no-print">
                        <div>
                            <label class="text-xs themed-text-muted">Base</label>
                            <input type="number" value="${attr.value || 10}" oninput="updateAttribute('${key}', 'value', this.value)"
                                   class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 themed-border border themed-ring-focus">
                        </div>
                        <div>
                            <label class="text-xs themed-text-muted">Outros</label>
                            <input type="number" value="${attr.other || 0}" oninput="updateAttribute('${key}', 'other', this.value)"
                                   class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 themed-border border themed-ring-focus">
                        </div>
                        <div>
                            <label class="text-xs themed-text-muted">Temp.</label>
                            <input type="number" value="${attr.temp || 0}" oninput="updateAttribute('${key}', 'temp', this.value)"
                                   class="w-full themed-bg-surface text-center themed-text-base rounded-md p-2 themed-border border themed-ring-focus">
                        </div>
                    </div>
                `;
                attrContainer.appendChild(attrDiv);
            }
        }
        
        function renderAtaquesEDano(charData) {
            if(!charData) return;

            const level = getCharacterLevel(charData.classLevel);
            const bonusPorNivel = getBonusPorNivel(level);
            const bba = charData.bba || 0;
            const sizeMod = charData.sizeModifier || 0;
            const attrs = charData.attributes;

            // Ataques
            const totalCorpoACorpo = bba + attrs.FOR.mod + sizeMod + (charData.ataqueCorpoACorpoOutros || 0);
            const totalDistancia = bba + attrs.DES.mod + sizeMod + (charData.ataqueDistanciaOutros || 0);
            const modMagico = attrs[charData.ataqueMagicoAttr || 'INT'].mod;
            const totalMagico = bba + modMagico + (charData.ataqueMagicoOutros || 0);

            document.getElementById('ataque-corpo-a-corpo-total').innerText = totalCorpoACorpo >= 0 ? `+${totalCorpoACorpo}` : totalCorpoACorpo;
            document.getElementById('ataque-distancia-total').innerText = totalDistancia >= 0 ? `+${totalDistancia}` : totalDistancia;
            document.getElementById('ataque-magico-total').innerText = totalMagico >= 0 ? `+${totalMagico}` : totalMagico;
            
            document.getElementById('ataque-corpo-a-corpo-tooltip').innerText = `${bba} (BBA) + ${attrs.FOR.mod} (FOR) + ${sizeMod} (Tamanho) + ${charData.ataqueCorpoACorpoOutros || 0} (Outros)`;
            document.getElementById('ataque-distancia-tooltip').innerText = `${bba} (BBA) + ${attrs.DES.mod} (DES) + ${sizeMod} (Tamanho) + ${charData.ataqueDistanciaOutros || 0} (Outros)`;
            document.getElementById('ataque-magico-tooltip').innerText = `${bba} (BBA) + ${modMagico} (${charData.ataqueMagicoAttr}) + ${charData.ataqueMagicoOutros || 0} (Outros)`;

            // Bônus de Dano
            const halfLevel = Math.floor(level / 2);
            const modDano = attrs[charData.danoCorpoACorpoAttr || 'FOR'].mod;
            const totalDanoCorpoACorpo = halfLevel + bonusPorNivel + modDano;
            const totalDanoDisparo = halfLevel + bonusPorNivel;

            document.getElementById('dano-corpo-a-corpo-total').innerText = totalDanoCorpoACorpo >= 0 ? `+${totalDanoCorpoACorpo}` : totalDanoCorpoACorpo;
            document.getElementById('dano-disparo-total').innerText = totalDanoDisparo >= 0 ? `+${totalDanoDisparo}` : totalDanoDisparo;

            document.getElementById('dano-corpo-a-corpo-tooltip').innerText = `${halfLevel} (Metade Nível) + ${bonusPorNivel} (Bônus Nível) + ${modDano} (${charData.danoCorpoACorpoAttr})`;
            document.getElementById('dano-disparo-tooltip').innerText = `${halfLevel} (Metade Nível) + ${bonusPorNivel} (Bônus Nível)`;


            // Populates the selects/inputs in this section
            document.getElementById('char-detail-bba').value = charData.bba || 0;
            document.getElementById('ataque-corpo-a-corpo-outros').value = charData.ataqueCorpoACorpoOutros || 0;
            document.getElementById('ataque-distancia-outros').value = charData.ataqueDistanciaOutros || 0;
            document.getElementById('ataque-magico-outros').value = charData.ataqueMagicoOutros || 0;
            document.getElementById('ataque-magico-attr').value = charData.ataqueMagicoAttr || 'INT';
            document.getElementById('dano-corpo-a-corpo-attr').value = charData.danoCorpoACorpoAttr || 'FOR';
        }

        /**
         * Atualiza as barras de PV e PM com base nos valores atuais/totais.
         */
        function updateStatusBars(charData) {
            if (!charData) return;
            const updateBar = (barId, current, total, colors) => {
                const bar = document.getElementById(barId);
                if (!bar) return;
                const percent = Math.max(0, Math.min(100, ((current || 0) / (total || 1)) * 100));
                bar.style.width = `${percent}%`;
                bar.classList.remove(...Object.values(colors));
                if (percent > 50) bar.classList.add(colors.high);
                else if (percent > 25) bar.classList.add(colors.mid);
                else bar.classList.add(colors.low);
            };

            updateBar('pv-bar', charData.pvCurrent, charData.pvTotal, { high: 'bg-green-500', mid: 'bg-yellow-500', low: 'bg-red-500' });
            updateBar('pm-bar', charData.pmCurrent, charData.pmTotal, { high: 'bg-blue-500', mid: 'bg-yellow-500', low: 'bg-red-500' });
        }

        function renderResistances(charData) {
            // Garantir que resistances existe
            if (!charData.resistances) {
                charData.resistances = { fortitude: 0, reflexos: 0, vontade: 0 };
            }
            
            const level = getCharacterLevel(charData.classLevel);
            const attrs = charData.attributes;
            ['fortitude', 'reflexos', 'vontade'].forEach(res => {
                const keyMap = { fortitude: 'CON', reflexos: 'DES', vontade: 'SAB' };
                const mod = attrs[keyMap[res]].mod;
                const other = charData.resistances[res] || 0;
                const total = calculateResistance(level, mod, other);
                document.getElementById(`res-${res}-other`).value = other;
                const totalEl = document.getElementById(`res-${res}-total`);
                if(totalEl) totalEl.innerText = total >= 0 ? `+${total}` : total;

                document.getElementById(`${res}-tooltip`).innerText = `${Math.floor(level/2)} (Metade Nível) + ${mod} (${keyMap[res]}) + ${other} (Outros)`;
            });
        }
        
        function renderSpellsList(spellsArray, listId) {
            // Se for a lista de magias da ficha do personagem, usar paginação
            if (listId === 'magias-list') {
                renderCharacterSpellsWithPagination(spellsArray);
                return;
            }
            
            // Renderização normal para outras listas
            const listContainer = document.getElementById(listId);
            const emptyMessage = document.getElementById('empty-prepared-spells');
            
            listContainer.innerHTML = '';
            
            if (!spellsArray || spellsArray.length === 0) {
                listContainer.innerHTML = `<p class="themed-text-muted text-sm">Nenhuma magia preparada.</p>`;
                if (emptyMessage) emptyMessage.classList.remove('hidden');
                return;
            }
            
            if (emptyMessage) emptyMessage.classList.add('hidden');
            spellsArray.forEach(spell => {
                const spellDiv = document.createElement('div');
                spellDiv.className = 'p-4 themed-bg-surface-alt rounded-xl shadow-md border-l-4 border-green-500';
                spellDiv.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleItemDetails('spell', '${spell.id}')">
                        <h5 class="text-xl font-bold text-green-300">${spell.name}</h5>
                        <div class="flex items-center no-print">
                            <button onclick="event.stopPropagation(); window.openEditSpellModal('${spell.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar Magia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                             <button onclick="event.stopPropagation(); window.removeItemById('spells', '${spell.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Deletar Magia"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg id="spell-arrow-${spell.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="spell-details-${spell.id}" class="hidden mt-3 pt-3 themed-border border-t">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 text-sm themed-text-muted gap-2 mb-3">
                            <p><span class="font-semibold themed-text-base">Nível:</span> ${spell.level || 'N/A'}</p><p><span class="font-semibold themed-text-base">Escola:</span> ${spell.school || 'N/A'}</p><p><span class="font-semibold themed-text-base">Componentes:</span> ${spell.components || 'N/A'}</p><p><span class="font-semibold themed-text-base">Tempo:</span> ${spell.time || 'N/A'}</p><p><span class="font-semibold themed-text-base">Alcance:</span> ${spell.range || 'N/A'}</p><p><span class="font-semibold themed-text-base">Alvo/Área:</span> ${spell.target || 'N/A'}</p><p><span class="font-semibold themed-text-base">Duração:</span> ${spell.duration || 'N/A'}</p><p><span class="font-semibold themed-text-base">Resistência:</span> ${spell.resistance || 'N/A'}</p>
                        </div>
                        <p class="themed-text-base whitespace-pre-wrap mt-2">${spell.description || 'Sem descrição.'}</p>
                    </div>`;
                listContainer.appendChild(spellDiv);
            });
        }
        
        // Nova função para renderizar magias com paginação na ficha do personagem
        function renderCharacterSpellsWithPagination(spellsArray) {
            const listContainer = document.getElementById('magias-list');
            const emptyMessage = document.getElementById('empty-prepared-spells');
            const paginationControls = document.getElementById('character-spells-pagination-controls');
            
            // Aplicar filtros se houver
            const filteredSpells = getFilteredCharacterSpells(spellsArray);
            
            if (!filteredSpells || filteredSpells.length === 0) {
                listContainer.innerHTML = '';
                if (emptyMessage) emptyMessage.classList.remove('hidden');
                paginationControls.classList.add('hidden');
                return;
            }
            
            if (emptyMessage) emptyMessage.classList.add('hidden');
            
            // Cálculos de paginação
            const totalPages = Math.ceil(filteredSpells.length / characterSpellsPerPage);
            const startIndex = (currentCharacterSpellPage - 1) * characterSpellsPerPage;
            const endIndex = startIndex + characterSpellsPerPage;
            const currentPageSpells = filteredSpells.slice(startIndex, endIndex);
            
            // Atualizar controles de paginação
            updateCharacterSpellPaginationControls(currentCharacterSpellPage, totalPages, filteredSpells.length);
            
            // Renderizar magias da página atual
            listContainer.innerHTML = '';
            currentPageSpells.forEach(spell => {
                const spellDiv = document.createElement('div');
                spellDiv.className = 'p-4 themed-bg-surface-alt rounded-xl shadow-md border-l-4 border-green-500';
                spellDiv.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleItemDetails('spell', '${spell.id}')">
                        <h5 class="text-xl font-bold text-green-300">${spell.name}</h5>
                        <div class="flex items-center no-print">
                            <button onclick="event.stopPropagation(); window.openEditSpellModal('${spell.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar Magia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                             <button onclick="event.stopPropagation(); window.removeItemById('spells', '${spell.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Deletar Magia"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg id="spell-arrow-${spell.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="spell-details-${spell.id}" class="hidden mt-3 pt-3 themed-border border-t">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 text-sm themed-text-muted gap-2 mb-3">
                            <p><span class="font-semibold themed-text-base">Nível:</span> ${spell.level || 'N/A'}</p><p><span class="font-semibold themed-text-base">Escola:</span> ${spell.school || 'N/A'}</p><p><span class="font-semibold themed-text-base">Componentes:</span> ${spell.components || 'N/A'}</p><p><span class="font-semibold themed-text-base">Tempo:</span> ${spell.time || 'N/A'}</p><p><span class="font-semibold themed-text-base">Alcance:</span> ${spell.range || 'N/A'}</p><p><span class="font-semibold themed-text-base">Alvo/Área:</span> ${spell.target || 'N/A'}</p><p><span class="font-semibold themed-text-base">Duração:</span> ${spell.duration || 'N/A'}</p><p><span class="font-semibold themed-text-base">Resistência:</span> ${spell.resistance || 'N/A'}</p>
                        </div>
                        <p class="themed-text-base whitespace-pre-wrap mt-2">${spell.description || 'Sem descrição.'}</p>
                    </div>`;
                listContainer.appendChild(spellDiv);
            });
        }
        
        // Função para atualizar controles de paginação das magias da ficha
        function updateCharacterSpellPaginationControls(currentPage, totalPages, totalSpells) {
            const paginationDiv = document.getElementById('character-spells-pagination-controls');
            const pageInfo = document.getElementById('character-spell-page-info');
            const totalInfo = document.getElementById('character-spell-total-info');
            const prevBtn = document.getElementById('character-spell-prev-btn');
            const nextBtn = document.getElementById('character-spell-next-btn');
            
            if (totalPages <= 1) {
                paginationDiv.classList.add('hidden');
                return;
            }
            
            paginationDiv.classList.remove('hidden');
            pageInfo.textContent = `${currentPage} / ${totalPages}`;
            totalInfo.textContent = `${totalSpells} ${totalSpells === 1 ? 'magia' : 'magias'}`;
            
            // Atualizar estado dos botões
            if (currentPage <= 1) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (currentPage >= totalPages) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Função auxiliar para obter dados do personagem atual
        function getCharacterData() {
            return currentCharacterId ? characters[currentCharacterId] : null;
        }

        // Função para mudar página das magias da ficha
        window.changeCharacterSpellPage = function(direction) {
            const charData = getCharacterData();
            if (!charData || !charData.spells) return;
            
            const filteredSpells = getFilteredCharacterSpells(charData.spells);
            const totalPages = Math.ceil(filteredSpells.length / characterSpellsPerPage);
            
            const newPage = currentCharacterSpellPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentCharacterSpellPage = newPage;
                renderCharacterSpellsWithPagination(charData.spells);
            }
        }

        // Função para resetar paginação das magias da ficha
        function resetCharacterSpellPagination() {
            currentCharacterSpellPage = 1;
        }

        // Função para obter magias filtradas da ficha
        function getFilteredCharacterSpells(spells) {
            const searchTerm = document.getElementById('spell-search-input')?.value.toLowerCase().trim() || '';
            
            if (!searchTerm) {
                return spells;
            }
            
            return spells.filter(spell => 
                spell.name.toLowerCase().includes(searchTerm) ||
                (spell.level && spell.level.toLowerCase().includes(searchTerm)) ||
                (spell.school && spell.school.toLowerCase().includes(searchTerm)) ||
                (spell.description && spell.description.toLowerCase().includes(searchTerm))
            );
        }
        
        // === FUNÇÕES DE PAGINAÇÃO PARA TALENTOS ===
        
        // Função para renderizar talentos com paginação na ficha do personagem
        function renderCharacterTalentsWithPagination(talentsArray) {
            const listContainer = document.getElementById('talents-list');
            const paginationControls = document.getElementById('character-talents-pagination');
            
            // Aplicar filtros se houver
            const filteredTalents = getFilteredCharacterTalents(talentsArray);
            
            if (!filteredTalents || filteredTalents.length === 0) {
                if (listContainer) listContainer.innerHTML = '<p class="text-center themed-text-muted">Nenhum talento encontrado.</p>';
                if (paginationControls) paginationControls.style.display = 'none';
                return;
            }
            
            // Cálculos de paginação
            const totalPages = Math.ceil(filteredTalents.length / characterItemsPerPage);
            const startIndex = (currentCharacterTalentPage - 1) * characterItemsPerPage;
            const endIndex = startIndex + characterItemsPerPage;
            const currentPageTalents = filteredTalents.slice(startIndex, endIndex);
            
            // Atualizar controles de paginação
            updateCharacterTalentPaginationControls(currentCharacterTalentPage, totalPages, filteredTalents.length);
            
            // Renderizar talentos da página atual
            if (listContainer) {
                listContainer.innerHTML = '';
                currentPageTalents.forEach(talent => {
                const talentDiv = document.createElement('div');
                talentDiv.className = 'p-4 themed-bg-surface-alt rounded-xl shadow-md border-l-4 border-amber-500';
                talentDiv.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleItemDetails('talent', '${talent.id}')">
                        <h5 class="text-xl font-bold text-amber-300">${talent.name}</h5>
                        <div class="flex items-center no-print">
                            <button onclick="event.stopPropagation(); window.openEditTalentModal('${talent.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar Talento"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button onclick="event.stopPropagation(); removeCharacterTalent('${talent.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Remover Talento"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg id="talent-arrow-${talent.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="talent-details-${talent.id}" class="hidden mt-4 space-y-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div><strong class="text-amber-400">Categoria:</strong> <span class="themed-text-muted">${talent.category || 'N/A'}</span></div>
                            <div><strong class="text-amber-400">Pré-req:</strong> <span class="themed-text-muted">${talent.prerequisites || 'Nenhum'}</span></div>
                            <div><strong class="text-amber-400">Origem:</strong> <span class="themed-text-muted">${talent.source || 'Desconhecida'}</span></div>
                        </div>
                        <div><strong class="text-amber-400">Descrição:</strong> <span class="themed-text-muted">${talent.description || 'Sem descrição'}</span></div>
                        ${talent.benefit ? `<div><strong class="text-amber-400">Benefício:</strong> <span class="themed-text-muted">${talent.benefit}</span></div>` : ''}
                    </div>
                `;
                listContainer.appendChild(talentDiv);
            });
            }
        }
        
        // Função para atualizar controles de paginação dos talentos
        function updateCharacterTalentPaginationControls(currentPage, totalPages, totalTalents) {
            const paginationControls = document.getElementById('character-talents-pagination');
            const prevBtn = document.getElementById('prev-character-talents');
            const nextBtn = document.getElementById('next-character-talents');
            const rangeInfo = document.getElementById('character-talents-range');
            const totalInfo = document.getElementById('character-talents-total');
            
            if (!paginationControls) return;
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Atualizar informações da página
            const startIndex = (currentPage - 1) * characterItemsPerPage + 1;
            const endIndex = Math.min(currentPage * characterItemsPerPage, totalTalents);
            if (rangeInfo) rangeInfo.textContent = `${startIndex}-${endIndex}`;
            if (totalInfo) totalInfo.textContent = `${totalTalents} ${totalTalents === 1 ? 'talento' : 'talentos'}`;
            
            // Atualizar estado dos botões
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        // Função para mudar página dos talentos da ficha
        window.changeCharacterTalentPage = function(direction) {
            const charData = getCharacterData();
            if (!charData || !charData.talents) return;
            
            const filteredTalents = getFilteredCharacterTalents(charData.talents);
            const totalPages = Math.ceil(filteredTalents.length / characterItemsPerPage);
            
            const newPage = currentCharacterTalentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentCharacterTalentPage = newPage;
                renderCharacterTalentsWithPagination(charData.talents);
            }
        }
        
        // Função para resetar paginação dos talentos da ficha
        function resetCharacterTalentPagination() {
            currentCharacterTalentPage = 1;
        }
        
        // Função para obter talentos filtrados da ficha
        function getFilteredCharacterTalents(talents) {
            // Por enquanto sem filtro, mas pode ser expandido
            return talents;
        }
        
        function renderTalentsList(talentsArray, listId) {
            const listContainer = document.getElementById(listId);
            listContainer.innerHTML = '';
            if (!talentsArray || talentsArray.length === 0) {
                listContainer.innerHTML = `<p class="themed-text-muted text-sm">Nenhum talento cadastrado.</p>`;
                return;
            }

            const typeColors = {
                'Raça': 'bg-green-600 text-green-100',
                'Classe': 'bg-sky-600 text-sky-100',
                'Comprado': 'bg-amber-600 text-amber-100',
                'Desvantagem': 'bg-red-600 text-red-100',
                'Outro': 'bg-gray-600 text-gray-100'
            };

            talentsArray.forEach(talent => {
                const talentDiv = document.createElement('div');
                const type = talent.type || 'Comprado'; // Default to comprado
                const category = talent.category || talent.type; // Usar category se disponível, senão type (compatibilidade)
                const color = typeColors[type] || typeColors['Outro'];
                talentDiv.className = 'p-4 themed-bg-surface-alt rounded-xl shadow-md border-l-4 themed-border-primary';
                talentDiv.innerHTML = `
                    <div class="flex justify-between items-start cursor-pointer" onclick="toggleItemDetails('talent', '${talent.id}')">
                        <div>
                            <div class="flex flex-wrap gap-1 mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded-full ${color}">${type}</span>
                                ${category && category !== type ? `<span class="text-xs px-2 py-0.5 rounded-full ${getTalentTypeColor(category)}">${getTalentTypeLabel(category)}</span>` : ''}
                            </div>
                            <h5 class="text-xl font-bold themed-text-primary-light">${talent.name}</h5>
                        </div>
                        <div class="flex items-center no-print flex-shrink-0">
                             <button onclick="event.stopPropagation(); window.openEditTalentModal('${talent.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar Talento"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                             <button onclick="event.stopPropagation(); window.removeItemById('talents', '${talent.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Deletar Talento"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg id="talent-arrow-${talent.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="talent-details-${talent.id}" class="hidden mt-3 pt-3 themed-border border-t">
                        <p class="text-sm mb-1"><span class="font-semibold themed-text-base">Pré-requisito:</span> ${talent.prerequisite || 'Nenhum'}</p>
                        <p class="themed-text-base whitespace-pre-wrap"><span class="font-semibold themed-text-base">Benefício:</span> ${talent.benefit || 'Nenhum.'}</p>
                    </div>`;
                listContainer.appendChild(talentDiv);
            });
        }
        
        // === FUNÇÕES DE PAGINAÇÃO PARA EQUIPAMENTOS ===
        
        // Função para renderizar equipamentos com paginação na ficha do personagem
        function renderCharacterEquipmentWithPagination(equipmentArray) {
            const filteredEquipment = getFilteredCharacterEquipment(equipmentArray);
            renderEquipmentList(filteredEquipment, true);
        }
        
        function renderEquipmentList(equipmentArray, usePagination = false) {
            const listContainer = document.getElementById('equipment-list');
            const paginationControls = document.getElementById('character-equipment-pagination');
            
            if (!equipmentArray || equipmentArray.length === 0) {
                listContainer.innerHTML = `<p class="themed-text-muted text-sm text-center">Nenhum equipamento cadastrado.</p>`;
                if (paginationControls && usePagination) paginationControls.style.display = 'none';
                return;
            }

            let itemsToRender = equipmentArray;
            
            if (usePagination) {
                // Cálculos de paginação
                const totalPages = Math.ceil(equipmentArray.length / characterItemsPerPage);
                const startIndex = (currentCharacterEquipmentPage - 1) * characterItemsPerPage;
                const endIndex = startIndex + characterItemsPerPage;
                itemsToRender = equipmentArray.slice(startIndex, endIndex);
                
                // Atualizar controles de paginação
                updateCharacterEquipmentPaginationControls(currentCharacterEquipmentPage, totalPages, equipmentArray.length);
            }
            
            listContainer.innerHTML = '';
            itemsToRender.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 themed-bg-surface-alt rounded-xl shadow-md border-l-4 themed-border-secondary';
                
                let weaponDetails = '';
                if (item.type === 'Arma') {
                    weaponDetails = `
                        <div class="mt-2 text-sm grid grid-cols-2 gap-x-4 gap-y-1">
                            <p><span class="font-semibold themed-text-base">Bônus de Ataque:</span> ${item.bonus || 'N/A'}</p>
                            <p><span class="font-semibold themed-text-base">Dano:</span> ${item.damage || 'N/A'}</p>
                            <p class="col-span-2"><span class="font-semibold themed-text-base">Ameaça/Crítico:</span> ${item.threat || 'N/A'}</p>
                            <p class="col-span-2"><span class="font-semibold themed-text-base">Especial:</span> ${item.special || 'Nenhum'}</p>
                        </div>
                    `;
                }

                let enhancementList = `<p class="text-xs themed-text-muted">Nenhum aprimoramento.</p>`;
                if(item.enhancements && item.enhancements.length > 0) {
                    enhancementList = `<ul class="list-disc list-inside text-sm">${item.enhancements.map((enh, index) => `<li>${enh} <button onclick="event.stopPropagation(); removeEnhancement('${item.id}', ${index})" class="text-red-500 hover:text-red-400 text-xs">(remover)</button></li>`).join('')}</ul>`;
                }

                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start cursor-pointer" onclick="toggleItemDetails('equipment', '${item.id}')">
                         <div>
                            <h5 class="text-xl font-bold themed-text-secondary">${item.name} <span class="text-sm font-normal themed-text-muted">(${item.type})</span></h5>
                            <p class="text-xs themed-text-muted mt-1">Custo: ${item.cost || 0} T$</p>
                        </div>
                        <div class="flex items-center no-print flex-shrink-0">
                             <button onclick="event.stopPropagation(); window.openEditEquipmentModal('${item.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar Item"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                             <button onclick="event.stopPropagation(); window.removeItemById('equipment', '${item.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Deletar Item"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg id="equipment-arrow-${item.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="equipment-details-${item.id}" class="hidden mt-3 pt-3 themed-border border-t space-y-3">
                        ${item.caBonus > 0 ? `<p class="text-sm"><span class="font-semibold themed-text-base">Bônus na CA:</span> +${item.caBonus}</p>` : ''}
                        <p class="themed-text-base whitespace-pre-wrap">${item.description || 'Sem descrição.'}</p>
                        ${weaponDetails}
                        <div>
                            <h6 class="font-semibold themed-text-base mb-1">Aprimoramentos:</h6>
                            ${enhancementList}
                            <button onclick="event.stopPropagation(); openEnhancementModal('${item.id}')" class="text-xs bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded mt-2">Adicionar Aprimoramento</button>
                        </div>
                    </div>`;
                listContainer.appendChild(itemDiv);
            });
        }
        
        // Função para atualizar controles de paginação dos equipamentos
        function updateCharacterEquipmentPaginationControls(currentPage, totalPages, totalEquipment) {
            const paginationControls = document.getElementById('character-equipment-pagination');
            if (!paginationControls) return;
            
            const prevBtn = document.getElementById('prev-character-equipment');
            const nextBtn = document.getElementById('next-character-equipment');
            const rangeInfo = document.getElementById('character-equipment-range');
            const totalInfo = document.getElementById('character-equipment-total');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Atualizar informações da página
            const startIndex = (currentPage - 1) * characterItemsPerPage + 1;
            const endIndex = Math.min(currentPage * characterItemsPerPage, totalEquipment);
            if (rangeInfo) rangeInfo.textContent = `${startIndex}-${endIndex}`;
            if (totalInfo) totalInfo.textContent = `${totalEquipment} ${totalEquipment === 1 ? 'equipamento' : 'equipamentos'}`;
            
            // Atualizar estado dos botões
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        // Função para mudar página dos equipamentos da ficha
        window.changeCharacterEquipmentPage = function(direction) {
            const charData = getCharacterData();
            if (!charData || !charData.equipment) return;
            
            const filteredEquipment = getFilteredCharacterEquipment(charData.equipment);
            const totalPages = Math.ceil(filteredEquipment.length / characterItemsPerPage);
            
            const newPage = currentCharacterEquipmentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentCharacterEquipmentPage = newPage;
                renderCharacterEquipmentWithPagination(charData.equipment);
            }
        }
        
        // Função para resetar paginação dos equipamentos da ficha
        function resetCharacterEquipmentPagination() {
            currentCharacterEquipmentPage = 1;
        }
        
        // Função para obter equipamentos filtrados da ficha
        function getFilteredCharacterEquipment(equipment) {
            // Por enquanto sem filtro, mas pode ser expandido
            return equipment;
        }
        
        // === FUNÇÕES DE PAGINAÇÃO PARA PERÍCIAS ===
        
        // Função para renderizar perícias com paginação na ficha do personagem
        function renderCharacterSkillsWithPagination(skillsData) {
            const charData = getCharacterData();
            if (!charData || !charData.attributes) {
                renderSkillsList({});
                return;
            }
            
            // Para perícias, vamos usar os dados completos dos atributos sem paginação real
            // pois renderSkillsList já trabalha com o objeto completo de atributos
            renderSkillsList(charData.attributes);
            
            // Ocultar controles de paginação para perícias (implementação diferenciada)
            const paginationControls = document.getElementById('character-skills-pagination');
            if (paginationControls) paginationControls.style.display = 'none';
        }
        
        // Funções de controle simplificadas para perícias
        function updateCharacterSkillsPaginationControls() { /* Perícias usam estrutura diferente */ }
        window.changeCharacterSkillsPage = function() { /* Perícias usam estrutura diferente */ }
        function resetCharacterSkillsPage() { currentCharacterSkillsPage = 1; }
        function getFilteredCharacterSkills(skills) { return skills; }
        
        // === FUNÇÕES DE PAGINAÇÃO PARA NPCS ===
        
        // Função para renderizar NPCs com paginação na ficha do personagem
        function renderCharacterNpcsWithPagination(npcsArray) {
            const listContainer = document.getElementById('npcs-list');
            const paginationControls = document.getElementById('character-npcs-pagination');
            
            if (!npcsArray || npcsArray.length === 0) {
                if (listContainer) listContainer.innerHTML = '<p class="themed-text-muted text-sm">Nenhum NPC cadastrado.</p>';
                if (paginationControls) paginationControls.style.display = 'none';
                return;
            }
            
            // Cálculos de paginação
            const totalPages = Math.ceil(npcsArray.length / characterItemsPerPage);
            const startIndex = (currentCharacterNpcsPage - 1) * characterItemsPerPage;
            const endIndex = startIndex + characterItemsPerPage;
            const currentPageNpcs = npcsArray.slice(startIndex, endIndex);
            
            // Atualizar controles de paginação
            updateCharacterNpcsPaginationControls(currentCharacterNpcsPage, totalPages, npcsArray.length);
            
            // Renderizar NPCs usando a função original com dados paginados
            renderJournalList('npcs', currentPageNpcs, 'npcs-list', 'NPC', 'note');
        }
        
        // Função para atualizar controles de paginação dos NPCs
        function updateCharacterNpcsPaginationControls(currentPage, totalPages, totalNpcs) {
            const paginationControls = document.getElementById('character-npcs-pagination');
            if (!paginationControls) return;
            
            const prevBtn = document.getElementById('prev-character-npcs');
            const nextBtn = document.getElementById('next-character-npcs');
            const rangeInfo = document.getElementById('character-npcs-range');
            const totalInfo = document.getElementById('character-npcs-total');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Atualizar informações da página
            const startIndex = (currentPage - 1) * characterItemsPerPage + 1;
            const endIndex = Math.min(currentPage * characterItemsPerPage, totalNpcs);
            if (rangeInfo) rangeInfo.textContent = `${startIndex}-${endIndex}`;
            if (totalInfo) totalInfo.textContent = `${totalNpcs} ${totalNpcs === 1 ? 'NPC' : 'NPCs'}`;
            
            // Atualizar estado dos botões
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        // Função para mudar página dos NPCs da ficha
        window.changeCharacterNpcsPage = function(direction) {
            const charData = getCharacterData();
            if (!charData || !charData.npcs) return;
            
            const totalPages = Math.ceil(charData.npcs.length / characterItemsPerPage);
            const newPage = currentCharacterNpcsPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentCharacterNpcsPage = newPage;
                renderCharacterNpcsWithPagination(charData.npcs);
            }
        }
        
        // Funções de controle simplificadas (implementação futura)
        function resetCharacterNpcsPage() { currentCharacterNpcsPage = 1; }
        function getFilteredCharacterNpcs(npcs) { return npcs; }
        
        // === FUNÇÕES DE PAGINAÇÃO PARA NOTAS ===
        
        // Função para renderizar notas com paginação na ficha do personagem
        function renderCharacterNotesWithPagination(notesArray) {
            const listContainer = document.getElementById('notes-list');
            const paginationControls = document.getElementById('character-notes-pagination');
            
            if (!notesArray || notesArray.length === 0) {
                if (listContainer) listContainer.innerHTML = '<p class="themed-text-muted text-sm">Nenhuma nota cadastrada.</p>';
                if (paginationControls) paginationControls.style.display = 'none';
                return;
            }
            
            // Cálculos de paginação
            const totalPages = Math.ceil(notesArray.length / characterItemsPerPage);
            const startIndex = (currentCharacterNotesPage - 1) * characterItemsPerPage;
            const endIndex = startIndex + characterItemsPerPage;
            const currentPageNotes = notesArray.slice(startIndex, endIndex);
            
            // Atualizar controles de paginação
            updateCharacterNotesPaginationControls(currentCharacterNotesPage, totalPages, notesArray.length);
            
            // Renderizar notas usando a função original com dados paginados
            renderJournalList('notes', currentPageNotes, 'notes-list', 'Nota', 'text', 'date');
        }
        
        // Função para atualizar controles de paginação das notas
        function updateCharacterNotesPaginationControls(currentPage, totalPages, totalNotes) {
            const paginationControls = document.getElementById('character-notes-pagination');
            if (!paginationControls) return;
            
            const prevBtn = document.getElementById('prev-character-notes');
            const nextBtn = document.getElementById('next-character-notes');
            const rangeInfo = document.getElementById('character-notes-range');
            const totalInfo = document.getElementById('character-notes-total');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Atualizar informações da página
            const startIndex = (currentPage - 1) * characterItemsPerPage + 1;
            const endIndex = Math.min(currentPage * characterItemsPerPage, totalNotes);
            if (rangeInfo) rangeInfo.textContent = `${startIndex}-${endIndex}`;
            if (totalInfo) totalInfo.textContent = `${totalNotes} ${totalNotes === 1 ? 'nota' : 'notas'}`;
            
            // Atualizar estado dos botões
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        // Função para mudar página das notas da ficha
        window.changeCharacterNotesPage = function(direction) {
            const charData = getCharacterData();
            if (!charData || !charData.notes) return;
            
            const totalPages = Math.ceil(charData.notes.length / characterItemsPerPage);
            const newPage = currentCharacterNotesPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentCharacterNotesPage = newPage;
                renderCharacterNotesWithPagination(charData.notes);
            }
        }
        
        // Funções de controle simplificadas
        function resetCharacterNotesPage() { currentCharacterNotesPage = 1; }
        function getFilteredCharacterNotes(notes) { return notes; }
        
        // === FUNÇÕES DE PAGINAÇÃO PARA HISTÓRICO ===
        
        // Função para renderizar histórico com paginação na ficha do personagem
        function renderCharacterHistoryWithPagination(historyArray) {
            const listContainer = document.getElementById('history-items-list');
            const paginationControls = document.getElementById('character-history-pagination');
            
            if (!historyArray || historyArray.length === 0) {
                if (listContainer) listContainer.innerHTML = '<p class="themed-text-muted text-sm">Nenhum item de histórico cadastrado.</p>';
                if (paginationControls) paginationControls.style.display = 'none';
                return;
            }
            
            // Cálculos de paginação
            const totalPages = Math.ceil(historyArray.length / characterItemsPerPage);
            const startIndex = (currentCharacterHistoryPage - 1) * characterItemsPerPage;
            const endIndex = startIndex + characterItemsPerPage;
            const currentPageHistory = historyArray.slice(startIndex, endIndex);
            
            // Atualizar controles de paginação
            updateCharacterHistoryPaginationControls(currentCharacterHistoryPage, totalPages, historyArray.length);
            
            // Renderizar histórico usando a função original com dados paginados
            renderHistoryItemsList(currentPageHistory);
        }
        
        // Função para atualizar controles de paginação do histórico
        function updateCharacterHistoryPaginationControls(currentPage, totalPages, totalHistory) {
            const paginationControls = document.getElementById('character-history-pagination');
            if (!paginationControls) return;
            
            const prevBtn = document.getElementById('prev-character-history');
            const nextBtn = document.getElementById('next-character-history');
            const rangeInfo = document.getElementById('character-history-range');
            const totalInfo = document.getElementById('character-history-total');
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Atualizar informações da página
            const startIndex = (currentPage - 1) * characterItemsPerPage + 1;
            const endIndex = Math.min(currentPage * characterItemsPerPage, totalHistory);
            if (rangeInfo) rangeInfo.textContent = `${startIndex}-${endIndex}`;
            if (totalInfo) totalInfo.textContent = `${totalHistory} ${totalHistory === 1 ? 'item' : 'itens'}`;
            
            // Atualizar estado dos botões
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        // Função para mudar página do histórico da ficha
        window.changeCharacterHistoryPage = function(direction) {
            const charData = getCharacterData();
            if (!charData || !charData.historyItems) return;
            
            const totalPages = Math.ceil(charData.historyItems.length / characterItemsPerPage);
            const newPage = currentCharacterHistoryPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentCharacterHistoryPage = newPage;
                renderCharacterHistoryWithPagination(charData.historyItems);
            }
        }
        
        // Funções de controle simplificadas
        function resetCharacterHistoryPage() { currentCharacterHistoryPage = 1; }
        function getFilteredCharacterHistory(history) { return history; }

        function renderJournalList(field, array, listId, titleKey, textKey, dateKey = null, usePagination = false) {
            const listContainer = document.getElementById(listId);
            
            if (!array || array.length === 0) {
                listContainer.innerHTML = `<p class="themed-text-muted text-sm">Nenhum(a) ${titleKey} cadastrado(a).</p>`;
                if (usePagination) {
                    const paginationId = `character-${field}-pagination`;
                    const paginationControls = document.getElementById(paginationId);
                    if (paginationControls) paginationControls.style.display = 'none';
                }
                return;
            }
            
            let itemsToRender = array;
            
            if (usePagination) {
                // Cálculos de paginação
                const totalPages = Math.ceil(array.length / characterItemsPerPage);
                let currentPage;
                
                if (field === 'npcs') {
                    currentPage = currentCharacterNpcsPage;
                } else if (field === 'notes') {
                    currentPage = currentCharacterNotesPage;
                }
                
                const startIndex = (currentPage - 1) * characterItemsPerPage;
                const endIndex = startIndex + characterItemsPerPage;
                itemsToRender = array.slice(startIndex, endIndex);
                
                // Atualizar controles de paginação
                if (field === 'npcs') {
                    updateCharacterNpcsPaginationControls(currentPage, totalPages, array.length);
                } else if (field === 'notes') {
                    updateCharacterNotesPaginationControls(currentPage, totalPages, array.length);
                }
            }
            
            listContainer.innerHTML = '';
            itemsToRender.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 themed-bg-surface-alt rounded-lg shadow-md border-l-4 themed-border-secondary';
                
                let displayTitle = (field === 'notes') ? `${item.date} - ${item.title || 'Nota'}` : (item.name || titleKey);
                let content = (field === 'notes') ? item.text : item[textKey];

                let editButton = '';
                if (field === 'npcs') {
                    editButton = `<button onclick="event.stopPropagation(); window.openEditNpcModal('${item.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>`;
                } else if (field === 'notes') {
                    editButton = `<button onclick="event.stopPropagation(); window.openEditNoteModal('${item.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>`;
                }
                
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleItemDetails('${field}', '${item.id}')">
                        <h5 class="text-xl font-bold themed-text-secondary">${displayTitle}</h5>
                        <div class="flex items-center no-print">
                            ${editButton}
                            <button onclick="event.stopPropagation(); window.removeItemById('${field}', '${item.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Deletar"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg id="${field}-arrow-${item.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="${field}-details-${item.id}" class="hidden mt-3 pt-3 themed-border border-t">
                        <p class="themed-text-base whitespace-pre-wrap">${content || 'Sem detalhes.'}</p>
                    </div>`;
                listContainer.appendChild(itemDiv);
            });
        }

        function renderLanguagesList(languagesArray) {
            const listContainer = document.getElementById('languages-list');
            listContainer.innerHTML = '';
            if (!languagesArray || languagesArray.length === 0) {
                listContainer.innerHTML = `<p class="themed-text-muted text-sm italic">Nenhum idioma adicional conhecido.</p>`;
                return;
            }

            languagesArray.forEach(lang => {
                const langTag = document.createElement('div');
                langTag.className = 'flex items-center bg-sky-800 text-sky-100 text-sm font-semibold px-3 py-1 rounded-full';
                langTag.innerHTML = `
                    <span>${lang.name}</span>
                    <button onclick="removeItemById('languages', '${lang.id}')" class="ml-2 text-sky-300 hover:text-white" title="Remover Idioma">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listContainer.appendChild(langTag);
            });
        }
        
        function renderHistoryItemsList(itemsArray, usePagination = false) {
            const listContainer = document.getElementById('history-items-list');
            const paginationControls = document.getElementById('character-history-pagination');
            
            if (!itemsArray || itemsArray.length === 0) {
                listContainer.innerHTML = `<p class="themed-text-muted text-sm text-center">Nenhuma característica ou relação cadastrada.</p>`;
                if (paginationControls && usePagination) paginationControls.style.display = 'none';
                return;
            }

            let itemsToRender = itemsArray;
            
            if (usePagination) {
                // Cálculos de paginação
                const totalPages = Math.ceil(itemsArray.length / characterItemsPerPage);
                const startIndex = (currentCharacterHistoryPage - 1) * characterItemsPerPage;
                const endIndex = startIndex + characterItemsPerPage;
                itemsToRender = itemsArray.slice(startIndex, endIndex);
                
                // Atualizar controles de paginação
                updateCharacterHistoryPaginationControls(currentCharacterHistoryPage, totalPages, itemsArray.length);
            }
            
            listContainer.innerHTML = '';
            itemsToRender.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 themed-bg-surface-alt rounded-xl shadow-md border-l-4 themed-border-secondary';
                
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleItemDetails('historyItems', '${item.id}')">
                        <div>
                            <p class="text-xs themed-text-muted px-2 py-0.5 bg-gray-700 rounded-full inline-block mb-1">${item.type}</p>
                            <h5 class="font-semibold themed-text-base">${item.description}</h5>
                        </div>
                        <div class="flex items-center no-print">
                            <button onclick="event.stopPropagation(); window.openEditHistoryItemModal('${item.id}')" class="text-sky-400 hover:text-sky-500 p-1" title="Editar Item"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button onclick="event.stopPropagation(); window.removeItemById('historyItems', '${item.id}')" class="text-red-400 hover:text-red-500 p-1 mr-2" title="Deletar Item">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                            <svg id="historyItems-arrow-${item.id}" class="h-6 w-6 themed-text-muted transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="historyItems-details-${item.id}" class="hidden mt-3 pt-3 themed-border border-t">
                        <p class="themed-text-base whitespace-pre-wrap">${item.details || 'Sem detalhes.'}</p>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });
        }

        function renderSkillsList(attributes) {
            const listContainer = document.getElementById('skills-list');
            listContainer.innerHTML = '';

            const charData = characters[currentCharacterId];
            if (!charData) return;

            const charLevel = getCharacterLevel(charData.classLevel);
            const skillsData = charData.skills || initializeSkillsData();
            const allSkills = [...SKILLS_BASE, ...(charData.customSkills || [])];

            allSkills.forEach(skill => {
                const skillData = skillsData[skill.name] || { isTrained: false, otherBonus: 0 };
                const isTrained = skillData.isTrained;
                const otherBonus = skillData.otherBonus;
                
                let graduations = 0;
                if (isTrained) graduations = charLevel + 3;
                else if (!skill.trainedOnly) graduations = Math.floor(charLevel / 2);
                
                const attrMod = attributes[skill.attr].mod; 
                const totalBonus = graduations + attrMod + otherBonus;
                const trainingColor = isTrained ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700';

                const skillItem = document.createElement('div');
                skillItem.className = 'grid grid-cols-12 gap-1 items-center p-2 themed-bg-surface-alt rounded-lg text-sm';
                
                const deleteButtonHtml = skill.isCustom ? `<button onclick="window.removeItemById('customSkills', '${skill.id}')" class="no-print text-red-400 hover:text-red-500 p-1" title="Remover"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : '';
                    
                skillItem.innerHTML = `
                    <span class="col-span-4 pl-2 themed-text-base flex justify-between items-center"><div>${skill.name} <span class="themed-text-muted">(${skill.attr})</span></div>${deleteButtonHtml}</span>
                    <button onclick="updateSkillData('${skill.name}', 'isTrained', ${!isTrained})" class="col-span-1 text-center text-xs font-bold py-1 rounded ${trainingColor} no-print" title="${skill.trainedOnly ? 'Treino Obrigatório' : ''}">${isTrained ? 'T' : (skill.trainedOnly ? 'T (Obrig.)' : 'NT')}</button>
                    <span class="col-span-2 text-center themed-text-primary-light font-semibold">${graduations >= 0 ? '+' : ''}${graduations}</span>
                    <span class="col-span-2 text-center themed-text-base font-semibold">${attrMod >= 0 ? '+' : ''}${attrMod}</span>
                    <div class="col-span-2 text-center no-print"><input type="number" value="${otherBonus}" oninput="updateSkillData('${skill.name}', 'otherBonus', parseInt(this.value) || 0)" class="w-10/12 themed-bg-surface text-center themed-text-secondary rounded-md p-1 themed-border border"></div>
                    <span class="col-span-1 text-center text-2xl font-extrabold themed-text-secondary">${totalBonus >= 0 ? '+' : ''}${totalBonus}</span>
                `;
                listContainer.appendChild(skillItem);
            });
        }
        
        // --- NAVEGAÇÃO E MODAIS (Expostas ao Window para onchange) ---

        window.showCharacterList = function() {
            if (hasUnsavedChanges) {
                document.getElementById('confirm-message').innerHTML = `Você tem alterações não salvas. Deseja voltar para a lista e descartar as alterações?`;
                const confirmButton = document.getElementById('confirm-action-button');
                const modal = document.getElementById('confirm-modal');
                
                modal.querySelector('.border-t-4').classList.remove('border-red-500');
                modal.querySelector('.border-t-4').classList.add('border-yellow-500');
                confirmButton.className = 'px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150';
                confirmButton.innerText = 'Descartar';
                
                const newConfirmButton = confirmButton.cloneNode(true); // Avoid multiple listeners
                confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);

                newConfirmButton.onclick = () => {
                    closeModal('confirm-modal');
                    proceedToShowCharacterList();
                };
                openModal('confirm-modal');
                return;
            }
            proceedToShowCharacterList();
        }

        function proceedToShowCharacterList() {
            hasUnsavedChanges = false;
            currentCharacterId = null;
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('character-sheet-view').classList.add('hidden');
            document.getElementById('character-list-view').classList.remove('hidden');
            renderCharacterList();
        }

        window.changeTab = function(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active-tab', 'themed-border-primary', 'themed-text-base');
                btn.classList.add('themed-text-muted', 'border-transparent');
            });
            document.querySelectorAll('.tab-content > div').forEach(content => content.classList.add('hidden'));

            const activeButton = document.querySelector(`.tab-button[onclick*="${tabId}"]`);
            activeButton.classList.add('active-tab', 'themed-border-primary', 'themed-text-base');
            activeButton.classList.remove('themed-text-muted', 'border-transparent');
            document.getElementById(tabId).classList.remove('hidden');
        }

        // === BIBLIOTECA DE RAÇAS ===
        let raceLibrary = [];
        let currentEditingRaceId = null;

        // Inicializar biblioteca de raças
        function initializeRaceLibrary() {
            const saved = localStorage.getItem('raceLibrary');
            if (saved) {
                try {
                    raceLibrary = JSON.parse(saved);
                } catch (e) {
                    console.error('Erro ao carregar biblioteca de raças:', e);
                    raceLibrary = [];
                }
            } else {
                // Dados iniciais das raças oficiais do Tormenta
                raceLibrary = [
                    {
                        id: Utils.generateUUID(),
                        name: "Anão",
                        size: "Médio",
                        movement: "6m",
                        abilityMods: { str: 0, dex: -2, con: 4, int: 0, wis: 2, cha: 0 },
                        traits: "Visão no Escuro (18m), +4 em testes de resistência contra venenos e magia, machados e martelos são armas simples, CA +4 contra adversários Grandes ou maiores, +2 em perícias relacionadas a pedra/metal."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Elfo",
                        size: "Médio",
                        movement: "9m",
                        abilityMods: { str: 0, dex: 4, con: -2, int: 2, wis: 0, cha: 0 },
                        traits: "Visão na Penumbra, +4 em Vontade contra encantamentos e imune à magia sono, +4 em Identificar Magia e Percepção, CD +2 em magias arcanas, Foco em Arma bônus."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Humano",
                        size: "Médio",
                        movement: "9m",
                        abilityMods: { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 },
                        traits: "+2 em duas habilidades à escolha, 2 talentos adicionais à escolha, 2 perícias treinadas extras."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Minotauro",
                        size: "Médio",
                        movement: "9m",
                        abilityMods: { str: 4, dex: 0, con: 2, int: 0, wis: 0, cha: -2 },
                        traits: "CA +1 (couro rígido), Ataque natural (Chifres 1d6, -4 em todos ataques), Faro, Lógica Labiríntica (+8 Sobrevivência/Não se Perder), Medo de altura (-4 em jogadas/testes a 3m+)."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Halfling",
                        size: "Pequeno",
                        movement: "6m",
                        abilityMods: { str: -2, dex: 4, con: 0, int: 0, wis: 2, cha: 0 },
                        traits: "CA +1 contra adversários Médios ou maiores, +2 em Ofício (culinária), +4 em Esconderse, +1 em todas as jogadas de proteção, pedras de funda são armas simples."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Goblin",
                        size: "Pequeno",
                        movement: "6m",
                        abilityMods: { str: -2, dex: 4, con: 0, int: 0, wis: 0, cha: -2 },
                        traits: "Visão no Escuro (18m), +4 em Esconder-se e Mover-se em Silêncio, CA +1 contra adversários Médios ou maiores."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Meio-elfo",
                        size: "Médio",
                        movement: "9m",
                        abilityMods: { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 2 },
                        traits: "+2 em duas perícias à escolha, Visão na Penumbra, +2 em testes de Vontade contra encantamentos."
                    },
                    {
                        id: Utils.generateUUID(),
                        name: "Meio-orc",
                        size: "Médio",
                        movement: "9m",
                        abilityMods: { str: 4, dex: 0, con: 2, int: -2, wis: 0, cha: -2 },
                        traits: "Visão no Escuro (18m), +2 em Intimidar, armas orcs são armas simples."
                    }
                ];
                saveRaceLibrary();
            }
        }

        // Salvar biblioteca de raças
        function saveRaceLibrary() {
            localStorage.setItem('raceLibrary', JSON.stringify(raceLibrary));
        }

        // Abrir modal da biblioteca de raças
        window.openRaceLibraryModal = function() {
            const modal = document.getElementById('race-library-modal');
            if (modal) {
                modal.classList.remove('hidden');
                loadRaceLibraryList();
                setTimeout(() => {
                    modal.querySelector('.themed-bg-surface').classList.add('scale-100', 'opacity-100');
                }, 10);
            }
        }

        // Fechar modal da biblioteca de raças
        window.closeRaceLibraryModal = function() {
            const modal = document.getElementById('race-library-modal');
            if (modal) {
                modal.querySelector('.themed-bg-surface').classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    clearRaceLibraryForm();
                }, 300);
            }
        }

        // Limpar formulário da biblioteca de raças
        window.clearRaceLibraryForm = function() {
            document.getElementById('race-library-form').reset();
            document.getElementById('race-name').value = '';
            document.getElementById('race-size').value = 'Médio';
            document.getElementById('race-movement').value = '';
            document.getElementById('race-str').value = '0';
            document.getElementById('race-dex').value = '0';
            document.getElementById('race-con').value = '0';
            document.getElementById('race-int').value = '0';
            document.getElementById('race-wis').value = '0';
            document.getElementById('race-cha').value = '0';
            document.getElementById('race-traits').value = '';
            
            currentEditingRaceId = null;
            document.getElementById('race-form-title').textContent = 'Cadastrar Nova Raça';
            document.getElementById('race-submit-btn').textContent = 'Cadastrar Raça';
            document.getElementById('race-cancel-edit').classList.add('hidden');
        }

        // Adicionar ou editar raça
        document.getElementById('race-library-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const raceData = {
                name: document.getElementById('race-name').value.trim(),
                size: document.getElementById('race-size').value,
                movement: document.getElementById('race-movement').value.trim(),
                abilityMods: {
                    str: parseInt(document.getElementById('race-str').value) || 0,
                    dex: parseInt(document.getElementById('race-dex').value) || 0,
                    con: parseInt(document.getElementById('race-con').value) || 0,
                    int: parseInt(document.getElementById('race-int').value) || 0,
                    wis: parseInt(document.getElementById('race-wis').value) || 0,
                    cha: parseInt(document.getElementById('race-cha').value) || 0
                },
                traits: document.getElementById('race-traits').value.trim()
            };

            if (!raceData.name) {
                alert('Nome da raça é obrigatório');
                return;
            }

            if (currentEditingRaceId) {
                // Editar raça existente
                const index = raceLibrary.findIndex(r => r.id === currentEditingRaceId);
                if (index !== -1) {
                    raceLibrary[index] = { ...raceLibrary[index], ...raceData };
                    alert('Raça atualizada com sucesso!');
                }
            } else {
                // Adicionar nova raça
                raceData.id = Utils.generateUUID();
                raceLibrary.push(raceData);
                alert('Raça cadastrada com sucesso!');
            }

            saveRaceLibrary();
            loadRaceLibraryList();
            clearRaceLibraryForm();
        });

        // Carregar lista da biblioteca de raças
        function loadRaceLibraryList() {
            const container = document.getElementById('race-library-list');
            const searchTerm = document.getElementById('race-library-search').value.toLowerCase();
            
            let filteredRaces = [...raceLibrary];
            
            // Filtrar por busca
            if (searchTerm) {
                filteredRaces = filteredRaces.filter(race => 
                    race.name.toLowerCase().includes(searchTerm) ||
                    race.size.toLowerCase().includes(searchTerm) ||
                    race.movement.toLowerCase().includes(searchTerm) ||
                    (race.traits && race.traits.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredRaces.length === 0) {
                container.innerHTML = '<p class="text-center themed-text-muted py-8">Nenhuma raça encontrada.</p>';
                return;
            }

            container.innerHTML = filteredRaces.map(race => {
                // Mapeamento das habilidades para português
                const abilityNames = {
                    str: 'FOR',
                    dex: 'DES', 
                    con: 'CON',
                    int: 'INT',
                    wis: 'SAB',
                    cha: 'CAR'
                };
                
                // Montar string de ajustes de habilidades
                const abilityString = Object.entries(race.abilityMods)
                    .map(([ability, mod]) => {
                        const sign = mod > 0 ? '+' : '';
                        const colorClass = mod > 0 ? 'text-green-400' : mod < 0 ? 'text-red-400' : 'text-gray-400';
                        const abilityName = abilityNames[ability] || ability.toUpperCase();
                        return `<span class="${colorClass}">${abilityName}: ${sign}${mod}</span>`;
                    })
                    .join(' / ');

                return `
                    <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                        <div class="flex items-start justify-between mb-2">
                            <h4 class="font-bold text-orange-400">${Utils.sanitizeHTML(race.name)}</h4>
                            <div class="flex gap-1">
                                <button onclick="editRaceLibrary('${race.id}')" 
                                        class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    Editar
                                </button>
                                <button onclick="deleteRaceLibrary('${race.id}')" 
                                        class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                                    Excluir
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-2 text-sm">
                            <span class="text-gray-300">Tamanho:</span> <span class="text-white">${Utils.sanitizeHTML(race.size)}</span> | 
                            <span class="text-gray-300">Deslocamento:</span> <span class="text-white">${Utils.sanitizeHTML(race.movement)}</span>
                        </div>
                        
                        <div class="mb-2 text-xs font-mono">${abilityString}</div>
                        
                        ${race.traits ? `
                            <div class="text-sm text-gray-300">
                                <strong>Traços Raciais:</strong>
                                <p class="mt-1 text-gray-400">${Utils.sanitizeHTML(race.traits)}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Editar raça da biblioteca
        window.editRaceLibrary = function(raceId) {
            const race = raceLibrary.find(r => r.id === raceId);
            if (!race) return;

            currentEditingRaceId = raceId;
            
            document.getElementById('race-name').value = race.name;
            document.getElementById('race-size').value = race.size;
            document.getElementById('race-movement').value = race.movement;
            document.getElementById('race-str').value = race.abilityMods.str;
            document.getElementById('race-dex').value = race.abilityMods.dex;
            document.getElementById('race-con').value = race.abilityMods.con;
            document.getElementById('race-int').value = race.abilityMods.int;
            document.getElementById('race-wis').value = race.abilityMods.wis;
            document.getElementById('race-cha').value = race.abilityMods.cha;
            document.getElementById('race-traits').value = race.traits || '';
            
            document.getElementById('race-form-title').textContent = 'Editar Raça';
            document.getElementById('race-submit-btn').textContent = 'Salvar Alterações';
            document.getElementById('race-cancel-edit').classList.remove('hidden');
        }

        // Cancelar edição
        window.cancelRaceLibraryEdit = function() {
            clearRaceLibraryForm();
        }

        // Excluir raça da biblioteca
        window.deleteRaceLibrary = function(raceId) {
            if (confirm('Tem certeza que deseja excluir esta raça?')) {
                raceLibrary = raceLibrary.filter(r => r.id !== raceId);
                saveRaceLibrary();
                loadRaceLibraryList();
                alert('Raça excluída com sucesso!');
            }
        }

        // Filtrar raças
        window.filterRaceLibrary = function() {
            loadRaceLibraryList();
        }

        // Limpar busca da biblioteca de raças
        window.clearRaceLibrarySearch = function() {
            document.getElementById('race-library-search').value = '';
            loadRaceLibraryList();
        }

        // Exportar biblioteca de raças
        window.exportRaceLibrary = function() {
            if (raceLibrary.length === 0) {
                alert('Não há raças para exportar');
                return;
            }

            const dataStr = JSON.stringify(raceLibrary, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `biblioteca-racas-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            alert(`Exportadas ${raceLibrary.length} raças!`);
        }

        // Importar biblioteca de raças
        window.importRaceLibrary = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedRaces = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedRaces)) {
                            throw new Error('Arquivo deve conter um array de raças');
                        }
                        
                        let importedCount = 0;
                        importedRaces.forEach(importedRace => {
                            // Validar estrutura básica
                            if (importedRace.name && importedRace.size) {
                                // Gerar novo ID se necessário
                                if (!importedRace.id || raceLibrary.some(r => r.id === importedRace.id)) {
                                    importedRace.id = Utils.generateUUID();
                                }
                                
                                // Verificar se já existe (por nome)
                                const exists = raceLibrary.some(r => 
                                    r.name.toLowerCase() === importedRace.name.toLowerCase()
                                );
                                
                                if (!exists) {
                                    raceLibrary.push(importedRace);
                                    importedCount++;
                                }
                            }
                        });
                        
                        saveRaceLibrary();
                        loadRaceLibraryList();
                        
                        alert(`Biblioteca importada com sucesso! ${importedCount} raças adicionadas.`);
                        
                    } catch (error) {
                        console.error('Erro ao importar:', error);
                        alert('Erro ao importar arquivo. Verifique se é um arquivo JSON válido.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // === FUNÇÕES DE MODAL ATUALIZADAS ===
        window.openModal = function(modalId, data = null) { 
            return ModalManager.open(modalId, data);
        }
        
        window.closeModal = function(modalId = null) { 
            return ModalManager.close(modalId);
        }

        // === FUNÇÃO ESPECÍFICA PARA MODAL DE AJUDA ===
        window.openHelpModal = function() {
            ModalManager.open('help-modal');
            HelpSystem.updateDynamicHelpTexts();
        }

        // === FUNÇÃO ESPECÍFICA PARA MODAL DE AUDITORIA ===
        window.openAuditModal = function() {
            ModalManager.open('audit-modal');
            // Inicializar a primeira aba
            switchAuditTab('validation');
        }

        // === FUNÇÃO DE TESTE PARA ATALHOS RÁPIDOS ===
        window.testQuickShortcuts = function() {
            console.log('Testando atalhos rápidos...');
            if (window.HelpSystem && typeof HelpSystem.showKeyboardShortcuts === 'function') {
                HelpSystem.showKeyboardShortcuts();
                console.log('✅ HelpSystem.showKeyboardShortcuts() funcionando');
            } else {
                console.error('❌ HelpSystem não encontrado ou método não disponível');
            }
        }

        // === FUNÇÕES DE NAVEGAÇÃO APRIMORADAS ===
        window.switchTab = function(tabId) {
            TabManager.switch(tabId);
        }

        // === FUNÇÕES DO MODAL DE ATALHOS RÁPIDOS ===
        window.showQuickShortcutsModal = function() {
            const modal = document.getElementById('quick-shortcuts-modal');
            const modalContent = modal.querySelector('div');
            
            if (modal) {
                modal.classList.remove('hidden');
                // Animação de entrada
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                // Iniciar countdown
                startShortcutCountdown();
                
                // Auto-fechar após 8 segundos
                setTimeout(() => {
                    closeQuickShortcutsModal();
                }, 8000);
                
                Logger.debug('Modal de atalhos rápidos exibido');
            }
        }
        
        window.closeQuickShortcutsModal = function() {
            const modal = document.getElementById('quick-shortcuts-modal');
            const modalContent = modal.querySelector('div');
            
            if (modal && !modal.classList.contains('hidden')) {
                // Animação de saída
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                
                // Limpar countdown se existir
                if (window.shortcutCountdownInterval) {
                    clearInterval(window.shortcutCountdownInterval);
                }
                
                Logger.debug('Modal de atalhos rápidos fechado');
            }
        }
        
        function startShortcutCountdown() {
            let timeLeft = 8;
            const countdownElement = document.getElementById('shortcut-countdown');
            
            if (countdownElement) {
                countdownElement.textContent = timeLeft;
                
                window.shortcutCountdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(window.shortcutCountdownInterval);
                    }
                }, 1000);
            }
        }

        // === FUNÇÕES DO MODAL DE BACKUP ===
        window.openBackupModal = function() {
            const modal = document.getElementById('backup-modal');
            const modalContent = modal.querySelector('div');
            
            if (modal) {
                modal.classList.remove('hidden');
                
                // Animação de entrada
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                // Atualizar informações do último backup
                updateBackupInfo();
                
                // Adicionar listener para ESC e outros atalhos
                document.addEventListener('keydown', handleBackupModalKeydown);
                
                Logger.debug('Modal de backup aberto');
            }
        }
        
        window.closeBackupModal = function() {
            const modal = document.getElementById('backup-modal');
            const modalContent = modal.querySelector('div');
            
            if (modal && !modal.classList.contains('hidden')) {
                // Animação de saída
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                
                // Remover listener de atalhos
                document.removeEventListener('keydown', handleBackupModalKeydown);
                
                Logger.debug('Modal de backup fechado');
            }
        }

        // === FUNÇÃO PARA TRATAR ATALHOS DO MODAL DE BACKUP ===
        function handleBackupModalKeydown(event) {
            const modal = document.getElementById('backup-modal');
            if (!modal || modal.classList.contains('hidden')) return;
            
            switch(event.key) {
                case 'Escape':
                    event.preventDefault();
                    closeBackupModal();
                    break;
                case 'b':
                case 'B':
                    if (event.ctrlKey || event.altKey) {
                        event.preventDefault();
                        manualBackup();
                    }
                    break;
                case 'd':
                case 'D':
                    if (event.ctrlKey || event.altKey) {
                        event.preventDefault();
                        downloadBackup();
                    }
                    break;
                case 'l':
                case 'L':
                    if (event.ctrlKey || event.altKey) {
                        event.preventDefault();
                        listBackups();
                    }
                    break;
            }
        }
        
        window.manualBackup = function() {
            try {
                updateBackupStatus('Criando backup manual...', 'info');
                
                // Usar o FileBackupManager para criar backup
                FileBackupManager.createBackup('manual').then(result => {
                    if (result !== false) {
                        updateBackupStatus('✅ Backup manual criado com sucesso!', 'success');
                        updateBackupInfo();
                        
                        if (window.NotificationManager) {
                            NotificationManager.show('💾 Backup manual criado com sucesso!', 'success', 3000);
                        } else {
                            alert('💾 Backup manual criado com sucesso!');
                        }
                        console.log('💾 Backup manual criado pelo usuário via FileBackupManager');
                    } else {
                        throw new Error('FileBackupManager retornou false');
                    }
                }).catch(error => {
                    updateBackupStatus('❌ Erro ao criar backup manual', 'error');
                    if (window.NotificationManager) {
                        NotificationManager.show('❌ Erro ao criar backup: ' + error.message, 'error', 5000);
                    } else {
                        alert('❌ Erro ao criar backup: ' + error.message);
                    }
                    console.error('❌ Erro no backup manual:', error);
                });
                
            } catch (error) {
                updateBackupStatus('❌ Erro ao criar backup manual', 'error');
                if (window.NotificationManager) {
                    NotificationManager.show('❌ Erro ao criar backup: ' + error.message, 'error', 5000);
                } else {
                    alert('❌ Erro ao criar backup: ' + error.message);
                }
                console.error('❌ Erro no backup manual:', error);
            }
        }
        
        window.downloadBackup = function() {
            try {
                updateBackupStatus('Preparando download...', 'info');
                
                const currentData = getCurrentCharacterData();
                const characterName = currentData.basicInfo?.name || 'personagem';
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `backup_${characterName}_${timestamp}.json`;
                
                const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateBackupStatus('✅ Download iniciado com sucesso!', 'success');
                if (window.NotificationManager) {
                    NotificationManager.show('📥 Download do backup iniciado!', 'success', 3000);
                } else {
                    alert('📥 Download do backup iniciado!');
                }
                
                console.log('📥 Download de backup realizado:', filename);
            } catch (error) {
                updateBackupStatus('❌ Erro no download', 'error');
                if (window.NotificationManager) {
                    NotificationManager.show('❌ Erro no download: ' + error.message, 'error', 5000);
                } else {
                    alert('❌ Erro no download: ' + error.message);
                }
                console.error('❌ Erro no download do backup:', error);
            }
        }
        
        // Função para restaurar backup de arquivo
        window.restoreBackupFromFile = function() {
            const fileInput = document.getElementById('backup-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                updateRestoreStatus('⚠️ Nenhum arquivo selecionado', 'warning');
                return;
            }
            
            updateRestoreStatus('Processando arquivo...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validar estrutura básica do backup
                    if (!data.basicInfo && !data.attributes) {
                        throw new Error('Arquivo não é um backup válido');
                    }
                    
                    updateRestoreStatus('Arquivo validado. Confirme a restauração.', 'success');
                    
                    // Confirmar restauração
                    if (confirm('⚠️ Isso substituirá todos os dados atuais. Continuar?')) {
                        updateRestoreStatus('Restaurando dados...', 'info');
                        
                        // Salvar os dados restaurados
                        saveCharacterData(data);
                        
                        updateRestoreStatus('✅ Backup restaurado com sucesso!', 'success');
                        if (window.NotificationManager) {
                            NotificationManager.show('✅ Backup restaurado com sucesso!', 'success', 3000);
                        }
                        
                        // Fechar modal após 2 segundos
                        setTimeout(() => {
                            closeRestoreModal();
                            window.location.reload(); // Recarregar para aplicar mudanças
                        }, 2000);
                        
                        console.log('✅ Backup restaurado do arquivo:', file.name);
                    } else {
                        updateRestoreStatus('Restauração cancelada', 'warning');
                    }
                } catch (error) {
                    updateRestoreStatus('❌ Erro na restauração: ' + error.message, 'error');
                    if (window.NotificationManager) {
                        NotificationManager.show('❌ Erro na restauração: ' + error.message, 'error', 5000);
                    } else {
                        alert('❌ Erro na restauração: ' + error.message);
                    }
                    console.error('❌ Erro na restauração:', error);
                }
            };
            
            reader.readAsText(file);
            fileInput.value = ''; // Limpar input
        }
        
        // Função utilitária para converter timestamp do backup para formato válido
        function parseBackupTimestamp(timestamp) {
            // O formato gerado é: 2025-10-07T23-02-20-960Z
            // Precisa converter para: 2025-10-07T23:02:20.960Z (formato ISO válido)
            
            if (timestamp.includes('T') && timestamp.includes('-', 11)) {
                // Dividir em data e tempo
                const [datePart, timePart] = timestamp.split('T');
                
                // Separar parte do tempo e milissegundos
                // timePart é algo como: "23-02-20-960Z"
                const timeWithoutZ = timePart.replace('Z', '');
                const timeParts = timeWithoutZ.split('-');
                
                if (timeParts.length === 4) {
                    // timeParts = ["23", "02", "20", "960"]
                    const [hours, minutes, seconds, milliseconds] = timeParts;
                    const timeFormatted = `${hours}:${minutes}:${seconds}.${milliseconds}Z`;
                    return `${datePart}T${timeFormatted}`;
                }
            }
            
            return timestamp; // Retorna original se já estiver no formato correto
        }

        window.listBackups = function() {
            try {
                updateBackupStatus('Listando backups...', 'info');
                
                // Usar FileBackupManager para listar backups
                const backups = FileBackupManager.getBackupList();
                
                if (backups.length === 0) {
                    updateBackupStatus('📝 Nenhum backup encontrado', 'info');
                    alert('📝 Nenhum backup encontrado.\n\nCrie um backup manual primeiro!');
                    return;
                }
                
                let backupList = `📋 Backups encontrados (${backups.length}):\n\n`;
                backups.forEach((backup, index) => {
                    // Converter timestamp usando função utilitária
                    const timestamp = parseBackupTimestamp(backup.timestamp);
                    const date = new Date(timestamp);
                    const dateString = date.toLocaleString('pt-BR');
                    const sizeMB = (backup.size / (1024 * 1024)).toFixed(2);
                    
                    backupList += `${index + 1}. ${backup.filename}\n`;
                    backupList += `   Data: ${dateString}\n`;
                    backupList += `   Motivo: ${backup.reason}\n`;
                    backupList += `   Tamanho: ${sizeMB}MB\n`;
                    backupList += `   Versão: ${backup.version}\n\n`;
                });
                
                alert(backupList);
                updateBackupStatus('Lista de backups exibida', 'success');
                
                console.log('📋 Lista de backups solicitada (FileBackupManager)');
            } catch (error) {
                updateBackupStatus('❌ Erro ao listar backups', 'error');
                if (window.NotificationManager) {
                    NotificationManager.show('❌ Erro ao listar: ' + error.message, 'error', 5000);
                } else {
                    alert('❌ Erro ao listar: ' + error.message);
                }
                console.error('❌ Erro ao listar backups:', error);
            }
        }
        
        function updateBackupStatus(message, type = 'info') {
            const statusDiv = document.getElementById('backup-status');
            if (statusDiv) {
                const colors = {
                    info: 'themed-text-base',
                    success: 'text-green-400',
                    error: 'text-red-400'
                };
                
                statusDiv.innerHTML = `
                    <h5 class="text-sm font-semibold themed-text-primary-light mb-2">Status</h5>
                    <p class="text-sm ${colors[type] || 'themed-text-muted'}">${message}</p>
                `;
            }
        }
        
        function updateBackupInfo() {
            const lastBackupElement = document.getElementById('last-backup-time');
            if (lastBackupElement) {
                const backups = getBackupList();
                if (backups.length > 0) {
                    const lastBackup = backups[0]; // O mais recente está no início
                    
                    // Converter timestamp usando função utilitária
                    const timestamp = parseBackupTimestamp(lastBackup.timestamp);
                    const date = new Date(timestamp).toLocaleString('pt-BR');
                    lastBackupElement.textContent = date;
                } else {
                    lastBackupElement.textContent = 'Nenhum backup';
                }
            }
        }

        // === FUNÇÕES AUXILIARES DE BACKUP ===
        function getCurrentCharacterData() {
            // Se houver um personagem selecionado, obter seus dados
            if (window.currentCharacterId && window.characters && window.characters[window.currentCharacterId]) {
                return window.characters[window.currentCharacterId];
            }
            
            // Caso contrário, coletar dados dos campos do formulário
            return collectFormData();
        }
        
        function saveCharacterData(data) {
            if (window.currentCharacterId) {
                // Salvar nos dados do personagem atual
                window.characters = window.characters || {};
                window.characters[window.currentCharacterId] = data;
                localStorage.setItem('characters', JSON.stringify(window.characters));
            }
            
            // Também salvar como dados gerais
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'object') {
                    localStorage.setItem(key, JSON.stringify(data[key]));
                } else {
                    localStorage.setItem(key, data[key]);
                }
            });
        }
        
        function getBackupList() {
            try {
                const backups = localStorage.getItem('character_backups');
                return backups ? JSON.parse(backups) : [];
            } catch (error) {
                console.error('❌ Erro ao obter lista de backups:', error);
                return [];
            }
        }
        
        function collectFormData() {
            // Função para coletar dados dos campos do formulário
            const data = {
                basicInfo: {},
                attributes: {},
                skills: {},
                spells: [],
                talents: [],
                equipment: [],
                notes: ''
            };
            
            // Coletar informações básicas
            const nameField = document.getElementById('character-name');
            if (nameField) data.basicInfo.name = nameField.value;
            
            const classField = document.getElementById('character-class');
            if (classField) data.basicInfo.class = classField.value;
            
            // Coletar atributos
            ['forca', 'destreza', 'constituicao', 'inteligencia', 'sabedoria', 'carisma'].forEach(attr => {
                const field = document.getElementById(`${attr}-value`);
                if (field) data.attributes[attr] = parseInt(field.value) || 10;
            });
            
            return data;
        }

        // === FUNÇÕES DO MODAL DE AJUDA ===
        window.switchHelpTab = function(tabId) {
            try {
                // Esconder todos os conteúdos
                document.querySelectorAll('.help-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Remover estado ativo de todos os botões
                document.querySelectorAll('[id^="help-tab-"]').forEach(btn => {
                    btn.classList.remove('help-tab-active', 'bg-blue-600', 'text-white');
                    btn.classList.add('help-tab-inactive', 'text-gray-400');
                });
                
                // Mostrar conteúdo ativo
                const activeContent = document.getElementById(`help-content-${tabId}`);
                const activeButton = document.getElementById(`help-tab-${tabId}`);
                
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                }
                
                if (activeButton) {
                    activeButton.classList.remove('help-tab-inactive', 'text-gray-400');
                    activeButton.classList.add('help-tab-active', 'bg-blue-600', 'text-white');
                }
                
                // Atualizar estatísticas quando aba Dev for ativada
                if (tabId === 'dev') {
                    setTimeout(() => {
                        if (window.updateLogStats) {
                            updateLogStats();
                        }
                    }, 100);
                }
                
                // Anunciar mudança para leitores de tela
                AccessibilityManager.announceToScreenReader(`Aba ${tabId} ativada na central de ajuda`);
                
                Logger.debug(`Help tab switched to: ${tabId}`);
            } catch (e) {
                ErrorHandler.handle(e, 'switchHelpTab');
            }
        }

        // === SISTEMA DE AJUDA CONTEXTUAL ===
        class HelpSystem {
            static showQuickHelp(feature) {
                const helpTexts = {
                    attributes: 'Atributos são as características básicas do seu personagem. Valores de 8-18 são normais para humanos.',
                    skills: 'Perícias representam conhecimentos e habilidades específicas. Marque como treinada para receber bônus.',
                    combat: 'Sistema de combate calcula automaticamente seus bônus de ataque e defesa baseado nos atributos.',
                    spells: 'Adicione magias conhecidas pelo seu personagem. Use a busca para encontrar rapidamente.',
                    equipment: 'Gerencie equipamentos e itens. Armas e armaduras fornecem bônus automáticos.',
                    backup: 'O sistema salva automaticamente suas alterações e cria backups regulares.'
                };
                
                const message = helpTexts[feature] || 'Funcionalidade do sistema de gerenciamento de fichas.';
                NotificationManager.show(`<span class="inline-flex items-center"><span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs mr-2">ℹ</span>${message}</span>`, 'info', 4000);
            }
            
            static showKeyboardShortcuts() {
                console.log('🔍 HelpSystem.showKeyboardShortcuts() chamado!');
                
                // Usar modal visual bonito
                if (window.showQuickShortcutsModal) {
                    console.log('✅ Exibindo modal de atalhos visual...');
                    showQuickShortcutsModal();
                    return;
                }
                
                // Fallback para notificação (caso modal não funcione)
                console.log('⚠️ Modal não disponível, usando fallback de notificação...');
                const shortcuts = [
                    'Alt+S: Salvar',
                    'Alt+N: Novo personagem',
                    'Alt+E: Exportar',
                    'Alt+K: Atalhos rápidos',
                    'F1: Ajuda completa',
                    'Esc: Fechar modal'
                ];
                
                if (window.NotificationManager) {
                    console.log('✅ NotificationManager disponível, exibindo notificação...');
                    NotificationManager.show(
                        `⌨️ Atalhos Principais: ${shortcuts.join(' | ')}`,
                        'info',
                        8000
                    );
                } else {
                    console.warn('⚠️ NotificationManager não disponível, usando alert...');
                    alert(`⌨️ Atalhos Principais:\n${shortcuts.join('\n')}`);
                }
            }
            
            static updateDynamicHelpTexts() {
                try {
                    // Converte millisegundos para minutos
                    const autoSaveMinutes = Math.round(CONFIG.AUTO_SAVE_INTERVAL / 60000);
                    const backupMinutes = Math.round(CONFIG.BACKUP_INTERVAL / 60000);
                    
                    // Atualiza texto do auto-save
                    const autoSaveElement = document.getElementById('help-autosave-text');
                    if (autoSaveElement) {
                        autoSaveElement.textContent = `• Auto-save a cada ${autoSaveMinutes} ${autoSaveMinutes === 1 ? 'minuto' : 'minutos'}`;
                    }
                    
                    // Atualiza texto do backup
                    const backupElement = document.getElementById('help-backup-text');
                    if (backupElement) {
                        backupElement.textContent = `O sistema cria backups automáticos a cada ${backupMinutes} ${backupMinutes === 1 ? 'minuto' : 'minutos'}.`;
                    }
                    
                    // Atualiza versão na aba de desenvolvimento
                    const helpVersionElement = document.getElementById('help-current-version');
                    if (helpVersionElement) {
                        helpVersionElement.textContent = CONFIG.VERSION;
                    }
                    
                    Logger.debug('Textos dinâmicos da ajuda atualizados', {
                        autoSave: `${autoSaveMinutes} min`,
                        backup: `${backupMinutes} min`,
                        version: CONFIG.VERSION
                    });
                } catch (e) {
                    ErrorHandler.handle(e, 'updateDynamicHelpTexts');
                }
            }
        }

        window.toggleWeaponFields = function() {
            const type = document.getElementById('item-type').value;
            document.getElementById('weapon-fields').classList.toggle('hidden', type !== 'Arma');
        }

        window.convertCurrency = function(source) {
            const tlInput = document.getElementById('conv-tl');
            const toInput = document.getElementById('conv-to');
            const tpInput = document.getElementById('conv-tp');
            const tsInput = document.getElementById('conv-ts');
            const value = parseFloat(document.getElementById(`conv-${source}`).value) || 0;

            if (value === 0) {
                tlInput.value = '';
                toInput.value = '';
                tpInput.value = '';
                tsInput.value = '';
                return;
            }

            switch (source) {
                case 'tl':
                    toInput.value = value * 10;
                    tpInput.value = value * 100;
                    tsInput.value = value * 1000;
                    break;
                case 'to':
                    tlInput.value = value / 10;
                    tpInput.value = value * 10;
                    tsInput.value = value * 100;
                    break;
                case 'tp':
                    tlInput.value = value / 100;
                    toInput.value = value / 10;
                    tsInput.value = value * 10;
                    break;
                case 'ts':
                    tlInput.value = value / 1000;
                    toInput.value = value / 100;
                    tpInput.value = value / 10;
                    break;
            }
        }

        window.toggleItemDetails = function(type, itemId) {
            const details = document.getElementById(`${type}-details-${itemId}`);
            const arrow = document.getElementById(`${type}-arrow-${itemId}`);
            if (details && arrow) {
                details.classList.toggle('hidden');
                arrow.classList.toggle('rotate-180');
            }
        }
        
        window.updateTalentPoints = function(source, value) {
            if (!currentCharacterId) return;
            const charData = characters[currentCharacterId];
            charData.talentPoints[source] = parseInt(value) || 0;
            hasUnsavedChanges = true;
            updateTalentCalculator(charData);
        }

        function updateTalentCalculator(charData) {
            if (!charData) return;
            
            const level = getCharacterLevel(charData.classLevel);
            const pointsFromLevel = Math.ceil(level / 2);

            // Calculate points from disadvantages
            const disadvantagesCount = (charData.talents || []).filter(t => t.type === 'Desvantagem').length;
            const pointsFromDisadvantages = Math.floor(disadvantagesCount / 3) * 2;
            
            const points = charData.talentPoints || { race: 0, class: 0, extra: 0 };
            document.getElementById('talent-points-level').innerText = pointsFromLevel;
            document.getElementById('talent-points-race').value = points.race || 0;
            document.getElementById('talent-points-class').value = points.class || 0;
            document.getElementById('talent-points-disadvantages').innerText = pointsFromDisadvantages;
            document.getElementById('talent-points-extra').value = points.extra || 0;
            
            const totalPoints = pointsFromLevel + (points.race || 0) + (points.class || 0) + pointsFromDisadvantages + (points.extra || 0);
            const spentPoints = (charData.talents || []).filter(t => t.type === 'Comprado').length;

            const totalEl = document.getElementById('talent-points-total');
            totalEl.innerText = `${spentPoints} / ${totalPoints}`;
            totalEl.classList.toggle('text-red-400', spentPoints > totalPoints);
            totalEl.classList.toggle('themed-text-secondary', spentPoints <= totalPoints);
        }
        
        // NOVO: Funções Financeiras
        window.updateFinancials = function(source, value) {
            if (!currentCharacterId) return;
            const charData = characters[currentCharacterId];
            charData[source] = parseInt(value) || 0;
            hasUnsavedChanges = true;
            calculateAndRenderTibar(charData);
        }

        function calculateAndRenderTibar(charData) {
            if (!charData) return;
            const itemsCost = (charData.equipment || []).reduce((total, item) => total + (item.cost || 0), 0);
            const totalGains = (charData.initialTibar || 0) + (charData.missionGains || 0);
            const finalBalance = totalGains - itemsCost;

            document.getElementById('display-items-cost').innerText = itemsCost;
            document.getElementById('display-total-tibar').innerText = finalBalance;
        }

        window.generatePrintableView = function() {
            if (!currentCharacterId || !characters[currentCharacterId]) {
                alert("Selecione um personagem primeiro!");
                return;
            }

            const charData = characters[currentCharacterId];
            const level = getCharacterLevel(charData.classLevel);

            // Recalculate values to ensure they are up-to-date
            const caTotal = document.getElementById('char-detail-ca-total').innerText;
            const resFortitude = document.getElementById('res-fortitude-total').innerText;
            const resReflexos = document.getElementById('res-reflexos-total').innerText;
            const resVontade = document.getElementById('res-vontade-total').innerText;
            const ataqueCorpoACorpo = document.getElementById('ataque-corpo-a-corpo-total').innerText;
            const ataqueDistancia = document.getElementById('ataque-distancia-total').innerText;
            const ataqueMagico = document.getElementById('ataque-magico-total').innerText;
            const danoCorpoACorpo = document.getElementById('dano-corpo-a-corpo-total').innerText;
            const danoDisparo = document.getElementById('dano-disparo-total').innerText;

            const totalMagias = (charData.spells || []).length;
            const totalTalentos = (charData.talents || []).length;
            const periciasTreinadas = Object.values(charData.skills || {}).filter(s => s.isTrained).length;

            // PREPARA OS DADOS DAS PERÍCIAS PARA O RESUMO
            const skillsForSummary = [];
            const skillsData = charData.skills || {};
            const allSkills = [...SKILLS_BASE, ...(charData.customSkills || [])];

            allSkills.forEach(skill => {
                const skillData = skillsData[skill.name] || { isTrained: false, otherBonus: 0 };
                const isTrained = skillData.isTrained;
                const otherBonus = skillData.otherBonus;
                
                let graduations = 0;
                if (isTrained) {
                    graduations = level + 3;
                } else if (!skill.trainedOnly) {
                    graduations = Math.floor(level / 2);
                }
                
                const attrMod = charData.attributes[skill.attr] ? charData.attributes[skill.attr].mod : 0;
                const totalBonus = graduations + attrMod + otherBonus;

                skillsForSummary.push({
                    name: skill.name,
                    attr: skill.attr,
                    totalBonus: totalBonus,
                    isTrained: isTrained
                });
            });
            skillsForSummary.sort((a, b) => a.name.localeCompare(b.name));


            const summaryHtml = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Resumo de ${charData.name}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        @media print {
                            .no-print { display: none !important; }
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                        body {
                            font-family: 'Inter', sans-serif;
                            background-color: #111827;
                        }
                        .modal { transition: opacity 0.3s ease; }
                        
                        /* Estilos para botões PV/PM */
                        .health-button {
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            min-width: 24px;
                            min-height: 24px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        }
                        .health-button:hover {
                            transform: scale(1.1);
                            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
                        }
                        .health-button:active {
                            transform: scale(0.95);
                            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                        }
                        
                        /* Cores específicas para status de saúde com animação */
                        .health-critical { 
                            color: #000000 !important; 
                            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
                        }
                        .health-low { 
                            color: #f87171 !important; 
                            text-shadow: 0 0 4px rgba(248,113,113,0.3);
                        }
                        .health-medium { 
                            color: #fbbf24 !important; 
                            text-shadow: 0 0 4px rgba(251,191,36,0.3);
                        }
                        .health-high-pv { 
                            color: #4ade80 !important; 
                            text-shadow: 0 0 4px rgba(74,222,128,0.3);
                        }
                        .health-high-pm { 
                            color: #60a5fa !important; 
                            text-shadow: 0 0 4px rgba(96,165,250,0.3);
                        }
                        
                        /* Animação de pulso para valores críticos */
                        .health-critical {
                            animation: criticalPulse 1.5s infinite;
                        }
                        
                        @keyframes criticalPulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.7; }
                        }
                        
                        /* Estilo para container de PV/PM */
                        .health-container {
                            position: relative;
                        }
                        
                        .health-container:hover .health-button {
                            opacity: 1;
                        }
                    </style>
                </head>
                <body class="bg-gray-900 text-white p-4 md:p-8">
                    <!-- Modal para Detalhes de Magia/Talento (z-50) -->
                    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 hidden no-print" onclick="closeDetailsModal()">
                        <div class="bg-gray-700 rounded-lg shadow-xl w-full max-w-2xl border-t-4 border-violet-500 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                             <div class="p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 id="modal-title" class="text-2xl font-bold text-violet-300">Detalhes</h3>
                                    <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                                </div>
                                <div id="modal-content" class="text-gray-300 space-y-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal para Listas (z-40, para ficar atrás do modal de detalhes) -->
                    <div id="list-modal" class="modal fixed inset-0 bg-black bg-opacity-75 z-40 flex items-center justify-center p-4 hidden no-print" onclick="closeListModal()">
                        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg border-t-4 border-gray-600 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
                             <div class="flex justify-between items-center p-4 border-b border-gray-700">
                                <h3 id="list-modal-title" class="text-xl font-bold text-gray-300">Lista</h3>
                                <button onclick="closeListModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                            </div>
                            <div id="list-modal-content" class="p-4 space-y-2 overflow-y-auto">
                                <!-- Conteúdo injetado via JS -->
                            </div>
                        </div>
                    </div>

                    <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-8 border-t-4 border-violet-500">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h1 class="text-4xl font-extrabold text-violet-300">${charData.name}</h1>
                                <p class="text-lg text-gray-400">${charData.classLevel}</p>
                            </div>
                            <button onclick="window.print()" class="no-print px-4 py-2 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition duration-150">Imprimir</button>
                        </div>

                        <!-- Status Principais -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-6">
                            <div class="bg-gray-700 p-3 rounded-lg health-container">
                                <p class="text-xs text-red-400">PV</p>
                                <div class="flex items-center justify-center gap-2 no-print">
                                    <button onclick="adjustPV(-1)" class="health-button w-6 h-6 bg-red-600 hover:bg-red-700 text-white rounded-full text-sm font-bold" title="Diminuir PV">-</button>
                                    <p id="summary-pv-display" class="text-2xl font-bold transition-colors duration-300">${charData.pvCurrent}/${charData.pvTotal}</p>
                                    <button onclick="adjustPV(1)" class="health-button w-6 h-6 bg-green-600 hover:bg-green-700 text-white rounded-full text-sm font-bold" title="Aumentar PV">+</button>
                                </div>
                                <p class="text-2xl font-bold print:block hidden transition-colors duration-300" id="summary-pv-print">${charData.pvCurrent}/${charData.pvTotal}</p>
                            </div>
                            <div class="bg-gray-700 p-3 rounded-lg health-container">
                                <p class="text-xs text-amber-400">PM</p>
                                <div class="flex items-center justify-center gap-2 no-print">
                                    <button onclick="adjustPM(-1)" class="health-button w-6 h-6 bg-purple-600 hover:bg-purple-700 text-white rounded-full text-sm font-bold" title="Diminuir PM">-</button>
                                    <p id="summary-pm-display" class="text-2xl font-bold transition-colors duration-300">${charData.pmCurrent}/${charData.pmTotal}</p>
                                    <button onclick="adjustPM(1)" class="health-button w-6 h-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full text-sm font-bold" title="Aumentar PM">+</button>
                                </div>
                                <p class="text-2xl font-bold print:block hidden transition-colors duration-300" id="summary-pm-print">${charData.pmCurrent}/${charData.pmTotal}</p>
                            </div>
                            <div class="bg-gray-700 p-3 rounded-lg"><p class="text-xs text-sky-400">CA</p><p class="text-2xl font-bold">${caTotal}</p></div>
                            <div class="bg-gray-700 p-3 rounded-lg"><p class="text-xs text-lime-400">Ação/RD</p><p class="text-2xl font-bold">${charData.actionPoints}/${charData.rd}</p></div>
                        </div>

                        <!-- Modificadores de Atributo -->
                        <h2 class="text-xl font-bold text-violet-300 mb-3 border-b border-gray-700 pb-2">Atributos</h2>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center mb-6">
                            ${Object.entries(charData.attributes).map(([key, attr]) => `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <p class="text-sm font-semibold text-gray-400">${key}</p>
                                    <p class="text-3xl font-bold">${attr.mod >= 0 ? '+' : ''}${attr.mod}</p>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Ataques e Resumos -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-violet-300 mb-3 border-b border-gray-700 pb-2">Ataques</h2>
                                <div class="space-y-2 text-lg">
                                    <p class="flex justify-between"><span>Corpo a Corpo:</span> <span class="font-bold text-red-400">${ataqueCorpoACorpo}</span></p>
                                    <p class="flex justify-between"><span>À Distância:</span> <span class="font-bold text-sky-400">${ataqueDistancia}</span></p>
                                    <p class="flex justify-between"><span>Mágico:</span> <span class="font-bold text-purple-400">${ataqueMagico}</span></p>
                                </div>
                            </div>
                            <div>
                                 <h2 class="text-xl font-bold text-violet-300 mb-3 border-b border-gray-700 pb-2">Resumos</h2>
                                <div class="space-y-3 text-lg">
                                     <p class="flex justify-between items-center">
                                        <span>Perícias (${periciasTreinadas} treinadas)</span>
                                        <button onclick='showListModal("pericias")' class="no-print text-sm px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold transition">Consultar</button>
                                    </p>
                                     <p class="flex justify-between items-center">
                                        <span>Talentos (${totalTalentos})</span>
                                         <button onclick='showListModal("talentos")' class="no-print text-sm px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold transition">Consultar</button>
                                    </p>
                                     <p class="flex justify-between items-center">
                                        <span>Magias (${totalMagias})</span>
                                         <button onclick='showListModal("magias")' class="no-print text-sm px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-lg font-semibold transition">Consultar</button>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Resistências e Bônus de Dano -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                 <h2 class="text-xl font-bold text-violet-300 mb-3 border-b border-gray-700 pb-2">Resistências</h2>
                                <div class="space-y-2 text-lg">
                                    <p class="flex justify-between"><span>Fortitude:</span> <span class="font-bold text-red-400">${resFortitude}</span></p>
                                    <p class="flex justify-between"><span>Reflexos:</span> <span class="font-bold text-sky-400">${resReflexos}</span></p>
                                    <p class="flex justify-between"><span>Vontade:</span> <span class="font-bold text-lime-400">${resVontade}</span></p>
                                </div>
                            </div>
                             <div>
                                <h2 class="text-xl font-bold text-violet-300 mb-3 border-b border-gray-700 pb-2">Bônus de Dano</h2>
                                <div class="space-y-2 text-lg">
                                    <p class="flex justify-between"><span>Corpo a Corpo:</span> <span class="font-bold text-red-400">${danoCorpoACorpo}</span></p>
                                    <p class="flex justify-between"><span>Disparo:</span> <span class="font-bold text-sky-400">${danoDisparo}</span></p>
                                </div>
                            </div>
                        </div>

                    </div>
                    <script>
                        // Armazena os dados em um objeto global para evitar sobrecarregar os atributos HTML
                        const summaryData = {
                            pericias: ${JSON.stringify(skillsForSummary)},
                            talentos: ${JSON.stringify(charData.talents || [])},
                            magias: ${JSON.stringify(charData.spells || [])}
                        };

                        function showListModal(type) {
                            const data = summaryData[type];
                            const titleEl = document.getElementById('list-modal-title');
                            const contentEl = document.getElementById('list-modal-content');
                            let contentHtml = '';

                            switch (type) {
                                case 'pericias':
                                    titleEl.innerText = 'Lista de Perícias';
                                    if (data && data.length > 0) {
                                        contentHtml = data.map(function(skill) {
                                            return \`<div class="flex justify-between items-center text-sm p-2 rounded \${skill.isTrained ? 'bg-gray-700/75' : 'bg-gray-900/50'}">
                                                <span>\${skill.name} <span class="text-gray-400">(\${skill.attr})</span></span>
                                                <span class="font-bold text-lg \${skill.isTrained ? 'text-violet-300' : 'text-gray-400'}">\${skill.totalBonus >= 0 ? '+' : ''}\${skill.totalBonus}</span>
                                            </div>\`;
                                        }).join('');
                                    } else {
                                        contentHtml = '<p class="text-sm text-gray-500 p-2">Nenhuma perícia.</p>';
                                    }
                                    break;
                                case 'talentos':
                                    titleEl.innerText = 'Lista de Talentos';
                                    if (data && data.length > 0) {
                                        contentHtml = data.map(function(talent, index) {
                                            return \`<button onclick="showTalentDetailsByIndex(\${index})" class="block w-full text-left text-gray-300 hover:text-white hover:bg-gray-700/50 p-3 rounded transition-colors duration-150">\${talent.name}</button>\`;
                                        }).join('');
                                    } else {
                                        contentHtml = '<p class="text-sm text-gray-500 p-2">Nenhum talento.</p>';
                                    }
                                    break;
                                case 'magias':
                                    titleEl.innerText = 'Lista de Magias';
                                    if (data && data.length > 0) {
                                        contentHtml = data.map(function(spell, index) {
                                            return \`<button onclick="showSpellDetailsByIndex(\${index})" class="block w-full text-left text-gray-300 hover:text-white hover:bg-gray-700/50 p-3 rounded transition-colors duration-150">\${spell.name}</button>\`;
                                        }).join('');
                                    } else {
                                        contentHtml = '<p class="text-sm text-gray-500 p-2">Nenhuma magia.</p>';
                                    }
                                    break;
                            }

                            contentEl.innerHTML = contentHtml;
                            document.getElementById('list-modal').classList.remove('hidden');
                        }

                        function closeListModal() {
                            document.getElementById('list-modal').classList.add('hidden');
                        }

                        function showSpellDetailsByIndex(index) {
                            const spell = summaryData.magias[index];
                            if (spell) showSpellDetailsModal(spell);
                        }

                        function showTalentDetailsByIndex(index) {
                            const talent = summaryData.talentos[index];
                            if (talent) showTalentDetailsModal(talent);
                        }

                        // Versões globais das funções para ficarem disponíveis globalmente
                        window.showTalentDetailsByIndex = function(index) {
                            const talent = summaryData.talentos ? summaryData.talentos[index] : null;
                            if (talent) showTalentDetailsModal(talent);
                        };

                        window.showSpellDetailsByIndex = function(index) {
                            const spell = summaryData.magias ? summaryData.magias[index] : null;
                            if (spell) showSpellDetailsModal(spell);
                        };

                        function showSpellDetailsModal(spell) {
                            document.getElementById('modal-title').innerText = spell.name || "Detalhes da Magia";
                            const content = document.getElementById('modal-content');
                            content.innerHTML = 
                                \`<div class="grid grid-cols-2 sm:grid-cols-3 text-sm text-gray-400 gap-2 mb-4 border-b border-gray-600 pb-4">
                                    <p><strong class="text-gray-200 block">Nível:</strong> \${spell.level || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Escola:</strong> \${spell.school || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Tempo:</strong> \${spell.time || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Alcance:</strong> \${spell.range || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Alvo/Área:</strong> \${spell.target || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Duração:</strong> \${spell.duration || 'N/A'}</p>
                                </div>
                                <div class="space-y-3">
                                    <p><strong class="text-gray-200">Componentes:</strong> \${spell.components || 'N/A'}</p>
                                    <p><strong class="text-gray-200">Teste de Resistência:</strong> \${spell.resistance || 'Nenhum'}</p>
                                    <hr class="border-gray-600 my-3">
                                    <p class="whitespace-pre-wrap">\${spell.description || 'Sem descrição.'}</p>
                                </div>\`;
                            document.getElementById('details-modal').classList.remove('hidden');
                        }

                        function showTalentDetailsModal(talent) {
                            document.getElementById('modal-title').innerText = talent.name || "Detalhes do Talento";
                            const content = document.getElementById('modal-content');
                            content.innerHTML = 
                                \`<p><strong class="text-gray-200">Tipo:</strong> \${talent.type || 'N/A'}</p>
                                <p><strong class="text-gray-200">Pré-requisito:</strong> \${talent.prerequisite || 'Nenhum'}</p>
                                <hr class="border-gray-600 my-3">
                                <p class="whitespace-pre-wrap"><strong class="text-gray-200">Benefício:</strong><br>\${talent.benefit || 'Nenhum.'}</p>\`;
                            document.getElementById('details-modal').classList.remove('hidden');
                        }

                        // Versão global da função de detalhes do talento
                        window.showTalentDetailsModal = function(talent) {
                            document.getElementById('modal-title').innerText = talent.name || "Detalhes do Talento";
                            const content = document.getElementById('modal-content');
                            content.innerHTML = 
                                \`<p><strong class="text-gray-200">Tipo:</strong> \${talent.type || 'N/A'}</p>
                                <p><strong class="text-gray-200">Pré-requisito:</strong> \${talent.prerequisite || 'Nenhum'}</p>
                                <hr class="border-gray-600 my-3">
                                <p class="whitespace-pre-wrap"><strong class="text-gray-200">Benefício:</strong><br>\${talent.benefit || 'Nenhum.'}</p>\`;
                            document.getElementById('details-modal').classList.remove('hidden');
                        };

                        // Versão global da função de detalhes da magia
                        window.showSpellDetailsModal = function(spell) {
                            document.getElementById('modal-title').innerText = spell.name || "Detalhes da Magia";
                            const content = document.getElementById('modal-content');
                            content.innerHTML = 
                                \`<div class="grid grid-cols-2 sm:grid-cols-3 text-sm text-gray-400 gap-2 mb-4 border-b border-gray-600 pb-4">
                                    <p><strong class="text-gray-200 block">Nível:</strong> \${spell.level || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Escola:</strong> \${spell.school || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Tempo:</strong> \${spell.time || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Alcance:</strong> \${spell.range || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Alvo/Área:</strong> \${spell.target || 'N/A'}</p>
                                    <p><strong class="text-gray-200 block">Duração:</strong> \${spell.duration || 'N/A'}</p>
                                </div>
                                <div class="space-y-3">
                                    <p><strong class="text-gray-200">Componentes:</strong> \${spell.components || 'N/A'}</p>
                                    <p><strong class="text-gray-200">Teste de Resistência:</strong> \${spell.resistance || 'Nenhum'}</p>
                                    <hr class="border-gray-600 my-3">
                                    <p class="whitespace-pre-wrap">\${spell.description || 'Sem descrição.'}</p>
                                </div>\`;
                            document.getElementById('details-modal').classList.remove('hidden');
                        };

                        function closeDetailsModal() {
                            document.getElementById('details-modal').classList.add('hidden');
                        }

                        // === FUNÇÕES DE GERENCIAMENTO DE PV/PM ===
                        
                        // Dados do personagem disponíveis no resumo
                        let summaryCharData = ${JSON.stringify(charData)};
                        
                        function getHealthColor(current, total, type = 'pv') {
                            if (total === 0) return 'health-critical';
                            
                            const percentage = (current / total) * 100;
                            
                            if (type === 'pv') {
                                // PV: Verde -> Amarelo -> Vermelho -> Preto
                                if (percentage > 75) return 'health-high-pv';
                                else if (percentage > 50) return 'health-medium';
                                else if (percentage > 0) return 'health-low';
                                else return 'health-critical';
                            } else {
                                // PM: Azul -> Amarelo -> Vermelho -> Preto
                                if (percentage > 75) return 'health-high-pm';
                                else if (percentage > 50) return 'health-medium';
                                else if (percentage > 0) return 'health-low';
                                else return 'health-critical';
                            }
                        }
                        
                        function updateSummaryDisplay() {
                            const pvDisplay = document.getElementById('summary-pv-display');
                            const pmDisplay = document.getElementById('summary-pm-display');
                            const pvPrint = document.getElementById('summary-pv-print');
                            const pmPrint = document.getElementById('summary-pm-print');
                            
                            const pvText = \`\${summaryCharData.pvCurrent}/\${summaryCharData.pvTotal}\`;
                            const pmText = \`\${summaryCharData.pmCurrent}/\${summaryCharData.pmTotal}\`;
                            
                            const pvColor = getHealthColor(summaryCharData.pvCurrent, summaryCharData.pvTotal, 'pv');
                            const pmColor = getHealthColor(summaryCharData.pmCurrent, summaryCharData.pmTotal, 'pm');
                            
                            // Atualizar displays de tela
                            if (pvDisplay) {
                                pvDisplay.textContent = pvText;
                                // Remover todas as classes de cor e adicionar a nova
                                pvDisplay.className = pvDisplay.className.replace(/health-\\w+/g, '').trim() + ' ' + pvColor;
                            }
                            if (pmDisplay) {
                                pmDisplay.textContent = pmText;
                                // Remover todas as classes de cor e adicionar a nova
                                pmDisplay.className = pmDisplay.className.replace(/health-\\w+/g, '').trim() + ' ' + pmColor;
                            }
                            
                            // Atualizar displays de impressão
                            if (pvPrint) {
                                pvPrint.textContent = pvText;
                                pvPrint.className = pvPrint.className.replace(/health-\\w+/g, '').trim() + ' ' + pvColor;
                            }
                            if (pmPrint) {
                                pmPrint.textContent = pmText;
                                pmPrint.className = pmPrint.className.replace(/health-\\w+/g, '').trim() + ' ' + pmColor;
                            }
                        }
                        
                        function adjustPV(delta) {
                            const newValue = Math.max(0, Math.min(summaryCharData.pvTotal, summaryCharData.pvCurrent + delta));
                            summaryCharData.pvCurrent = newValue;
                            
                            // Sincronizar com dados principais se a janela pai estiver disponível
                            if (window.opener && window.opener.updateCharacterDetails) {
                                window.opener.updateCharacterDetails('pvCurrent', newValue);
                            }
                            
                            updateSummaryDisplay();
                        }
                        
                        function adjustPM(delta) {
                            const newValue = Math.max(0, Math.min(summaryCharData.pmTotal, summaryCharData.pmCurrent + delta));
                            summaryCharData.pmCurrent = newValue;
                            
                            // Sincronizar com dados principais se a janela pai estiver disponível
                            if (window.opener && window.opener.updateCharacterDetails) {
                                window.opener.updateCharacterDetails('pmCurrent', newValue);
                            }
                            
                            updateSummaryDisplay();
                        }
                        
                        // Função para sincronização bidirecional
                        function syncWithMainWindow() {
                            if (window.opener && window.opener.characters && window.opener.currentCharacterId) {
                                const mainCharData = window.opener.characters[window.opener.currentCharacterId];
                                if (mainCharData) {
                                    summaryCharData.pvCurrent = mainCharData.pvCurrent || summaryCharData.pvCurrent;
                                    summaryCharData.pmCurrent = mainCharData.pmCurrent || summaryCharData.pmCurrent;
                                    updateSummaryDisplay();
                                }
                            }
                        }
                        
                        // Verificar periodicamente por atualizações da janela principal
                        setInterval(syncWithMainWindow, 1000);
                        
                        // Atalhos de teclado para gerenciamento de PV/PM
                        document.addEventListener('keydown', function(e) {
                            // Só funciona se não estiver em um input
                            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                            
                            switch(e.key.toLowerCase()) {
                                case 'q': // Q para diminuir PV
                                    e.preventDefault();
                                    adjustPV(-1);
                                    break;
                                case 'w': // W para aumentar PV
                                    e.preventDefault();
                                    adjustPV(1);
                                    break;
                                case 'a': // A para diminuir PM
                                    e.preventDefault();
                                    adjustPM(-1);
                                    break;
                                case 's': // S para aumentar PM
                                    e.preventDefault();
                                    adjustPM(1);
                                    break;
                                case 'r': // R para resetar PV ao máximo
                                    if (e.ctrlKey) {
                                        e.preventDefault();
                                        summaryCharData.pvCurrent = summaryCharData.pvTotal;
                                        if (window.opener && window.opener.updateCharacterDetails) {
                                            window.opener.updateCharacterDetails('pvCurrent', summaryCharData.pvTotal);
                                        }
                                        updateSummaryDisplay();
                                    }
                                    break;
                                case 'm': // M para resetar PM ao máximo
                                    if (e.ctrlKey) {
                                        e.preventDefault();
                                        summaryCharData.pmCurrent = summaryCharData.pmTotal;
                                        if (window.opener && window.opener.updateCharacterDetails) {
                                            window.opener.updateCharacterDetails('pmCurrent', summaryCharData.pmTotal);
                                        }
                                        updateSummaryDisplay();
                                    }
                                    break;
                            }
                        });
                        
                        // Inicializar as cores quando a página carregar
                        document.addEventListener('DOMContentLoaded', function() {
                            updateSummaryDisplay();
                            // Sincronizar uma vez no carregamento
                            setTimeout(syncWithMainWindow, 500);
                            
                            // Mostrar dica dos atalhos por alguns segundos
                            const helpText = document.createElement('div');
                            helpText.innerHTML = \`
                                <div class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg shadow-lg z-50 no-print" id="keyboard-help">
                                    <p class="text-sm font-bold mb-2">Atalhos de Teclado:</p>
                                    <p class="text-xs">Q/W: PV -/+</p>
                                    <p class="text-xs">A/S: PM -/+</p>
                                    <p class="text-xs">Ctrl+R: Resetar PV</p>
                                    <p class="text-xs">Ctrl+M: Resetar PM</p>
                                </div>
                            \`;
                            document.body.appendChild(helpText);
                            
                            // Remover dica após 8 segundos
                            setTimeout(() => {
                                const help = document.getElementById('keyboard-help');
                                if (help) {
                                    help.style.opacity = '0';
                                    help.style.transition = 'opacity 0.5s ease';
                                    setTimeout(() => help.remove(), 500);
                                }
                            }, 8000);
                        });
                        
                        // === MODAL DE ATALHOS DO RESUMO ===
                        
                        // Criar modal de atalhos
                        const shortcutsModal = document.createElement('div');
                        shortcutsModal.id = 'summary-shortcuts-modal';
                        shortcutsModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print';
                        shortcutsModal.onclick = function() { closeSummaryShortcutsModal(); };
                        
                        shortcutsModal.innerHTML = \`
                            <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-blue-300 flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 3a1 1 0 012 0v5.5a.5.5 0 001 0V4a1 1 0 112 0v4.5a.5.5 0 001 0V6a1 1 0 112 0v6a2.5 2.5 0 01-2.5 2.5h-1.086a3.5 3.5 0 01-1.664-.823L12 15.5V18a1 1 0 11-2 0v-2.5l-1.5-1.5C7.664 13.177 7 12.092 7 11V3z" clip-rule="evenodd"></path>
                                        </svg>
                                        ⌨️ Atalhos do Resumo
                                    </h3>
                                    <button onclick="closeSummaryShortcutsModal()" class="text-gray-400 hover:text-white transition-colors">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-3">
                                    <div class="bg-gray-900 p-3 rounded-lg border-l-4 border-red-400">
                                        <h4 class="text-red-300 font-semibold mb-2 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                            🩸 Gerenciar PV (Pontos de Vida)
                                        </h4>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Diminuir PV</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-red-300 rounded text-xs font-mono">Q</kbd>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Aumentar PV</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-green-300 rounded text-xs font-mono">W</kbd>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Resetar PV (Total)</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-blue-300 rounded text-xs font-mono">Ctrl + R</kbd>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gray-900 p-3 rounded-lg border-l-4 border-blue-400">
                                        <h4 class="text-blue-300 font-semibold mb-2 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                                            </svg>
                                            ✨ Gerenciar PM (Pontos de Magia)
                                        </h4>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Diminuir PM</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-red-300 rounded text-xs font-mono">A</kbd>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Aumentar PM</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-green-300 rounded text-xs font-mono">S</kbd>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Resetar PM (Total)</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-blue-300 rounded text-xs font-mono">Ctrl + M</kbd>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gray-900 p-3 rounded-lg border-l-4 border-purple-400">
                                        <h4 class="text-purple-300 font-semibold mb-2 flex items-center">
                                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                            </svg>
                                            🎯 Outros Atalhos
                                        </h4>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Exibir atalhos</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-purple-300 rounded text-xs font-mono">F1</kbd>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-300">Fechar modal</span>
                                                <kbd class="px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs font-mono">Esc</kbd>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 text-center">
                                    <p class="text-xs text-gray-400">Modal desaparece automaticamente em <span id="summary-countdown">10</span> segundos</p>
                                </div>
                            </div>
                        \`;
                        
                        document.body.appendChild(shortcutsModal);
                        
                        // Funções do modal
                        window.showSummaryShortcutsModal = function() {
                            const modal = document.getElementById('summary-shortcuts-modal');
                            const modalContent = modal.querySelector('div');
                            
                            if (modal) {
                                modal.classList.remove('hidden');
                                setTimeout(() => {
                                    modalContent.classList.remove('scale-95', 'opacity-0');
                                    modalContent.classList.add('scale-100', 'opacity-100');
                                }, 10);
                                
                                startSummaryCountdown();
                                
                                // Auto-fechar após 10 segundos
                                setTimeout(() => {
                                    closeSummaryShortcutsModal();
                                }, 10000);
                            }
                        };
                        
                        window.closeSummaryShortcutsModal = function() {
                            const modal = document.getElementById('summary-shortcuts-modal');
                            const modalContent = modal.querySelector('div');
                            
                            if (modal && !modal.classList.contains('hidden')) {
                                modalContent.classList.remove('scale-100', 'opacity-100');
                                modalContent.classList.add('scale-95', 'opacity-0');
                                
                                setTimeout(() => {
                                    modal.classList.add('hidden');
                                }, 300);
                                
                                if (window.summaryCountdownInterval) {
                                    clearInterval(window.summaryCountdownInterval);
                                }
                            }
                        };
                        
                        function startSummaryCountdown() {
                            let timeLeft = 10;
                            const countdownElement = document.getElementById('summary-countdown');
                            
                            if (countdownElement) {
                                countdownElement.textContent = timeLeft;
                                
                                window.summaryCountdownInterval = setInterval(() => {
                                    timeLeft--;
                                    if (countdownElement) {
                                        countdownElement.textContent = timeLeft;
                                    }
                                    
                                    if (timeLeft <= 0) {
                                        clearInterval(window.summaryCountdownInterval);
                                    }
                                }, 1000);
                            }
                        }
                        
                        // Evento F1 para mostrar atalhos
                        document.addEventListener('keydown', function(e) {
                            if (e.key === 'F1') {
                                e.preventDefault();
                                showSummaryShortcutsModal();
                            }
                            
                            // Esc para fechar modal
                            if (e.key === 'Escape') {
                                const modal = document.getElementById('summary-shortcuts-modal');
                                if (modal && !modal.classList.contains('hidden')) {
                                    closeSummaryShortcutsModal();
                                }
                            }
                        });
                    <\/script>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(summaryHtml);
            printWindow.document.close();
        }

        window.importCharacter = function() {
            document.getElementById('import-file-input').click();
        };

        window.handleFileImport = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const charData = JSON.parse(e.target.result);
                    if (charData && charData.name) {
                        charData.id = crypto.randomUUID(); // Garante um ID único
                        charData.createdAt = new Date().toISOString();
                        characters[charData.id] = charData;
                        saveCharactersToLocalStorage();
                        renderCharacterList();
                    } else {
                        alert("Arquivo JSON inválido ou não contém um personagem.");
                    }
                } catch (error) {
                    alert("Erro ao ler o arquivo JSON.");
                    console.error("Erro ao importar:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reseta o input para permitir importar o mesmo arquivo de novo
        };

        window.exportCharacter = function(charId) {
            if (!characters[charId]) return;

            const charData = characters[charId];
            const dataStr = JSON.stringify(charData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${charData.name.replace(/\s/g, '_')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        window.saveCurrentCharacter = function() {
            if (!currentCharacterId) return;
            saveCharactersToLocalStorage();
            hasUnsavedChanges = false;
            const feedback = document.getElementById('save-feedback');
            feedback.innerText = "Alterações salvas com sucesso!";
            setTimeout(() => {
                feedback.innerText = "";
            }, 2000);
        };
        
        window.handleImageUpload = function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                updateCharacterDetails('imageUrl', dataUrl);
            };
            reader.readAsDataURL(file);
            event.target.value = ''; // Reset input to allow re-uploading the same file
        };

        // === SISTEMA DE INICIALIZAÇÃO MELHORADO ===
        class AppInitializer {
            static async init() {
                try {
                    this.showLoading();
                    
                    // Inicializar sistemas core
                    await this.initializeCoreServices();
                    
                    // Carregar dados
                    await this.loadUserData();
                    
                    // Configurar interface
                    await this.setupInterface();
                    
                    // Inicializar funcionalidades avançadas
                    this.initializeAdvancedFeatures();
                    
                    this.hideLoading();
                    Logger.debug('Aplicação inicializada com sucesso');
                    NotificationManager.show('Sistema carregado com sucesso!', 'success', 2000);
                } catch (e) {
                    this.hideLoading();
                    ErrorHandler.handle(e, 'initialization');
                    NotificationManager.show('Erro ao inicializar sistema', 'error');
                }
            }
            
            static showLoading() {
                const loadingView = document.getElementById('loading-view');
                if (loadingView) {
                    loadingView.classList.remove('hidden');
                }
            }
            
            static hideLoading() {
                const loadingView = document.getElementById('loading-view');
                if (loadingView) {
                    loadingView.classList.add('hidden');
                }
            }
            
            static async initializeCoreServices() {
                // Inicializar gerenciadores
                AccessibilityManager.init();
                RealTimeValidator.init();
                AutoSaveManager.start();
                BackupManager.startAutoBackup();
                
                // Verificar recursos do navegador
                this.checkBrowserSupport();
            }
            
            static async loadUserData() {
                loadCharactersFromLocalStorage();
                loadSavedTheme();
            }
            
            static async setupInterface() {
                populateLanguageDropdown();
                this.setupGlobalEventListeners();
                this.addKeyboardShortcutsHelp();
                this.initializeHelpSystem();
            }
            
            static initializeHelpSystem() {
                // Configurar modal de ajuda para abrir na primeira aba por padrão
                const helpModal = document.getElementById('help-modal');
                if (helpModal) {
                    // Adicionar listener para resetar para primeira aba quando modal é aberto
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                const isVisible = !helpModal.classList.contains('hidden');
                                if (isVisible) {
                                    // Resetar para primeira aba quando modal abre
                                    setTimeout(() => window.switchHelpTab('shortcuts'), 100);
                                }
                            }
                        });
                    });
                    
                    observer.observe(helpModal, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }
            }
            
            static initializeAdvancedFeatures() {
                // Configurar observadores de performance
                this.setupPerformanceMonitoring();
                
                // Adicionar handlers para eventos de sistema
                this.setupSystemEventHandlers();
            }
            
            static checkBrowserSupport() {
                const features = {
                    localStorage: typeof Storage !== 'undefined',
                    crypto: typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function',
                    fetch: typeof fetch !== 'undefined'
                };
                
                const unsupported = Object.entries(features)
                    .filter(([key, value]) => !value)
                    .map(([key]) => key);
                
                if (unsupported.length > 0) {
                    Logger.error(`Recursos não suportados: ${unsupported.join(', ')}`);
                    NotificationManager.show(
                        `Alguns recursos podem não funcionar corretamente neste navegador.`,
                        'warning',
                        5000
                    );
                }
            }
            
            static setupGlobalEventListeners() {
                // Listener para mudanças não salvas
                window.addEventListener('beforeunload', (e) => {
                    if (hasUnsavedChanges) {
                        e.preventDefault();
                        e.returnValue = 'Você tem alterações não salvas. Deseja sair mesmo assim?';
                    }
                });
                
                // Listener para eventos de visibilidade (pausar auto-save quando não visível)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        AutoSaveManager.stop();
                        BackupManager.stopAutoBackup();
                    } else {
                        AutoSaveManager.start();
                        BackupManager.startAutoBackup();
                    }
                });
            }
            
            static setupPerformanceMonitoring() {
                // Monitorar performance de renderização
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.duration > CONFIG.PERFORMANCE_THRESHOLD) {
                            Logger.performance(entry.name, entry.duration);
                        }
                    });
                });
                
                if (window.PerformanceObserver) {
                    observer.observe({ entryTypes: ['measure'] });
                }
            }
            
            static setupSystemEventHandlers() {
                // Handler para erros globais
                window.addEventListener('error', (e) => {
                    ErrorHandler.handle(e.error, 'globalError');
                });
                
                // Handler para erros de promise rejeitadas
                window.addEventListener('unhandledrejection', (e) => {
                    ErrorHandler.handle(e.reason, 'unhandledPromise');
                });
            }
            
            static addKeyboardShortcutsHelp() {
                const helpText = `
                    Atalhos de Teclado:
                    • Ctrl+S: Salvar alterações
                    • Ctrl+N: Novo personagem
                    • Ctrl+E: Exportar personagem
                    • Esc: Fechar modal
                `;
                
                // Adicionar tooltip de ajuda ao botão de tema
                const themeButton = document.querySelector('[title="Mudar Tema"]');
                if (themeButton) {
                    themeButton.setAttribute('title', themeButton.title + ' | ' + helpText.trim());
                }
            }
        }

        // --- FUNÇÕES GLOBAIS PARA FACILITAR DESENVOLVIMENTO ---
        
        // Função global para facilitar mudança de versão durante desenvolvimento
        window.updateSystemVersion = function(newVersion) {
            VersionManager.setVersion(newVersion);
            NotificationManager.showNotification(`Sistema atualizado para versão ${newVersion}`, 'success');
            console.log(`%c🚀 Sistema atualizado para versão ${newVersion}`, 'color: #10B981; font-weight: bold;');
        };
        
        // Função global para obter versão atual
        window.getCurrentVersion = function() {
            const version = VersionManager.getVersion();
            console.log(`%c📋 Versão atual do sistema: ${version}`, 'color: #3B82F6; font-weight: bold;');
            return version;
        };
        
        // Função global para testar atalhos rápidos
        window.testQuickShortcuts = function() {
            console.log('%c🧪 Testando função de atalhos rápidos...', 'color: #F59E0B; font-weight: bold;');
            if (window.showQuickShortcutsModal) {
                showQuickShortcutsModal();
                return '✅ Teste executado - verifique se apareceu notificação!';
            } else {
                return '❌ HelpSystem não disponível!';
            }
        };
        
        // Função global para testar atalhos do resumo
        window.testSummaryShortcuts = function() {
            console.log('%c📊 Testando função de atalhos do resumo...', 'color: #8B5CF6; font-weight: bold;');
            console.log('%cℹ Dica: Esta função só funciona na janela do resumo!', 'color: #F59E0B;');
            return '⚠️ Esta função só funciona na janela do resumo de personagem!';
        };
        
        // === FUNÇÕES GLOBAIS PARA LOGS E ERROS ===
        
        // Atualizar estatísticas de logs na interface
        window.updateLogStats = function() {
            const stats = Logger.getLogStats();
            
            const totalEl = document.getElementById('log-stats-total');
            const errorsEl = document.getElementById('log-stats-errors');
            const warningsEl = document.getElementById('log-stats-warnings');
            const performanceEl = document.getElementById('log-stats-performance');
            
            if (totalEl) totalEl.textContent = stats.total;
            if (errorsEl) errorsEl.textContent = stats.errors;
            if (warningsEl) warningsEl.textContent = stats.warnings;
            if (performanceEl) performanceEl.textContent = stats.performance;
            
            console.log('%c📊 Estatísticas de logs atualizadas:', 'color: #3B82F6; font-weight: bold;', stats);
        };
        
        // Mostrar logs do sistema com filtros melhorados
        window.showSystemLogs = function() {
            const logs = Logger.getLogs();
            const stats = Logger.getLogStats();
            
            // Debug: verificar dados
            console.log('🔍 DEBUG showSystemLogs - logs carregados:', logs?.length || 0);
            console.log('🔍 DEBUG showSystemLogs - stats:', stats);
            console.log('🔍 DEBUG showSystemLogs - logs por nível:', logs?.reduce((acc, log) => {
                acc[log.level] = (acc[log.level] || 0) + 1;
                return acc;
            }, {}) || {});
            
            if (logs.length === 0) {
                alert('📋 Nenhum log encontrado.\n\nIsso significa que não houve atividade recente no sistema!');
                return;
            }
            
            // Mostrar estatísticas no console
            console.log('%c� Estatísticas dos Logs:', 'color: #3B82F6; font-weight: bold; font-size: 16px;');
            console.log(`📋 Total de logs: ${stats.total}`);
            console.log(`🔥 Por nível:`, stats.byLevel);
            console.log(`📁 Por contexto:`, stats.byContext);
            console.log(`⏰ Por período:`, stats.byTimeRange);
            console.log('');
            
            // Mostrar logs recentes por categoria
            console.log('%c📋 Logs Recentes por Categoria:', 'color: #10B981; font-weight: bold;');
            
            const recentLogs = logs.slice(-30).reverse();
            const logsByContext = {};
            
            recentLogs.forEach(log => {
                if (!logsByContext[log.context]) {
                    logsByContext[log.context] = [];
                }
                logsByContext[log.context].push(log);
            });
            
            Object.entries(logsByContext).forEach(([context, contextLogs]) => {
                console.log(`%c\n🏷️ [${context}] (${contextLogs.length} logs):`, 'color: #F59E0B; font-weight: bold;');
                
                contextLogs.slice(0, 5).forEach((log, index) => {
                    const color = getLogColor(log.level);
                    const icon = getLogIcon(log.level);
                    
                    console.log(`%c${icon} ${log.level.toUpperCase()}: ${log.message}`, `color: ${color}; font-weight: bold;`);
                    console.log(`   ⏰ ${log.timestampReadable}`);
                    if (log.data && log.data !== 'null') {
                        try {
                            const parsedData = JSON.parse(log.data);
                            console.log(`   📊 Dados:`, parsedData);
                        } catch (e) {
                            console.log(`   📊 Dados: ${log.data}`);
                        }
                    }
                    if (log.stack) console.log(`   📍 Stack:`, log.stack);
                });
                
                if (contextLogs.length > 5) {
                    console.log(`   ... e mais ${contextLogs.length - 5} logs em [${context}]`);
                }
            });
            
            // Mostrar modal com últimos logs
            createLogModal(logs, stats);
        };

        // Funções auxiliares para cores e ícones
        window.getLogColor = function(level) {
            const colors = {
                'error': '#EF4444',
                'warn': '#F59E0B',
                'warning': '#F59E0B',
                'performance': '#8B5CF6',
                'info': '#3B82F6',
                'debug': '#6B7280'
            };
            return colors[level] || '#6B7280';
        };

        window.getLogIcon = function(level) {
            const icons = {
                'error': '🚨',
                'warn': '⚠️',
                'warning': '⚠️',
                'performance': '⚡',
                'info': 'ℹ️',
                'debug': '🔍'
            };
            return icons[level] || '📝';
        };
        
        // Exportar logs do sistema
        window.exportSystemLogs = function() {
            console.log('%c💾 Exportando logs do sistema...', 'color: #10B981; font-weight: bold;');
            Logger.exportLogs();
        };
        
        // Limpar logs do sistema
        window.clearSystemLogs = function() {
            if (confirm('⚠️ Tem certeza que deseja limpar todos os logs?\n\nEsta ação não pode ser desfeita.')) {
                Logger.clearLogs();
                updateLogStats();
                console.log('%c🗑️ Logs limpos com sucesso!', 'color: #10B981; font-weight: bold;');
                
                if (window.NotificationManager) {
                    NotificationManager.show('🗑️ Logs limpos com sucesso', 'success', 3000);
                }
            }
        };
        
        // Testar sistema de logging melhorado
        window.testErrorLogging = function() {
            console.log('%c🧪 TESTANDO LOGGER MELHORADO...', 'color: #8B5CF6; font-weight: bold; font-size: 16px;');
            
            // Simular logs de diferentes categorias e níveis
            console.log('%c📝 Gerando logs de teste por categoria...', 'color: #3B82F6;');
            
            // Logs por categoria
            Logger.character('info', 'Personagem "Testador" carregado com sucesso', { id: 'test-123', name: 'Testador' });
            Logger.character('warn', 'Atributo de força está muito baixo', { strength: 5 });
            
            Logger.library('info', 'Nova magia adicionada à biblioteca', { name: 'Bola de Fogo', level: 3 });
            Logger.library('error', 'Falha ao validar dados da magia', new Error('Dados inválidos'));
            
            Logger.storage('info', 'Dados salvos no localStorage', { size: '2.5KB' });
            Logger.storage('warn', 'localStorage próximo do limite', { usage: '95%' });
            
            Logger.ui('debug', 'Aba "Magias" selecionada pelo usuário');
            Logger.ui('info', 'Modal de edição aberto', { modal: 'edit-spell-modal' });
            
            Logger.pagination('debug', 'Navegação para página 2', { tab: 'magias', page: 2 });
            Logger.pagination('info', 'Filtro aplicado', { filter: 'nivel:3', results: 8 });
            
            // Simular erro com stack trace
            setTimeout(() => {
                try {
                    throw new Error('Este é um erro de teste para demonstração');
                } catch (e) {
                    Logger.error('Erro capturado durante teste', e, 'TEST');
                }
            }, 100);
            
            // Simular log de performance
            setTimeout(() => {
                Logger.performance('Operação de teste', 1250, 'TEST');
            }, 150);
            
            setTimeout(() => {
                // Atualizar estatísticas
                Logger.updateLogStats();
                
                console.log('%c✅ TESTE CONCLUÍDO!', 'color: #10B981; font-weight: bold; font-size: 16px;');
                console.log('%c📊 Estatísticas atualizadas na aba Dev', 'color: #F59E0B;');
                console.log('%c🔍 Use showSystemLogs() para ver a interface melhorada', 'color: #3B82F6;');
                
                if (window.NotificationManager) {
                    NotificationManager.show('🧪 Teste do Logger melhorado concluído! Verifique a aba Dev.', 'success', 5000);
                }
            }, 200);
        };
        
        // Criar modal para exibir logs com filtros e estatísticas
        function createLogModal(logs, stats = null) {
            // Debug: verificar logs recebidos
            console.log('🔍 DEBUG createLogModal - logs recebidos:', logs?.length || 0);
            console.log('🔍 DEBUG createLogModal - primeiros 3 logs:', logs?.slice(0, 3) || []);
            
            // Remover modal existente se houver
            const existingModal = document.getElementById('logs-modal');
            if (existingModal) {
                existingModal.remove();
            }

            if (!stats) {
                stats = Logger.getLogStats();
            }
            
            // Verificar se stats está válido e criar valores padrão se necessário
            if (!stats || typeof stats !== 'object') {
                stats = {
                    total: logs ? logs.length : 0,
                    byLevel: { info: 0, warn: 0, error: 0, debug: 0, performance: 0 },
                    byContext: { SYSTEM: logs ? logs.length : 0 },
                    byTimeRange: { last1Hour: 0, last24Hours: 0, older: logs ? logs.length : 0 }
                };
            }
            
            // Garantir que byLevel existe e tem os campos necessários
            if (!stats.byLevel || typeof stats.byLevel !== 'object') {
                stats.byLevel = { info: 0, warn: 0, error: 0, debug: 0, performance: 0 };
            }
            
            // Garantir que byContext existe
            if (!stats.byContext || typeof stats.byContext !== 'object') {
                stats.byContext = { SYSTEM: logs ? logs.length : 0 };
            }
            
            // Garantir que byTimeRange existe
            if (!stats.byTimeRange || typeof stats.byTimeRange !== 'object') {
                stats.byTimeRange = { last1Hour: 0, last24Hours: 0, older: logs ? logs.length : 0 };
            }

            // Calcular estatísticas corretas dos logs atuais
            const actualStats = calculateLogStats(logs);
            
            const modal = document.createElement('div');
            modal.id = 'logs-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center no-print';
            
            modal.innerHTML = `
                <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-blue-300 flex items-center">
                            � Monitor de Logs do Sistema
                            <span class="ml-2 bg-blue-600 text-xs px-2 py-1 rounded" id="total-logs-count">${actualStats.total || 0} logs</span>
                        </h3>
                        <button onclick="document.getElementById('logs-modal').remove()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Estatísticas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-xs">
                        <div class="bg-red-900/30 border-l-2 border-red-500 p-2 rounded">
                            <div class="text-red-300 font-semibold">🚨 Erros</div>
                            <div class="text-xl text-white" id="error-count">${actualStats.byLevel.error || 0}</div>
                        </div>
                        <div class="bg-yellow-900/30 border-l-2 border-yellow-500 p-2 rounded">
                            <div class="text-yellow-300 font-semibold">⚠️ Avisos</div>
                            <div class="text-xl text-white" id="warn-count">${actualStats.byLevel.warn || 0}</div>
                        </div>
                        <div class="bg-purple-900/30 border-l-2 border-purple-500 p-2 rounded">
                            <div class="text-purple-300 font-semibold">⚡ Performance</div>
                            <div class="text-xl text-white" id="performance-count">${actualStats.byLevel.performance || 0}</div>
                        </div>
                        <div class="bg-blue-900/30 border-l-2 border-blue-500 p-2 rounded">
                            <div class="text-blue-300 font-semibold">ℹ️ Info</div>
                            <div class="text-xl text-white" id="info-count">${actualStats.byLevel.info || 0}</div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="system-log-level-filter" onchange="filterLogs()" class="bg-gray-700 text-white text-xs px-2 py-1 rounded">
                            <option value="">Todos os níveis</option>
                            <option value="error">🚨 Apenas Erros</option>
                            <option value="warn">⚠️ Apenas Avisos</option>
                            <option value="performance">⚡ Apenas Performance</option>
                            <option value="info">ℹ️ Apenas Info</option>
                            <option value="debug">🔍 Apenas Debug</option>
                        </select>
                        <select id="system-log-context-filter" onchange="filterLogs()" class="bg-gray-700 text-white text-xs px-2 py-1 rounded">
                            <option value="">Todos os contextos</option>
                            ${Object.keys(actualStats.byContext).map(context => 
                                `<option value="${context}">📁 ${context} (${actualStats.byContext[context]})</option>`
                            ).join('')}
                        </select>
                        <button onclick="filterLogs()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded">
                            🔍 Filtrar
                        </button>
                        <button onclick="clearLogFilters()" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-1 rounded">
                            🗑️ Limpar
                        </button>
                        <button onclick="toggleLogOrder()" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded" id="sort-button">
                            📅 Mais Recentes
                        </button>
                        
                        <div class="flex items-center gap-2 ml-auto">
                            <span class="text-xs text-gray-400">Logs por página:</span>
                            <select id="logs-per-page" class="bg-gray-700 text-white text-xs px-2 py-1 rounded" onchange="changeLogsPerPage()">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Controles de Paginação -->
                    <div class="flex items-center justify-between mb-4 text-xs">
                        <div class="text-gray-400">
                            Mostrando <span id="showing-from">1</span> a <span id="showing-to">10</span> de <span id="total-filtered-logs">0</span> logs
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="prev-page" onclick="previousPage()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded disabled:opacity-50" disabled>
                                ← Anterior
                            </button>
                            <span class="text-gray-400">
                                Página <span id="current-page">1</span> de <span id="total-pages">1</span>
                            </span>
                            <button id="next-page" onclick="nextPage()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded disabled:opacity-50" disabled>
                                Próxima →
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Logs -->
                    <div id="logs-container" class="overflow-y-auto max-h-96 space-y-2">
                        <!-- Os logs serão carregados aqui -->
                    </div>
                    
                    <!-- Ações -->
                    <div class="flex gap-2 mt-4 pt-4 border-t border-gray-600">
                        <button onclick="Logger.exportLogs()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                            💾 Exportar Logs
                        </button>
                        <button onclick="Logger.clearLogs(); document.getElementById('logs-modal').remove();" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded">
                            🗑️ Limpar Logs
                        </button>
                        <button onclick="location.reload()" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded">
                            🔄 Recarregar Página
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Variáveis de controle de paginação
            window.logModalState = {
                allLogs: logs || [],
                filteredLogs: logs || [],
                currentPage: 1,
                logsPerPage: 10,
                sortDescending: false // false = mais antigos primeiro, true = mais recentes primeiro
            };

            // Inicializar exibição
            applyFiltersAndPagination();

            // Adicionar funções de filtro e paginação ao window para acesso global
            window.filterLogs = function() {
                try {
                    const levelFilter = document.getElementById('system-log-level-filter')?.value || '';
                    const contextFilter = document.getElementById('system-log-context-filter')?.value || '';
                    
                    console.log('🔍 DEBUG filterLogs - levelFilter:', levelFilter);
                    console.log('🔍 DEBUG filterLogs - contextFilter:', contextFilter);
                    console.log('🔍 DEBUG filterLogs - allLogs count:', window.logModalState.allLogs.length);
                    
                    let filteredLogs = window.logModalState.allLogs;
                    
                    if (levelFilter) {
                        filteredLogs = filteredLogs.filter(log => log.level === levelFilter);
                        console.log('🔍 DEBUG filterLogs - após filtro level:', filteredLogs.length);
                    }
                    
                    if (contextFilter) {
                        filteredLogs = filteredLogs.filter(log => log.context === contextFilter);
                        console.log('🔍 DEBUG filterLogs - após filtro context:', filteredLogs.length);
                    }
                    
                    window.logModalState.filteredLogs = filteredLogs;
                    window.logModalState.currentPage = 1; // Reset para primeira página
                    applyFiltersAndPagination();
                    updateFilteredStats();
                } catch (error) {
                    console.error('Erro ao filtrar logs:', error);
                }
            };

            window.clearLogFilters = function() {
                try {
                    const levelFilter = document.getElementById('system-log-level-filter');
                    const contextFilter = document.getElementById('system-log-context-filter');
                    
                    if (levelFilter) levelFilter.value = '';
                    if (contextFilter) contextFilter.value = '';
                    
                    window.logModalState.filteredLogs = window.logModalState.allLogs;
                    window.logModalState.currentPage = 1;
                    applyFiltersAndPagination();
                    updateFilteredStats();
                } catch (error) {
                    console.error('Erro ao limpar filtros:', error);
                }
            };

            window.changeLogsPerPage = function() {
                try {
                    const logsPerPageElement = document.getElementById('logs-per-page');
                    const logsPerPage = parseInt(logsPerPageElement?.value || '10');
                    window.logModalState.logsPerPage = logsPerPage;
                    window.logModalState.currentPage = 1; // Reset para primeira página
                    applyFiltersAndPagination();
                } catch (error) {
                    console.error('Erro ao alterar logs por página:', error);
                }
            };

            window.toggleLogOrder = function() {
                try {
                    window.logModalState.sortDescending = !window.logModalState.sortDescending;
                    window.logModalState.currentPage = 1; // Reset para primeira página
                    
                    // Atualizar texto do botão
                    const sortButton = document.getElementById('sort-button');
                    if (sortButton) {
                        sortButton.innerHTML = window.logModalState.sortDescending 
                            ? '📅 Mais Antigos' 
                            : '📅 Mais Recentes';
                    }
                    
                    // Reordenar logs
                    applyFiltersAndPagination();
                    
                    console.log('🔍 DEBUG toggleLogOrder - sortDescending:', window.logModalState.sortDescending);
                } catch (error) {
                    console.error('Erro ao alternar ordenação:', error);
                }
            };

            window.previousPage = function() {
                try {
                    if (window.logModalState.currentPage > 1) {
                        window.logModalState.currentPage--;
                        applyFiltersAndPagination();
                    }
                } catch (error) {
                    console.error('Erro ao navegar para página anterior:', error);
                }
            };

            window.nextPage = function() {
                try {
                    const totalPages = Math.ceil(window.logModalState.filteredLogs.length / window.logModalState.logsPerPage);
                    if (window.logModalState.currentPage < totalPages) {
                        window.logModalState.currentPage++;
                        applyFiltersAndPagination();
                    }
                } catch (error) {
                    console.error('Erro ao navegar para próxima página:', error);
                }
            };

            function applyFiltersAndPagination() {
                try {
                    const { filteredLogs, currentPage, logsPerPage, sortDescending } = window.logModalState;
                    
                    // Ordenar logs baseado na configuração
                    const sortedLogs = [...filteredLogs].sort((a, b) => {
                        const timeA = new Date(a.timestamp).getTime();
                        const timeB = new Date(b.timestamp).getTime();
                        
                        return sortDescending ? (timeB - timeA) : (timeA - timeB);
                    });
                    
                    const totalPages = Math.ceil(sortedLogs.length / logsPerPage) || 1;
                    const startIndex = (currentPage - 1) * logsPerPage;
                    const endIndex = Math.min(startIndex + logsPerPage, sortedLogs.length);
                    const pageLog = sortedLogs.slice(startIndex, endIndex);

                    // Atualizar interface
                    const logsContainer = document.getElementById('logs-container');
                    if (logsContainer) {
                        logsContainer.innerHTML = renderLogEntries(pageLog);
                    }
                    
                    // Atualizar indicadores de paginação
                    const currentPageEl = document.getElementById('current-page');
                    const totalPagesEl = document.getElementById('total-pages');
                    const showingFromEl = document.getElementById('showing-from');
                    const showingToEl = document.getElementById('showing-to');
                    const totalFilteredEl = document.getElementById('total-filtered-logs');
                    
                    if (currentPageEl) currentPageEl.textContent = currentPage;
                    if (totalPagesEl) totalPagesEl.textContent = totalPages;
                    if (showingFromEl) showingFromEl.textContent = sortedLogs.length > 0 ? startIndex + 1 : 0;
                    if (showingToEl) showingToEl.textContent = endIndex;
                    if (totalFilteredEl) totalFilteredEl.textContent = sortedLogs.length;

                    // Atualizar botões de navegação
                    const prevButton = document.getElementById('prev-page');
                    const nextButton = document.getElementById('next-page');
                    
                    if (prevButton) prevButton.disabled = currentPage <= 1;
                    if (nextButton) nextButton.disabled = currentPage >= totalPages;
                    
                    console.log('🔍 DEBUG applyFiltersAndPagination - sortDescending:', sortDescending, 'logs ordenados:', pageLog.length);
                } catch (error) {
                    console.error('Erro ao aplicar filtros e paginação:', error);
                }
            }

            function updateFilteredStats() {
                try {
                    const stats = calculateLogStats(window.logModalState.filteredLogs);
                    
                    const totalCountEl = document.getElementById('total-logs-count');
                    const errorCountEl = document.getElementById('error-count');
                    const warnCountEl = document.getElementById('warn-count');
                    const performanceCountEl = document.getElementById('performance-count');
                    const infoCountEl = document.getElementById('info-count');
                    
                    if (totalCountEl) totalCountEl.textContent = `${stats.total} logs`;
                    if (errorCountEl) errorCountEl.textContent = stats.byLevel.error || 0;
                    if (warnCountEl) warnCountEl.textContent = stats.byLevel.warn || 0;
                    if (performanceCountEl) performanceCountEl.textContent = stats.byLevel.performance || 0;
                    if (infoCountEl) infoCountEl.textContent = stats.byLevel.info || 0;
                } catch (error) {
                    console.error('Erro ao atualizar estatísticas:', error);
                }
            }
        }

        // Função para calcular estatísticas dos logs
        function calculateLogStats(logs) {
            if (!logs || !Array.isArray(logs)) {
                return {
                    total: 0,
                    byLevel: { info: 0, warn: 0, error: 0, debug: 0, performance: 0 },
                    byContext: { SYSTEM: 0 },
                    byTimeRange: { last1Hour: 0, last24Hours: 0, older: 0 }
                };
            }

            const stats = {
                total: logs.length,
                byLevel: { info: 0, warn: 0, error: 0, debug: 0, performance: 0 },
                byContext: {},
                byTimeRange: { last1Hour: 0, last24Hours: 0, older: 0 }
            };

            const now = Date.now();
            const oneHour = 60 * 60 * 1000;
            const oneDay = 24 * oneHour;

            logs.forEach(log => {
                // Contar por nível
                if (stats.byLevel.hasOwnProperty(log.level)) {
                    stats.byLevel[log.level]++;
                } else {
                    stats.byLevel[log.level] = 1;
                }

                // Contar por contexto
                const context = log.context || 'SYSTEM';
                stats.byContext[context] = (stats.byContext[context] || 0) + 1;

                // Contar por período
                const logTime = new Date(log.timestamp).getTime();
                const timeDiff = now - logTime;
                
                if (timeDiff <= oneHour) {
                    stats.byTimeRange.last1Hour++;
                } else if (timeDiff <= oneDay) {
                    stats.byTimeRange.last24Hours++;
                } else {
                    stats.byTimeRange.older++;
                }
            });

            return stats;
        }

        // Função para renderizar entradas de log
        function renderLogEntries(logs) {
            return logs.map(log => {
                const color = {
                    'error': 'border-red-500 bg-red-900/20 text-red-200',
                    'warn': 'border-yellow-500 bg-yellow-900/20 text-yellow-200',
                    'warning': 'border-yellow-500 bg-yellow-900/20 text-yellow-200',
                    'performance': 'border-purple-500 bg-purple-900/20 text-purple-200',
                    'info': 'border-blue-500 bg-blue-900/20 text-blue-200',
                    'debug': 'border-gray-500 bg-gray-900/20 text-gray-200'
                }[log.level] || 'border-gray-500 bg-gray-900/20 text-gray-200';
                
                const icon = {
                    'error': '🚨',
                    'warn': '⚠️',
                    'warning': '⚠️',
                    'performance': '⚡',
                    'info': 'ℹ️',
                    'debug': '🔍'
                }[log.level] || '📝';
                
                return `
                    <div class="p-3 rounded border-l-4 ${color}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm flex items-center">
                                ${icon} [${log.level.toUpperCase()}] [${log.context}] ${log.message}
                            </span>
                            <span class="text-xs opacity-75">${log.timestampReadable || new Date(log.timestamp).toLocaleString('pt-BR')}</span>
                        </div>
                        ${log.data && log.data !== 'null' ? `
                            <div class="text-xs opacity-75 mt-1 bg-black/30 p-2 rounded">
                                📊 <strong>Dados:</strong> ${log.data}
                            </div>
                        ` : ''}
                        ${log.stack ? `
                            <div class="text-xs opacity-75 mt-1 bg-black/30 p-2 rounded font-mono">
                                📍 <strong>Stack:</strong><br>${log.stack.split('\n').slice(0, 3).join('<br>')}
                            </div>
                        ` : ''}
                        ${log.sessionId ? `
                            <div class="text-xs opacity-50 mt-1">
                                🔗 Session: ${log.sessionId}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // === EXPOSIÇÃO GLOBAL DAS CLASSES ===
        window.FileBackupManager = FileBackupManager;
        window.CharacterManager = CharacterManager;
        window.NotificationManager = NotificationManager;
        window.HelpSystem = HelpSystem;
        window.Logger = Logger;

        // === EXPOSIÇÃO GLOBAL DAS FUNÇÕES DE GESTÃO DE FUNCIONALIDADES ===
        window.openFeatureManagerModal = openFeatureManagerModal;
        window.closeFeatureManagerModal = closeFeatureManagerModal;
        window.switchFeatureTab = switchFeatureTab;
        window.loadFeatures = loadFeatures;
        window.saveFeatures = saveFeatures;
        window.createFeature = createFeature;
        window.updateFeature = updateFeature;
        window.deleteFeature = deleteFeature;
        window.updateFeatureManagerStats = updateFeatureManagerStats;
        window.renderKanbanBoard = renderKanbanBoard;
        window.renderFeatureList = renderFeatureList;
        window.updateDashboard = updateDashboard;
        window.clearFeatureForm = clearFeatureForm;
        window.cancelFeatureEdit = cancelFeatureEdit;
        window.changeFeatureStatus = changeFeatureStatus;
        window.deleteFeatureConfirm = deleteFeatureConfirm;
        window.filterFeatureList = filterFeatureList;
        window.exportFeatures = exportFeatures;
        window.initializeExampleFeatures = initializeExampleFeatures;
        window.showMessage = showMessage;
        window.openFeatureDetailsModal = openFeatureDetailsModal;
        window.closeFeatureDetailsModal = closeFeatureDetailsModal;
        window.changeFeatureStatusFromDetails = changeFeatureStatusFromDetails;
        window.deleteFeatureFromDetails = deleteFeatureFromDetails;
        window.openStatusSelectionModal = openStatusSelectionModal;
        window.closeStatusSelectionModal = closeStatusSelectionModal;
        window.selectNewStatus = selectNewStatus;
        window.confirmStatusChange = confirmStatusChange;

        // === SISTEMA DE JANELAS ARRASTÁVEIS CENTRALIZADO ===
        let isDragging = false;
        let currentModal = null;
        let offsetX, offsetY;

        // Lista de todos os modais do sistema (auto-detectados)
        const ALL_MODALS = [
            // Modais principais do sistema
            'create-modal',
            'confirm-modal', 
            'enhancement-modal',
            'currency-converter-modal',
            'edit-spell-modal',
            'edit-talent-modal',
            'edit-equipment-modal',
            'edit-npc-modal',
            'edit-note-modal',
            'edit-historyItem-modal',
            'help-modal',
            'quick-shortcuts-modal',
            'backup-modal',
            'restore-modal',
            'spell-library-modal',
            'talent-library-modal',
            'spell-selection-modal',
            'talent-selection-modal',
            'race-library-modal',
            // Modais de funcionalidades
            'feature-manager-modal',
            'feature-details-modal',
            'status-selection-modal'
        ];

        function makeDraggable(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            // Procurar por diferentes padrões de modal content
            const modalContent = modal.querySelector('[onclick="event.stopPropagation()"]') ||
                                modal.querySelector('.modal-content') ||
                                modal.querySelector('.themed-bg-surface') ||
                                modal.querySelector('.bg-white') ||
                                modal.querySelector('div[class*="bg-"]');
            
            if (!modalContent) return;

            // Encontrar o cabeçalho do modal (vários padrões possíveis)
            const header = modalContent.querySelector('.flex.justify-between.items-center') ||
                          modalContent.querySelector('h2') ||
                          modalContent.querySelector('h3') ||
                          modalContent.querySelector('.modal-header') ||
                          modalContent.querySelector('[class*="header"]');
            
            if (header) {
                header.classList.add('modal-header');
                header.style.cursor = 'move';
                
                header.addEventListener('mousedown', function(e) {
                    // Não arrastar se clicou em botão, input, textarea, select
                    if (e.target.tagName === 'BUTTON' || 
                        e.target.tagName === 'SVG' || 
                        e.target.tagName === 'PATH' ||
                        e.target.tagName === 'INPUT' ||
                        e.target.tagName === 'TEXTAREA' ||
                        e.target.tagName === 'SELECT' ||
                        e.target.closest('button')) {
                        return;
                    }
                    
                    isDragging = true;
                    currentModal = modalContent;
                    
                    // Calcular offset baseado na posição atual do modal
                    const rect = modalContent.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    
                    // Mudar para position absolute para facilitar o movimento
                    modalContent.style.position = 'absolute';
                    modalContent.style.left = rect.left + 'px';
                    modalContent.style.top = rect.top + 'px';
                    modalContent.style.transform = 'none';
                    modalContent.style.margin = '0';
                    modalContent.style.zIndex = '9999';
                    
                    currentModal.classList.add('dragging');
                    
                    // Feedback visual no header
                    header.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
            }
        }

        // Event listeners globais para arrastar
        document.addEventListener('mousemove', function(e) {
            if (isDragging && currentModal) {
                const newX = e.clientX - offsetX;
                const newY = e.clientY - offsetY;
                
                // Limitar dentro da tela com margem de segurança
                const margin = 20;
                const maxX = window.innerWidth - currentModal.offsetWidth - margin;
                const maxY = window.innerHeight - currentModal.offsetHeight - margin;
                
                const boundedX = Math.max(margin, Math.min(newX, maxX));
                const boundedY = Math.max(margin, Math.min(newY, maxY));
                
                currentModal.style.left = boundedX + 'px';
                currentModal.style.top = boundedY + 'px';
            }
        });

        document.addEventListener('mouseup', function() {
            if (currentModal) {
                currentModal.classList.remove('dragging');
                
                // Remover feedback visual do header
                const header = currentModal.querySelector('.modal-header');
                if (header) {
                    header.style.backgroundColor = '';
                }
            }
            isDragging = false;
            currentModal = null;
        });

        function resetModalPosition(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            const modalContent = modal.querySelector('[onclick="event.stopPropagation()"]') ||
                                modal.querySelector('.modal-content') ||
                                modal.querySelector('.themed-bg-surface') ||
                                modal.querySelector('.bg-white') ||
                                modal.querySelector('div[class*="bg-"]');
            
            if (modalContent) {
                modalContent.style.position = 'fixed';
                modalContent.style.top = '50%';
                modalContent.style.left = '50%';
                modalContent.style.transform = 'translate(-50%, -50%)';
                modalContent.style.margin = '';
                modalContent.style.zIndex = '';
            }
        }

        function initializeAllDraggableModals() {
            console.log('🖱️ Inicializando sistema de janelas arrastáveis...');
            
            let initializedCount = 0;
            ALL_MODALS.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    makeDraggable(modalId);
                    initializedCount++;
                }
            });
            
            console.log(`✅ ${initializedCount} modais configurados como arrastáveis`);
        }

        // Função para detectar novos modais automaticamente
        function autoDetectModals() {
            const foundModals = [];
            document.querySelectorAll('[id*="modal"]').forEach(modal => {
                if (modal.id && !ALL_MODALS.includes(modal.id)) {
                    foundModals.push(modal.id);
                    makeDraggable(modal.id);
                }
            });
            
            if (foundModals.length > 0) {
                console.log('🔍 Novos modais detectados:', foundModals);
            }
        }

        // Inicializar quando o DOM carrega
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar sistema de janelas arrastáveis
            initializeAllDraggableModals();
            
            // Auto-detectar novos modais
            autoDetectModals();
            
            // Inicializar versões dinâmicas
            initializeVersions();
        });

        // Expor funções globalmente
        window.makeDraggable = makeDraggable;
        window.resetModalPosition = resetModalPosition;
        window.initializeAllDraggableModals = initializeAllDraggableModals;

        // === SISTEMA DE VERSÃO DINÂMICA ===
        function initializeVersions() {
            const version = CONFIG.VERSION;
            
            // Atualizar todos os elementos que exibem versão
            const versionElements = [
                'help-current-version',
                'header-version', 
                'modal-version'
            ];
            
            versionElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = version;
                }
            });
            
            console.log(`%c🚀 Sistema de Gerenciamento Tormenta RPG v${version}`, 'color: #10B981; font-weight: bold; font-size: 14px;');
        }

        // === FUNÇÕES GLOBAIS PARA BACKUP DE ARQUIVOS ===
        
        // Função para criar backup manual
        window.createFileBackup = function(reason = 'manual') {
            console.log('%c💾 Criando backup de arquivo...', 'color: #F59E0B; font-weight: bold;');
            FileBackupManager.createBackup(reason).then(result => {
                if (result) {
                    console.log('%c✅ Backup criado com sucesso!', 'color: #10B981; font-weight: bold;', result);
                } else {
                    console.log('%c❌ Erro ao criar backup!', 'color: #EF4444; font-weight: bold;');
                }
            });
        };
        
        // Função para listar backups
        window.listFileBackups = function() {
            const backups = FileBackupManager.getBackupList();
            const stats = FileBackupManager.getBackupStats();
            
            console.log('%c📋 Lista de Backups de Arquivo:', 'color: #3B82F6; font-weight: bold;');
            console.log('%c📊 Estatísticas:', 'color: #8B5CF6;', stats);
            
            if (backups.length === 0) {
                console.log('%c⚠️ Nenhum backup encontrado', 'color: #F59E0B;');
                return [];
            }
            
            backups.forEach((backup, index) => {
                console.log(`%c${index + 1}. ${backup.filename}`, 'color: #10B981;');
                console.log(`   📅 ${new Date(backup.timestamp.replace(/-/g, ':')).toLocaleString()}`);
                console.log(`   🏷️ Versão: ${backup.version} | Motivo: ${backup.reason}`);
                console.log(`   📏 Tamanho: ${(backup.size / 1024).toFixed(1)} KB`);
                console.log('');
            });
            
            return backups;
        };
        
        // Função para baixar backup
        window.downloadFileBackup = function(timestamp) {
            if (!timestamp) {
                const backups = FileBackupManager.getBackupList();
                if (backups.length === 0) {
                    console.log('%c❌ Nenhum backup disponível', 'color: #EF4444;');
                    return false;
                }
                timestamp = backups[0].timestamp; // Usar o mais recente
                console.log('%cℹ Usando backup mais recente:', 'color: #F59E0B;', timestamp);
            }
            
            console.log('%c⬇️ Baixando backup...', 'color: #3B82F6; font-weight: bold;');
            FileBackupManager.downloadBackup(timestamp);
            return true;
        };
        
        // Função para restaurar backup
        window.restoreFileBackup = function(timestamp) {
            if (!timestamp) {
                const backups = FileBackupManager.getBackupList();
                if (backups.length === 0) {
                    console.log('%c❌ Nenhum backup disponível', 'color: #EF4444;');
                    return false;
                }
                timestamp = backups[0].timestamp; // Usar o mais recente
                console.log('%cℹ Usando backup mais recente:', 'color: #F59E0B;', timestamp);
            }
            
            console.log('%c🔄 Restaurando backup...', 'color: #8B5CF6; font-weight: bold;');
            FileBackupManager.restoreBackup(timestamp);
            return true;
        };
        
        // Função para ver estatísticas de backup
        window.getFileBackupStats = function() {
            const stats = FileBackupManager.getBackupStats();
            console.log('%c📊 Estatísticas de Backup:', 'color: #3B82F6; font-weight: bold;');
            console.log(`📁 Total de backups: ${stats.count}`);
            console.log(`💽 Espaço total usado: ${stats.totalSizeMB} MB`);
            
            if (stats.newestBackup) {
                console.log(`🆕 Backup mais recente: ${stats.newestBackup.filename}`);
            }
            if (stats.oldestBackup) {
                console.log(`📜 Backup mais antigo: ${stats.oldestBackup.filename}`);
            }
            
            return stats;
        };

        // === FUNÇÕES DO MODAL DE RESTAURAÇÃO ===
        window.openRestoreModal = function() {
            const modal = document.getElementById('restore-modal');
            if (modal) {
                modal.classList.remove('hidden');
                refreshLocalBackups();
                
                // Adicionar listener para ESC
                document.addEventListener('keydown', handleRestoreModalKeydown);
                
                Logger.debug('Modal de restauração aberto');
            }
        };
        
        window.closeRestoreModal = function() {
            const modal = document.getElementById('restore-modal');
            if (modal) {
                modal.classList.add('hidden');
                
                // Limpar status e input
                updateRestoreStatus('', 'info', true);
                document.getElementById('backup-file-input').value = '';
                
                // Remover listener do ESC
                document.removeEventListener('keydown', handleRestoreModalKeydown);
                
                Logger.debug('Modal de restauração fechado');
            }
        };
        
        function handleRestoreModalKeydown(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                closeRestoreModal();
            }
        }
        
        // Função para atualizar status do modal de restauração
        function updateRestoreStatus(message, type = 'info', hide = false) {
            const statusDiv = document.getElementById('restore-status');
            const iconDiv = document.getElementById('restore-status-icon');
            const textDiv = document.getElementById('restore-status-text');
            
            if (hide || !message) {
                statusDiv.classList.add('hidden');
                return;
            }
            
            statusDiv.classList.remove('hidden');
            textDiv.textContent = message;
            
            // Atualizar ícone baseado no tipo
            const icons = {
                'info': '<span class="inline-flex items-center justify-center w-4 h-4 bg-blue-500 text-white rounded-full text-xs">ℹ</span>',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            };
            iconDiv.textContent = icons[type] || icons['info'];
        }
        
        // Função para atualizar lista de backups locais
        window.refreshLocalBackups = function() {
            const listContainer = document.getElementById('local-backups-list');
            
            try {
                const backups = FileBackupManager.getBackupList();
                
                if (backups.length === 0) {
                    listContainer.innerHTML = `
                        <div class="text-center text-gray-400 py-4">
                            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-sm">Nenhum backup local encontrado</p>
                            <p class="text-xs mt-1">Crie um backup manual primeiro</p>
                        </div>
                    `;
                    return;
                }
                
                listContainer.innerHTML = backups.map((backup, index) => {
                    // Converter timestamp string ISO para Date
                    const date = new Date(backup.timestamp.replace(/-/g, ':').replace(/T/, 'T').replace(/Z$/, ''));
                    const formattedDate = date.toLocaleString('pt-BR');
                    const timeAgo = getTimeAgo(date.getTime());
                    
                    // Calcular tamanho em MB
                    const sizeMB = backup.size ? (backup.size / (1024 * 1024)).toFixed(2) : '0.00';
                    
                    return `
                        <div class="bg-slate-600 rounded-lg p-3 border border-slate-500 hover:border-blue-400 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="text-sm font-medium text-white">${backup.filename || 'Backup sem nome'}</span>
                                        <span class="text-xs px-2 py-1 bg-blue-600 text-white rounded-full">
                                            ${backup.reason || 'manual'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-300 space-y-1">
                                        <div>📅 ${formattedDate}</div>
                                        <div>⏰ ${timeAgo}</div>
                                        <div>💾 ${sizeMB} MB</div>
                                        ${backup.version ? `<div>🏷️ v${backup.version}</div>` : ''}
                                    </div>
                                </div>
                                <button onclick="restoreLocalBackup('${backup.timestamp}')" 
                                    class="ml-3 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors"
                                    title="Restaurar este backup">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar backups locais:', error);
                listContainer.innerHTML = `
                    <div class="text-center text-red-400 py-4">
                        <p class="text-sm">❌ Erro ao carregar backups</p>
                        <p class="text-xs mt-1">${error.message}</p>
                    </div>
                `;
            }
        };
        
        // Função auxiliar para calcular tempo decorrido
        function getTimeAgo(timestamp) {
            const now = Date.now();
            
            // Converter timestamp para número se for string
            let compareTime;
            if (typeof timestamp === 'string') {
                // Se for string ISO com hífens no lugar de dois pontos, converter
                const correctedTimestamp = timestamp.replace(/-/g, ':').replace(/T/, 'T').replace(/Z$/, '');
                compareTime = new Date(correctedTimestamp).getTime();
            } else {
                compareTime = timestamp;
            }
            
            const diff = now - compareTime;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Agora mesmo';
            if (minutes < 60) return `${minutes} min atrás`;
            if (hours < 24) return `${hours}h atrás`;
            return `${days} dias atrás`;
        }
        
        // Função para restaurar backup local
        window.restoreLocalBackup = function(timestamp) {
            if (!timestamp) {
                updateRestoreStatus('❌ Timestamp inválido', 'error');
                return;
            }
            
            updateRestoreStatus('Preparando restauração...', 'info');
            
            try {
                // Buscar conteúdo do backup local
                const backupContent = FileBackupManager.getBackupContent(timestamp);
                if (!backupContent) {
                    updateRestoreStatus('❌ Backup não encontrado', 'error');
                    return;
                }
                
                // Encontrar informações do backup
                const backups = FileBackupManager.getBackupList();
                const backupInfo = backups.find(b => b.timestamp === timestamp);
                const backupName = backupInfo ? backupInfo.filename : timestamp;
                
                updateRestoreStatus('Backup encontrado. Confirme a restauração.', 'success');
                
                // Confirmar restauração
                if (confirm(`⚠️ Isso substituirá todos os dados atuais.\n\nBackup: ${backupName}\n\nContinuar?`)) {
                    updateRestoreStatus('Criando backup de segurança...', 'info');
                    
                    // Criar backup da versão atual antes de restaurar
                    FileBackupManager.createBackup('pre_restore');
                    
                    updateRestoreStatus('Processando dados do backup...', 'info');
                    
                    // Extrair dados do personagem do HTML do backup
                    const parser = new DOMParser();
                    const backupDoc = parser.parseFromString(backupContent, 'text/html');
                    
                    // Tentar extrair dados do localStorage que estava no backup
                    const scripts = backupDoc.querySelectorAll('script');
                    let characterData = null;
                    
                    for (let script of scripts) {
                        const scriptContent = script.textContent;
                        // Procurar por dados de personagem no script
                        if (scriptContent.includes('currentCharacterData') || scriptContent.includes('characterData')) {
                            try {
                                // Esta é uma abordagem simplificada - em um backup real
                                // os dados estariam estruturados de forma mais clara
                                updateRestoreStatus('❌ Formato de backup não suportado para restauração automática', 'error');
                                
                                // Oferecer alternativa
                                if (confirm('❌ Este tipo de backup não pode ser restaurado automaticamente.\n\n✅ Deseja abrir o backup em uma nova janela para verificação manual?')) {
                                    FileBackupManager.restoreBackup(timestamp);
                                    updateRestoreStatus('Backup aberto em nova janela', 'success');
                                }
                                return;
                            } catch (e) {
                                console.error('Erro ao processar backup:', e);
                            }
                        }
                    }
                    
                    updateRestoreStatus('❌ Não foi possível extrair dados do backup', 'error');
                    
                    // Oferecer abrir em nova janela como alternativa
                    if (confirm('❌ Não foi possível restaurar automaticamente.\n\n✅ Deseja abrir o backup em uma nova janela?')) {
                        FileBackupManager.restoreBackup(timestamp);
                        updateRestoreStatus('Backup aberto em nova janela', 'success');
                        
                        setTimeout(() => {
                            closeRestoreModal();
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('Erro na restauração:', error);
                updateRestoreStatus('❌ Erro na restauração: ' + error.message, 'error');
                if (window.NotificationManager) {
                    NotificationManager.show('❌ Erro na restauração: ' + error.message, 'error', 5000);
                }
            }
        };
        
        // Função para selecionar arquivo de backup
        window.selectBackupFile = function() {
            const fileInput = document.getElementById('backup-file-input');
            fileInput.click();
        };

        // === FUNÇÕES DO MODAL DE DIAGNÓSTICO ===
        window.openDiagnosticModal = function() {
            // Notificar o ModalManager para manter a pilha de modais
            if (window.ModalManager && ModalManager.currentModal) {
                ModalManager.modalStack.push(ModalManager.currentModal);
            }
            if (window.ModalManager) {
                ModalManager.currentModal = 'diagnostic-modal';
            }
            
            const modal = document.getElementById('diagnostic-modal');
            modal.classList.remove('hidden');
            // Adicionar animação de entrada
            setTimeout(() => {
                modal.querySelector('.bg-gray-900').classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeDiagnosticModal = function() {
            const modal = document.getElementById('diagnostic-modal');
            modal.classList.add('hidden');
            
            // Restaurar modal anterior se existir na pilha do ModalManager
            if (window.ModalManager && ModalManager.modalStack.length > 0) {
                ModalManager.currentModal = ModalManager.modalStack.pop();
            } else if (window.ModalManager) {
                ModalManager.currentModal = null;
            }
        };

        window.clearDiagnosticLog = function() {
            const logArea = document.getElementById('diagnostic-log-area');
            logArea.innerHTML = '<div class="text-gray-400 text-center py-8">Log limpo. Clique em "Executar Diagnóstico" para iniciar uma nova análise...</div>';
        };

        window.appendDiagnosticLog = function(message, type = 'info') {
            const logArea = document.getElementById('diagnostic-log-area');
            
            // Limpar mensagem inicial se existir
            if (logArea.querySelector('.text-center')) {
                logArea.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2';
            
            let colorClass = 'text-gray-300';
            switch (type) {
                case 'header':
                    colorClass = 'text-yellow-400 font-bold text-lg';
                    break;
                case 'section':
                    colorClass = 'text-blue-400 font-bold';
                    break;
                case 'success':
                    colorClass = 'text-green-400';
                    break;
                case 'error':
                    colorClass = 'text-red-400';
                    break;
                case 'warning':
                    colorClass = 'text-yellow-300';
                    break;
                case 'info':
                    colorClass = 'text-gray-300';
                    break;
            }
            
            logEntry.innerHTML = `<span class="${colorClass}">${message}</span>`;
            logArea.appendChild(logEntry);
            
            // Auto-scroll para o final
            logArea.scrollTop = logArea.scrollHeight;
        };

        window.runDiagnostic = function() {
            try {
                // Limpar log anterior
                clearDiagnosticLog();
                
                appendDiagnosticLog('🔍 DIAGNÓSTICO DOS SISTEMAS DE BACKUP', 'header');
                appendDiagnosticLog('=========================================', 'info');
                
                // Sistema 1: character_backups (antigo)
                appendDiagnosticLog('📋 Sistema Antigo (character_backups):', 'section');
                try {
                    const oldBackups = localStorage.getItem('character_backups');
                    if (oldBackups) {
                        const parsed = JSON.parse(oldBackups);
                        appendDiagnosticLog(`   Backups encontrados: ${parsed.length}`, 'success');
                        parsed.forEach((backup, i) => {
                            const size = backup.data ? JSON.stringify(backup.data).length : 0;
                            appendDiagnosticLog(`   ${i+1}. ${backup.name} - ${size} bytes`, 'info');
                        });
                    } else {
                        appendDiagnosticLog('   Nenhum backup encontrado', 'warning');
                    }
                } catch (e) {
                    appendDiagnosticLog(`   Erro ao ler: ${e.message}`, 'error');
                }
                
                // Sistema 2: file_backup_list (novo)
                appendDiagnosticLog('💾 Sistema Novo (FileBackupManager):', 'section');
                try {
                    const newBackups = FileBackupManager.getBackupList();
                    appendDiagnosticLog(`   Backups encontrados: ${newBackups.length}`, 'success');
                    newBackups.forEach((backup, i) => {
                        appendDiagnosticLog(`   ${i+1}. ${backup.filename} - ${backup.size} bytes`, 'info');
                    });
                } catch (e) {
                    appendDiagnosticLog(`   Erro ao ler: ${e.message}`, 'error');
                }
                
                // Verificar conteúdo dos backups do FileBackupManager
                appendDiagnosticLog('🔍 Verificando conteúdo dos backups do FileBackupManager:', 'section');
                try {
                    const newBackups = FileBackupManager.getBackupList();
                    newBackups.forEach((backup, i) => {
                        const content = FileBackupManager.getBackupContent(backup.timestamp);
                        appendDiagnosticLog(`   ${i+1}. ${backup.filename}:`, 'info');
                        appendDiagnosticLog(`      Conteúdo existe: ${content ? 'SIM' : 'NÃO'}`, content ? 'success' : 'warning');
                        appendDiagnosticLog(`      Tamanho real: ${content ? content.length : 0} bytes`, 'info');
                    });
                } catch (e) {
                    appendDiagnosticLog(`   Erro ao verificar conteúdo: ${e.message}`, 'error');
                }
                
                // Análise de integridade
                appendDiagnosticLog('🔧 Análise de Integridade:', 'section');
                try {
                    const totalStorage = JSON.stringify(localStorage).length;
                    appendDiagnosticLog(`   Uso total do localStorage: ${totalStorage} bytes`, 'info');
                    
                    const oldSystem = JSON.parse(localStorage.getItem('character_backups') || '[]');
                    const newSystem = FileBackupManager.getBackupList();
                    
                    if (oldSystem.length > 0 && newSystem.length === 0) {
                        appendDiagnosticLog('   ⚠️ Migração de backup necessária!', 'warning');
                    } else if (newSystem.length > 0) {
                        appendDiagnosticLog('   ✅ Sistema de backup atualizado funcionando', 'success');
                    } else {
                        appendDiagnosticLog('   ⚠️ Nenhum backup encontrado em nenhum sistema', 'warning');
                    }
                } catch (e) {
                    appendDiagnosticLog(`   Erro na análise: ${e.message}`, 'error');
                }
                
                appendDiagnosticLog('=========================================', 'info');
                appendDiagnosticLog('✅ Diagnóstico concluído!', 'success');
                
            } catch (error) {
                appendDiagnosticLog(`❌ Erro no diagnóstico: ${error.message}`, 'error');
            }
        };

        // === SISTEMA CENTRALIZADO DE FECHAMENTO COM ESC ===
        window.GlobalModalManager = {
            // Mapeamento de todos os modais e suas funções de fechamento
            modalMap: {
                // Modais principais do sistema
                'help-modal': () => closeModal('help-modal'),
                'diagnostic-modal': () => closeDiagnosticModal(),
                'quick-shortcuts-modal': () => closeQuickShortcutsModal(),
                'race-library-modal': () => closeRaceLibraryModal(),
                'backup-modal': () => closeBackupModal(),
                'restore-modal': () => closeRestoreModal(),
                'feature-manager-modal': () => closeFeatureManagerModal(),
                
                // Modais de edição usando closeModal genérico
                'create-modal': () => closeModal('create-modal'),
                'confirm-modal': () => closeModal('confirm-modal'),
                'enhancement-modal': () => closeModal('enhancement-modal'),
                'currency-converter-modal': () => closeModal('currency-converter-modal'),
                'edit-spell-modal': () => closeModal('edit-spell-modal'),
                'edit-talent-modal': () => closeModal('edit-talent-modal'),
                'edit-equipment-modal': () => closeModal('edit-equipment-modal'),
                'edit-npc-modal': () => closeModal('edit-npc-modal'),
                'edit-note-modal': () => closeModal('edit-note-modal'),
                'edit-historyItem-modal': () => closeModal('edit-historyItem-modal'),
                
                // Modais de biblioteca e seleção
                'spell-library-modal': () => closeSpellLibraryModal(),
                'talent-library-modal': () => closeTalentLibraryModal(),
                'spell-selection-modal': () => closeSpellSelectionModal(),
                'talent-selection-modal': () => closeTalentSelectionModal(),
                
                // Modais usando ModalManager
                'character-selection-modal': () => ModalManager && ModalManager.close ? ModalManager.close('character-selection-modal') : null,
                
                // Modais de funcionalidades (fallback para modais não mapeados)
                'feature-modal': () => FeatureModal && FeatureModal.close ? FeatureModal.close() : null,
                'feature-details-modal': () => window.closeFeatureDetailsModal ? closeFeatureDetailsModal() : null,
                'version-modal': () => window.closeVersionModal ? closeVersionModal() : null,
                'delete-character-modal': () => window.closeDeleteCharacterModal ? closeDeleteCharacterModal() : null,
                'character-info-modal': () => window.closeCharacterInfoModal ? closeCharacterInfoModal() : null,
                'notes-modal': () => window.closeNotesModal ? closeNotesModal() : null,
                'combat-notes-modal': () => window.closeCombatNotesModal ? closeCombatNotesModal() : null,
                'general-notes-modal': () => window.closeGeneralNotesModal ? closeGeneralNotesModal() : null,
                'equipment-modal': () => window.closeEquipmentModal ? closeEquipmentModal() : null,
                'spell-modal': () => window.closeSpellModal ? closeSpellModal() : null,
                'talent-modal': () => window.closeTalentModal ? closeTalentModal() : null,
                'companion-modal': () => window.closeCompanionModal ? closeCompanionModal() : null,
                'skill-modal': () => window.closeSkillModal ? closeSkillModal() : null,
                'inventory-modal': () => window.closeInventoryModal ? closeInventoryModal() : null,
                'attribute-modal': () => window.closeAttributeModal ? closeAttributeModal() : null,
                'class-modal': () => window.closeClassModal ? closeClassModal() : null,
                'origin-modal': () => window.closeOriginModal ? closeOriginModal() : null,
                'deity-modal': () => window.closeDeityModal ? closeDeityModal() : null,
                'import-modal': () => window.closeImportModal ? closeImportModal() : null,
                'export-modal': () => window.closeExportModal ? closeExportModal() : null
            },

            // Verifica qual modal está visível e o fecha
            handleGlobalEscape() {
                // PRIORIDADE: Usar ModalManager se disponível (gerencia pilha corretamente)
                if (window.ModalManager && ModalManager.currentModal) {
                    try {
                        ModalManager.close(); // Fecha o modal atual respeitando a pilha
                        return true;
                    } catch (error) {
                        console.warn('Erro ao fechar via ModalManager:', error);
                        // Continuar para fallback
                    }
                }

                // FALLBACK: Sistema de mapeamento direto para modais não gerenciados pelo ModalManager
                const visibleModals = [];
                
                // Identificar todos os modais visíveis e suas prioridades
                for (const [modalId, closeFunction] of Object.entries(this.modalMap)) {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        const zIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
                        visibleModals.push({ modalId, closeFunction, zIndex, modal });
                    }
                }

                // Se houver modais visíveis, fechar o de maior z-index (mais "em cima")
                if (visibleModals.length > 0) {
                    // Ordenar por z-index decrescente (maior primeiro)
                    visibleModals.sort((a, b) => b.zIndex - a.zIndex);
                    
                    const modalToClose = visibleModals[0];
                    try {
                        if (modalToClose.closeFunction && typeof modalToClose.closeFunction === 'function') {
                            modalToClose.closeFunction();
                            return true;
                        }
                    } catch (error) {
                        console.warn(`Erro ao fechar modal ${modalToClose.modalId}:`, error);
                        // Tentar fallback para este modal específico
                        this.fallbackCloseModal(modalToClose.modal, modalToClose.modalId);
                        return true;
                    }
                }

                // ÚLTIMO RECURSO: Buscar qualquer modal visível genérico
                const allModals = document.querySelectorAll('[id$="-modal"]');
                const visibleGenericModals = [];
                
                for (const modal of allModals) {
                    if (!modal.classList.contains('hidden')) {
                        const zIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
                        visibleGenericModals.push({ modal, zIndex });
                    }
                }
                
                if (visibleGenericModals.length > 0) {
                    // Fechar o modal com maior z-index
                    visibleGenericModals.sort((a, b) => b.zIndex - a.zIndex);
                    this.fallbackCloseModal(visibleGenericModals[0].modal, visibleGenericModals[0].modal.id);
                    return true;
                }
                
                return false; // Nenhum modal foi fechado
            },

            // Função de fallback para fechar modais
            fallbackCloseModal(modal, modalId) {
                // 1. Tentar usar closeModal genérico
                if (typeof window.closeModal === 'function') {
                    try {
                        window.closeModal(modalId);
                        return true;
                    } catch (error) {
                        console.warn(`Fallback closeModal falhou para ${modalId}:`, error);
                    }
                }

                // 2. Tentar clicar no botão de fechar (×) se existir
                const closeButton = modal.querySelector('button[onclick*="close"], button[onclick*="Close"], .close-button, [data-close]');
                if (closeButton) {
                    try {
                        closeButton.click();
                        return true;
                    } catch (error) {
                        console.warn(`Fallback click falhou para ${modalId}:`, error);
                    }
                }
                
                // 3. Último recurso: ocultar diretamente
                try {
                    modal.classList.add('hidden');
                    console.log(`Modal ${modalId} fechado via fallback direto`);
                    return true;
                } catch (error) {
                    console.error(`Todos os fallbacks falharam para ${modalId}:`, error);
                    return false;
                }
            },

            // Inicializar o sistema
            init() {
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        this.handleGlobalEscape();
                    }
                });
                console.log('🔐 Sistema de ESC global inicializado para todos os modais');
            }
        };

        // === FUNÇÃO DE DIAGNÓSTICO DE BACKUP (MODIFICADA) ===
        window.diagnoseBackupSystems = function() {
            // Abrir o modal de diagnóstico ao invés de usar console/alert
            openDiagnosticModal();
            // Executar o diagnóstico automaticamente após abrir o modal
            setTimeout(() => {
                runDiagnostic();
            }, 100);
        };

        // --- INICIALIZAÇÃO APRIMORADA ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar sistema de ESC global
            GlobalModalManager.init();
            
            AppInitializer.init().then(() => {
                window.showCharacterList();
                // Atualizar textos dinâmicos da ajuda na inicialização
                HelpSystem.updateDynamicHelpTexts();
                // Atualizar versão em todos os elementos
                VersionManager.updateVersionElements();
                
                // Inicializar bibliotecas
                initializeTalentLibrary();
                initializeRaceLibrary();
                initializeItemLibrary();
                initializeItemLibrary();
                
                // Popular dropdown de raças após inicialização
                populateRaceDropdown();
                
                // Criar backup inicial se não existir
                setTimeout(() => {
                    const backups = getBackupList();
                    if (backups.length === 0) {
                        console.log('🔄 Criando backup inicial do sistema...');
                        try {
                            const currentData = getCurrentCharacterData();
                            const timestamp = new Date().toISOString();
                            const backupData = {
                                name: `initial_system_backup_${timestamp.slice(0, 19).replace(/:/g, '-')}`,
                                timestamp: timestamp,
                                data: currentData,
                                type: 'automatic'
                            };
                            localStorage.setItem('character_backups', JSON.stringify([backupData]));
                            console.log('✅ Backup inicial criado com sucesso');
                        } catch (error) {
                            console.error('❌ Erro ao criar backup inicial:', error);
                        }
                    }
                }, 2000);
            });
        });

        // Sistema de Gestão de Funcionalidades - Funções Globais
        const FEATURE_STATUSES = ['Backlog', 'Em Análise', 'Aprovada', 'Planejada', 'Em Desenvolvimento', 'Em Testes', 'Implementada', 'Rejeitada', 'Em Espera', 'Cancelada'];
        const STATUS_COLORS = {
            'Backlog': 'bg-gray-500',
            'Em Análise': 'bg-yellow-500',
            'Aprovada': 'bg-blue-500', 
            'Planejada': 'bg-purple-500',
            'Em Desenvolvimento': 'bg-orange-500',
            'Em Testes': 'bg-indigo-500',
            'Implementada': 'bg-green-500',
            'Rejeitada': 'bg-red-500',
            'Em Espera': 'bg-gray-400',
            'Cancelada': 'bg-red-800'
        };

        function openFeatureManagerModal(tab = 'kanban') {
            // Notificar o ModalManager para manter a pilha de modais
            if (window.ModalManager && ModalManager.currentModal) {
                ModalManager.modalStack.push(ModalManager.currentModal);
            }
            if (window.ModalManager) {
                ModalManager.currentModal = 'feature-manager-modal';
            }
            
            document.getElementById('feature-manager-modal').classList.remove('hidden');
            initializeExampleFeatures(); // Inicializar dados de exemplo se necessário
            loadFeatures();
            updateFeatureManagerStats();
            renderKanbanBoard();
            updateDashboard();
            
            // Trocar para a aba especificada
            if (tab) {
                switchFeatureTab(tab);
            }
        }

        function closeFeatureManagerModal() {
            document.getElementById('feature-manager-modal').classList.add('hidden');
            
            // Restaurar modal anterior se existir na pilha do ModalManager
            if (window.ModalManager && ModalManager.modalStack.length > 0) {
                ModalManager.currentModal = ModalManager.modalStack.pop();
            } else if (window.ModalManager) {
                ModalManager.currentModal = null;
            }
        }

        function switchFeatureTab(tab) {
            // Atualizar botões
            document.querySelectorAll('[id^="feature-tab-"]').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-400', 'hover:text-white');
            });
            document.getElementById(`feature-tab-${tab}`).classList.add('bg-blue-600', 'text-white');
            document.getElementById(`feature-tab-${tab}`).classList.remove('text-gray-400', 'hover:text-white');

            // Mostrar conteúdo correto
            document.querySelectorAll('.feature-tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`feature-content-${tab}`).classList.remove('hidden');

            // Atualizar conteúdo específico
            if (tab === 'kanban') renderKanbanBoard();
            if (tab === 'list') renderFeatureList();
            if (tab === 'dashboard') updateDashboard();
        }

        function loadFeatures() {
            const features = JSON.parse(localStorage.getItem('features') || '[]');
            return features;
        }

        function saveFeatures(features) {
            localStorage.setItem('features', JSON.stringify(features));
            updateFeatureManagerStats();
        }

        function generateFeatureId() {
            return 'feat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }

        function createFeature(featureData) {
            const features = loadFeatures();
            const newFeature = {
                id: generateFeatureId(),
                title: featureData.title,
                description: featureData.description,
                priority: featureData.priority || 'Média',
                category: featureData.category || 'Feature',
                module: featureData.module || 'Geral',
                effort: featureData.effort || 'Médio',
                author: featureData.author || 'Sistema',
                notes: featureData.notes || '',
                status: 'Backlog',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            features.push(newFeature);
            saveFeatures(features);
            return newFeature;
        }

        function updateFeature(featureId, updates) {
            const features = loadFeatures();
            const index = features.findIndex(f => f.id === featureId);
            if (index !== -1) {
                features[index] = { ...features[index], ...updates, updatedAt: new Date().toISOString() };
                saveFeatures(features);
                return features[index];
            }
            return null;
        }

        function deleteFeature(featureId) {
            const features = loadFeatures();
            const filteredFeatures = features.filter(f => f.id !== featureId);
            saveFeatures(filteredFeatures);
        }

        function updateFeatureManagerStats() {
            const features = loadFeatures();
            const totalFeatures = features.length;
            const implementedFeatures = features.filter(f => f.status === 'Implementada').length;
            const inDevelopmentFeatures = features.filter(f => f.status === 'Em Desenvolvimento').length;
            const backlogFeatures = features.filter(f => f.status === 'Backlog').length;
            const analysisFeatures = features.filter(f => f.status === 'Em Análise').length;
            const approvedFeatures = features.filter(f => f.status === 'Aprovada').length;

            // Atualizar elementos na central de ajuda
            const totalEl = document.getElementById('feature-stats-total');
            const implementedEl = document.getElementById('feature-stats-implemented');
            const developmentEl = document.getElementById('feature-stats-development');
            const backlogEl = document.getElementById('feature-stats-backlog');
            const analysisEl = document.getElementById('feature-stats-analysis');
            const approvedEl = document.getElementById('feature-stats-approved');

            if (totalEl) totalEl.textContent = totalFeatures;
            if (implementedEl) implementedEl.textContent = implementedFeatures;
            if (developmentEl) developmentEl.textContent = inDevelopmentFeatures;
            if (backlogEl) backlogEl.textContent = backlogFeatures;
            if (analysisEl) analysisEl.textContent = analysisFeatures;
            if (approvedEl) approvedEl.textContent = approvedFeatures;
        }

        function renderKanbanBoard() {
            const features = loadFeatures();
            
            // Limpar colunas
            document.querySelectorAll('[id^="kanban-"]').forEach(col => {
                if (col.id.includes('-count')) return;
                col.innerHTML = '';
            });

            // Renderizar features em cada coluna
            const kanbanStatuses = ['backlog', 'analysis', 'approved', 'development', 'implemented'];
            const statusMapping = {
                'backlog': 'Backlog',
                'analysis': 'Em Análise', 
                'approved': 'Aprovada',
                'development': 'Em Desenvolvimento',
                'implemented': 'Implementada'
            };

            kanbanStatuses.forEach(status => {
                const statusName = statusMapping[status];
                const statusFeatures = features.filter(f => f.status === statusName);
                const container = document.getElementById(`kanban-${status}`);
                const countElement = document.getElementById(`kanban-${status}-count`);
                
                if (countElement) countElement.textContent = statusFeatures.length;
                
                if (container) {
                    statusFeatures.forEach(feature => {
                        const card = createFeatureCard(feature);
                        container.appendChild(card);
                    });
                }
            });
        }

        function createFeatureCard(feature) {
            const card = document.createElement('div');
            card.className = 'bg-gray-700 p-3 rounded border-l-4 cursor-pointer hover:bg-gray-600 transition-colors';
            card.classList.add(STATUS_COLORS[feature.status].replace('bg-', 'border-l-'));
            
            // Adicionar evento de clique no card para abrir detalhes
            card.addEventListener('click', function(e) {
                // Não abrir detalhes se clicou em um botão de ação
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                openFeatureDetailsModal(feature.id);
            });
            
            const priorityIcon = {
                'Crítica': '🔴',
                'Alta': '🟠', 
                'Média': '🟡',
                'Baixa': '🟢'
            }[feature.priority] || '⚪';

            card.innerHTML = `
                <div class="text-sm font-medium text-white mb-1 line-clamp-2">${feature.title}</div>
                <div class="text-xs text-gray-300 mb-2 line-clamp-2">${feature.description}</div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-gray-400">${priorityIcon} ${feature.priority}</span>
                    <span class="text-gray-400">${feature.category}</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-gray-400">${feature.author}</span>
                    <div class="flex gap-1">
                        <button onclick="event.stopPropagation(); editFeature('${feature.id}')" class="text-blue-400 hover:text-blue-300 text-xs" title="Editar">
                            ✏️
                        </button>
                        <button onclick="event.stopPropagation(); changeFeatureStatus('${feature.id}')" class="text-green-400 hover:text-green-300 text-xs" title="Alterar Status">
                            🔄
                        </button>
                        <button onclick="event.stopPropagation(); deleteFeatureConfirm('${feature.id}')" class="text-red-400 hover:text-red-300 text-xs" title="Excluir">
                            🗑️
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function renderFeatureList() {
            const features = loadFeatures();
            const container = document.getElementById('feature-list-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-lg border-l-4 cursor-pointer hover:bg-gray-700 transition-colors ' + STATUS_COLORS[feature.status].replace('bg-', 'border-l-');
                
                // Adicionar evento de clique no item da lista
                item.addEventListener('click', function(e) {
                    // Não abrir detalhes se clicou em um botão de ação
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return;
                    }
                    openFeatureDetailsModal(feature.id);
                });
                
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-medium text-white">${feature.title}</h5>
                        <span class="text-xs px-2 py-1 rounded ${STATUS_COLORS[feature.status]} text-white">
                            ${feature.status}
                        </span>
                    </div>
                    <p class="text-gray-300 text-sm mb-3">${feature.description}</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-gray-400 mb-3">
                        <div><strong>Prioridade:</strong> ${feature.priority}</div>
                        <div><strong>Categoria:</strong> ${feature.category}</div>
                        <div><strong>Módulo:</strong> ${feature.module}</div>
                        <div><strong>Esforço:</strong> ${feature.effort}</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-400">Por: ${feature.author}</span>
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); editFeature('${feature.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700" title="Editar">
                                Editar
                            </button>
                            <button onclick="event.stopPropagation(); changeFeatureStatus('${feature.id}')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700" title="Alterar Status">
                                Status
                            </button>
                            <button onclick="event.stopPropagation(); deleteFeatureConfirm('${feature.id}')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700" title="Excluir">
                                Excluir
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function updateDashboard() {
            const features = loadFeatures();
            
            // Métricas gerais
            const totalEl = document.getElementById('dashboard-total');
            const implementedEl = document.getElementById('dashboard-implemented');
            const developmentEl = document.getElementById('dashboard-development');
            const completionRateEl = document.getElementById('dashboard-completion-rate');
            
            if (totalEl) totalEl.textContent = features.length;
            if (implementedEl) implementedEl.textContent = features.filter(f => f.status === 'Implementada').length;
            if (developmentEl) developmentEl.textContent = features.filter(f => f.status === 'Em Desenvolvimento').length;
            
            const completionRate = features.length > 0 ? 
                Math.round((features.filter(f => f.status === 'Implementada').length / features.length) * 100) : 0;
            if (completionRateEl) completionRateEl.textContent = completionRate + '%';
            
            // Por prioridade
            const criticalEl = document.getElementById('dashboard-critical');
            const highEl = document.getElementById('dashboard-high');
            const mediumEl = document.getElementById('dashboard-medium');
            const lowEl = document.getElementById('dashboard-low');
            
            if (criticalEl) criticalEl.textContent = features.filter(f => f.priority === 'Crítica').length;
            if (highEl) highEl.textContent = features.filter(f => f.priority === 'Alta').length;
            if (mediumEl) mediumEl.textContent = features.filter(f => f.priority === 'Média').length;
            if (lowEl) lowEl.textContent = features.filter(f => f.priority === 'Baixa').length;
            
            // Por categoria
            const categoryCounts = {};
            features.forEach(f => {
                categoryCounts[f.category] = (categoryCounts[f.category] || 0) + 1;
            });
            
            const categoriesContainer = document.getElementById('dashboard-categories');
            if (categoriesContainer) {
                categoriesContainer.innerHTML = '';
                Object.entries(categoryCounts).forEach(([category, count]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between';
                    div.innerHTML = `<span>${category}:</span><span class="font-mono">${count}</span>`;
                    categoriesContainer.appendChild(div);
                });
            }
            
            // Funcionalidades recentes
            const recentFeatures = features
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .slice(0, 5);
            
            const recentContainer = document.getElementById('dashboard-recent');
            if (recentContainer) {
                recentContainer.innerHTML = '';
                recentFeatures.forEach(feature => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1 border-b border-gray-700';
                    div.innerHTML = `
                        <span class="text-sm">${feature.title}</span>
                        <span class="text-xs px-2 py-1 rounded ${STATUS_COLORS[feature.status]} text-white">
                            ${feature.status}
                        </span>
                    `;
                    recentContainer.appendChild(div);
                });
            }
        }

        function clearFeatureForm() {
            const form = document.getElementById('feature-form');
            if (form) {
                form.reset();
                const authorEl = document.getElementById('feature-author');
                const priorityEl = document.getElementById('feature-priority');
                const effortEl = document.getElementById('feature-effort');
                
                if (authorEl) authorEl.value = 'Sorentto';
                if (priorityEl) priorityEl.value = 'Média';
                if (effortEl) effortEl.value = 'Médio';
            }
        }

        function editFeature(featureId) {
            const features = loadFeatures();
            const feature = features.find(f => f.id === featureId);
            if (!feature) return;
            
            // Preencher formulário
            const titleEl = document.getElementById('feature-title');
            const descEl = document.getElementById('feature-description');
            const priorityEl = document.getElementById('feature-priority');
            const categoryEl = document.getElementById('feature-category');
            const moduleEl = document.getElementById('feature-module');
            const effortEl = document.getElementById('feature-effort');
            const authorEl = document.getElementById('feature-author');
            const notesEl = document.getElementById('feature-notes');
            
            if (titleEl) titleEl.value = feature.title;
            if (descEl) descEl.value = feature.description;
            if (priorityEl) priorityEl.value = feature.priority;
            if (categoryEl) categoryEl.value = feature.category;
            if (moduleEl) moduleEl.value = feature.module;
            if (effortEl) effortEl.value = feature.effort;
            if (authorEl) authorEl.value = feature.author;
            if (notesEl) notesEl.value = feature.notes;
            
            // Configurar modo de edição
            const form = document.getElementById('feature-form');
            const formTitle = document.getElementById('feature-form-title');
            const submitBtn = document.getElementById('feature-submit-btn');
            const cancelEdit = document.getElementById('feature-cancel-edit');
            
            if (form) form.dataset.editingId = featureId;
            if (formTitle) formTitle.textContent = '✏️ Editar Funcionalidade';
            if (submitBtn) submitBtn.textContent = 'Atualizar Funcionalidade';
            if (cancelEdit) cancelEdit.classList.remove('hidden');
            
            // Abrir modal e ir para aba de adicionar
            openFeatureManagerModal('add');
        }

        // Expor função editFeature globalmente
        window.editFeature = editFeature;

        function cancelFeatureEdit() {
            const form = document.getElementById('feature-form');
            const formTitle = document.getElementById('feature-form-title');
            const submitBtn = document.getElementById('feature-submit-btn');
            const cancelEdit = document.getElementById('feature-cancel-edit');
            
            if (form) delete form.dataset.editingId;
            if (formTitle) formTitle.textContent = '➕ Adicionar Nova Funcionalidade';
            if (submitBtn) submitBtn.textContent = 'Adicionar Funcionalidade';
            if (cancelEdit) cancelEdit.classList.add('hidden');
            
            clearFeatureForm();
        }

        function changeFeatureStatus(featureId) {
            openStatusSelectionModal(featureId);
        }

        function deleteFeatureConfirm(featureId) {
            const features = loadFeatures();
            const feature = features.find(f => f.id === featureId);
            if (!feature) return;
            
            if (confirm(`Tem certeza que deseja excluir a funcionalidade:\n"${feature.title}"?`)) {
                deleteFeature(featureId);
                renderKanbanBoard();
                renderFeatureList();
                updateDashboard();
                showMessage('Funcionalidade excluída com sucesso!');
            }
        }

        function filterFeatureList() {
            const searchTerm = document.getElementById('feature-search')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('feature-filter-status')?.value || '';
            const priorityFilter = document.getElementById('feature-filter-priority')?.value || '';
            
            const features = loadFeatures();
            const filteredFeatures = features.filter(feature => {
                const matchesSearch = feature.title.toLowerCase().includes(searchTerm) || 
                                    feature.description.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || feature.status === statusFilter;
                const matchesPriority = !priorityFilter || feature.priority === priorityFilter;
                
                return matchesSearch && matchesStatus && matchesPriority;
            });
            
            // Renderizar lista filtrada
            const container = document.getElementById('feature-list-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            filteredFeatures.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-lg border-l-4 ' + STATUS_COLORS[feature.status].replace('bg-', 'border-l-');
                
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-medium text-white">${feature.title}</h5>
                        <span class="text-xs px-2 py-1 rounded ${STATUS_COLORS[feature.status]} text-white">
                            ${feature.status}
                        </span>
                    </div>
                    <p class="text-gray-300 text-sm mb-3">${feature.description}</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-gray-400 mb-3">
                        <div><strong>Prioridade:</strong> ${feature.priority}</div>
                        <div><strong>Categoria:</strong> ${feature.category}</div>
                        <div><strong>Módulo:</strong> ${feature.module}</div>
                        <div><strong>Esforço:</strong> ${feature.effort}</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-400">Por: ${feature.author}</span>
                        <div class="flex gap-2">
                            <button onclick="editFeature('${feature.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                Editar
                            </button>
                            <button onclick="changeFeatureStatus('${feature.id}')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                Status
                            </button>
                            <button onclick="deleteFeatureConfirm('${feature.id}')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                Excluir
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
            
            if (filteredFeatures.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhuma funcionalidade encontrada com os filtros aplicados.</div>';
            }
        }

        function exportFeatures() {
            const features = loadFeatures();
            const dataStr = JSON.stringify(features, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'funcionalidades_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            
            showMessage('Funcionalidades exportadas com sucesso!');
        }

        // Inicializar dados de exemplo (apenas na primeira vez)
        function initializeExampleFeatures() {
            const features = loadFeatures();
            if (features.length === 0) {
                const exampleFeatures = [
                    {
                        id: generateFeatureId(),
                        title: 'Sistema de Gestão de Funcionalidades',
                        description: 'Implementar um sistema completo para gerenciar o desenvolvimento de novas funcionalidades com Kanban board.',
                        priority: 'Alta',
                        category: 'Feature',
                        module: 'Geral',
                        effort: 'Grande',
                        author: 'Sorentto',
                        notes: 'Feature solicitada pelo usuário para controlar o desenvolvimento.',
                        status: 'Implementada',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: generateFeatureId(),
                        title: 'Biblioteca de Raças',
                        description: 'Sistema para cadastrar e gerenciar raças de personagens com modificadores de atributos.',
                        priority: 'Alta',
                        category: 'Feature',
                        module: 'Bibliotecas',
                        effort: 'Grande',
                        author: 'Sorentto',
                        notes: 'Implementada com sucesso, incluindo 8 raças pré-cadastradas.',
                        status: 'Implementada',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: generateFeatureId(),
                        title: 'Melhorar Performance Mobile',
                        description: 'Otimizar o carregamento e responsividade do sistema em dispositivos móveis.',
                        priority: 'Média',
                        category: 'Performance',
                        module: 'Mobile',
                        effort: 'Médio',
                        author: 'Sorentto',
                        notes: 'Necessário revisar CSS e JavaScript para dispositivos menores.',
                        status: 'Backlog',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                saveFeatures(exampleFeatures);
            }
        }

        // Função auxiliar para mostrar mensagens usando o NotificationManager
        function showMessage(message, type = 'success') {
            if (window.NotificationManager) {
                NotificationManager.show(message, type);
            } else {
                alert(message);
            }
        }

        // Funções para o Modal de Detalhes da Funcionalidade
        let currentFeatureId = null;

        function openFeatureDetailsModal(featureId) {
            const features = loadFeatures();
            const feature = features.find(f => f.id === featureId);
            if (!feature) return;

            currentFeatureId = featureId;

            // Preencher os dados no modal
            document.getElementById('feature-details-title').textContent = 'Detalhes da Funcionalidade';
            document.getElementById('feature-details-name').textContent = feature.title;
            document.getElementById('feature-details-description').textContent = feature.description;
            document.getElementById('feature-details-category').textContent = feature.category;
            document.getElementById('feature-details-module').textContent = feature.module;
            document.getElementById('feature-details-effort').textContent = feature.effort;
            document.getElementById('feature-details-author').textContent = feature.author;

            // Formatar datas
            const createdDate = new Date(feature.createdAt).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const updatedDate = new Date(feature.updatedAt).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('feature-details-created').textContent = createdDate;
            document.getElementById('feature-details-updated').textContent = updatedDate;

            // Status com cores
            const statusElement = document.getElementById('feature-details-status');
            statusElement.textContent = feature.status;
            statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${STATUS_COLORS[feature.status]} text-white`;

            // Prioridade com cores
            const priorityElement = document.getElementById('feature-details-priority');
            const priorityColors = {
                'Crítica': 'bg-red-500',
                'Alta': 'bg-orange-500',
                'Média': 'bg-yellow-500',
                'Baixa': 'bg-green-500'
            };
            const priorityIcons = {
                'Crítica': '🔴',
                'Alta': '🟠',
                'Média': '🟡',
                'Baixa': '🟢'
            };
            priorityElement.textContent = `${priorityIcons[feature.priority]} ${feature.priority}`;
            priorityElement.className = `px-3 py-1 rounded-full text-sm font-medium ${priorityColors[feature.priority]} text-white`;

            // Observações
            const notesSection = document.getElementById('feature-details-notes-section');
            const notesElement = document.getElementById('feature-details-notes');
            if (feature.notes && feature.notes.trim()) {
                notesElement.textContent = feature.notes;
                notesSection.style.display = 'block';
            } else {
                notesElement.textContent = 'Nenhuma observação adicional.';
                notesSection.style.display = 'block';
            }

            // Mostrar o modal
            // Notificar o ModalManager para manter a pilha de modais
            if (window.ModalManager && ModalManager.currentModal) {
                ModalManager.modalStack.push(ModalManager.currentModal);
            }
            if (window.ModalManager) {
                ModalManager.currentModal = 'feature-details-modal';
            }
            
            document.getElementById('feature-details-modal').classList.remove('hidden');
        }

        function closeFeatureDetailsModal() {
            document.getElementById('feature-details-modal').classList.add('hidden');
            currentFeatureId = null;
            
            // Restaurar modal anterior se existir na pilha do ModalManager
            if (window.ModalManager && ModalManager.modalStack.length > 0) {
                ModalManager.currentModal = ModalManager.modalStack.pop();
            } else if (window.ModalManager) {
                ModalManager.currentModal = null;
            }
        }

        function editFeatureFromDetails() {
            if (currentFeatureId) {
                // Chama editFeature primeiro para abrir o modal de edição
                editFeature(currentFeatureId);
                // Fecha o modal de detalhes com um pequeno delay
                setTimeout(() => {
                    closeFeatureDetailsModal();
                }, 100);
            }
        }

        // Expor função editFeatureFromDetails globalmente
        window.editFeatureFromDetails = editFeatureFromDetails;

        function changeFeatureStatusFromDetails() {
            if (currentFeatureId) {
                openStatusSelectionModal(currentFeatureId);
            }
        }

        function deleteFeatureFromDetails() {
            if (currentFeatureId) {
                closeFeatureDetailsModal();
                deleteFeatureConfirm(currentFeatureId);
            }
        }

        // Funções para o Modal de Seleção de Status
        let statusChangeFeatureId = null;
        let selectedNewStatus = null;

        function openStatusSelectionModal(featureId) {
            const features = loadFeatures();
            const feature = features.find(f => f.id === featureId);
            if (!feature) return;

            statusChangeFeatureId = featureId;
            selectedNewStatus = null;

            // Preencher informações da funcionalidade
            document.getElementById('status-feature-title').textContent = feature.title;
            
            const currentStatusElement = document.getElementById('status-current-status');
            currentStatusElement.textContent = feature.status;
            currentStatusElement.className = `text-xs px-2 py-1 rounded ${STATUS_COLORS[feature.status]} text-white`;

            // Criar opções de status
            const statusOptionsContainer = document.getElementById('status-options');
            statusOptionsContainer.innerHTML = '';

            FEATURE_STATUSES.forEach(status => {
                const isCurrentStatus = status === feature.status;
                const option = document.createElement('div');
                option.className = `p-2 rounded-lg border-2 cursor-pointer transition-all duration-200 ${
                    isCurrentStatus 
                        ? 'border-gray-500 bg-gray-700 opacity-50 cursor-not-allowed' 
                        : 'border-gray-600 bg-gray-800 hover:border-blue-500 hover:bg-gray-700'
                }`;
                
                if (!isCurrentStatus) {
                    option.addEventListener('click', () => selectNewStatus(status, option));
                }

                const statusColor = STATUS_COLORS[status] || 'bg-gray-500';
                const statusIcons = {
                    'Backlog': '📋',
                    'Em Análise': '🔍',
                    'Aprovada': '✅',
                    'Planejada': '📅',
                    'Em Desenvolvimento': '⚙️',
                    'Em Testes': '🧪',
                    'Implementada': '🚀',
                    'Rejeitada': '❌',
                    'Em Espera': '⏸️',
                    'Cancelada': '🚫'
                };

                option.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-base">${statusIcons[status] || '📄'}</span>
                            <div>
                                <div class="font-medium text-white text-sm">${status}</div>
                                ${!isCurrentStatus ? `<div class="text-xs text-gray-400">${getStatusDescription(status)}</div>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-1 rounded ${statusColor} text-white">${status}</span>
                            ${isCurrentStatus ? '<span class="text-xs text-gray-500">(Atual)</span>' : ''}
                        </div>
                    </div>
                `;

                statusOptionsContainer.appendChild(option);
            });

            // Mostrar o modal
            // Notificar o ModalManager para manter a pilha de modais
            if (window.ModalManager && ModalManager.currentModal) {
                ModalManager.modalStack.push(ModalManager.currentModal);
            }
            if (window.ModalManager) {
                ModalManager.currentModal = 'status-selection-modal';
            }
            
            document.getElementById('status-selection-modal').classList.remove('hidden');
        }

        function getStatusDescription(status) {
            const descriptions = {
                'Backlog': 'Aguardando priorização',
                'Em Análise': 'Sendo analisada pela equipe',
                'Aprovada': 'Aprovada para desenvolvimento',
                'Planejada': 'Incluída no planejamento',
                'Em Desenvolvimento': 'Sendo desenvolvida',
                'Em Testes': 'Em fase de testes',
                'Implementada': 'Concluída e implementada',
                'Rejeitada': 'Rejeitada após análise',
                'Em Espera': 'Aguardando dependências',
                'Cancelada': 'Cancelada'
            };
            return descriptions[status] || 'Status da funcionalidade';
        }

        function selectNewStatus(status, optionElement) {
            // Remover seleção anterior
            document.querySelectorAll('#status-options > div').forEach(el => {
                el.classList.remove('border-blue-500', 'bg-blue-900');
                el.classList.add('border-gray-600', 'bg-gray-800');
            });

            // Adicionar seleção atual
            optionElement.classList.remove('border-gray-600', 'bg-gray-800');
            optionElement.classList.add('border-blue-500', 'bg-blue-900');

            selectedNewStatus = status;
        }

        function confirmStatusChange() {
            if (!statusChangeFeatureId || !selectedNewStatus) {
                showMessage('Selecione um novo status antes de confirmar.', 'warning');
                return;
            }

            // Atualizar o status
            updateFeature(statusChangeFeatureId, { status: selectedNewStatus });
            
            // Atualizar visualizações
            renderKanbanBoard();
            renderFeatureList();
            updateDashboard();
            
            // Fechar modal
            closeStatusSelectionModal();
            
            // Mostrar mensagem de sucesso
            showMessage(`Status alterado para: ${selectedNewStatus}`, 'success');

            // Se o modal de detalhes estiver aberto, atualizá-lo
            if (currentFeatureId === statusChangeFeatureId && 
                !document.getElementById('feature-details-modal').classList.contains('hidden')) {
                setTimeout(() => {
                    openFeatureDetailsModal(currentFeatureId);
                }, 100);
            }
        }

        function closeStatusSelectionModal() {
            document.getElementById('status-selection-modal').classList.add('hidden');
            statusChangeFeatureId = null;
            selectedNewStatus = null;
            
            // Restaurar modal anterior se existir na pilha do ModalManager
            if (window.ModalManager && ModalManager.modalStack.length > 0) {
                ModalManager.currentModal = ModalManager.modalStack.pop();
            } else if (window.ModalManager) {
                ModalManager.currentModal = null;
            }
        }

        // Manipulação do formulário
        document.addEventListener('DOMContentLoaded', function() {
            const featureForm = document.getElementById('feature-form');
            if (featureForm) {
                featureForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        title: document.getElementById('feature-title').value,
                        description: document.getElementById('feature-description').value,
                        priority: document.getElementById('feature-priority').value,
                        category: document.getElementById('feature-category').value,
                        module: document.getElementById('feature-module').value,
                        effort: document.getElementById('feature-effort').value,
                        author: document.getElementById('feature-author').value,
                        notes: document.getElementById('feature-notes').value
                    };
                    
                    const editingId = this.dataset.editingId;
                    
                    if (editingId) {
                        // Editar funcionalidade existente
                        updateFeature(editingId, formData);
                        cancelFeatureEdit();
                        showMessage('Funcionalidade atualizada com sucesso!');
                    } else {
                        // Criar nova funcionalidade
                        createFeature(formData);
                        clearFeatureForm();
                        showMessage('Funcionalidade adicionada com sucesso!');
                    }
                    
                    // Atualizar visualizações
                    updateFeatureManagerStats();
                    renderKanbanBoard();
                    renderFeatureList();
                    updateDashboard();
                });
            }
            
            // Atualizar estatísticas da Central de Ajuda ao carregar a página
            updateFeatureManagerStats();
        });

        // === FUNÇÕES DE AUDITORIA E DEBUG ===
        
        // Inicializar sistema de auditoria
        document.addEventListener('DOMContentLoaded', function() {
            AuditLogger.loadFromStorage();
            AuditLogger.log('INFO', 'SYSTEM', 'Sistema de auditoria inicializado');
        });

        // Função para abrir modal de auditoria
        window.openAuditModal = function() {
            openModal('audit-modal');
            switchAuditTab('validation');
        }

        // Função para alternar tabs
        window.switchAuditTab = function(tabName) {
            // Remover classe ativa de todas as tabs
            document.querySelectorAll('[id^="audit-tab-"]').forEach(tab => {
                tab.classList.remove('text-orange-400', 'border-orange-400');
                tab.classList.add('text-gray-400', 'border-transparent');
            });
            
            // Ocultar todo conteúdo
            document.querySelectorAll('.audit-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Ativar tab selecionada
            const activeTab = document.getElementById(`audit-tab-${tabName}`);
            const activeContent = document.getElementById(`audit-content-${tabName}`);
            
            if (activeTab && activeContent) {
                activeTab.classList.remove('text-gray-400', 'border-transparent');
                activeTab.classList.add('text-orange-400', 'border-orange-400');
                activeContent.classList.remove('hidden');
            }
            
            // Carregar conteúdo específico da tab
            if (tabName === 'logs') {
                loadAuditLogs();
            }
        }

        // Função para validação de IDs
        window.runIDValidation = function() {
            AuditLogger.log('AUDIT', 'ID_VALIDATION', 'Iniciando validação de IDs');
            
            const issues = IDValidator.validateCharacterConsistency();
            const container = document.getElementById('validation-results');
            
            container.innerHTML = '';
            
            if (issues.length === 0) {
                container.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-green-500 text-2xl mr-3">✅</span>
                            <div>
                                <h4 class="text-green-800 font-bold">Tudo OK!</h4>
                                <p class="text-green-700 text-sm">Nenhum problema de ID encontrado.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <span class="text-red-500 text-2xl mr-3">⚠️</span>
                            <div>
                                <h4 class="text-red-800 font-bold">Problemas Encontrados!</h4>
                                <p class="text-red-700 text-sm">${issues.length} problema(s) de ID detectado(s).</p>
                            </div>
                        </div>
                    </div>
                `;
                
                issues.forEach(issue => {
                    const severityColors = {
                        CRITICAL: 'red',
                        ERROR: 'orange',
                        WARN: 'yellow'
                    };
                    const color = severityColors[issue.severity] || 'gray';
                    
                    container.innerHTML += `
                        <div class="bg-${color}-50 border border-${color}-200 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h5 class="text-${color}-800 font-semibold">${issue.type}</h5>
                                    <p class="text-${color}-700 text-sm">${issue.message}</p>
                                    ${issue.keyId ? `<p class="text-xs text-${color}-600 mt-1">Chave: ${issue.keyId} | Object ID: ${issue.objectId}</p>` : ''}
                                </div>
                                <span class="text-${color}-600 font-bold text-xs">${issue.severity}</span>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // Função para corrigir IDs
        window.fixCharacterIDs = function() {
            if (!confirm('Tem certeza que deseja corrigir automaticamente os IDs? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            AuditLogger.log('AUDIT', 'ID_FIX', 'Iniciando correção automática de IDs');
            
            const fixes = IDValidator.fixCharacterIds();
            
            if (fixes.length > 0) {
                alert(`✅ ${fixes.length} ID(s) corrigido(s) com sucesso!\n\n${fixes.map(f => `• ${f.charName}: ${f.oldId.substring(0,8)}... → ${f.newId.substring(0,8)}...`).join('\n')}`);
                
                // Re-renderizar a lista para aplicar as correções
                renderCharacterListFixed();
                
                // Re-executar validação
                runIDValidation();
            } else {
                alert('Nenhuma correção necessária. Todos os IDs já estão consistentes.');
            }
        }

        // Função para carregar logs de auditoria
        window.loadAuditLogs = function() {
            filterAuditLogs();
        }

        // Função para filtrar logs
        window.filterAuditLogs = function() {
            const levelFilter = document.getElementById('log-level-filter')?.value;
            const categoryFilter = document.getElementById('log-category-filter')?.value;
            
            const filters = {};
            if (levelFilter) filters.level = levelFilter;
            if (categoryFilter) filters.category = categoryFilter;
            
            const logs = AuditLogger.getLogs(filters);
            const container = document.getElementById('audit-logs-container');
            
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum log encontrado.</p>';
                return;
            }
            
            logs.slice(0, 100).forEach(log => { // Mostrar apenas os 100 mais recentes
                const time = new Date(log.timestamp).toLocaleString();
                const levelColors = {
                    DEBUG: 'blue',
                    INFO: 'green',
                    WARN: 'yellow',
                    ERROR: 'red',
                    CRITICAL: 'red',
                    AUDIT: 'purple'
                };
                const color = levelColors[log.level] || 'gray';
                
                container.innerHTML += `
                    <div class="bg-${color}-50 border-l-4 border-${color}-400 p-3 rounded">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="bg-${color}-100 text-${color}-800 px-2 py-1 rounded text-xs font-bold">${log.level}</span>
                                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">${log.category}</span>
                                    <span class="text-gray-500 text-xs">${time}</span>
                                </div>
                                <p class="text-gray-800 mt-1">${log.message}</p>
                                ${log.data ? `<details class="mt-2"><summary class="text-xs text-gray-600 cursor-pointer">Ver dados</summary><pre class="text-xs bg-gray-100 p-2 rounded mt-1 overflow-auto">${JSON.stringify(log.data, null, 2)}</pre></details>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Função para exportar logs
        window.exportAuditLogs = function() {
            AuditLogger.exportLogs();
            AuditLogger.log('INFO', 'AUDIT', 'Logs exportados pelo usuário');
        }

        // Função para limpar logs
        window.clearAuditLogs = function() {
            if (!confirm('Tem certeza que deseja limpar todos os logs? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            AuditLogger.logs = [];
            AuditLogger.saveToStorage();
            AuditLogger.log('INFO', 'AUDIT', 'Logs limpos pelo usuário');
            
            loadAuditLogs();
        }

        // Função para carregar lista de força exclusão
        window.loadForceDeleteList = function() {
            const container = document.getElementById('force-delete-container');
            if (!container) {
                console.error('Container force-delete-container não encontrado');
                return;
            }
            
            container.innerHTML = '';
            
            if (Object.keys(characters).length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum personagem encontrado.</p>';
                return;
            }
            
            Object.entries(characters).forEach(([key, char]) => {
                const isIdMismatch = key !== char.id;
                
                container.innerHTML += `
                    <div class="border rounded-lg p-4 mb-2 ${isIdMismatch ? 'bg-red-900 border-red-600' : 'bg-gray-700 border-gray-600'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold ${isIdMismatch ? 'text-red-300' : 'text-white'}">${char.name}</h4>
                                <p class="text-sm text-gray-300">Jogador: ${char.player || 'N/A'}</p>
                                <div class="text-xs mt-2 space-y-1 text-gray-400">
                                    <p><strong>ID Armazenado:</strong> ${key}</p>
                                    <p><strong>ID Objeto:</strong> ${char.id}</p>
                                    ${isIdMismatch ? '<p class="text-red-400"><strong>⚠️ INCONSISTÊNCIA DETECTADA</strong></p>' : ''}
                                </div>
                            </div>
                            <button onclick="forceDeleteCharacter('${key}')" 
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors ml-4">
                                🗑️ Remover
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // Função para força exclusão
        window.forceDeleteCharacter = function(charKey) {
            const char = characters[charKey];
            const charName = char ? char.name : 'Personagem não encontrado';
            
            if (!confirm(`🚨 FORÇA EXCLUSÃO\n\nTem certeza que deseja FORÇAR a exclusão do personagem "${charName}"?\n\nEsta ação:\n• Remove permanentemente o personagem\n• Não pode ser desfeita\n• Ignora problemas de ID\n\nChave a ser removida: ${charKey}`)) {
                return;
            }
            
            AuditLogger.log('CRITICAL', 'FORCE_DELETE', `Força exclusão iniciada para personagem "${charName}" (chave: ${charKey})`);
            
            try {
                // Forçar remoção usando a chave
                if (characters[charKey]) {
                    delete characters[charKey];
                    
                    // Verificar se também existe com outro ID
                    const duplicateChar = Object.values(characters).find(c => c.name === charName);
                    if (duplicateChar) {
                        const otherKey = Object.keys(characters).find(key => characters[key] === duplicateChar);
                        if (otherKey) {
                            delete characters[otherKey];
                            AuditLogger.log('WARN', 'FORCE_DELETE', `Removido também personagem duplicado com chave: ${otherKey}`);
                        }
                    }
                    
                    // Salvar alterações
                    saveCharacters();
                    
                    // Atualizar interface
                    renderCharacterList();
                    
                    // Recarregar lista
                    loadForceDeleteList();
                    
                    AuditLogger.log('SUCCESS', 'FORCE_DELETE', `Personagem "${charName}" removido com sucesso`);
                    alert(`✅ Personagem "${charName}" foi removido com sucesso.`);
                    
                } else {
                    AuditLogger.log('ERROR', 'FORCE_DELETE', `Personagem com chave ${charKey} não encontrado`);
                    alert(`❌ Personagem com chave ${charKey} não foi encontrado.`);
                }
                
            } catch (error) {
                AuditLogger.log('ERROR', 'FORCE_DELETE', `Erro durante força exclusão: ${error.message}`);
                alert(`❌ Erro durante a exclusão: ${error.message}`);
            }
        }

        // === INICIALIZAÇÃO DO SISTEMA DE LOGS MELHORADO ===
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar um pouco para garantir que tudo carregou
            setTimeout(() => {
                try {
                    // Log de inicialização do sistema
                    Logger.info('Sistema SGP T&T v3.4.1.5 inicializado com Logger melhorado', null, 'SYSTEM');
                    
                    // Exemplos de logs de diferentes níveis para demonstração
                    Logger.warn('Exemplo de aviso: LocalStorage com uso moderado', { usage: '65%' }, 'STORAGE');
                    Logger.performance('Exemplo performance: Carregamento inicial do sistema', { tempo: 1200 }, 'SYSTEM');
                    Logger.warn('Exemplo de aviso: Versão do navegador pode ter limitações', { 
                        userAgent: navigator.userAgent.substring(0, 50) 
                    }, 'UI');
                    Logger.error('Exemplo de erro: Teste de erro para demonstração', { teste: true }, 'SYSTEM');
                    Logger.debug('Exemplo de debug: Estado interno do sistema', { debug: true }, 'SYSTEM');
                    
                    // Atualizar estatísticas de logs na interface
                    Logger.updateLogStats();
                    
                    // Log de teste para demonstração
                    Logger.character('info', 'Sistema de logs para personagens ativo');
                    Logger.library('info', 'Sistema de logs para biblioteca ativo');
                    Logger.storage('info', 'Sistema de logs para storage ativo');
                    Logger.ui('debug', 'Sistema de logs para interface ativo');
                    Logger.pagination('debug', 'Sistema de logs para paginação ativo');
                    
                    // Mostrar no console que o sistema foi melhorado
                    console.log('%c🚀 LOGGER MELHORADO ATIVO!', 'color: #10B981; font-weight: bold; font-size: 16px;');
                    console.log('%c📊 Use Logger.getLogStats() para ver estatísticas detalhadas', 'color: #3B82F6;');
                    console.log('%c🔍 Use showSystemLogs() para ver interface melhorada', 'color: #F59E0B;');
                    
                } catch (error) {
                    console.error('Erro na inicialização do Logger melhorado:', error);
                }
            }, 1000);
        });

    </script>
</body>
</html>
