<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Classes - Tormenta RPG Clássico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;0,700;0,900&display=swap');

        /* Cores base para Tema Claro (Pergaminho Antigo) - FIXO */
        :root {
            --color-bg: #f7f3e8; /* Off-white/Pergaminho */
            --color-surface: #fff;
            --color-text: #2c2f33; /* Texto escuro */
            --color-primary: #8d0801; /* Vermelho/Ouro Velho (Aventura) */
            --color-accent: #0d47a1; /* Azul (Magia Arcana) */
        }
        
        /* Remoção de .dark-mode e variáveis relacionadas */
        /* ... */

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.3s, color 0.3s;
        }

        .card-surface {
            background-color: var(--color-surface);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: #fff; /* Fixo como branco, pois o primário é escuro */
            transition: transform 0.1s, opacity 0.1s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .btn-secondary {
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            transition: background-color 0.1s;
        }

        .btn-secondary:hover {
            background-color: rgba(141, 8, 1, 0.1); /* Cor primária com opacidade */
        }

        /* Ajustando cores de input para o tema claro */
        input[type="text"], textarea, select {
            border: 1px solid #ccc;
            background-color: var(--color-surface);
            color: var(--color-text);
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem;
            transition: border-color 0.15s;
        }
        
        /* Foco */
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        /* Removendo estilos de Toggle Switch */
        /* ... */

        /* Estilo da Tabela de Progressão (Desktop/Padrão) */
        .progress-table th, .progress-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .progress-table thead {
            background-color: rgba(141, 8, 1, 0.2);
            color: var(--color-primary);
            font-weight: 700;
        }

        .progress-table tbody tr:nth-child(even) {
            background-color: rgba(44, 47, 51, 0.05);
        }

        /* ====================================================
        CSS ORIGINAL: Tabela com Scroll Horizontal (Mobile)
        REVERTIDO
        ====================================================
        */
        @media screen and (max-width: 1024px) {
            /* Remove as regras de transformação da tabela */
            .progress-table {
                /* Mantém o min-width para permitir o scroll horizontal */
                min-width: 900px;
                display: table;
            }
            .progress-table thead {
                display: table-header-group;
            }
            .progress-table tr {
                display: table-row;
                margin-bottom: 0;
                border: 1px solid rgba(0, 0, 0, 0.1);
                padding: 0;
                background-color: transparent;
            }
            .progress-table td {
                display: table-cell;
                text-align: center;
                padding: 8px;
                border: 1px solid rgba(0, 0, 0, 0.1);
                position: static;
            }
            .progress-table td:before {
                /* Esconde o label de cabeçalho móvel */
                content: none;
            }
        }
        /* Fim do CSS responsivo revertido */

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .toast {
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0.95;
            animation: fadeInOut 4s forwards;
            min-width: 250px;
        }

        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #0d47a1; }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(100%); }
            10% { opacity: 0.95; transform: translateX(0); }
            90% { opacity: 0.95; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }

        /* Estilo para campos de texto longos de background */
        .background-section p {
            font-family: 'Merriweather', serif;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        /* Utilitário de Scrollbar customizado (Não é mais dark mode, mas mantém o estilo) */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #aaa;
            border-radius: 4px;
        }

        /* Tooltip Customizado */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--color-surface);
            color: var(--color-text);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            top: 150%; 
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--color-primary);
            font-size: 0.875rem; /* text-sm */
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Ponta da Seta */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent var(--color-primary) transparent;
        }

        /* Ajuste específico para o ícone de informação no formulário (para não quebrar a linha) */
        .form-th-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* Espaçamento entre o texto e o ícone */
        }
        
        /* Limpeza de classes condicionais de Dark Mode */
        .text-gray-900 { color: var(--color-text); }
        .text-gray-100 { color: var(--color-text); }
        .text-gray-500 { color: #6b7280; } /* Cinza padrão do light mode */
        .border-gray-700 { border-color: #d1d5db; } /* Borda clara */

    </style>
</head>
<body class="min-h-screen">

    <!-- Container de Notificações Toast -->
    <div id="toast-container"></div>

    <!-- Modal de Confirmação/Exclusão -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden justify-center items-center">
        <div class="card-surface p-6 rounded-xl w-11/12 max-w-md">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Confirmar Ação</h3>
            <p class="mb-6" id="modal-message">Tem certeza de que deseja realizar esta ação?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="btn-secondary px-4 py-2 rounded-lg">Cancelar</button>
                <button id="modal-confirm-btn" class="btn-primary px-4 py-2 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE LOGS DE ERRO -->
    <div id="log-modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden justify-center items-center">
        <div class="card-surface p-6 rounded-xl w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
                <span>Logs de Erro (Importação)</span>
                <button class="text-red-500 hover:text-red-700" onclick="hideLogModal()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </h3>
            <p class="mb-4 text-sm text-gray-500">Aqui você pode visualizar o conteúdo que gerou o erro de `JSON.parse` para tentar corrigir a formatação.</p>
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-sm font-semibold mb-2 text-red-500">Mensagem de Erro:</p>
                <code id="log-error-message" class="block whitespace-pre-wrap text-sm text-red-600 mb-4"></code>
                <p class="text-sm font-semibold mb-2">Conteúdo JSON Tentado:</p>
                <code id="log-json-content" class="block whitespace-pre-wrap text-xs text-gray-800"></code>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn-secondary px-4 py-2 rounded-lg" onclick="hideLogModal()">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Cabeçalho Principal -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">
                Tormenta <span class="text-[var(--color-primary)]">Classes</span>
            </h1>
            <div class="flex items-center space-x-4">
                <!-- Botão Novo em Mobile (Mantido para mobile, mas removido da seção de ações globais) -->
                <button id="btn-novo-mobile" class="sm:hidden btn-primary p-2 rounded-full shadow-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- NOVA BARRA DE AÇÕES GLOBAIS (Alinhada no topo) -->
    <nav class="bg-gray-100 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex justify-end space-x-2">
            
            <!-- Botão Nova Classe -->
            <button id="btn-nova-classe-desktop-nav" class="btn-primary px-3 py-2 rounded-lg flex items-center space-x-1 hidden sm:flex">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="font-medium">Nova Classe</span>
            </button>
            
            <!-- Botão Limpar BBA Graduações (Removido, apenas mantendo a referência para a função) -->
            <button id="btn-limpar-graduacoes-bba" class="btn-secondary px-3 py-2 rounded-lg flex items-center space-x-1 border-gray-400 text-gray-700 hover:bg-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="hidden sm:inline font-medium">Limpar BBA</span>
            </button>

            <!-- Botão Importar Classes -->
            <input type="file" id="input-import-json" accept=".json" class="hidden" multiple>
            <button id="btn-importar-classes-nav" class="btn-secondary px-3 py-2 rounded-lg flex items-center space-x-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span class="hidden sm:inline font-medium">Importar</span>
            </button>

            <!-- Botão Exportar Todas -->
            <button id="btn-exportar-tudo-nav" class="btn-secondary px-3 py-2 rounded-lg flex items-center space-x-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H4a2 2 0 01-2-2v-8a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2z"></path></svg>
                <span class="hidden sm:inline font-medium">Exportar Tudo</span>
            </button>
            
            <!-- NOVO BOTÃO: Excluir Todos os Dados -->
            <button id="btn-excluir-tudo-nav" class="btn-secondary px-3 py-2 rounded-lg flex items-center space-x-1 border-red-500 text-red-500 hover:bg-red-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span class="hidden sm:inline font-medium">Excluir Tudo</span>
            </button>

            <!-- Botão Logs de Erro -->
            <button id="btn-view-logs-nav" class="btn-secondary px-3 py-2 rounded-lg flex items-center space-x-1 border-[var(--color-accent)] text-[var(--color-accent)]">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="hidden sm:inline font-medium">Logs</span>
            </button>
        </div>
    </nav>

    <!-- Layout Principal (Grid/Flex) -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Coluna Esquerda: Listagem, Busca, Filtros e Paginação -->
        <section id="lista-classes-container" class="lg:col-span-1">
            <div class="flex justify-between items-center mb-4">
                <!-- MODIFICADO: Contador de Classes adicionado ao título -->
                <h2 class="text-xl font-semibold flex items-center space-x-2">
                    <span>Classes Salvas</span>
                    <span id="class-count" class="text-base font-bold text-[var(--color-accent)]">0</span>
                </h2>
                <!-- Botão Nova Classe removido daqui, agora está na nav -->
            </div>

            <!-- Busca e Filtro -->
            <div class="mb-4 space-y-2">
                <input type="text" id="input-busca" placeholder="Buscar por nome ou tag..." class="w-full card-surface rounded-lg">
                <select id="select-ordenacao" class="w-full card-surface rounded-lg">
                    <option value="alfabetica">Ordenar Alfabeticamente</option>
                    <option value="bab">Ordenar por BAB Máximo</option>
                    <option value="dano">Ordenar por Dado de Vida</option>
                </select>
            </div>

            <div id="lista-classes" class="space-y-3">
                <!-- Conteúdo dos Cards de Classe será injetado aqui -->
            </div>
            
            <!-- Controles de Paginação -->
            <div id="pagination-controls" class="flex justify-center items-center space-x-4 mt-4">
                <!-- Botões de página e indicador serão injetados aqui -->
            </div>

            <!-- Estado Vazio -->
            <div id="estado-vazio" class="card-surface p-6 rounded-xl text-center hidden">
                <p class="text-lg font-medium mb-2">Sem Classes Cadastradas!</p>
                <p class="text-sm">Clique em "+ Nova Classe" para começar, ou importe dados.</p>
            </div>

            <!-- Funções de Import/Export (Removidas daqui) -->
            <div class="mt-8 pt-4 border-t border-gray-300 space-y-3 hidden" id="old-data-management-section">
                <h3 class="text-lg font-semibold">Gestão de Dados</h3>
                <input type="file" id="input-import-json-old" accept=".json" class="hidden">
                <button id="btn-importar-classes-old" class="btn-secondary w-full px-4 py-2 rounded-lg">Importar Classes (JSON)</button>
                <button id="btn-exportar-tudo-old" class="btn-secondary w-full px-4 py-2 rounded-lg">Exportar Todas (JSON)</button>
                <button id="btn-view-logs-old" class="btn-secondary w-full px-4 py-2 rounded-lg text-[var(--color-accent)] border-[var(--color-accent)]">Visualizar Logs de Erro</button>
            </div>
        </section>

        <!-- Coluna Direita: Visualização e Formulário (Conteúdo Principal) -->
        <section id="conteudo-principal" class="lg:col-span-2 min-h-[70vh]">
            <!-- As seções de Visualização ou Formulário serão injetadas aqui -->
            <div id="view-loader" class="flex justify-center items-center h-full hidden">
                <p class="text-xl animate-pulse">Carregando...</p>
            </div>
            <div id="classe-visualizacao">
                <!-- Visualização de uma classe selecionada ou tela de boas-vindas -->
            </div>
            <div id="classe-formulario" class="hidden">
                <!-- Formulário de Edição/Criação -->
            </div>

            <!-- Tour/Ajuda -->
            <div id="tour-ajuda" class="card-surface p-6 rounded-xl">
                <h2 class="text-2xl font-bold text-[var(--color-primary)] mb-4">Bem-vindo(a) ao Gerenciador de Classes TRPG!</h2>
                <p class="mb-4">Este sistema foi feito para você, mestre de Tormenta RPG Clássico, gerenciar e criar suas classes *homebrew*.</p>
                <h3 class="font-semibold mb-2">Como Usar:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li>Use o botão **"Nova Classe"** na barra de topo para abrir o formulário.</li>
                    <li>Preencha a **Tabela de Progressão (o coração da classe!)** no formulário.</li>
                    <li>**Clique em um Card** na lateral para visualizar a classe em formato de ficha.</li>
                    <li>O sistema salva automaticamente no seu navegador (<span class="font-bold">LocalStorage</span>).</li>
                    <li>Use os botões de **Exportar** e **Importar** na barra de topo para fazer backup ou compartilhar suas criações.</li>
                </ul>
                <p class="mt-4 text-sm italic">Os dados de Bárbaro e Bardo foram pré-carregados para referência, extraídos do PDF original.</p>
            </div>
        </section>

    </main>

<script>
    // ====================================================================
    // 1. ESTRUTURA DE DADOS E VARIÁVEIS GLOBAIS
    // ====================================================================

    // Chave para LocalStorage
    const STORAGE_KEY = 'torg_classes_v1';
    
    // Variável global para armazenar o último erro de importação/exportação
    let lastImportError = { message: '', content: '' };
    
    // VARIÁVEIS DE PAGINAÇÃO
    let classesPerPage = 3; 
    let currentPage = 1;

    // Tabela de Benefícios por Nível (Global) - Extraída estritamente da pág. 45
    const globalLevelBenefits = [
        { nivel: 1, xp: 0, talentos: 1, aumentoHab: 0, bonusGlobal: '+0' },
        { nivel: 2, xp: 1000, talentos: 1, aumentoHab: 1, bonusGlobal: '+1' },
        { nivel: 3, xp: 3000, talentos: 2, aumentoHab: 1, bonusGlobal: '+1' },
        { nivel: 4, xp: 6000, talentos: 2, aumentoHab: 2, bonusGlobal: '+2' },
        { nivel: 5, xp: 10000, talentos: 3, aumentoHab: 2, bonusGlobal: '+2' },
        { nivel: 6, xp: 15000, talentos: 3, aumentoHab: 3, bonusGlobal: '+3' },
        { nivel: 7, xp: 21000, talentos: 4, aumentoHab: 3, bonusGlobal: '+3' },
        { nivel: 8, xp: 28000, talentos: 4, aumentoHab: 4, bonusGlobal: '+4' },
        { nivel: 9, xp: 36000, talentos: 5, aumentoHab: 4, bonusGlobal: '+4' },
        { nivel: 10, xp: 45000, talentos: 5, aumentoHab: 5, bonusGlobal: '+5' },
        { nivel: 11, xp: 55000, talentos: 6, aumentoHab: 5, bonusGlobal: '+5' },
        { nivel: 12, xp: 66000, talentos: 6, aumentoHab: 6, bonusGlobal: '+6' },
        { nivel: 13, xp: 78000, talentos: 7, aumentoHab: 6, bonusGlobal: '+6' },
        { nivel: 14, xp: 91000, talentos: 7, aumentoHab: 7, bonusGlobal: '+7' },
        { nivel: 15, xp: 105000, talentos: 8, aumentoHab: 7, bonusGlobal: '+7' },
        { nivel: 16, xp: 120000, talentos: 8, aumentoHab: 8, bonusGlobal: '+8' },
        { nivel: 17, xp: 136000, talentos: 9, aumentoHab: 8, bonusGlobal: '+8' },
        { nivel: 18, xp: 153000, talentos: 9, aumentoHab: 9, bonusGlobal: '+9' },
        { nivel: 19, xp: 171000, talentos: 10, aumentoHab: 9, bonusGlobal: '+9' },
        { nivel: 20, xp: 190000, talentos: 10, aumentoHab: 10, bonusGlobal: '+10' },
    ];
    
    // Classes de Exemplo (Extraídas do PDF)
    // ATUALIZAÇÃO: BBA volta a ser uma coluna única, incluindo graduações. Removendo 'graduacoes'
    const initialClassesData = [
    {
        id: 'barbaro-default',
        nome: 'Bárbaro',
        tipo: 'Guerreiro Primitivo',
        tag: 'Guerreiro',
        descricaoCurta: 'Um mestre do combate selvagem, capaz de canalizar grande fúria para dizimar seus inimigos.',
        background: {
            aventuras: 'Para os bárbaros, aventurar-se é um modo de vida. Em seus povos, eles costumam ser os maiores lutadores ou caçadores. Muitos partem para conhecer o mundo em uma missão para suas tribos, ou num rito de passagem. Caso decidam viver na civilização, existe muito pouco que possam fazer além de enfrentar perigos que amedrontam o povo comum.',
            tendencia: 'Bondosos, Malignos ou Neutros, mas nunca Leais. Seu espírito livre não se prende a regulamentos e artifícios da civilização.',
            religiao: 'Bondosos ou Neutros costumam cultuar Allihanna ou Oceano. Malignos muitas vezes são devotos de Megalokk ou Ragnar.',
            historico: 'Muitos dos povos bárbaros de Arton foram dizimados pela "civilização". Um membro desta classe pode ser um dos últimos sobreviventes de sua tribo, buscando vingança ou apenas manter seus ideais e cultura vivos. A fúria bárbara também pode surgir em um membro da sociedade civilizada, fazendo com que ele fuja para os ermos e se torne um bárbaro.',
            racas: 'Comum entre humanos selvagens, alguns anões e minotauros, lefou e goblins não-civilizados. Raro em halflings ou qareen.',
            outrasClasses: 'Coexistem pacificamente com rangers e druidas. Tem mais dificuldade de convivência com magos e clérigos Leais.',
        },
        dadosBase: {
            dadoVida: 'd12',
            pvInicial: 24,
            pvPorNivel: 6,
            periciasPorNivel: '4 + Mod. Int',
            pmInicial: '0',
            pmPorNivel: 0,
            talentosAdicionais: [
                'Usar Armaduras (leves e médias)', 'Usar Armas (simples e marciais)',
                'Usar Escudos', 'Fortitude Maior'
            ],
            periciasDeClasse: [
                'Adestrar Animais (Car)', 'Atletismo (For)', 'Cavalgar (Des)',
                'Iniciativa (Des)', 'Intimidação (Car)', 'Ofício (Int)',
                'Percepção (Sab)', 'Sobrevivência (Sab)'
            ]
        },
        magia: null,
        habilidadesEspeciais: [
            { nome: 'Analfabetismo', nivel: 1, descricao: 'Membros desta classe não sabem ler e escrever. Podem aprender se adquirirem um nível em qualquer outra classe.' },
            { nome: 'Fúria (1/dia)', nivel: 1, descricao: 'Ação libre. Recebe +2 em ataque/dano corpo-a-corpo e RD 1, mas sofre -2 na CA. Dura 5 + Mod. Con rodadas. Fica fatigado após o fim. Usos aumentam a cada 4 níveis (máx. 6/dia no 20º).' },
            { nome: 'Movimento Rápido', nivel: 1, descricao: 'Seu deslocamento aumenta em +3m.' },
            { nome: 'Esquiva Sobrenatural', nivel: 2, descricao: 'Nunca fica desprevenido. Se já tiver de outra classe, recebe Esquiva Sobrenatural Aprimorada.' },
            { nome: 'Instinto Selvagem +1', nivel: 3, descricao: 'Recebe +1 em testes de Iniciativa e Reflexos. Aumenta em +1 a cada 6 níveis (3º, 9º, 15º...).' },
            { nome: 'Esquiva Sobrenatural Aprimorada', nivel: 5, descricao: 'Não pode ser flanqueado.' },
            { nome: 'Redução de Dano 1', nivel: 7, descricao: 'Reduz o dano de ataques físicos em 1. Aumenta em +1 a cada 3 níveis seguintes (7º, 10º, 13º, 16º, 19º).' },
            { nome: 'Fúria Maior', nivel: 11, descricao: 'O bônus da Fúria aumenta para +3 em ataque/dano e RD para 3.' },
            { nome: 'Vontade Inabalável', nivel: 14, descricao: 'Recebe +4 em testes de Vontade quando em fúria.' },
            { nome: 'Fúria Incansável', nivel: 17, descricao: 'Não fica mais fatigado quando sua fúria termina.' },
            { nome: 'Fúria Poderosa', nivel: 20, descricao: 'O bônus da Fúria aumenta para +4 em ataque/dano e RD para 5.' },
        ],
        tabelaProgressao: [
            // BBA: Alto (1º ao 20º) - Inclui graduações
            { nivel: 1, bab: '+1', hab: 'Analf., Fúria 1/dia, Mov. Rápido', magias: '-' },
            { nivel: 2, bab: '+2', hab: 'Esquiva Sobrenatural', magias: '-' },
            { nivel: 3, bab: '+3', hab: 'Instinto Selvagem +1', magias: '-' },
            { nivel: 4, bab: '+4', hab: 'Fúria 2/dia', magias: '-' },
            { nivel: 5, bab: '+5', hab: 'Esquiva Sobrenatural Aprimorada', magias: '-' },
            { nivel: 6, bab: '+6', hab: '–', magias: '-' },
            { nivel: 7, bab: '+7', hab: 'Redução de Dano 1', magias: '-' },
            { nivel: 8, bab: '+8', hab: 'Fúria 3/dia', magias: '-' },
            { nivel: 9, bab: '+9', hab: 'Instinto Selvagem +2', magias: '-' },
            { nivel: 10, bab: '+10', hab: 'Redução de Dano 2', magias: '-' },
            { nivel: 11, bab: '+11', hab: 'Fúria Maior', magias: '-' },
            { nivel: 12, bab: '+12', hab: 'Fúria 4/dia', magias: '-' },
            { nivel: 13, bab: '+13', hab: 'Redução de Dano 3', magias: '-' },
            { nivel: 14, bab: '+14', hab: 'Vontade Inabalável', magias: '-' },
            { nivel: 15, bab: '+15', hab: 'Instinto Selvagem +3', magias: '-' },
            { nivel: 16, bab: '+16', hab: 'Fúria 5/dia, RD 4', magias: '-' },
            { nivel: 17, bab: '+17', hab: 'Fúria Incansável', magias: '-' },
            { nivel: 18, bab: '+18', hab: '–', magias: '-' },
            { nivel: 19, bab: '+19', hab: 'Redução de Dano 5', magias: '-' },
            { nivel: 20, bab: '+20', hab: 'Fúria 6/dia, Fúria Poderosa', magias: '-' },
        ]
    },
    {
        id: 'bardo-default',
        nome: 'Bardo',
        tipo: 'Conjurador Arcano/Suporte',
        tag: 'Híbrido, Conjurador',
        descricaoCurta: 'O artista, músico e sedutor de Arton, que usa sua performance para encantar a plateia e inspirar aliados.',
        background: {
            aventuras: 'Pouquíssimos bardos ficam satisfeitos num mesmo lugar o tempo todo. Costumam sair para conhecer o mundo, coletar histórias e espalhar conhecimento (e sua própria fama).',
            tendencia: 'Neutros ou Caóticos, mas nenhum é Leal.',
            religiao: 'Devotados a Tanna-Toh. Também costumam cultuar Valkaria, Wynna e Marah.',
            historico: 'Muitos bardos têm raízes na corte. Outros estudam em grandes colégios, onde aprendem minúcias sobre poesia, história e outras artes e conhecimentos. Bardos tribais preservam e ensinam as tradições de seus povos.',
            racas: 'Comum em humanos, qareen e elfos. Bardos anões são historiadores, halflings preferem canções sobre cerveja. Raro em goblins e lefou.',
            outrasClasses: 'Bons companheiros para qualquer um. Bárbaros, druidas, rangers e certos clérigos podem ter problemas com o jeito extrovertido e brincalhão da maioria dos bardos, mas é difícil resistir a seus modos cativantes.',
        },
        dadosBase: {
            dadoVida: 'd8',
            pvInicial: 12,
            pvPorNivel: 3,
            periciasPorNivel: '6 + Mod. Int',
            pmInicial: '1 + Mod. Car',
            pmPorNivel: 2,
            talentosAdicionais: [
                'Usar Armaduras (leves)', 'Usar Armas (simples e marciais)',
                'Usar Escudos', 'Reflexos Rápidos', 'Vontade de Ferro'
            ],
            periciasDeClasse: [
                'Acrobacia (Des)', 'Atletismo (For)', 'Atuação (Car)', 'Cavalgar (Des)',
                'Conhecimento (Int)', 'Diplomacia (Car)', 'Enganação (Car)',
                'Furtividade (Des)', 'Identificar Magia (Int)', 'Iniciativa (Des)',
                'Intuição (Sab)', 'Ladinagem (Des)', 'Obter Informação (Car)',
                'Percepção (Sab)'
            ]
        },
        magia: {
            tipo: 'Arcana',
            habilidadeChave: 'Carisma',
            magiasConhecidasNivel0: 4,
            ganhoMagiasPorNivel: 1, // +1 nova magia por nível
            preparacao: 'Espontânea',
            progressaoMagias: [
                { nivel: 1, maxMagia: 1, habNivel: '0º, 1º' },
                { nivel: 4, maxMagia: 2, habNivel: '2º' },
                { nivel: 7, maxMagia: 3, habNivel: '3º' },
                { nivel: 10, maxMagia: 4, habNivel: '4º' },
                { nivel: 13, maxMagia: 5, habNivel: '5º' },
                { nivel: 16, maxMagia: 6, habNivel: '6º' },
            ]
        },
        habilidadesEspeciais: [
            { nome: 'Conhecimento de Bardo', nivel: 1, descricao: 'Pode fazer testes de qualquer perícia de Conhecimento como se fosse treinado, com bônus igual a seu nível + Mod. Int.' },
            { nome: 'Música de Bardo', nivel: 1, descricao: 'Começa com 2 efeitos, aprende +1 a cada 2 níveis (a partir do 2º). Usos: Nível + Mod. Car/dia. Exige treino em Atuação.' },
        ],
        tabelaProgressao: [
            // BBA: Médio/Baixo (3/4 - 1/2) - Inclui graduações
            { nivel: 1, bab: '+0', hab: 'Conhecimento de Bardo, Música de Bardo (2 efeitos)', magias: '0º, 1º' },
            { nivel: 2, bab: '+1', hab: 'Música de Bardo (+1 efeito)', magias: '1º' },
            { nivel: 3, bab: '+2', hab: '–', magias: '1º' },
            { nivel: 4, bab: '+3', hab: 'Música de Bardo (+1 efeito)', magias: '2º' },
            { nivel: 5, bab: '+3', hab: 'Música de Bardo (+1 efeito)', magias: '2º' },
            { nivel: 6, bab: '+4', hab: '–', magias: '2º' },
            { nivel: 7, bab: '+5', hab: '–', magias: '3º' },
            { nivel: 8, bab: '+6', hab: 'Música de Bardo (+1 efeito)', magias: '3º' },
            { nivel: 9, bab: '+6', hab: '–', magias: '3º' },
            { nivel: 10, bab: '+7', hab: 'Música de Bardo (+1 efeito)', magias: '4º' },
            { nivel: 11, bab: '+8', hab: '–', magias: '4º' },
            { nivel: 12, bab: '+9', hab: 'Música de Bardo (+1 efeito)', magias: '4º' },
            { nivel: 13, bab: '+9', hab: '–', magias: '5º' },
            { nivel: 14, bab: '+10', hab: 'Música de Bardo (+1 efeito)', magias: '5º' },
            { nivel: 15, bab: '+11', hab: '–', magias: '5º' },
            { nivel: 16, bab: '+12', hab: 'Música de Bardo (+1 efeito)', magias: '6º' },
            { nivel: 17, bab: '+12', hab: '–', magias: '6º' },
            { nivel: 18, bab: '+13', hab: 'Música de Bardo (+1 efeito)', magias: '6º' },
            { nivel: 19, bab: '+14', hab: '–', magias: '6º' },
            { nivel: 20, bab: '+15', hab: 'Música de Bardo (+1 efeito)', magias: '6º' },
        ]
    }
    ];

    let currentClasses = [];
    let currentView = 'home'; // 'home', 'list', 'view', 'form'
    let editingClassId = null;

    // ====================================================================
    // 2. FUNÇÕES AUXILIARES E UTILS
    // ====================================================================

    /**
     * Gera um ID único simples.
     * @returns {string}
     */
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

    /**
     * Exibe uma notificação toast.
     * @param {string} message - Mensagem a ser exibida.
     * @param {('success'|'error'|'info')} type - Tipo de notificação.
     */
    const showToast = (message, type) => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type} shadow-lg`;
        toast.textContent = message;
        container.appendChild(toast);

        // Remove após 4 segundos
        setTimeout(() => {
            toast.remove();
        }, 4000);
    };

    /**
     * Retorna o Bônus de Nível Global (Metade do Nível, arredondado para baixo).
     * Regra Extraída de "Benefícios por Nível de Personagem" (CA, Resistências e Dano).
     * @param {number} nivel - Nível do personagem.
     * @returns {string} Bônus global formatado.
     */
    const getGlobalBonus = (nivel) => {
        // Regra: Metade do nível, arredondado para baixo.
        return `+${Math.floor(nivel / 2)}`;
    }
    
    /**
     * Retorna um objeto com os benefícios globais do nível do personagem,
     * tratando Talentos e Aumento de Habilidade para mostrar '-' onde não há concessão.
     * @param {number} nivel - Nível do personagem.
     * @returns {object} { bonusGlobal, talentos, aumentoHab }
     */
    const getGlobalBenefits = (nivel) => {
        const data = globalLevelBenefits.find(b => b.nivel === nivel) || { bonusGlobal: '+0', talentos: 0, aumentoHab: 0 };
        
        // Regra do PDF: Talentos em níveis ímpares.
        // O valor exibido é o TOTAL acumulado.
        const totalTalentos = data.talentos;
        const talentos = nivel % 2 !== 0 ? totalTalentos : '–'; 
        
        // Regra do PDF: Aumento de Habilidade em níveis pares.
        // O valor exibido é o TOTAL acumulado.
        const totalAumentoHab = data.aumentoHab;
        const aumentoHab = nivel % 2 === 0 ? totalAumentoHab : '–'; 

        // O Bônus Global é concedido em todos os níveis e deve ser exibido.
        const bonusGlobal = data.bonusGlobal;
        
        return { bonusGlobal, talentos, aumentoHab };
    }
    

    // ====================================================================
    // 3. DARK MODE (Removido)
    // ====================================================================

    /**
     * Apenas inicializa o sistema no modo claro.
     */
    const initDarkMode = () => {
        // Não faz nada além de garantir que o tema padrão seja o claro.
        // O body já não tem a classe dark-mode.
    };


    // ====================================================================
    // 4. STORAGE (LOCALSTORAGE)
    // ====================================================================

    /**
     * Lógica para Excluir TODOS os dados do LocalStorage e re-inicializar.
     */
    const clearAllData = () => {
        localStorage.removeItem(STORAGE_KEY);
        currentClasses = initialClassesData; // Recarrega os dados de exemplo
        saveClasses();
        currentPage = 1;
        renderClassList();
        setMainView('home');
        showToast('Todos os dados foram excluídos. Dados de exemplo recarregados.', 'success');
    };

    /**
     * Carrega as classes do LocalStorage.
     * Se vazio, carrega os dados de exemplo.
     */
    const loadClasses = () => {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
            try {
                currentClasses = JSON.parse(data);
                // Verifica se dados carregados são válidos e contém a progressão
                if (!Array.isArray(currentClasses) || currentClasses.length === 0 || !currentClasses[0].tabelaProgressao) {
                    showToast('Dados inválidos encontrados. Usando dados de exemplo.', 'error');
                    currentClasses = initialClassesData;
                }
            } catch (e) {
                console.error("Erro ao carregar do LocalStorage:", e);
                showToast('Erro ao carregar classes. Usando dados de exemplo.', 'error');
                currentClasses = initialClassesData;
            }
        } else {
            currentClasses = initialClassesData;
        }

        // Garante que os dados iniciais sejam salvos no primeiro acesso
        saveClasses();
    };

    /**
     * Salva o array de classes no LocalStorage.
     */
    const saveClasses = () => {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentClasses));
        } catch (e) {
            console.error("Erro ao salvar no LocalStorage:", e);
            showToast('Erro ao salvar classes no navegador.', 'error');
        }
    };


    // ====================================================================
    // 5. RENDERIZAÇÃO E UI
    // ====================================================================

    /**
     * Alterna a visualização principal.
     * @param {('home'|'view'|'form')} mode - O modo de visualização.
     */
    const setMainView = (mode) => {
        document.getElementById('tour-ajuda').classList.add('hidden');
        document.getElementById('classe-visualizacao').classList.add('hidden');
        document.getElementById('classe-formulario').classList.add('hidden');
        document.getElementById('view-loader').classList.add('hidden');

        if (mode === 'home') {
            document.getElementById('tour-ajuda').classList.remove('hidden');
        } else if (mode === 'view') {
            document.getElementById('classe-visualizacao').classList.remove('hidden');
        } else if (mode === 'form') {
            document.getElementById('classe-formulario').classList.remove('hidden');
        }
        currentView = mode;
    };

    /**
     * Renderiza o card de uma classe na lista lateral.
     * @param {object} classe - O objeto da classe.
     */
    const renderClassCard = (classe) => {
        const tags = classe.tag ? `<span class="text-xs text-[var(--color-accent)]">${classe.tag.split(',').map(t => `#${t.trim()}`).join(' ')}</span>` : '';
        const dadoVida = `<span class="font-mono font-bold text-xl text-[var(--color-primary)]">${classe.dadosBase.dadoVida}</span>`;

        return `
            <div id="card-${classe.id}" class="class-card card-surface p-4 rounded-xl cursor-pointer hover:shadow-lg transition duration-200 border-l-4 border-[var(--color-primary)]" data-id="${classe.id}">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold">${classe.nome}</h3>
                        ${tags}
                        <p class="text-sm mt-1 text-gray-500">${classe.descricaoCurta.substring(0, 50)}...</p>
                    </div>
                    ${dadoVida}
                </div>
            </div>
        `;
    };

    /**
     * Renderiza a lista completa de classes (com paginação).
     */
    const renderClassList = () => {
        const listaContainer = document.getElementById('lista-classes');
        const paginationControls = document.getElementById('pagination-controls');
        listaContainer.innerHTML = '';
        paginationControls.innerHTML = '';

        const search = document.getElementById('input-busca').value.toLowerCase();
        const sortType = document.getElementById('select-ordenacao').value;

        // 1. FILTRAR
        let filteredClasses = currentClasses.filter(c =>
            c.nome.toLowerCase().includes(search) || (c.tag && c.tag.toLowerCase().includes(search))
        );

        // 2. ORDENAR
        filteredClasses.sort((a, b) => {
            if (sortType === 'alfabetica') return a.nome.localeCompare(b.nome);
            if (sortType === 'dano') {
                const dA = parseInt(a.dadosBase.dadoVida.replace('d', ''));
                const dB = parseInt(b.dadosBase.dadoVida.replace('d', ''));
                return dB - dA; 
            }
            if (sortType === 'bab') {
                const babA = parseInt(a.tabelaProgressao[19].bab.split('+')[1]);
                const babB = parseInt(b.tabelaProgressao[19].bab.split('+')[1]);
                return babB - babA;
            }
            return 0;
        });

        // 3. PAGINAR
        const totalClasses = filteredClasses.length;
        const totalPages = Math.ceil(totalClasses / classesPerPage);
        
        // Garante que a página atual seja válida
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        } else if (totalPages === 0) {
            currentPage = 1;
        } else if (currentPage < 1) {
            currentPage = 1;
        }

        const startIndex = (currentPage - 1) * classesPerPage;
        const endIndex = startIndex + classesPerPage;
        const classesForPage = filteredClasses.slice(startIndex, endIndex);

        // 4. RENDERIZAR LISTA
        const classCountElement = document.getElementById('class-count');
        if (classCountElement) {
            classCountElement.textContent = totalClasses;
        }

        if (classesForPage.length === 0) {
            document.getElementById('estado-vazio').classList.remove('hidden');
        } else {
            document.getElementById('estado-vazio').classList.add('hidden');
            classesForPage.forEach(classe => {
                listaContainer.innerHTML += renderClassCard(classe);
            });
        }
        
        // 5. RENDERIZAR CONTROLES DE PAGINAÇÃO
        if (totalPages > 1) {
            const prevDisabled = currentPage === 1;
            const nextDisabled = currentPage === totalPages;

            paginationControls.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" 
                        class="btn-secondary px-3 py-1 rounded-lg ${prevDisabled ? 'opacity-50 cursor-not-allowed' : ''}" 
                        ${prevDisabled ? 'disabled' : ''}>
                    Anterior
                </button>
                <span class="text-sm">Página ${currentPage} de ${totalPages}</span>
                <button onclick="changePage(${currentPage + 1})" 
                        class="btn-secondary px-3 py-1 rounded-lg ${nextDisabled ? 'opacity-50 cursor-not-allowed' : ''}" 
                        ${nextDisabled ? 'disabled' : ''}>
                    Próxima
                </button>
            `;
        }
    };
    
    /**
     * Altera a página atual e re-renderiza a lista.
     * @param {number} newPage - O número da nova página.
     */
    const changePage = (newPage) => {
        // Obter o número total de páginas (refiltrando/reordenando internamente se necessário)
        const search = document.getElementById('input-busca').value.toLowerCase();
        let filteredClasses = currentClasses.filter(c =>
            c.nome.toLowerCase().includes(search) || (c.tag && c.tag.toLowerCase().includes(search))
        );
        const totalPages = Math.ceil(filteredClasses.length / classesPerPage);

        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderClassList();
            // Scroll to the top of the class list on page change
            document.getElementById('lista-classes-container').scrollTo(0, 0);
        } else if (totalPages === 0) {
             currentPage = 1;
        }
    };


    /**
     * Renderiza a visualização da classe (Ficha).
     * @param {object} classe - O objeto da classe.
     */
    const renderClassView = (classe) => {
        if (!classe) return;

        // 1. Renderiza a Tabela de Progressão
        const tableRows = classe.tabelaProgressao.map(row => {
            const nivelData = getGlobalBenefits(row.nivel);
            
            // Note: graduacoes is removed. BAB is the single source.
            
            // Adiciona labels para o modo mobile
            return `
                <tr class="text-sm">
                    <td data-label="Nível" class="font-bold">${row.nivel}º</td>
                    <!-- Coluna Bônus Global (CA, Resist, Dano) -->
                    <td data-label="Bônus (CA, Resist, Dano)" class="font-bold text-[var(--color-accent)]">${nivelData.bonusGlobal}</td> 
                    
                    <td data-label="BBA">${row.bab}</td> 

                    <!-- Coluna Talentos Global (Mostra '-' nos níveis pares) -->
                    <td data-label="Talentos">${nivelData.talentos}</td> 
                    <!-- Coluna Aumento de Habilidade Global (Mostra '-' nos níveis ímpares) -->
                    <td data-label="Aum. Hab.">${nivelData.aumentoHab}</td>
                    <td data-label="Habilidades" class="text-left font-merriweather">${row.hab || '–'}</td>
                    <td data-label="Magias" class="font-bold">${row.magias || '–'}</td>
                </tr>
            `;
        }).join('');
        
        // Função utilitária para o ícone de informação
        const infoIcon = (tip) => `
            <span class="tooltip ml-1 text-gray-500 hover:text-[var(--color-primary)] cursor-pointer">
                <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="tooltiptext card-surface">${tip}</span>
            </span>
        `;
        
        const tableHTML = `
            <div class="overflow-x-auto my-6 p-4 card-surface rounded-xl">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Tabela de Progressão (Níveis 1-20)</h3>
                <p class="text-xs text-gray-500 mb-2 italic">
                    Esta tabela combina a progressão **da classe** (BBA, Habilidades, Magias) com os **Benefícios Globais do Nível do Personagem** (Bônus, Talentos e Aumento de Habilidade).
                </p>
                <table class="progress-table w-full min-w-[900px] lg:min-w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th>Nível</th>
                            <!-- Coluna Bônus Global -->
                            <th class="bg-blue-100 text-[var(--color-accent)]">Bônus (CA, Resist, Dano) ${infoIcon('Bônus universal para CA, Testes de Resistência (Fort, Ref, Von) e Jogadas de Dano. Calculado como metade do nível (arredondado para baixo).')}</th>
                            <!-- BBA da Classe -->
                            <th>BBA ${infoIcon('Bônus Base de Ataque.')}</th>
                            <!-- Colunas Globais do PDF pág 45 -->
                            <th class="bg-green-100 text-green-700">Talentos ${infoIcon('Total de Talentos acumulados. Concedidos em níveis impares.')}</th>
                            <th class="bg-green-100 text-green-700">Aum. Hab. ${infoIcon('Total de Aumentos de Habilidade acumulados. Concedidos em níveis pares.')}</th>
                            <!-- Colunas da Classe -->
                            <th class="w-[30%]">Habilidades (Resumo)</th>
                            <th>Magias ${infoIcon('Nível máximo de magia que o personagem pode lançar neste nível (0º a 9º).')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        `;

        // 2. Renderiza as Habilidades
        const habsHTML = classe.habilidadesEspeciais.map(hab => `
            <div class="mb-3 p-3 rounded-lg border border-gray-200 hover:shadow-md transition">
                <p class="font-bold text-base text-[var(--color-accent)]">${hab.nivel}º Nível: ${hab.nome}</p>
                ${hab.prerequisito ? `<p class="text-xs italic text-red-500">Pré-requisito: ${hab.prerequisito}</p>` : ''}
                <p class="text-sm mt-1">${hab.descricao}</p>
            </div>
        `).join('');

        // 3. Renderiza o Background (Colapsável)
        const renderBackgroundSection = (title, content) => content ? `
            <details class="mb-3 p-3 rounded-xl card-surface border border-gray-200">
                <summary class="font-semibold cursor-pointer text-[var(--color-primary)]">${title}</summary>
                <div class="background-section text-sm mt-2">${content.split('\n').map(p => `<p>${p.trim()}</p>`).join('')}</div>
            </details>
        ` : '';

        const backgroundHTML = `
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Contexto e Roleplay</h3>
                ${renderBackgroundSection('Tendência', classe.background.tendencia)}
                ${renderBackgroundSection('Religião', classe.background.religiao)}
                ${renderBackgroundSection('Aventuras', classe.background.aventuras)}
                ${renderBackgroundSection('Histórico', classe.background.historico)}
                ${renderBackgroundSection('Raças', classe.background.racas)}
                ${renderBackgroundSection('Outras Classes', classe.background.outrasClasses)}
            </div>
        `;

        // 4. Renderiza a seção de Magia (se existir)
        const magiaHTML = classe.magia ? `
            <div class="card-surface p-4 rounded-xl mt-6 border-l-4 border-[var(--color-accent)]">
                <h3 class="text-lg font-semibold mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002.944 12c-.499 1.45.687 2.898 1.95 3.197.35.084.706.126 1.062.126.758 0 1.498-.15 2.193-.443l.534-.221a4 4 0 002.724-.038 4 4 0 002.724.038l.534.221c.695.293 1.435.443 2.193.443.356 0 .712-.042 1.062-.126 1.263-.299 2.45-1.747 1.95-3.197A12.001 12.001 0 0021.618 8.984z"></path></svg>
                    Magia (${classe.magia.tipo})
                </h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <p><strong>Habilidade Chave:</strong> ${classe.magia.habilidadeChave}</p>
                    <p><strong>Preparação:</strong> ${classe.magia.preparacao}</p>
                    <p><strong>PM Inicial:</strong> ${classe.dadosBase.pmInicial}</p>
                    <p><strong>PM/Nível:</strong> +${classe.dadosBase.pmPorNivel}</p>
                    <p><strong>Magias 0º:</strong> ${classe.magia.magiasConhecidasNivel0}</p>
                    <p><strong>Magias 1º:</strong> ${classe.magia.magiasConhecidasNivel1Formula}</p>
                </div>
            </div>
        ` : '';


        // 5. Estrutura Principal da Ficha
        const viewHTML = `
            <div class="card-surface p-6 rounded-xl">
                <div class="flex justify-between items-start border-b pb-4 mb-4">
                    <div>
                        <h2 class="text-3xl font-extrabold font-merriweather text-[var(--color-primary)]">${classe.nome}</h2>
                        <p class="text-sm font-light text-gray-500">${classe.tipo} | Tags: ${classe.tag || 'N/A'}</p>
                        <p class="mt-2 text-base italic">${classe.descricaoCurta}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn-secondary p-2 rounded-full" onclick="handleDuplicate('${classe.id}')" title="Duplicar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v7a4 4 0 004 4h1a3 3 0 003-3V5a3 3 0 00-3-3H9a3 3 0 00-3 3v2m0 0h3"></path></svg>
                        </button>
                        <button class="btn-primary p-2 rounded-full" onclick="startEditClass('${classe.id}')" title="Editar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button class="btn-secondary p-2 rounded-full text-red-500 border-red-500" onclick="confirmDelete('${classe.id}', '${classe.nome}')" title="Excluir">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Estatísticas Base -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center border-b pb-4">
                    <div class="p-2 card-surface rounded-lg">
                        <p class="text-xs text-gray-500">Dado de Vida</p>
                        <p class="text-xl font-extrabold text-[var(--color-primary)]">${classe.dadosBase.dadoVida}</p>
                    </div>
                    <div class="p-2 card-surface rounded-lg">
                        <p class="text-xs text-gray-500">PV Inicial</p>
                        <p class="text-xl font-extrabold">${classe.dadosBase.pvInicial}</p>
                    </div>
                    <div class="p-2 card-surface rounded-lg">
                        <p class="text-xs text-gray-500">Perícias/Nível</p>
                        <p class="text-xl font-extrabold">${classe.dadosBase.periciasPorNivel}</p>
                    </div>
                    <div class="p-2 card-surface rounded-lg">
                        <p class="text-xs text-gray-500">PM/Nível</p>
                        <p class="text-xl font-extrabold text-[var(--color-accent)]">+${classe.dadosBase.pmPorNivel}</p>
                    </div>
                </div>

                ${magiaHTML}

                <!-- Habilidades e Progressão (Componentes Específicos) -->
                ${tableHTML}

                <h3 class="text-lg font-semibold mt-8 mb-3 border-b pb-2">Habilidades de Classe</h3>
                ${habsHTML}

                <h3 class="text-lg font-semibold mt-8 mb-3 border-b pb-2">Detalhes da Classe</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="font-semibold mb-1">Talentos Adicionais:</p>
                        <ul class="list-disc list-inside ml-2">
                            ${classe.dadosBase.talentosAdicionais.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">Perícias de Classe:</p>
                        <ul class="list-disc list-inside ml-2">
                            ${classe.dadosBase.periciasDeClasse.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                ${backgroundHTML}

                <div class="flex justify-end mt-6 space-x-3">
                    <button class="btn-secondary px-4 py-2 rounded-lg" onclick="exportClassJSON('${classe.id}', '${classe.nome}')">Exportar JSON</button>
                    <button class="btn-secondary px-4 py-2 rounded-lg" onclick="copyClassToClipboard('${classe.id}')">Copiar Texto</button>
                </div>
            </div>
        `;

        document.getElementById('classe-visualizacao').innerHTML = viewHTML;
        setMainView('view');
    };

    // ====================================================================
    // 6. FORMULÁRIO (CRUD)
    // ====================================================================

    /**
     * Limpa as graduações do BBA, mantendo apenas o bônus principal (ex: +20/+15/+10/+5 -> +20).
     * Esta função agora opera sobre todas as classes cadastradas no LocalStorage.
     */
    const clearAllClassesBbaGraduations = () => {
        showToast('A limpeza de graduações globais foi desativada, pois a tabela agora tem colunas separadas para BBA e Graduações.', 'info');
        // A função original foi removida do código, mas mantemos o listener do botão
        // para informar o usuário da mudança no fluxo de dados.
    };


    /**
     * Gera o HTML do formulário.
     */
    const renderForm = (classe = null) => {
        const isEdit = !!classe;
        const data = classe || {
            nome: '', tipo: '', tag: '', descricaoCurta: '',
            dadosBase: { dadoVida: 'd8', pvInicial: 12, pvPorNivel: 3, periciasPorNivel: '2 + Mod. Int', pmInicial: '0', pmPorNivel: 0, talentosAdicionais: [''], periciasDeClasse: [''] },
            background: { aventuras: '', tendencia: '', religiao: '', historico: '', racas: '', outrasClasses: '' },
            magia: null,
            // ATUALIZAÇÃO: BBA é campo único
            tabelaProgressao: Array.from({ length: 20 }, (_, i) => ({
                nivel: i + 1, bab: '', hab: '', magias: ''
            }))
        };
        
        // Garante que os dados antigos sejam migrados
        if (classe) {
            data.tabelaProgressao = data.tabelaProgressao.map((row, i) => {
                const oldRow = classe.tabelaProgressao[i] || {};
                let bab = oldRow.bab || '';
                
                // Se a classe antiga tinha 'graduacoes' separada, juntamos ao BAB
                // Como não queremos criar regras implícitas, voltamos a confiar no BAB como campo completo.
                // Esta lógica não é ideal, mas garante que classes importadas com o campo 'graduacoes' 
                // não percam a informação se o campo 'bab' foi limpo anteriormente.
                // NOVO CÓDIGO: Se o BAB for um valor simples e 'graduacoes' existir, juntamos na importação.
                if (oldRow.graduacoes && oldRow.graduacoes !== '-' && !bab.includes('/')) {
                     bab = bab + oldRow.graduacoes;
                }
                
                return {
                    nivel: row.nivel,
                    bab: bab,
                    hab: oldRow.hab || '',
                    magias: oldRow.magias || '',
                    // Mantém B/R para referência (Seção 2)
                    fort: oldRow.fort || '', 
                    ref: oldRow.ref || '', 
                    von: oldRow.von || ''
                };
            });
        }


        const habsForm = data.habilidadesEspeciais.map((hab, index) => `
            <div class="flex flex-col sm:flex-row gap-2 p-3 border rounded-lg mb-2 bg-gray-50 relative">
                <input type="number" min="1" max="20" placeholder="Nível" value="${hab.nivel}" class="w-full sm:w-1/6" data-hab-field="nivel" data-index="${index}">
                <input type="text" placeholder="Nome da Habilidade" value="${hab.nome}" class="w-full sm:w-2/6" data-hab-field="nome" data-index="${index}">
                <input type="text" placeholder="Pré-requisito (Opcional)" value="${hab.prerequisito || ''}" class="w-full sm:w-2/6" data-hab-field="prerequisito" data-index="${index}">
                <button type="button" class="text-red-500 w-full sm:w-1/6 p-2 rounded-md hover:bg-red-100" onclick="removeHabilidade(${index})">Remover</button>
                <textarea placeholder="Descrição Detalhada" rows="2" class="w-full mt-2 sm:col-span-4" data-hab-field="descricao" data-index="${index}">${hab.descricao}</textarea>
            </div>
        `).join('');

        // Função utilitária para o ícone de informação no formulário
        const formInfoIcon = (tip) => `
            <span class="tooltip ml-1 text-gray-500 hover:text-[var(--color-primary)] cursor-pointer">
                <svg class="w-3 h-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="tooltiptext card-surface !w-48 !left-1/2 !-ml-24">${tip}</span>
            </span>
        `;
        
        const tableRowsForm = data.tabelaProgressao.map((row, index) => {
            const nivel = index + 1;
            const nivelData = getGlobalBenefits(nivel);
            
            // Campos B/R (fort, ref, von) não são mais usados na progressão principal,
            // mas mantemos o código para acessar os valores de referência da Seção 2
            const fortValue = row.fort || '';
            const refValue = row.ref || '';
            const vonValue = row.von || '';
            
            return `
                <tr class="text-sm">
                    <td class="font-bold p-1">${nivel}º</td>
                    <!-- Bônus Global (CA, Resist, Dano) -->
                    <td class="font-bold text-[var(--color-accent)]">${nivelData.bonusGlobal}</td> 
                    
                    <td><input type="text" value="${row.bab}" data-table-field="bab" data-level="${nivel}" class="w-full text-center p-1" placeholder="+N/+N"></td>

                    <!-- Progressão Global (Talentos) -->
                    <td>${nivelData.talentos}</td> 
                    <!-- Progressão Global (Aumento de Habilidade) -->
                    <td>${nivelData.aumentoHab}</td>
                    
                    <td><input type="text" value="${row.hab}" data-table-field="hab" data-level="${nivel}" class="w-full text-left p-1"></td>
                    <td><input type="text" value="${row.magias}" data-table-field="magias" data-level="${nivel}" class="w-full text-center p-1"></td>
                </tr>
            `;
        }).join('');

        const formHTML = `
            <div class="card-surface p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-6">${isEdit ? `Editar ${classe.nome}` : 'Nova Classe (Homebrew)'}</h2>
                <form id="class-form">

                    <!-- SEÇÃO 1: INFORMAÇÕES BÁSICAS -->
                    <div class="mb-8 p-4 border rounded-xl">
                        <h3 class="text-xl font-semibold mb-3 border-b pb-2 text-[var(--color-accent)]">1. Informações Básicas</h3>
                        <label class="block mb-2 font-medium">Nome da Classe*</label>
                        <input type="text" id="form-nome" value="${data.nome}" required class="w-full mb-4">

                        <label class="block mb-2 font-medium">Tipo de Classe (Ex: Guerreiro, Conjurador, Híbrido)*</label>
                        <input type="text" id="form-tipo" value="${data.tipo}" required class="w-full mb-4">

                        <label class="block mb-2 font-medium">Tags (Separadas por vírgula, Ex: Causa Dano, Suporte, Combate)</label>
                        <input type="text" id="form-tag" value="${data.tag || ''}" class="w-full mb-4">

                        <label class="block mb-2 font-medium">Descrição Curta (Máx 100 caracteres)*</label>
                        <textarea id="form-descricaoCurta" required class="w-full" rows="2">${data.descricaoCurta}</textarea>
                    </div>

                    <!-- SEÇÃO 2: ATRIBUTOS E REQUISITOS -->
                    <div class="mb-8 p-4 border rounded-xl">
                        <h3 class="text-xl font-semibold mb-3 border-b pb-2 text-[var(--color-accent)]">2. Atributos Base</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block mb-1 font-medium text-sm">Dado de Vida (Ex: d8)*</label><input type="text" id="form-dadoVida" value="${data.dadosBase.dadoVida}" required class="w-full"></div>
                            <div><label class="block mb-1 font-medium text-sm">PV Inicial (Nível 1)*</label><input type="number" id="form-pvInicial" value="${data.dadosBase.pvInicial}" required class="w-full"></div>
                            <div><label class="block mb-1 font-medium text-sm">PV por Nível (Após o 1º)*</label><input type="number" id="form-pvPorNivel" value="${data.dadosBase.pvPorNivel}" required class="w-full"></div>
                            <div><label class="block mb-1 font-medium text-sm">Perícias por Nível (Ex: 2 + Mod. Int)*</label><input type="text" id="form-periciasPorNivel" value="${data.dadosBase.periciasPorNivel}" required class="w-full"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block mb-1 font-medium text-sm">PM Inicial (Ex: 1 + Mod. Sab)*</label><input type="text" id="form-pmInicial" value="${data.dadosBase.pmInicial}" required class="w-full"></div>
                            <div><label class="block mb-1 font-medium text-sm">PM por Nível*</label><input type="number" id="form-pmPorNivel" value="${data.dadosBase.pmPorNivel}" required class="w-full"></div>
                        </div>

                        <div class="mt-4">
                            <label class="block mb-1 font-medium text-sm">Talentos Adicionais (Um por linha)</label>
                            <textarea id="form-talentosAdicionais" class="w-full" rows="3">${data.dadosBase.talentosAdicionais.join('\n')}</textarea>
                        </div>

                        <div class="mt-4">
                            <label class="block mb-1 font-medium text-sm">Perícias de Classe (Um por linha, no formato Perícia (Habilidade))</label>
                            <textarea id="form-periciasDeClasse" class="w-full" rows="3">${data.dadosBase.periciasDeClasse.join('\n')}</textarea>
                        </div>
                        
                        <!-- Campos de base de resistência removidos, mas mantemos o input de texto para customização opcional -->
                        <div class="mt-6 border-t pt-4">
                            <p class="font-medium text-sm mb-2">Progressão Base de Resistência (Opcional - B/R):</p>
                            <div class="grid grid-cols-3 gap-3">
                                <div><label class="block mb-1 text-xs">Fort Base (Ex: B ou R)</label><input type="text" id="form-fort-base" value="${data.tabelaProgressao[0].fort || ''}" class="w-full text-center p-1" placeholder="B ou R"></div>
                                <div><label class="block mb-1 text-xs">Ref Base (Ex: B ou R)</label><input type="text" id="form-ref-base" value="${data.tabelaProgressao[0].ref || ''}" class="w-full text-center p-1" placeholder="B ou R"></div>
                                <div><label class="block mb-1 text-xs">Von Base (Ex: B ou R)</label><input type="text" id="form-von-base" value="${data.tabelaProgressao[0].von || ''}" class="w-full text-center p-1" placeholder="B ou R"></div>
                                <p class="text-xs text-gray-500 italic col-span-3 mt-1">Estes campos não afetam a tabela final (que usa o Bônus Global), mas podem ser usados para referência e exportação da progressão B/R.</p>
                            </div>
                        </div>
                    </div>

                    <!-- SEÇÃO 3: HABILIDADES ESPECIAIS (LISTA) -->
                    <div class="mb-8 p-4 border rounded-xl">
                        <h3 class="text-xl font-semibold mb-3 border-b pb-2 text-[var(--color-accent)]">3. Habilidades Especiais</h3>
                        <div id="habilidades-container">
                            ${habsForm}
                        </div>
                        <button type="button" class="btn-secondary w-full px-4 py-2 rounded-lg mt-3" onclick="addHabilidade()">+ Adicionar Habilidade</button>
                        <p class="mt-4 text-sm italic text-gray-500">As habilidades devem ser referenciadas na Tabela de Progressão (Seção 4) para a ficha final.</p>
                    </div>

                    <!-- SEÇÃO 4: TABELA DE PROGRESSÃO -->
                    <div class="mb-8 p-4 border rounded-xl overflow-x-auto">
                        <div class="flex justify-between items-center mb-3 border-b pb-2">
                             <h3 class="text-xl font-semibold text-[var(--color-accent)]">4. Tabela de Progressão (1º ao 20º)</h3>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">
                            A progressão **Bônus (CA, Resist, Dano)**, **Talentos** e **Aumento de Habilidade** é gerada automaticamente com base na tabela global do PDF.
                        </p>
                        <table class="progress-table w-full min-w-[800px] rounded-lg overflow-hidden">
                            <thead>
                                <tr>
                                    <th>Nível</th>
                                    <!-- NOVA COLUNA GLOBAL -->
                                    <th class="bg-blue-100 text-[var(--color-accent)]">Bônus (CA, Resist, Dano)</th>
                                    <!-- BBA SEPARADO (Agora único) -->
                                    <th><div class="form-th-content">BBA ${formInfoIcon('Bônus Base de Ataque.')}</div></th>
                                    <!-- Graduações (REMOVIDO) -->
                                    <!-- NOVAS COLUNAS GLOBAIS -->
                                    <th class="bg-green-100 text-green-700">Talentos</th>
                                    <th class="bg-green-100 text-green-700">Aum. Hab.</th>
                                    <!-- FIM NOVAS COLUNAS GLOBAIS -->
                                    <th class="w-[30%]">Habilidades (Resumo)</th>
                                    <th><div class="form-th-content">Magias ${formInfoIcon('Nível máximo de magia que adquire (ex: 3º, ou 0º,1º).')}</div></th>
                                </tr>
                            </thead>
                            <tbody id="progressao-body">
                                ${tableRowsForm}
                            </tbody>
                        </table>
                    </div>

                    <!-- SEÇÃO 5: TEXTOS DESCRITIVOS (BACKGROUND) -->
                    <div class="mb-8 p-4 border rounded-xl">
                        <h3 class="text-xl font-semibold mb-3 border-b pb-2 text-[var(--color-accent)]">5. Textos Descritivos (Roleplay)</h3>
                        <label class="block mb-1 font-medium text-sm">Tendência</label><textarea id="form-tendencia" class="w-full mb-4" rows="2">${data.background.tendencia}</textarea>
                        <label class="block mb-1 font-medium text-sm">Religião</label><textarea id="form-religiao" class="w-full mb-4" rows="2">${data.background.religiao}</textarea>
                        <label class="block mb-1 font-medium text-sm">Aventuras</label><textarea id="form-aventuras" class="w-full mb-4" rows="3">${data.background.aventuras}</textarea>
                        <label class="block mb-1 font-medium text-sm">Histórico</label><textarea id="form-historico" class="w-full mb-4" rows="3">${data.background.historico || ''}</textarea>
                        <label class="block mb-1 font-medium text-sm">Raças</label><textarea id="form-racas" class="w-full mb-4" rows="3">${data.background.racas || ''}</textarea>
                        <label class="block mb-1 font-medium text-sm">Outras Classes</label><textarea id="form-outrasClasses" class="w-full mb-4" rows="3">${data.background.outrasClasses || ''}</textarea>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="setMainView('home')">Cancelar</button>
                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg">${isEdit ? 'Salvar Edição' : 'Criar Classe'}</button>
                    </div>
                </form>
            </div>
        `;

        document.getElementById('classe-formulario').innerHTML = formHTML;

        // Re-popula e ajusta o formulário de habilidades
        document.getElementById('habilidades-container').innerHTML = data.habilidadesEspeciais.map((hab, index) => {
            return generateHabilidadeHtml(hab, index);
        }).join('');

        // Preenche o campo de magia se existir (para Classes Conjuradoras)
        // OBS: Para simplificar o formulário, o usuário deverá adicionar a magia manualmente
        // Vou apenas garantir que a interface de Magia na Visualização funcione, baseado em PM/Nível etc.

        document.getElementById('class-form').onsubmit = handleFormSubmit;
        setMainView('form');
    };

    /**
     * Gera o HTML para uma única habilidade (para o formulário).
     * @param {object} hab - O objeto da habilidade.
     * @param {number} index - O índice no array de habilidades.
     */
    const generateHabilidadeHtml = (hab, index) => {
        return `
            <div class="flex flex-wrap gap-2 p-3 border rounded-lg mb-2 bg-gray-50 relative" data-index="${index}">
                <input type="number" min="1" max="20" placeholder="Nível" value="${hab.nivel}" class="w-full sm:w-[calc(16.666%-0.5rem)]" data-hab-field="nivel" data-index="${index}">
                <input type="text" placeholder="Nome da Habilidade" value="${hab.nome}" class="w-full sm:w-[calc(33.333%-0.5rem)]" data-hab-field="nome" data-index="${index}">
                <input type="text" placeholder="Pré-requisito (Opcional)" value="${hab.prerequisito || ''}" class="w-full sm:w-[calc(33.333%-0.5rem)]" data-hab-field="prerequisito" data-index="${index}">
                <button type="button" class="text-red-500 w-full sm:w-[calc(16.666%-0.5rem)] p-1 rounded-md hover:bg-red-100" onclick="removeHabilidade(${index})">Remover</button>
                <textarea placeholder="Descrição Detalhada" rows="2" class="w-full mt-2" data-hab-field="descricao" data-index="${index}">${hab.descricao}</textarea>
            </div>
        `;
    };

    /**
     * Adiciona um novo campo de habilidade ao formulário.
     */
    const addHabilidade = () => {
        const container = document.getElementById('habilidades-container');
        const index = container.children.length;
        const newHab = { nome: '', nivel: 1, descricao: '', prerequisito: '' };
        container.insertAdjacentHTML('beforeend', generateHabilidadeHtml(newHab, index));
    };

    /**
     * Remove um campo de habilidade do formulário.
     * @param {number} index - O índice da habilidade a ser removida.
     */
    const removeHabilidade = (index) => {
        document.querySelector(`#habilidades-container > div[data-index="${index}"]`).remove();
    };


    // ====================================================================
    // 7. LÓGICA DE PERSISTÊNCIA E VALIDAÇÃO
    // ====================================================================

    /**
     * Lida com o envio do formulário.
     * @param {Event} event - O evento de envio.
     */
    const handleFormSubmit = (event) => {
        event.preventDefault();

        // 1. Coleta e Valida Dados Base
        const nome = document.getElementById('form-nome').value.trim();
        const descricaoCurta = document.getElementById('form-descricaoCurta').value.trim();
        const dadoVida = document.getElementById('form-dadoVida').value.trim();
        const pvInicial = parseInt(document.getElementById('form-pvInicial').value);
        const pvPorNivel = parseInt(document.getElementById('form-pvPorNivel').value);
        const pmInicial = document.getElementById('form-pmInicial').value.trim();
        const pmPorNivel = parseInt(document.getElementById('form-pmPorNivel').value);

        // Campos de B/R de Referência
        const fortBase = document.getElementById('form-fort-base').value.trim();
        const refBase = document.getElementById('form-ref-base').value.trim();
        const vonBase = document.getElementById('form-von-base').value.trim();


        if (!nome || !descricaoCurta || !dadoVida || isNaN(pvInicial) || isNaN(pvPorNivel) || !pmInicial || isNaN(pmPorNivel)) {
            showToast('Por favor, preencha todos os campos obrigatórios na Seção 1 e 2.', 'error');
            return;
        }

        // 2. Coleta Habilidades
        const habilidadesEspeciais = Array.from(document.querySelectorAll('#habilidades-container > div')).map(div => ({
            nome: div.querySelector('[data-hab-field="nome"]').value.trim(),
            nivel: parseInt(div.querySelector('[data-hab-field="nivel"]').value),
            descricao: div.querySelector('[data-hab-field="descricao"]').value.trim(),
            prerequisito: div.querySelector('[data-hab-field="prerequisito"]').value.trim() || null
        })).filter(h => h.nome && h.descricao);

        // 3. Coleta Tabela de Progressão
        const tabelaProgressao = Array.from(document.querySelectorAll('#progressao-body tr')).map(row => {
            const nivel = parseInt(row.querySelector('[data-table-field="bab"]').dataset.level);
            return {
                nivel: nivel,
                bab: row.querySelector('[data-table-field="bab"]').value.trim(),
                hab: row.querySelector('[data-table-field="hab"]').value.trim(),
                magias: row.querySelector('[data-table-field="magias"]').value.trim(),
                // Adicionando B/R base da classe para rastreabilidade
                fort: fortBase, 
                ref: refBase, 
                von: vonBase,
            };
        });

        // 4. Cria o objeto final da classe
        const newClass = {
            id: editingClassId || generateId(),
            nome: nome,
            tipo: document.getElementById('form-tipo').value.trim(),
            tag: document.getElementById('form-tag').value.trim(),
            descricaoCurta: descricaoCurta,
            background: {
                tendencia: document.getElementById('form-tendencia').value.trim(),
                religiao: document.getElementById('form-religiao').value.trim(),
                aventuras: document.getElementById('form-aventuras').value.trim(),
                historico: document.getElementById('form-historico').value.trim(),
                racas: document.getElementById('form-racas').value.trim(),
                outrasClasses: document.getElementById('form-outrasClasses').value.trim(),
            },
            dadosBase: {
                dadoVida: dadoVida,
                pvInicial: pvInicial,
                pvPorNivel: pvPorNivel,
                periciasPorNivel: document.getElementById('form-periciasPorNivel').value.trim(),
                pmInicial: pmInicial,
                pmPorNivel: pmPorNivel,
                talentosAdicionais: document.getElementById('form-talentosAdicionais').value.split('\n').map(t => t.trim()).filter(t => t),
                periciasDeClasse: document.getElementById('form-periciasDeClasse').value.split('\n').map(p => p.trim()).filter(p => p)
            },
            magia: (pmPorNivel > 0 || pmInicial !== '0') ? {
                tipo: 'A definir/Manual', // Simplificando a extração da magia para focar na tabela principal
                habilidadeChave: 'A definir/Manual',
                magiasConhecidasNivel0: 0,
                ganhoMagiasPorNivel: 0,
                preparacao: 'A definir/Manual',
            } : null,
            habilidadesEspeciais: habilidadesEspeciais,
            tabelaProgressao: tabelaProgressao
        };

        // 5. Salva (CRUD: Update ou Create)
        if (editingClassId) {
            const index = currentClasses.findIndex(c => c.id === editingClassId);
            if (index !== -1) {
                currentClasses[index] = newClass;
                showToast(`Classe ${newClass.nome} atualizada com sucesso!`, 'success');
            }
        } else {
            currentClasses.push(newClass);
            showToast(`Classe ${newClass.nome} criada com sucesso!`, 'success');
        }

        editingClassId = null;
        saveClasses();
        // Resetar para a primeira página ao criar/editar uma classe
        currentPage = 1; 
        renderClassList();
        renderClassView(newClass);
    };

    /**
     * Inicia a criação de uma nova classe.
     */
    const startNewClass = () => {
        editingClassId = null;
        renderForm();
    };

    /**
     * Inicia a edição de uma classe existente.
     * @param {string} id - O ID da classe a ser editada.
     */
    const startEditClass = (id) => {
        const classe = currentClasses.find(c => c.id === id);
        if (classe) {
            editingClassId = id;
            renderForm(classe);
        } else {
            showToast('Classe não encontrada para edição.', 'error');
        }
    };

    /**
     * Lida com a deleção de uma classe, solicitando confirmação.
     * @param {string} id - O ID da classe a ser deletada.
     * @param {string} nome - O nome da classe.
     */
    const confirmDelete = (id, nome) => {
        showModal({
            title: `Excluir Classe: ${nome}`,
            message: `Tem certeza de que deseja excluir permanentemente a classe ${nome}? Esta ação é irreversível.`,
            onConfirm: () => deleteClass(id)
        });
    };

    /**
     * Executa a deleção da classe.
     * @param {string} id - O ID da classe a ser deletada.
     */
    const deleteClass = (id) => {
        const index = currentClasses.findIndex(c => c.id === id);
        if (index !== -1) {
            const nome = currentClasses[index].nome;
            currentClasses.splice(index, 1);
            saveClasses();
            // Após excluir, tentar manter a página atual, ou voltar para a última se necessário
            renderClassList();
            setMainView('home');
            showToast(`Classe ${nome} excluída com sucesso.`, 'success');
        } else {
            showToast('Classe não encontrada.', 'error');
        }
    };
    
    /**
     * Confirma e exclui todos os dados salvos.
     */
    const confirmClearAllData = () => {
        showModal({
            title: 'EXCLUIR TODOS OS DADOS',
            message: 'ATENÇÃO: Você tem certeza que deseja apagar TODAS as classes salvas no LocalStorage, incluindo as de exemplo? Esta ação é IRREVERSÍVEL.',
            onConfirm: clearAllData
        });
    };


    /**
     * Duplica uma classe.
     * @param {string} id - O ID da classe a ser duplicada.
     */
    const handleDuplicate = (id) => {
        const original = currentClasses.find(c => c.id === id);
        if (original) {
            const duplicated = JSON.parse(JSON.stringify(original));
            duplicated.id = generateId();
            duplicated.nome = `Cópia de ${original.nome}`;
            currentClasses.push(duplicated);
            saveClasses();
            // Resetar para a primeira página para mostrar a nova cópia
            currentPage = 1;
            renderClassList();
            showToast(`Classe ${original.nome} duplicada como "${duplicated.nome}".`, 'info');
            renderClassView(duplicated);
        }
    };


    // ====================================================================
    // 8. FUNCIONALIDADES AVANÇADAS (IMPORT/EXPORT/COPY)
    // ====================================================================

    /**
     * Exporta todas as classes salvas em um arquivo JSON.
     */
    const exportAllClassesJSON = () => {
        if (currentClasses.length === 0) {
            showToast('Não há classes para exportar.', 'info');
            return;
        }

        try {
            // Ajusta o JSON para incluir o B/R da classe para a exportação
            const exportClasses = currentClasses.map(c => {
                 const { fort, ref, von, ...progress } = c.tabelaProgressao[0];
                 const baseProgress = { fort, ref, von };
                 return { ...c, progressoBaseResist: baseProgress };
            });
            
            const dataStr = JSON.stringify(currentClasses, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `torg_classes_export_${new Date().toISOString().slice(0, 10)}.json`;

            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', exportFileDefaultName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Todas as classes exportadas com sucesso!', 'success');
            lastImportError = { 
                message: 'Última Ação: Exportação bem-sucedida (teoricamente). Se o download falhou, verifique as políticas de segurança do seu navegador (pop-ups/downloads automáticos).', 
                content: 'Nenhum erro síncrono capturado.' 
            };

        } catch (e) {
            console.error("Erro ao exportar classes:", e);
            showToast(`Erro ao exportar: ${e.message}. Verifique os logs.`, 'error');
            // Atualiza o log de erro para o visualizador
            lastImportError = { 
                message: `ERRO DE EXPORTAÇÃO: ${e.message}`, 
                content: e.stack || e.toString() 
            };
            return;
        }
    };

    /**
     * Exporta uma única classe como arquivo JSON.
     */
    const exportClassJSON = (id, nome) => {
        const classe = currentClasses.find(c => c.id === id);
        if (!classe) {
            showToast('Classe não encontrada para exportação.', 'error');
            return;
        }

        const dataStr = JSON.stringify(classe, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `torg_class_${nome.toLowerCase().replace(/[^a-z0-9]/g, '_')}.json`;

        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', exportFileDefaultName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    /**
     * Tenta limpar o JSON de comentários, chaves sem aspas duplas e **vírgulas finais (trailing commas)**.
     * @param {string} text - O JSON bruto.
     * @returns {string} O JSON (potencialmente) corrigido.
     */
    const cleanJsonString = (text) => {
        // 1. Remove comentários de linha única (//)
        let cleaned = text.replace(/\/\/.*$/gm, '');
        
        // 2. Tenta remover **trailing commas** em objetos e arrays:
        // Procura por uma vírgula (,) seguida opcionalmente por espaços (\s*), 
        // seguida por um caractere de fechamento de bloco (] ou })
        // O $1 garante que o caractere de fechamento seja mantido.
        cleaned = cleaned.replace(/,\s*([\]}])/g, '$1'); 
        
        // 3. Remove quebras de linha/espaços em excesso (após remoção de vírgulas, para normalizar)
        cleaned = cleaned.trim();
        
        // 4. Tenta envolver as chaves de objeto que não estão entre aspas duplas (key: value)
        cleaned = cleaned.replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
        
        return cleaned;
    }
    
    /**
     * Processa um único arquivo JSON lido.
     * @param {string} fileName - Nome do arquivo para log.
     * @param {string} content - Conteúdo do arquivo.
     * @param {object} stats - Objeto de estatísticas de importação.
     */
    const processSingleFile = (fileName, content, stats) => {
        const cleanedContent = cleanJsonString(content);
        
        try {
            const importedData = JSON.parse(cleanedContent);
            let classesToImport = [];

            if (Array.isArray(importedData)) {
                classesToImport = importedData;
            } else if (typeof importedData === 'object' && importedData.nome) {
                classesToImport = [importedData];
            } else {
                throw new Error('Formato JSON inválido. Esperado um array de classes ou um objeto de classe única.');
            }

            classesToImport.forEach(c => {
                const className = c.nome ? c.nome.trim() : 'Nome Desconhecido';
                
                // Validação de Duplicados: Verifica se o nome da classe JÁ existe
                const isDuplicate = currentClasses.some(existing => existing.nome.toLowerCase() === className.toLowerCase());
                
                if (isDuplicate) {
                    stats.duplicates.push(className);
                } else if (className && c.tabelaProgressao && c.tabelaProgressao.length === 20) {
                    // Adiciona nova classe
                    c.id = generateId();
                    
                    // Lógica de sanitização: garantir que o campo 'bab' é a única fonte
                    c.tabelaProgressao = c.tabelaProgressao.map(row => {
                        let bab = row.bab || '';
                        
                        // SANITIZAÇÃO: Remove graduações se a classe antiga as tinha separadamente
                        // Se 'graduacoes' existe no JSON importado, juntamos no BAB
                        if (row.graduacoes && row.graduacoes !== '-' && !bab.includes('/')) {
                            bab = bab + row.graduacoes;
                        }
                        
                        // Remove o campo 'graduacoes' para evitar confusão de dados
                        delete row.graduacoes; 
                        
                        return { ...row, bab: bab };
                    });
                    
                    currentClasses.push(c);
                    stats.importedCount++;
                    stats.importedNames.push(className);
                } else {
                    stats.failures.push({ name: className, file: fileName, reason: 'Dados incompletos ou faltando Tabela de Progressão (20 níveis).' });
                }
            });

        } catch (error) {
            // Captura falhas de parsing de JSON
            stats.fileFailures.push({ 
                file: fileName, 
                message: error.message,
                content: cleanedContent
            });
        }
    };
    

    /**
     * Lida com a importação de classes de um arquivo JSON.
     */
    const handleImportClasses = (event) => {
        const files = event.target.files;
        if (files.length === 0) return;
        
        // Estatísticas de importação para o log final
        const importStats = {
            importedCount: 0,
            importedNames: [],
            duplicates: [],
            failures: [], // Classes com dados incompletos
            fileFailures: [] // Arquivos que falharam no parsing (erro JSON)
        };
        
        let filesProcessed = 0;
        
        // Função que lê e processa um arquivo
        const readAndProcessFile = (file) => {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    processSingleFile(file.name, e.target.result, importStats);
                    resolve();
                };
                reader.onerror = () => {
                    importStats.fileFailures.push({ 
                        file: file.name, 
                        message: 'Erro de leitura do arquivo (FileReader Error).', 
                        content: 'N/A' 
                    });
                    resolve();
                };
                reader.readAsText(file);
            });
        };
        
        // Processa todos os arquivos em lote
        Promise.all(Array.from(files).map(file => readAndProcessFile(file)))
            .then(() => {
                saveClasses();
                currentPage = 1;
                renderClassList();

                let logMessage = '';
                let toastType = 'info';

                if (importStats.importedCount > 0) {
                    logMessage += `✅ ${importStats.importedCount} classes importadas com sucesso! `;
                    toastType = 'success';
                }

                if (importStats.duplicates.length > 0) {
                    logMessage += `⚠️ ${importStats.duplicates.length} classes ignoradas (Duplicadas por Nome). `;
                    if (toastType !== 'success') toastType = 'info';
                }
                
                if (importStats.fileFailures.length > 0 || importStats.failures.length > 0) {
                    logMessage += `❌ ${importStats.fileFailures.length + importStats.failures.length} falhas. Verifique os Logs. `;
                    toastType = 'error';
                }

                showToast(logMessage || 'Nenhuma classe foi processada.', toastType);
                
                // Consolida o log detalhado para o modal
                let detailedLog = JSON.stringify(importStats, null, 2);
                let errorMessage = `Resultado da Importação de ${files.length} arquivo(s):\n`;
                errorMessage += `Importados: ${importStats.importedCount}\n`;
                errorMessage += `Duplicados Ignorados: ${importStats.duplicates.join(', ') || 'Nenhum'}\n`;
                errorMessage += `Falhas de Arquivo/Parsing: ${importStats.fileFailures.map(f => f.file).join(', ') || 'Nenhuma'}\n`;
                
                lastImportError = { 
                    message: errorMessage, 
                    content: detailedLog 
                };
                
            });
        
        // Limpa a seleção do arquivo para permitir nova importação
        event.target.value = null;
    };

    /**
     * Copia os dados da classe para o clipboard como texto formatado (ficha).
     */
    const copyClassToClipboard = (id) => {
        const classe = currentClasses.find(c => c.id === id);
        if (!classe) {
            showToast('Classe não encontrada para copiar.', 'error');
            return;
        }

        let text = `FICHA DE CLASSE: ${classe.nome.toUpperCase()}\n`;
        text += `\nTipo: ${classe.tipo} | Tags: ${classe.tag || 'N/A'}\n`;
        text += `Descrição: ${classe.descricaoCurta}\n`;
        text += `--------------------------------------------------\n`;
        text += `Dados Base:\n`;
        text += `  PV: ${classe.dadosBase.dadoVida} | Inicial: ${classe.dadosBase.pvInicial} | Por Nível: ${classe.dadosBase.pvPorNivel}\n`;
        text += `  PM: Inicial: ${classe.dadosBase.pmInicial} | Por Nível: +${classe.dadosBase.pmPorNivel}\n`;
        text += `  Perícias/Nível: ${classe.dadosBase.periciasPorNivel}\n`;
        text += `  Talentos Adicionais: ${classe.dadosBase.talentosAdicionais.join(', ')}\n`;
        text += `  Perícias de Classe: ${classe.dadosBase.periciasDeClasse.join(', ')}\n`;
        text += `\n--------------------------------------------------\n`;
        text += `HABILIDADES ESPECIAIS:\n`;
        classe.habilidadesEspeciais.forEach(hab => {
            text += `  - [Nível ${hab.nivel}]: ${hab.nome} ${hab.prerequisito ? `(Pré: ${hab.prerequisito})` : ''}\n`;
            text += `    > ${hab.descricao}\n`;
        });
        text += `\n--------------------------------------------------\n`;
        text += `TABELA DE PROGRESSÃO:\n`;
        text += `Nível | Bônus Global | BBA | Talentos | Aum. Hab. | Habilidades | Magias\n`;
        
        classe.tabelaProgressao.forEach(row => {
             const nivelData = getGlobalBenefits(row.nivel);
             
             // Base (Global)
             const bonusGlobal = nivelData.bonusGlobal;
             const talentos = nivelData.talentos;
             const aumentoHab = nivelData.aumentoHab;
             const bab = row.bab || '–';
             
             text += `  Nível ${row.nivel.toString().padStart(2, '0')}: ${bonusGlobal.padEnd(12, ' ')} | ${bab.padEnd(5, ' ')} | ${String(talentos).padEnd(8, ' ')} | ${String(aumentoHab).padEnd(9, ' ')} | ${row.hab.substring(0, 30).padEnd(30, ' ')} | ${row.magias}\n`;
        });

        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = text;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();

        try {
            document.execCommand('copy');
            showToast('Ficha copiada para o clipboard!', 'success');
        } catch (err) {
            console.error('Falha ao copiar:', err);
            showToast('Falha ao copiar. Tente selecionar o texto manualmente.', 'error');
        }
        document.body.removeChild(tempTextArea);
    };

    // ====================================================================
    // 9. MODAL DE CONFIRMAÇÃO E LOGS
    // ====================================================================

    let currentModalAction = null;

    /**
     * Exibe o modal de confirmação.
     * @param {object} options - { title, message, onConfirm }
     */
    const showModal = ({ title, message, onConfirm }) => {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        document.getElementById('modal-container').classList.remove('hidden');
        document.getElementById('modal-container').classList.add('flex');
        currentModalAction = onConfirm;
    };

    /**
     * Esconde o modal.
     */
    const hideModal = () => {
        document.getElementById('modal-container').classList.add('hidden');
        document.getElementById('modal-container').classList.remove('flex');
        currentModalAction = null;
    };
    
    /**
     * Exibe o modal de logs de erro.
     */
    const showLogModal = () => {
        document.getElementById('log-error-message').textContent = lastImportError.message || 'Nenhum erro recente de importação foi registrado.';
        document.getElementById('log-json-content').textContent = lastImportError.content || 'Nenhum conteúdo JSON para exibir.';
        document.getElementById('log-modal-container').classList.remove('hidden');
        document.getElementById('log-modal-container').classList.add('flex');
    };
    
    /**
     * Esconde o modal de logs de erro.
     */
    const hideLogModal = () => {
        document.getElementById('log-modal-container').classList.add('hidden');
        document.getElementById('log-modal-container').classList.remove('flex');
    };


    // ====================================================================
    // 10. INICIALIZAÇÃO E LISTENERS
    // ====================================================================

    /**
     * Inicializa a aplicação.
     */
    const initApp = () => {
        initDarkMode();
        loadClasses();
        renderClassList();
        setMainView('home'); // Tela de Boas-Vindas

        // --- LISTENERS PARA A NOVA BARRA DE NAVEGAÇÃO ---
        document.getElementById('btn-nova-classe-desktop-nav').addEventListener('click', startNewClass);
        document.getElementById('btn-novo-mobile').addEventListener('click', startNewClass);
        
        document.getElementById('btn-importar-classes-nav').addEventListener('click', () => document.getElementById('input-import-json').click());
        document.getElementById('input-import-json').addEventListener('change', handleImportClasses);
        
        document.getElementById('btn-exportar-tudo-nav').addEventListener('click', exportAllClassesJSON);
        document.getElementById('btn-view-logs-nav').addEventListener('click', showLogModal);
        
        // NOVO LISTENER: Excluir Todos os Dados
        document.getElementById('btn-excluir-tudo-nav').addEventListener('click', confirmClearAllData);

        // Listener do botão de Limpar BBA Graduações
        const btnLimparBBA = document.getElementById('btn-limpar-graduacoes-bba');
        if (btnLimparBBA) { // Adicionando verificação de existência, pois o botão foi removido no fluxo anterior
            btnLimparBBA.addEventListener('click', () => {
                showModal({
                    title: 'Limpar Graduações de BBA',
                    message: 'Atenção: A coluna Graduações foi removida. O campo BBA agora deve conter o valor completo (ex: +20/+15/+10/+5), como no PDF. A função de limpeza foi desativada.',
                    onConfirm: hideModal // Ação de confirmação agora é apenas fechar o modal.
                });
            });
        }
        // ------------------------------------------------

        // Listener para a lista (para visualizar classes)
        document.getElementById('lista-classes').addEventListener('click', (e) => {
            const card = e.target.closest('.class-card');
            if (card) {
                renderClassView(currentClasses.find(c => c.id === card.dataset.id));
            }
        });

        // Listeners para Busca e Ordenação
        document.getElementById('input-busca').addEventListener('input', () => {
            currentPage = 1; // Resetar página ao buscar
            renderClassList();
        });
        document.getElementById('select-ordenacao').addEventListener('change', () => {
            currentPage = 1; // Resetar página ao ordenar
            renderClassList();
        });

        // Listeners do Modal
        document.getElementById('modal-cancel-btn').addEventListener('click', hideModal);
        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if (currentModalAction) {
                currentModalAction();
            }
            hideModal();
        });

    };

    // Inicia a aplicação após o carregamento do DOM
    window.onload = initApp;

</script>
</body>
</html>

